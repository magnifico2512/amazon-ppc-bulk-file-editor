<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon PPC Bulk Manager - Enhanced</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* Prevent white background on scroll */
        html, body {
            background-color: #f8fafc;
            min-width: 100%;
        }
        
        /* Custom scrollbar styling */
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #94a3b8, #64748b);
            border-radius: 4px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #64748b, #475569);
        }
        
        /* Row states with subtle gradients */
        .changed-row {
            background: linear-gradient(90deg, #fef3c7 0%, #fef9c3 100%);
        }
        .new-row {
            background: linear-gradient(90deg, #d1fae5 0%, #dcfce7 100%);
        }
        
        /* Column resizer */
        .resizer {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 5px;
            cursor: col-resize;
            user-select: none;
            background: transparent;
            transition: background 0.15s ease;
        }
        .resizer:hover {
            background: linear-gradient(180deg, #06b6d4, #0891b2);
        }
        
        th { position: relative; }
        table { table-layout: fixed; }
        td { overflow: hidden; text-overflow: ellipsis; }
        
        /* Filter modal styling */
        .filter-modal {
            position: absolute;
            z-index: 1000;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 320px;
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }
        .filter-header {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        .filter-items {
            max-height: 300px;
            overflow-y: auto;
            padding: 8px;
        }
        .filter-footer {
            padding: 12px 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }
        .filter-icon {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }
        .filter-icon:hover {
            background-color: #f1f5f9;
        }
        .filter-icon.active {
            color: #0891b2;
        }
        
        /* Animations */
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .dropdown-animate {
            animation: slideDown 0.15s ease-out;
        }
        .fade-in {
            animation: fadeIn 0.2s ease-out;
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #e2e8f0;
            border-top-color: #0891b2;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .loading-text {
            margin-top: 16px;
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }
        .loading-progress {
            margin-top: 8px;
            width: 200px;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
        }
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #06b6d4, #0891b2);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }
        
        /* Dropdown containers */
        .dropdown-container {
            position: relative;
            z-index: 100;
        }
        .dropdown-menu {
            min-width: max-content;
        }
        .dropdown-animate div {
            overflow: visible !important;
            text-overflow: clip !important;
        }
        
        /* Enhanced button styles */
        .btn-primary {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            border: none;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(6, 182, 212, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        
        /* Tab active states */
        .tab-active {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
        }
        
        /* Stat cards hover */
        .stat-card {
            transition: all 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        /* Table row hover */
        tbody tr {
            transition: background-color 0.15s ease;
        }
        tbody tr:hover {
            background-color: #f8fafc;
        }
        
        /* Keyboard shortcut hints */
        .kbd {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 6px;
            font-size: 11px;
            font-family: ui-monospace, monospace;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            color: #64748b;
            box-shadow: 0 1px 0 #e2e8f0;
        }
        
        /* Focus states */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }
        
        /* Virtual scrolling container */
        .virtual-scroll-container {
            position: relative;
            overflow: auto;
        }
        .virtual-scroll-content {
            position: relative;
        }
        
        /* Empty state styling */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #334155;
            margin-bottom: 8px;
        }
        .empty-state-desc {
            font-size: 14px;
            max-width: 400px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // ========================================
        // UTILITY HOOKS
        // ========================================
        
        // Debounce hook for search performance
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            
            useEffect(() => {
                const handler = setTimeout(() => {
                    setDebouncedValue(value);
                }, delay);
                
                return () => clearTimeout(handler);
            }, [value, delay]);
            
            return debouncedValue;
        }
        
        // Loading component with progress
        function LoadingOverlay({ message = 'Processing...', progress = null }) {
            return (
                <div className="loading-overlay">
                    <div className="loading-spinner"></div>
                    <div className="loading-text">{message}</div>
                    {progress !== null && (
                        <div className="loading-progress">
                            <div 
                                className="loading-progress-bar" 
                                style={{ width: `${Math.min(100, progress)}%` }}
                            />
                        </div>
                    )}
                </div>
            );
        }
        
        // Empty state component
        function EmptyState({ icon, title, description, action }) {
            return (
                <div className="empty-state">
                    <div className="empty-state-icon">{icon}</div>
                    <div className="empty-state-title">{title}</div>
                    <div className="empty-state-desc">{description}</div>
                    {action && <div className="mt-4">{action}</div>}
                </div>
            );
        }
        
        // Keyboard shortcut indicator
        function KeyboardHint({ keys }) {
            return (
                <span className="ml-2 opacity-60">
                    {keys.map((key, i) => (
                        <span key={i}>
                            {i > 0 && <span className="mx-1">+</span>}
                            <span className="kbd">{key}</span>
                        </span>
                    ))}
                </span>
            );
        }

        // Dropdown component for pill navigation
        function Dropdown({ trigger, children, align = 'left' }) {
            const [open, setOpen] = useState(false);
            const ref = useRef(null);

            useEffect(() => {
                function handleClick(e) {
                    if (ref.current && !ref.current.contains(e.target)) {
                        setOpen(false);
                    }
                }
                document.addEventListener('mousedown', handleClick);
                return () => document.removeEventListener('mousedown', handleClick);
            }, []);

            return (
                <div className="relative overflow-visible" ref={ref}>
                    <div onClick={() => setOpen(!open)}>{trigger}</div>
                    {open && (
                        <div className={`absolute top-full mt-2 ${align === 'right' ? 'right-0' : 'left-0'} z-50 dropdown-animate`} style={{ minWidth: 'max-content' }}>
                            {children}
                        </div>
                    )}
                </div>
            );
        }

        // ========================================
        // AMAZON BULKSHEET EXPORT CONFIGURATION
        // Updated to match Amazon's official bulksheet format for Sponsored Products
        // ========================================
        const AMAZON_BULKSHEET_CONFIG = {
            // ALL possible columns in Amazon Sponsored Products bulksheets (in correct order)
            allColumns: [
                'Product',
                'Entity',
                'Operation',
                'Campaign ID',
                'Ad Group ID',
                'Portfolio ID',
                'Ad ID',
                'Keyword ID',
                'Product Targeting ID',
                'Campaign Name',
                'Ad Group Name',
                'Start Date',
                'End Date',
                'Targeting Type',
                'State',
                'Daily Budget',
                'SKU',
                'ASIN',
                'Ad Group Default Bid',
                'Bid',
                'Keyword Text',
                'Match Type',
                'Bidding Strategy',
                'Placement',
                'Percentage',
                'Product Targeting Expression'
            ],

            // Columns to EXCLUDE from exports (KPIs and read-only informational data)
            excludeColumns: [
                'Impressions', 'Clicks', 'Spend', 'Sales', 'Orders', 'Units',
                'Click-through Rate', 'Conversion Rate', 'ACOS', 'ROAS', 'CPC',
                'Portfolio Name (Informational only)',
                'Campaign State (Informational only)',
                'Ad Group State (Informational only)',
                'Eligibility Status (Informational only)',
                'Reason for Ineligibility (Informational only)',
                'ASIN (Informational only)',
                'Resolved Product Targeting Expression (Informational only)',
                'Campaign Name (Informational only)',
                'Ad Group Name (Informational only)',
                'Native Language Keyword',
                'Native Language Locale',
                'Ad Group Default Bid (Informational only)'
            ],

            // Map internal entity names to Amazon's bulksheet entity names
            entityNameMap: {
                'Campaign Placement': 'Bidding adjustment'
            },

            // Fields to always include (even if blank) for better compatibility
            alwaysIncludeFields: [
                'Product', 'Entity', 'Operation', 'Campaign ID', 'Ad Group ID',
                'Portfolio ID', 'Ad ID', 'Keyword ID', 'Product Targeting ID'
            ]
        };

        // Enhanced export data preparation for Amazon bulksheets
        const prepareAmazonBulksheet = (changes, originalRowMap) => {
            return changes.map(row => {
                const cleanRow = {};
                const original = originalRowMap.get(getRowId(row));
                
                // Determine operation
                const operation = original ? 'Update' : 'Create';
                
                // Map entity name if needed
                let entityName = row.Entity;
                if (AMAZON_BULKSHEET_CONFIG.entityNameMap[entityName]) {
                    entityName = AMAZON_BULKSHEET_CONFIG.entityNameMap[entityName];
                }
                
                // Process each column in the correct order
                AMAZON_BULKSHEET_CONFIG.allColumns.forEach(column => {
                    // Skip if in exclude list
                    if (AMAZON_BULKSHEET_CONFIG.excludeColumns.includes(column)) {
                        return;
                    }
                    
                    let value = '';
                    
                    // Set special field values
                    if (column === 'Product') {
                        value = 'Sponsored Products';
                    } else if (column === 'Entity') {
                        value = entityName;
                    } else if (column === 'Operation') {
                        value = operation;
                    } else if (column === 'Portfolio ID' && original && original['Portfolio ID']) {
                        // Preserve Portfolio ID for updates to avoid removing from portfolio
                        value = original['Portfolio ID'];
                    } else {
                        // Get value from current row
                        value = row[column] !== undefined ? row[column] : '';
                    }
                    
                    // Convert empty strings to actual empty values for CSV
                    if (value === null || value === undefined) {
                        value = '';
                    }
                    
                    // Trim whitespace
                    if (typeof value === 'string') {
                        value = value.trim();
                    }
                    
                    // Include field if:
                    // 1. It's in alwaysIncludeFields, OR
                    // 2. It has a non-empty value
                    if (AMAZON_BULKSHEET_CONFIG.alwaysIncludeFields.includes(column) ||
                        value !== '') {
                        cleanRow[column] = value;
                    }
                });
                
                return cleanRow;
            });
        };

        // Helper to get campaign/ad group names from either regular or informational columns
        const getCampaignName = (row) => {
            return row['Campaign Name'] || row['Campaign Name (Informational only)'] || '-';
        };

        const getAdGroupName = (row) => {
            return row['Ad Group Name'] || row['Ad Group Name (Informational only)'] || '-';
        };

        const getPortfolioName = (row) => {
            return row['Portfolio Name (Informational only)'] || '-';
        };

        // Improved change detection - only compare meaningful fields
        const hasRowChanged = (original, current) => {
            if (!original) return false;
            
            // Base fields that apply to all entities
            const baseCompareFields = [
                'State', 'Daily Budget', 'Ad Group Default Bid', 'Bid', 'Match Type', 
                'Bidding Strategy', 'Targeting Type', 'Keyword Text', 
                'Product Targeting Expression', 'Percentage', 'SKU', 'End Date'
            ];
            
            // Add name fields only for their specific entities
            const compareFields = [...baseCompareFields];
            if (current.Entity === 'Campaign') {
                compareFields.push('Campaign Name');
            }
            if (current.Entity === 'Ad Group') {
                compareFields.push('Ad Group Name');
            }
            
            return compareFields.some(field => {
                const origVal = String(original[field] || '').trim();
                const currVal = String(current[field] || '').trim();
                return origVal !== currVal;
            });
        };

        // Create unique ID for row comparison
        const getRowId = (row) => {
            // Include _originalIndex if present to handle rows with duplicate logical IDs
            const baseId = `${row.Entity}|${row['Campaign ID']}|${row['Ad Group ID']}|${row['Keyword ID']}|${row['Ad ID']}|${row['Product Targeting ID']}|${row['Keyword Text']}|${row.SKU}`;
            return row._originalIndex !== undefined ? `${row._originalIndex}|${baseId}` : baseId;
        };

        // Format product targeting expressions from simple input
        const formatProductTargetingExpression = (input, type = 'auto') => {
            input = input.trim();
            if (!input) return '';
            
            // If already formatted, return as-is
            if (input.includes('=') && input.includes('"')) {
                return input;
            }
            
            // Auto-detect type if not specified
            if (type === 'auto') {
                // Check if it's a 10-character alphanumeric ASIN
                if (/^[A-Z0-9]{10}$/i.test(input)) {
                    type = 'asin';
                }
                // Check if it's purely numeric (likely a category)
                else if (/^\d+$/.test(input)) {
                    type = 'category';
                }
                // Default to ASIN
                else {
                    type = 'asin';
                }
            }
            
            // Format based on type
            switch(type) {
                case 'asin':
                    return `asin="${input}"`;
                case 'asin-expanded':
                    return `asin-expanded="${input}"`;
                case 'category':
                    return `category="${input}"`;
                default:
                    return `asin="${input}"`;
            }
        };

        // Filter Modal Component for Excel-style filtering
        function FilterModal({ column, uniqueValues, selectedFilters, onApply, onClose, position, currentSort, onSort }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [localSelected, setLocalSelected] = useState(new Set(selectedFilters || []));
            const modalRef = useRef(null);
            
            // Determine if this is a KPI column (numeric data)
            const kpiColumns = ['Impressions', 'Clicks', 'Spend', 'Sales', 'Orders', 'Units', 
                              'Click-through Rate', 'Conversion Rate', 'ACOS', 'ROAS', 'CPC',
                              'Ad Group Default Bid', 'Bid', 'Daily Budget', 'Percentage'];
            const isKPIColumn = kpiColumns.includes(column);

            // Close modal when clicking outside
            useEffect(() => {
                function handleClickOutside(event) {
                    if (modalRef.current && !modalRef.current.contains(event.target)) {
                        onClose();
                    }
                }
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [onClose]);

            const filteredValues = useMemo(() => {
                if (!searchTerm) return uniqueValues;
                return uniqueValues.filter(value => 
                    String(value).toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [uniqueValues, searchTerm]);

            const handleSelectAll = () => {
                // Get the count of filtered items that are currently selected
                const filteredSelectedCount = filteredValues.filter(v => localSelected.has(v)).length;
                
                // If all filtered items are selected, deselect only the filtered items
                if (filteredSelectedCount === filteredValues.length) {
                    const newSelected = new Set(localSelected);
                    filteredValues.forEach(v => newSelected.delete(v));
                    setLocalSelected(newSelected);
                } else {
                    // Otherwise, add all filtered items to selection
                    const newSelected = new Set(localSelected);
                    filteredValues.forEach(v => newSelected.add(v));
                    setLocalSelected(newSelected);
                }
            };

            const handleApply = () => {
                onApply(column, localSelected);
                onClose();
            };

            const handleClear = () => {
                setLocalSelected(new Set());
            };

            return (
                <div 
                    ref={modalRef}
                    className="filter-modal"
                    style={{
                        top: position.top,
                        left: Math.min(position.left, window.innerWidth - 340)
                    }}
                >
                    <div className="filter-header">
                        {isKPIColumn && (
                            <div className="mb-2 pb-2 border-b border-gray-200">
                                <div className="text-[10px] font-semibold text-gray-700 mb-1">Sort by {column}:</div>
                                <div className="flex gap-1">
                                    <button
                                        onClick={() => onSort(column, currentSort?.column === column && currentSort?.direction === 'asc' ? null : 'asc')}
                                        className={`flex-1 px-2 py-1 text-[10px] rounded transition ${
                                            currentSort?.column === column && currentSort?.direction === 'asc'
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        ‚Üë Lowest First
                                    </button>
                                    <button
                                        onClick={() => onSort(column, currentSort?.column === column && currentSort?.direction === 'desc' ? null : 'desc')}
                                        className={`flex-1 px-2 py-1 text-[10px] rounded transition ${
                                            currentSort?.column === column && currentSort?.direction === 'desc'
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        ‚Üì Highest First
                                    </button>
                                </div>
                            </div>
                        )}
                        <input
                            type="text"
                            placeholder="Search..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full px-3 py-1.5 border border-gray-300 rounded text-sm"
                            autoFocus
                        />
                    </div>
                    
                    <div className="filter-items scrollbar-thin">
                        <label className="flex items-center gap-2 px-2 py-1.5 hover:bg-gray-50 cursor-pointer text-sm font-medium">
                            <input
                                type="checkbox"
                                checked={filteredValues.length > 0 && filteredValues.every(v => localSelected.has(v))}
                                onChange={handleSelectAll}
                                className="rounded"
                            />
                            <span>Select All ({filteredValues.length})</span>
                        </label>
                        <div className="border-t my-1"></div>
                        {filteredValues.map((value, index) => (
                            <label 
                                key={index} 
                                className="flex items-center gap-2 px-2 py-1.5 hover:bg-gray-50 cursor-pointer text-sm"
                            >
                                <input
                                    type="checkbox"
                                    checked={localSelected.has(value)}
                                    onChange={(e) => {
                                        const newSelected = new Set(localSelected);
                                        if (e.target.checked) {
                                            newSelected.add(value);
                                        } else {
                                            newSelected.delete(value);
                                        }
                                        setLocalSelected(newSelected);
                                    }}
                                    className="rounded"
                                />
                                <span className="truncate">{value}</span>
                            </label>
                        ))}
                    </div>
                    
                    <div className="filter-footer">
                        <button
                            onClick={handleClear}
                            className="flex-1 px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                        >
                            Clear
                        </button>
                        <button
                            onClick={handleApply}
                            className="flex-1 px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700"
                        >
                            Apply
                        </button>
                    </div>
                </div>
            );
        }

        function FindReplaceModal({ settings, setSettings, onExecute, onClose, data }) {
            const [previewResults, setPreviewResults] = useState([]);
            
            const availableColumns = [
                'Campaign Name',
                'Ad Group Name',
                'Keyword Text',
                'SKU',
                'Product Targeting Expression'
            ];
            
            const toggleColumn = (column) => {
                const newColumns = settings.selectedColumns.includes(column)
                    ? settings.selectedColumns.filter(c => c !== column)
                    : [...settings.selectedColumns, column];
                setSettings({ ...settings, selectedColumns: newColumns });
            };
            
            const generatePreview = () => {
                if (!settings.findText) return;
                
                const { findText, replaceText, matchCase, selectedColumns } = settings;
                const results = [];
                
                data.forEach((row, index) => {
                    selectedColumns.forEach(column => {
                        const currentValue = row[column];
                        if (currentValue && typeof currentValue === 'string') {
                            let newValue;
                            if (matchCase) {
                                newValue = currentValue.split(findText).join(replaceText);
                            } else {
                                const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                                newValue = currentValue.replace(regex, replaceText);
                            }
                            
                            if (newValue !== currentValue) {
                                results.push({
                                    index,
                                    column,
                                    entity: row.Entity,
                                    before: currentValue,
                                    after: newValue
                                });
                            }
                        }
                    });
                });
                
                setPreviewResults(results);
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 className="text-xl font-bold text-gray-900 mb-4">üîç Find & Replace</h3>
                        
                        <div className="space-y-4">
                            {/* Find Text Input */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Find Text *
                                </label>
                                <input
                                    type="text"
                                    value={settings.findText}
                                    onChange={(e) => setSettings({ ...settings, findText: e.target.value })}
                                    placeholder="Enter text to find..."
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    autoFocus
                                />
                            </div>
                            
                            {/* Replace Text Input */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Replace With
                                </label>
                                <input
                                    type="text"
                                    value={settings.replaceText}
                                    onChange={(e) => setSettings({ ...settings, replaceText: e.target.value })}
                                    placeholder="Enter replacement text..."
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                />
                            </div>
                            
                            {/* Options */}
                            <div>
                                <label className="flex items-center gap-2 text-sm">
                                    <input
                                        type="checkbox"
                                        checked={settings.matchCase}
                                        onChange={(e) => setSettings({ ...settings, matchCase: e.target.checked })}
                                        className="rounded"
                                    />
                                    <span>Match case</span>
                                </label>
                            </div>
                            
                            {/* Column Selection */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Search in Columns *
                                </label>
                                <div className="grid grid-cols-2 gap-2">
                                    {availableColumns.map(column => (
                                        <label key={column} className="flex items-center gap-2 text-sm p-2 border rounded hover:bg-gray-50 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={settings.selectedColumns.includes(column)}
                                                onChange={() => toggleColumn(column)}
                                                className="rounded"
                                            />
                                            <span>{column}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Preview Button */}
                            <div>
                                <button
                                    onClick={generatePreview}
                                    disabled={!settings.findText || settings.selectedColumns.length === 0}
                                    className="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium"
                                >
                                    üîé Preview Changes
                                </button>
                            </div>
                            
                            {/* Preview Results */}
                            {previewResults.length > 0 && (
                                <div className="border rounded-lg p-4 bg-gray-50 max-h-64 overflow-y-auto">
                                    <h4 className="text-sm font-semibold text-gray-900 mb-2">
                                        Preview: {previewResults.length} change(s) will be made
                                    </h4>
                                    <div className="space-y-2 text-xs">
                                        {previewResults.slice(0, 10).map((result, idx) => (
                                            <div key={idx} className="bg-white p-2 rounded border">
                                                <div className="text-gray-600 mb-1">
                                                    {result.entity} ‚Ä¢ {result.column}
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-red-600 line-through">{result.before}</span>
                                                    <span>‚Üí</span>
                                                    <span className="text-green-600 font-medium">{result.after}</span>
                                                </div>
                                            </div>
                                        ))}
                                        {previewResults.length > 10 && (
                                            <div className="text-center text-gray-500 text-xs">
                                                ... and {previewResults.length - 10} more
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {previewResults.length === 0 && settings.findText && (
                                <div className="text-sm text-gray-600 bg-yellow-50 border border-yellow-200 rounded p-3">
                                    ‚ÑπÔ∏è No matches found. Try adjusting your search text or selected columns.
                                </div>
                            )}
                        </div>
                        
                        {/* Action Buttons */}
                        <div className="flex gap-3 mt-6">
                            <button
                                onClick={onExecute}
                                disabled={!settings.findText || settings.selectedColumns.length === 0 || previewResults.length === 0}
                                className="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium"
                            >
                                Replace All ({previewResults.length})
                            </button>
                            <button
                                onClick={onClose}
                                className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-medium"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ========================================
        // HELPER FUNCTIONS (Global Scope)
        // ========================================
        // Helper function to parse numbers with comma or period as decimal separator
        // Defined at global scope to avoid Babel deoptimization issues with large files
        const parseNumber = (value) => {
            if (value === null || value === undefined || value === '') return 0;
            // Convert to string and replace comma with period for European format
            const normalized = String(value).replace(',', '.');
            const parsed = parseFloat(normalized);
            return isNaN(parsed) ? 0 : parsed;
        };

        function App() {
            const [data, setData] = useState([]);
            const [originalRowMap, setOriginalRowMap] = useState(new Map());
            const [activeTab, setActiveTab] = useState('adgroups');
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedItems, setSelectedItems] = useState(new Set());
            const [showModal, setShowModal] = useState(false);
            const [modalType, setModalType] = useState('');
            const [columnWidths, setColumnWidths] = useState({});
            const [columnFilters, setColumnFilters] = useState({});
            const [columnSort, setColumnSort] = useState({ column: null, direction: null }); // null, 'asc', 'desc'
            const [activeFilterColumn, setActiveFilterColumn] = useState(null);
            const [filterPosition, setFilterPosition] = useState({ top: 0, left: 0 });
            const [showReferencePanel, setShowReferencePanel] = useState(false);
            const [showFindReplaceModal, setShowFindReplaceModal] = useState(false);
            const [findReplaceSettings, setFindReplaceSettings] = useState({
                findText: '',
                replaceText: '',
                matchCase: false,
                selectedColumns: ['Campaign Name', 'Ad Group Name']
            });
            const [referenceKeywords, setReferenceKeywords] = useState('');
            const [expandedKeywordRows, setExpandedKeywordRows] = useState(new Set());
            const [referenceProducts, setReferenceProducts] = useState('');
            const [referenceTab, setReferenceTab] = useState('keywords');
            const [referencePortfolio, setReferencePortfolio] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [statusSearch, setStatusSearch] = useState('');
            const [matchTypeFiltersExpanded, setMatchTypeFiltersExpanded] = useState(false);
            const [matchTypeHas, setMatchTypeHas] = useState({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
            const [matchTypeMissing, setMatchTypeMissing] = useState({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
            const [hasSavedChanges, setHasSavedChanges] = useState(false);
            const [savedChangesCount, setSavedChangesCount] = useState(0);
            const isLoadingFile = useRef(false); // Prevent auto-save during file upload
            const [showRecoveryBanner, setShowRecoveryBanner] = useState(false);
            const [originalFileName, setOriginalFileName] = useState('');
            const [referenceKeywordSelections, setReferenceKeywordSelections] = useState(new Set());
            const [metadataSort, setMetadataSort] = useState({ column: null, direction: null });
            const [metadataFilters, setMetadataFilters] = useState({});
            const [keywordTableData, setKeywordTableData] = useState([{ Keyword: '' }]);
            const [tableColumns, setTableColumns] = useState(['Keyword']);
            const [editingCell, setEditingCell] = useState(null);
            const [useTableMode, setUseTableMode] = useState(true);
            const [panelWidth, setPanelWidth] = useState(600); // Resizable panel width
            const [showTargetCheckerTip, setShowTargetCheckerTip] = useState(true);
            const [showTableModeTip, setShowTableModeTip] = useState(true);
            const [showExportTip, setShowExportTip] = useState(true);
            const [showBulkModeTip, setShowBulkModeTip] = useState(true);
            const [statusFilterValue, setStatusFilterValue] = useState('all'); // 'all', 'modified', 'new', 'unchanged'
            const [productTargetFilters, setProductTargetFilters] = useState({}); // { adGroupId: { state: '', acos: '', clicks: '', search: '' } }
            
            // ========================================
            // LOADING & PERFORMANCE STATES
            // ========================================
            const [isLoading, setIsLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [loadingProgress, setLoadingProgress] = useState(null);
            
            // Debounced search for better performance
            const debouncedSearchTerm = useDebounce(searchTerm, 150);
            
            // Pre-computed index map for O(1) row lookups
            const dataIndexMap = useMemo(() => {
                const map = new Map();
                data.forEach((row, index) => {
                    map.set(row, index);
                });
                return map;
            }, [data]);
            
            // Helper to get index efficiently
            const getDataIndex = useCallback((item) => {
                return dataIndexMap.get(item) ?? -1;
            }, [dataIndexMap]);
            

            // ========================================
            // AUTO-SAVE SYSTEM - IndexedDB Utilities
            // ========================================
            
            const STORAGE_KEY = 'ppc_manager_changes';
            const TARGETCHECKER_STORAGE_KEY = 'target_checker_data';
            const DB_NAME = 'PPCManagerDB';
            const STORE_NAME = 'changes';
            
            // Initialize IndexedDB
            const initDB = () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME);
                        }
                    };
                });
            };
            
            // Save changes to IndexedDB
            const saveChangesToDB = async (changesData) => {
                try {
                    const db = await initDB();
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    
                    const saveData = {
                        changes: changesData.changes,
                        originalRowMap: changesData.originalRowMap,
                        timestamp: Date.now(),
                        fileName: changesData.fileName || 'unknown.csv'
                    };
                    
                    store.put(saveData, STORAGE_KEY);
                    
                    return new Promise((resolve, reject) => {
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = () => reject(transaction.error);
                    });
                } catch (error) {
                    console.error('Error saving to IndexedDB:', error);
                }
            };
            
            // Load changes from IndexedDB
            const loadChangesFromDB = async () => {
                try {
                    const db = await initDB();
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(STORAGE_KEY);
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('Error loading from IndexedDB:', error);
                    return null;
                }
            };
            
            // Clear saved changes from IndexedDB
            const clearSavedChanges = async () => {
                try {
                    const db = await initDB();
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.delete(STORAGE_KEY);
                    
                    return new Promise((resolve, reject) => {
                        transaction.oncomplete = () => {
                            setHasSavedChanges(false);
                            setSavedChangesCount(0);
                            setShowRecoveryBanner(false);
                            resolve();
                        };
                        transaction.onerror = () => reject(transaction.error);
                    });
                } catch (error) {
                    console.error('Error clearing saved changes:', error);
                }
            };
            
            // ========================================
            // TARGET CHECKER PERSISTENCE
            // ========================================
            
            // Save Target Checker data to IndexedDB
            const saveTargetCheckerToDB = async (tableData, columns) => {
                try {
                    const db = await initDB();
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    
                    const saveData = {
                        tableData: tableData,
                        columns: columns,
                        timestamp: Date.now()
                    };
                    
                    store.put(saveData, TARGETCHECKER_STORAGE_KEY);
                    
                    return new Promise((resolve, reject) => {
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = () => reject(transaction.error);
                    });
                } catch (error) {
                    console.error('Error saving Target Checker to IndexedDB:', error);
                }
            };
            
            // Load Target Checker data from IndexedDB
            const loadTargetCheckerFromDB = async () => {
                try {
                    const db = await initDB();
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(TARGETCHECKER_STORAGE_KEY);
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('Error loading Target Checker from IndexedDB:', error);
                    return null;
                }
            };
            
            // Clear Target Checker data from IndexedDB
            const clearTargetCheckerData = async () => {
                try {
                    const db = await initDB();
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.delete(TARGETCHECKER_STORAGE_KEY);
                    
                    return new Promise((resolve, reject) => {
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = () => reject(transaction.error);
                    });
                } catch (error) {
                    console.error('Error clearing Target Checker data:', error);
                }
            };
            
            // Check for saved changes on component mount
            useEffect(() => {
                const checkSavedChanges = async () => {
                    const savedData = await loadChangesFromDB();
                    if (savedData && savedData.changes && savedData.changes.length > 0) {
                        setHasSavedChanges(true);
                        setSavedChangesCount(savedData.changes.length);
                        setShowRecoveryBanner(true);
                    }
                };
                checkSavedChanges();
            }, []);
            
            // Auto-save Target Checker data when it changes
            useEffect(() => {
                // Skip saving if data is empty/default
                if (keywordTableData.length === 1 && 
                    keywordTableData[0].Keyword === '' && 
                    tableColumns.length === 1 && 
                    tableColumns[0] === 'Keyword') {
                    return;
                }
                
                // Save after a small delay to avoid too frequent saves
                const timeoutId = setTimeout(() => {
                    saveTargetCheckerToDB(keywordTableData, tableColumns);
                }, 500);
                
                return () => clearTimeout(timeoutId);
            }, [keywordTableData, tableColumns]);
            
            // Check for saved Target Checker data when panel opens
            // Only prompt to restore if the current table is empty (new session)
            useEffect(() => {
                if (!showReferencePanel) return;
                
                const checkSavedTargetChecker = async () => {
                    // Only offer to restore if current table is empty
                    // This prevents the prompt from showing when reopening the panel in the same session
                    if (keywordTableData.length > 0) {
                        return; // Already have data, don't prompt
                    }
                    
                    const savedData = await loadTargetCheckerFromDB();
                    if (savedData && savedData.tableData && savedData.tableData.length > 0) {
                        const shouldRestore = confirm(
                            `Found saved Target Checker data from ${new Date(savedData.timestamp).toLocaleString()}.\n\n` +
                            `${savedData.tableData.length} rows in your table.\n\n` +
                            `Would you like to restore it?`
                        );
                        
                        if (shouldRestore) {
                            setKeywordTableData(savedData.tableData);
                            setTableColumns(savedData.columns);
                        }
                    }
                };
                
                checkSavedTargetChecker();
            }, [showReferencePanel]); // Note: intentionally not including keywordTableData to avoid re-running
            
            // Apply saved changes to uploaded data
            const applySavedChanges = async (baseData, baseRowMap) => {
                try {
                    const savedData = await loadChangesFromDB();
                    if (!savedData || !savedData.changes) return;
                    
                    console.log('=== APPLYING SAVED CHANGES ===');
                    console.log('Base CSV rows:', baseData.length);
                    console.log('Saved changes count:', savedData.changes.length);
                    
                    const changedRows = savedData.changes;
                    const savedOriginalMap = new Map(Object.entries(savedData.originalRowMap || {}));
                    
                    console.log('Saved original map size:', savedOriginalMap.size);
                    
                    // Build a complete dataset by merging base data with changes
                    // Strategy: Start with base CSV, then overlay all changes
                    
                    // Create ID -> row map for quick lookup
                    const baseDataById = new Map();
                    baseData.forEach(row => {
                        baseDataById.set(getRowId(row), row);
                    });
                    
                    const changedById = new Map();
                    changedRows.forEach(row => {
                        const id = getRowId(row);
                        changedById.set(id, row);
                        console.log('Changed:', row.Entity, row['Campaign Name'] || row['Ad Group Name'] || row['Keyword Text']);
                    });
                    
                    // Build final data: use changed version if exists, else base version
                    const finalData = [];
                    const processedIds = new Set();
                    
                    // First, process all base data rows
                    baseData.forEach(baseRow => {
                        const id = getRowId(baseRow);
                        const changedRow = changedById.get(id);
                        
                        if (changedRow) {
                            // Use the changed version
                            finalData.push({ ...changedRow });
                            console.log('Replaced:', baseRow.Entity, baseRow['Campaign Name'], '‚Üí', changedRow['Campaign Name']);
                        } else {
                            // Use base version
                            finalData.push({ ...baseRow });
                        }
                        
                        processedIds.add(id);
                    });
                    
                    // Then add any new rows that weren't in base data
                    changedRows.forEach(changedRow => {
                        const id = getRowId(changedRow);
                        if (!processedIds.has(id)) {
                            finalData.push({ ...changedRow });
                            console.log('Added new:', changedRow.Entity, changedRow['Campaign Name']);
                        }
                    });
                    
                    // Build originalRowMap: use saved originals for changed items, base data for unchanged
                    const finalOriginalMap = new Map();
                    baseData.forEach(row => {
                        const id = getRowId(row);
                        const savedOriginal = savedOriginalMap.get(id);
                        
                        if (savedOriginal) {
                            // This row was changed - use the saved original (from before any edits)
                            finalOriginalMap.set(id, savedOriginal);
                        } else {
                            // This row wasn't changed - use the base CSV as original
                            finalOriginalMap.set(id, { ...row });
                        }
                    });
                    
                    console.log('Final data size:', finalData.length);
                    console.log('Final original map size:', finalOriginalMap.size);
                    
                    // CASCADE CAMPAIGN NAME CHANGES TO CHILDREN
                    // Find all campaigns that have been renamed
                    const renamedCampaigns = new Map(); // campaignId -> newName
                    finalData.forEach(row => {
                        if (row.Entity === 'Campaign') {
                            const id = getRowId(row);
                            const original = finalOriginalMap.get(id);
                            if (original && original['Campaign Name'] !== row['Campaign Name']) {
                                renamedCampaigns.set(row['Campaign ID'], row['Campaign Name']);
                                console.log('Found renamed campaign:', original['Campaign Name'], '‚Üí', row['Campaign Name']);
                            }
                        }
                    });
                    
                    // If any campaigns were renamed, cascade to all children
                    if (renamedCampaigns.size > 0) {
                        console.log('Cascading campaign renames to children...');
                        finalData.forEach((row, index) => {
                            const campaignId = row['Campaign ID'];
                            if (campaignId && renamedCampaigns.has(campaignId) && row.Entity !== 'Campaign') {
                                const newName = renamedCampaigns.get(campaignId);
                                finalData[index] = {
                                    ...row,
                                    'Campaign Name': newName,
                                    'Campaign Name (Informational only)': newName
                                };
                                console.log('  Updated child:', row.Entity, 'to campaign:', newName);
                            }
                        });
                    }
                    
                    // CASCADE AD GROUP NAME CHANGES TO CHILDREN
                    // Find all ad groups that have been renamed
                    const renamedAdGroups = new Map(); // adGroupId -> newName
                    finalData.forEach(row => {
                        if (row.Entity === 'Ad Group') {
                            const id = getRowId(row);
                            const original = finalOriginalMap.get(id);
                            if (original && original['Ad Group Name'] !== row['Ad Group Name']) {
                                renamedAdGroups.set(row['Ad Group ID'], row['Ad Group Name']);
                                console.log('Found renamed ad group:', original['Ad Group Name'], '‚Üí', row['Ad Group Name']);
                            }
                        }
                    });
                    
                    // If any ad groups were renamed, cascade to all children
                    if (renamedAdGroups.size > 0) {
                        console.log('Cascading ad group renames to children...');
                        finalData.forEach((row, index) => {
                            const adGroupId = row['Ad Group ID'];
                            if (adGroupId && renamedAdGroups.has(adGroupId) && row.Entity !== 'Ad Group') {
                                const newName = renamedAdGroups.get(adGroupId);
                                finalData[index] = {
                                    ...row,
                                    'Ad Group Name': newName,
                                    'Ad Group Name (Informational only)': newName
                                };
                                console.log('  Updated child:', row.Entity, 'to ad group:', newName);
                            }
                        });
                    }
                    
                    // Debug: Print first few entries
                    console.log('=== SAMPLE DATA ===');
                    finalData.slice(0, 3).forEach(row => {
                        const id = getRowId(row);
                        const original = finalOriginalMap.get(id);
                        console.log('Row:', row.Entity, row['Campaign Name']);
                        console.log('  Has original?', !!original);
                        if (original) {
                            console.log('  Original campaign:', original['Campaign Name']);
                            console.log('  Current campaign:', row['Campaign Name']);
                            console.log('  Are they different?', original['Campaign Name'] !== row['Campaign Name']);
                        }
                    });
                    
                    console.log('=== SETTING STATE ===');
                    
                    // IMPORTANT: Reset the status filter dropdown to "All Items" so changes are visible
                    console.log('Resetting status filter to "all"');
                    setStatusFilterValue('all');
                    
                    // Set data - use simple array spread to create new reference
                    console.log('Setting data...');
                    setData(finalData);
                    
                    console.log('Setting originalRowMap...');
                    setOriginalRowMap(finalOriginalMap);
                    
                    console.log('State set! Now checking changes detection...');
                    
                    // Immediate check of what changes would be detected
                    const immediateChanges = finalData.filter(row => {
                        const rowId = getRowId(row);
                        const original = finalOriginalMap.get(rowId);
                        return !original || hasRowChanged(original, row);
                    });
                    console.log('IMMEDIATE changes count:', immediateChanges.length);
                    if (immediateChanges.length > 0) {
                        console.log('First change:', immediateChanges[0].Entity, immediateChanges[0]['Campaign Name']);
                    } else {
                        console.log('WARNING: No changes detected! This is the problem.');
                        console.log('Checking why...');
                        // Sample check
                        const sampleRow = finalData.find(r => r.Entity === 'Campaign');
                        if (sampleRow) {
                            const sampleId = getRowId(sampleRow);
                            const sampleOriginal = finalOriginalMap.get(sampleId);
                            console.log('Sample campaign:', sampleRow['Campaign Name']);
                            console.log('Sample original:', sampleOriginal ? sampleOriginal['Campaign Name'] : 'NOT FOUND');
                        }
                    }
                    
                    alert(`Successfully applied ${changedRows.length} saved changes!\n\nChanges detected: ${immediateChanges.length}\n\nFilter has been reset to "All Items" so you can see your changes.`);
                } catch (error) {
                    console.error('Error applying saved changes:', error);
                    alert('Error applying saved changes: ' + error.message);
                }
            };
            
            // Auto-save changes to IndexedDB
            useEffect(() => {
                // Don't auto-save during file upload to prevent race conditions
                if (isLoadingFile.current) return;
                
                if (data.length === 0) return; // Don't save empty state
                if (originalRowMap.size === 0) return; // Don't save if originalRowMap not ready
                
                const saveChanges = async () => {
                    // Get current changes
                    const currentChanges = data.filter(row => {
                        const rowId = getRowId(row);
                        const original = originalRowMap.get(rowId);
                        return !original || hasRowChanged(original, row);
                    });
                    
                    if (currentChanges.length > 0) {
                        // Convert originalRowMap to plain object for storage
                        const originalMapObj = {};
                        originalRowMap.forEach((value, key) => {
                            originalMapObj[key] = value;
                        });
                        
                        // Calculate checksum of base data for verification
                        const baseData = Array.from(originalRowMap.values());
                        const dataChecksum = baseData.length + '_' + 
                            (baseData[0] ? JSON.stringify(baseData[0]) : '') + '_' +
                            (baseData[baseData.length - 1] ? JSON.stringify(baseData[baseData.length - 1]) : '');
                        
                        await saveChangesToDB({
                            changes: currentChanges,
                            originalRowMap: originalMapObj,
                            fileName: originalFileName,
                            dataChecksum: dataChecksum
                        });
                        
                        setHasSavedChanges(true);
                        setSavedChangesCount(currentChanges.length);
                    } else {
                        // No changes, clear any saved data
                        await clearSavedChanges();
                    }
                };
                
                // Debounce auto-save to avoid too frequent saves
                const timeoutId = setTimeout(saveChanges, 1000);
                return () => clearTimeout(timeoutId);
            }, [data, originalRowMap, originalFileName]);
            
            // Download changes as JSON file
            const downloadChangesFile = async () => {
                const savedData = await loadChangesFromDB();
                if (!savedData || !savedData.changes || savedData.changes.length === 0) {
                    alert('No changes to download');
                    return;
                }
                
                const exportData = {
                    version: '1.0',
                    timestamp: savedData.timestamp,
                    fileName: savedData.fileName,
                    dataChecksum: savedData.dataChecksum || '',
                    changesCount: savedData.changes.length,
                    changes: savedData.changes,
                    originalRowMap: savedData.originalRowMap
                };
                
                const json = JSON.stringify(exportData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().split('T')[0];
                a.download = `ppc-changes-${date}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert(`Downloaded ${savedData.changes.length} changes`);
            };
            
            // Upload and apply changes from JSON file
            const uploadChangesFile = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const importData = JSON.parse(text);
                    
                    if (!importData.changes || !Array.isArray(importData.changes)) {
                        alert('Invalid changes file format');
                        return;
                    }
                    
                    // Save to IndexedDB
                    await saveChangesToDB({
                        changes: importData.changes,
                        originalRowMap: importData.originalRowMap || {},
                        fileName: importData.fileName || 'imported.csv',
                        dataChecksum: importData.dataChecksum || ''
                    });
                    
                    setHasSavedChanges(true);
                    setSavedChangesCount(importData.changes.length);
                    setShowRecoveryBanner(true);
                    
                    alert(`Loaded ${importData.changes.length} changes. Upload your CSV to apply them.`);
                } catch (error) {
                    console.error('Error loading changes file:', error);
                    alert('Error loading changes file. Please check the file format.');
                }
                
                // Reset file input
                event.target.value = '';
            };

            const changes = useMemo(() => {
                // GUARD: Don't calculate changes if state is not fully initialized
                if (data.length > 0 && originalRowMap.size === 0) {
                    return [];
                }
                
                const changeList = data.filter(row => {
                    const rowId = getRowId(row);
                    const original = originalRowMap.get(rowId);
                    return !original || hasRowChanged(original, row);
                });
                
                return changeList;
            }, [data, originalRowMap]);

            // Keyboard shortcuts
            useEffect(() => {
                const handleKeyDown = (e) => {
                    // Skip if typing in an input
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                        return;
                    }
                    
                    // Ctrl/Cmd + F: Focus search
                    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                        e.preventDefault();
                        const searchInput = document.querySelector('input[placeholder*="Search"]');
                        if (searchInput) searchInput.focus();
                    }
                    
                    // Escape: Close modals
                    if (e.key === 'Escape') {
                        setShowModal(false);
                        setShowFindReplaceModal(false);
                        setActiveFilterColumn(null);
                    }
                };
                
                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, []);

            // Normalize column names and values to handle different capitalizations from Amazon exports
            const normalizeColumnNames = (data) => {
                // Mapping of lowercase column names to the expected format
                const columnMapping = {
                    'ad group id': 'Ad Group ID',
                    'campaign name': 'Campaign Name',
                    'ad group name': 'Ad Group Name',
                    'campaign name (informational only)': 'Campaign Name (Informational only)',
                    'ad group name (informational only)': 'Ad Group Name (Informational only)',
                    'portfolio name (informational only)': 'Portfolio Name (Informational only)',
                    'start date': 'Start Date',
                    'end date': 'End Date',
                    'targeting type': 'Targeting Type',
                    'campaign state (informational only)': 'Campaign State (Informational only)',
                    'ad group state (informational only)': 'Ad Group State (Informational only)',
                    'daily budget': 'Daily Budget',
                    'eligibility status (informational only)': 'Eligibility Status (Informational only)',
                    'reason for ineligibility (informational only)': 'Reason for Ineligibility (Informational only)',
                    'keyword text': 'Keyword Text',
                    'native language keyword': 'Native Language Keyword',
                    'native language locale': 'Native Language Locale',
                    'match type': 'Match Type',
                    'bidding strategy': 'Bidding Strategy',
                    'product targeting expression': 'Product Targeting Expression',
                    'resolved product targeting expression (informational only)': 'Resolved Product Targeting Expression (Informational only)',
                    'click-through rate': 'Click-through Rate',
                    'conversion rate': 'Conversion Rate'
                };

                // Mapping for Entity values to ensure consistency
                const entityMapping = {
                    'ad group': 'Ad Group',
                    'product ad': 'Product Ad',
                    'keyword': 'Keyword',
                    'campaign': 'Campaign',
                    'negative keyword': 'Negative Keyword',
                    'product targeting': 'Product Targeting',
                    'negative product targeting': 'Negative Product Targeting'
                };

                return data.map(row => {
                    const normalizedRow = {};
                    Object.keys(row).forEach(key => {
                        const lowerKey = key.toLowerCase();
                        const normalizedKey = columnMapping[lowerKey] || key;
                        let value = row[key];
                        
                        // Normalize Entity values
                        if (normalizedKey === 'Entity' && value) {
                            const lowerEntity = value.toLowerCase();
                            value = entityMapping[lowerEntity] || value;
                        }
                        
                        normalizedRow[normalizedKey] = value;
                    });
                    return normalizedRow;
                });
            };

            const parseCSV = (csvText) => {
                return new Promise((resolve, reject) => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            const normalizedData = normalizeColumnNames(results.data);
                            resolve(normalizedData);
                        },
                        error: (error) => reject(error)
                    });
                });
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // Show loading state
                setIsLoading(true);
                setLoadingMessage(`Loading ${file.name}...`);
                setLoadingProgress(10);

                // Set loading flag to prevent auto-save race condition
                isLoadingFile.current = true;

                try {
                    setLoadingProgress(20);
                    const text = await file.text();
                    
                    setLoadingMessage('Parsing CSV data...');
                    setLoadingProgress(40);
                    const parsedData = await parseCSV(text);
                    
                    setLoadingMessage('Checking for saved changes...');
                    setLoadingProgress(60);
                    
                    // CRITICAL: Always check IndexedDB directly, not just the state variable
                    // This prevents issues where state hasn't updated yet
                    const savedData = await loadChangesFromDB();
                    let shouldApplySavedChanges = false;
                    
                    if (savedData && savedData.changes && savedData.changes.length > 0) {
                        const savedFileName = savedData.fileName || 'unknown.csv';
                        
                        // Calculate a simple checksum of the base data to verify it's truly the same file
                        const newDataChecksum = parsedData.length + '_' + 
                            (parsedData[0] ? JSON.stringify(parsedData[0]) : '') + '_' +
                            (parsedData[parsedData.length - 1] ? JSON.stringify(parsedData[parsedData.length - 1]) : '');
                        const savedChecksum = savedData.dataChecksum || '';
                        
                        // Only apply changes if filename AND checksum match
                        if (savedFileName === file.name && savedChecksum === newDataChecksum && savedChecksum !== '') {
                            setIsLoading(false);
                            shouldApplySavedChanges = confirm(`Found ${savedData.changes.length} saved changes from this exact file. Apply them?`);
                            setIsLoading(true);
                            if (!shouldApplySavedChanges) {
                                await clearSavedChanges();
                            }
                        } else {
                            // Different file or different data - automatically clear old saved changes
                            await clearSavedChanges();
                        }
                    } else {
                        // No saved changes in DB
                        setHasSavedChanges(false);
                        setSavedChangesCount(0);
                    }
                    
                    setLoadingMessage('Building row index...');
                    setLoadingProgress(80);
                    
                    // Build the row map for the new data
                    // Add _originalIndex to each row to ensure uniqueness in row ID generation
                    const rowMap = new Map();
                    parsedData.forEach((row, index) => {
                        row._originalIndex = index;
                        const rowId = getRowId(row);
                        rowMap.set(rowId, { ...row });
                    });
                    
                    console.log('File loaded:', parsedData.length, 'rows');
                    
                    setOriginalFileName(file.name);
                    setSelectedItems(new Set());
                    
                    setLoadingMessage('Finalizing...');
                    setLoadingProgress(90);
                    
                    // Apply saved changes if user confirmed, otherwise set fresh data
                    if (shouldApplySavedChanges) {
                        console.log('Applying saved changes');
                        await applySavedChanges(parsedData, rowMap);
                    } else {
                        // Set fresh data - no saved changes to apply
                        setData(parsedData);
                        setOriginalRowMap(rowMap);
                        setHasSavedChanges(false);
                        setSavedChangesCount(0);
                    }
                    
                    setLoadingProgress(100);
                } catch (error) {
                    console.error('Error loading file:', error);
                    alert('Error loading file. Please check the file format.');
                } finally {
                    // Clear loading flag after state is updated
                    setTimeout(() => {
                        isLoadingFile.current = false;
                        setIsLoading(false);
                        setLoadingMessage('');
                        setLoadingProgress(null);
                    }, 100);
                }
            };

            const downloadCSV = () => {
                const csv = Papa.unparse(data);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'amazon-ppc-export.csv';
                a.click();
            };

            const downloadChanges = () => {
                if (changes.length === 0) {
                    alert('No changes to export');
                    return;
                }
                
                // Prepare data in Amazon bulksheet format
                const exportData = prepareAmazonBulksheet(changes, originalRowMap);
                
                // Use Papa.unparse with column ordering
                const csv = Papa.unparse(exportData, {
                    columns: AMAZON_BULKSHEET_CONFIG.allColumns.filter(col => 
                        !AMAZON_BULKSHEET_CONFIG.excludeColumns.includes(col)
                    )
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'amazon-ppc-bulksheet-upload.csv';
                a.click();
            };

            const updateRow = (row, field, value) => {
                let newData = [...data];
                
                // Find the actual index in the full data array using row identity
                const actualIndex = newData.findIndex(r => 
                    r.Entity === row.Entity &&
                    r['Campaign ID'] === row['Campaign ID'] &&
                    r['Ad Group ID'] === row['Ad Group ID'] &&
                    r['Keyword ID'] === row['Keyword ID'] &&
                    r['Ad ID'] === row['Ad ID'] &&
                    r['Product Targeting ID'] === row['Product Targeting ID']
                );
                
                if (actualIndex === -1) return; // Row not found
                
                // Handle Campaign Name updates
                if (field === 'Campaign Name') {
                    const campaignId = row['Campaign ID'];
                    const oldCampaignName = getCampaignName(row);
                    
                    // Find the actual Campaign entity
                    const campaignIndex = newData.findIndex(r => 
                        r.Entity === 'Campaign' && r['Campaign ID'] === campaignId
                    );
                    
                    if (campaignIndex !== -1) {
                        // Update the Campaign entity
                        newData[campaignIndex] = {
                            ...newData[campaignIndex],
                            'Campaign Name': value,
                            'Campaign Name (Informational only)': value
                        };
                    }
                    
                    // Update both fields on ALL child rows (won't trigger change detection)
                    newData = newData.map((r, i) => {
                        if (r['Campaign ID'] === campaignId && i !== campaignIndex) {
                            return {
                                ...r,
                                'Campaign Name': value,
                                'Campaign Name (Informational only)': value
                            };
                        }
                        return r;
                    });
                    
                    // Update column filters to include the new name
                    if (columnFilters['Campaign Name'] && oldCampaignName !== value) {
                        const newFilters = { ...columnFilters };
                        if (newFilters['Campaign Name'].has(oldCampaignName)) {
                            newFilters['Campaign Name'].delete(oldCampaignName);
                            newFilters['Campaign Name'].add(value);
                            setColumnFilters(newFilters);
                        }
                    }
                    
                } else if (field === 'Ad Group Name') {
                    const adGroupId = row['Ad Group ID'];
                    const oldAdGroupName = getAdGroupName(row);
                    
                    // Find the actual Ad Group entity
                    const adGroupIndex = newData.findIndex(r => 
                        r.Entity === 'Ad Group' && r['Ad Group ID'] === adGroupId
                    );
                    
                    if (adGroupIndex !== -1) {
                        // Update the Ad Group entity
                        newData[adGroupIndex] = {
                            ...newData[adGroupIndex],
                            'Ad Group Name': value,
                            'Ad Group Name (Informational only)': value
                        };
                    }
                    
                    // Update both fields on ALL child rows (won't trigger change detection)
                    newData = newData.map((r, i) => {
                        if (r['Ad Group ID'] === adGroupId && i !== adGroupIndex) {
                            return {
                                ...r,
                                'Ad Group Name': value,
                                'Ad Group Name (Informational only)': value
                            };
                        }
                        return r;
                    });
                    
                    // Update column filters to include the new name
                    if (columnFilters['Ad Group Name'] && oldAdGroupName !== value) {
                        const newFilters = { ...columnFilters };
                        if (newFilters['Ad Group Name'].has(oldAdGroupName)) {
                            newFilters['Ad Group Name'].delete(oldAdGroupName);
                            newFilters['Ad Group Name'].add(value);
                            setColumnFilters(newFilters);
                        }
                    }
                    
                } else {
                    // For all other fields, update the actual row
                    newData[actualIndex] = { ...newData[actualIndex], [field]: value };
                }
                
                setData(newData);
            };

            const toggleSelection = useCallback((index) => {
                setSelectedItems(prevSelected => {
                    const newSelected = new Set(prevSelected);
                    if (newSelected.has(index)) {
                        newSelected.delete(index);
                    } else {
                        newSelected.add(index);
                    }
                    return newSelected;
                });
            }, []);

            const selectAll = useCallback(() => {
                const filtered = filteredData; // Use memoized filteredData directly
                // PERFORMANCE: Use the pre-computed index map for O(1) lookups instead of O(n) indexOf
                const filteredIndices = filtered.map(item => getDataIndex(item)).filter(i => i !== -1);
                
                setSelectedItems(prevSelected => {
                    // Check if all filtered items are currently selected
                    const allSelected = filteredIndices.every(index => prevSelected.has(index));
                    
                    const newSelected = new Set(prevSelected);
                    if (allSelected) {
                        // Deselect all filtered items
                        filteredIndices.forEach(index => newSelected.delete(index));
                    } else {
                        // Select all filtered items
                        filteredIndices.forEach(index => newSelected.add(index));
                    }
                    return newSelected;
                });
            }, [filteredData, getDataIndex]);

            const executeFindReplace = () => {
                const { findText, replaceText, matchCase, selectedColumns } = findReplaceSettings;
                
                if (!findText) {
                    alert('Please enter text to find');
                    return;
                }
                
                let replacementCount = 0;
                const newData = data.map(row => {
                    const newRow = { ...row };
                    let rowModified = false;
                    
                    selectedColumns.forEach(column => {
                        const currentValue = row[column];
                        if (currentValue && typeof currentValue === 'string') {
                            let newValue;
                            if (matchCase) {
                                newValue = currentValue.split(findText).join(replaceText);
                            } else {
                                const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                                newValue = currentValue.replace(regex, replaceText);
                            }
                            
                            if (newValue !== currentValue) {
                                newRow[column] = newValue;
                                
                                // Also update the informational-only version if it exists
                                const infoColumn = column + ' (Informational only)';
                                if (row[infoColumn]) {
                                    newRow[infoColumn] = newValue;
                                }
                                
                                rowModified = true;
                                replacementCount++;
                            }
                        }
                    });
                    
                    return rowModified ? newRow : row;
                });
                
                if (replacementCount > 0) {
                    setData(newData);
                    alert(`Replaced ${replacementCount} occurrence(s) across ${selectedColumns.join(', ')}`);
                    setShowFindReplaceModal(false);
                } else {
                    alert('No matches found');
                }
            };

            const bulkUpdateState = (state) => {
                const newData = [...data];
                selectedItems.forEach(index => {
                    newData[index] = { ...newData[index], State: state };
                });
                setData(newData);
            };

            const deleteSelected = () => {
                if (!confirm(`Delete ${selectedItems.size} items?`)) return;
                const newData = data.filter((_, index) => !selectedItems.has(index));
                setData(newData);
                setSelectedItems(new Set());
            };

            const undoSelected = () => {
                if (!confirm(`Undo changes for ${selectedItems.size} selected items?`)) return;
                
                const newData = [...data];
                const selectedArray = Array.from(selectedItems);
                
                // Sort in reverse order to handle deletions correctly
                selectedArray.sort((a, b) => b - a);
                
                selectedArray.forEach(index => {
                    const row = data[index];
                    const rowId = getRowId(row);
                    const original = originalRowMap.get(rowId);
                    
                    if (!original) {
                        // This is a new item, mark it for removal
                        newData[index] = null;
                    } else {
                        // This is a modified item, revert to original
                        newData[index] = { ...original };
                    }
                });
                
                // Filter out null entries (removed new items)
                const filteredData = newData.filter(item => item !== null);
                setData(filteredData);
                setSelectedItems(new Set());
            };

            const addNewItems = (newItems) => {
                setData([...data, ...newItems]);
            };

            const undoChange = (row) => {
                // Find the actual index in the data array
                const rowId = getRowId(row);
                const actualIndex = data.findIndex(r => getRowId(r) === rowId);
                
                if (actualIndex === -1) return; // Row not found
                
                const original = originalRowMap.get(rowId);
                
                if (!original) {
                    // This is a new item, remove it entirely
                    const newData = data.filter((_, i) => i !== actualIndex);
                    setData(newData);
                } else {
                    // This is a modified item, revert to original
                    const newData = [...data];
                    newData[actualIndex] = { ...original };
                    setData(newData);
                }
                
                // Remove from selected items if it was selected
                const newSelected = new Set(selectedItems);
                newSelected.delete(actualIndex);
                setSelectedItems(newSelected);
            };

            const undoAllChanges = async () => {
                if (!confirm(`Undo all ${changes.length} changes? This will revert all modifications and remove all new items.`)) return;
                
                // Revert all modified items and remove all new items
                const newData = data.filter(row => {
                    const rowId = getRowId(row);
                    return originalRowMap.has(rowId);
                }).map(row => {
                    const rowId = getRowId(row);
                    const original = originalRowMap.get(rowId);
                    return { ...original };
                });
                
                setData(newData);
                setSelectedItems(new Set());
                
                // Also clear any saved changes from storage
                await clearSavedChanges();
            };

            // Listen for keywords added from ad group dropdown
            useEffect(() => {
                const handleAddKeywords = (event) => {
                    if (event.detail) {
                        addNewItems(event.detail);
                    }
                };
                
                window.addEventListener('addKeywords', handleAddKeywords);
                return () => window.removeEventListener('addKeywords', handleAddKeywords);
            }, [data]);

            // PERFORMANCE: Memoized filtered data with debounced search
            const filteredData = useMemo(() => {
                let filtered = data;

                // Filter by tab
                switch (activeTab) {
                    case 'campaigns':
                        filtered = filtered.filter(r => r.Entity === 'Campaign');
                        break;
                    case 'adgroups':
                        filtered = filtered.filter(r => r.Entity === 'Ad Group');
                        break;
                    case 'products':
                        filtered = filtered.filter(r => r.Entity === 'Product Ad');
                        break;
                    case 'keywords':
                        filtered = filtered.filter(r => r.Entity === 'Keyword');
                        break;
                    case 'targeting':
                        filtered = filtered.filter(r => r.Entity === 'Product Targeting');
                        break;
                    case 'negative':
                        filtered = filtered.filter(r => r.Entity === 'Negative Keyword' || r.Entity === 'Campaign Negative Keyword');
                        break;
                    case 'changes':
                        filtered = changes;
                        break;
                    case 'coverage':
                        // Coverage tab handles its own filtering - return all data
                        return data;
                }

                // Filter by status (NEW, MODIFIED, UNCHANGED)
                if (statusFilterValue !== 'all') {
                    filtered = filtered.filter(row => {
                        const rowId = getRowId(row);
                        const isNew = !originalRowMap.has(rowId);
                        const original = originalRowMap.get(rowId);
                        const isModified = original && hasRowChanged(original, row);
                        
                        if (statusFilterValue === 'new') return isNew;
                        if (statusFilterValue === 'modified') return isModified;
                        if (statusFilterValue === 'unchanged') return !isNew && !isModified;
                        return true;
                    });
                }

                // Filter by debounced search term for performance
                if (debouncedSearchTerm) {
                    const searchLower = debouncedSearchTerm.toLowerCase();
                    filtered = filtered.filter(row => {
                        return Object.values(row).some(val => 
                            String(val).toLowerCase().includes(searchLower)
                        );
                    });
                }

                // Apply column filters
                if (Object.keys(columnFilters).length > 0) {
                    filtered = filtered.filter(row => {
                        return Object.entries(columnFilters).every(([column, selectedValues]) => {
                            if (selectedValues.size === 0) return true;
                            
                            let rowValue;
                            // Check against CURRENT data (what user sees), not original
                            if (column === 'Portfolio Name') {
                                rowValue = getPortfolioName(row);
                            } else if (column === 'Campaign Name') {
                                rowValue = getCampaignName(row);
                            } else if (column === 'Ad Group Name') {
                                rowValue = getAdGroupName(row);
                            } else {
                                rowValue = row[column];
                            }
                            
                            return selectedValues.has(String(rowValue));
                        });
                    });
                }
                
                // Apply column sorting
                if (columnSort.column && columnSort.direction) {
                    filtered = [...filtered].sort((a, b) => {
                        const aVal = a[columnSort.column];
                        const bVal = b[columnSort.column];
                        
                        // Parse numeric values
                        const aNum = parseFloat(String(aVal).replace(/[,$%]/g, '')) || 0;
                        const bNum = parseFloat(String(bVal).replace(/[,$%]/g, '')) || 0;
                        
                        if (columnSort.direction === 'asc') {
                            return aNum - bNum;
                        } else {
                            return bNum - aNum;
                        }
                    });
                }

                return filtered;
            }, [data, activeTab, statusFilterValue, debouncedSearchTerm, columnFilters, columnSort, changes, originalRowMap]);
            
            // Wrapper function for backward compatibility
            const getFilteredData = () => filteredData;

            // Helper function to normalize keywords (replace + with spaces)
            const normalizeKeyword = (keyword) => {
                return keyword.trim().toLowerCase().replace(/\+/g, ' ').replace(/\s+/g, ' ');
            };

            // PERFORMANCE OPTIMIZATION: Pre-compute reference lists as Sets for O(1) lookup
            // These are memoized and only recomputed when the reference data changes
            const referenceKeywordSet = React.useMemo(() => {
                if (useTableMode && keywordTableData.length > 0) {
                    return new Set(
                        keywordTableData
                            .map(r => normalizeKeyword(r['Keyword'] || r[tableColumns[0]] || ''))
                            .filter(k => k)
                    );
                }
                if (referenceKeywords) {
                    return new Set(
                        referenceKeywords.split('\n')
                            .map(k => {
                                const parts = k.split('\t');
                                return normalizeKeyword(parts[0]);
                            })
                            .filter(k => k)
                    );
                }
                return new Set();
            }, [useTableMode, keywordTableData, referenceKeywords, tableColumns]);

            const referenceProductSet = React.useMemo(() => {
                if (referenceProducts) {
                    return new Set(
                        referenceProducts.split('\n')
                            .map(p => p.trim().toUpperCase())
                            .filter(p => p)
                    );
                }
                return new Set();
            }, [referenceProducts]);

            // PERFORMANCE: Pre-compute a Map of normalized keywords -> matching data rows
            // This turns O(n) lookups into O(1) for each keyword check
            const keywordDataMap = React.useMemo(() => {
                const map = new Map();
                data.forEach(row => {
                    if (row.Entity === 'Keyword') {
                        const normalized = normalizeKeyword(row['Keyword Text'] || '');
                        if (!map.has(normalized)) {
                            map.set(normalized, []);
                        }
                        map.get(normalized).push(row);
                    }
                });
                return map;
            }, [data]);

            // PERFORMANCE: Pre-compute reference list membership for ALL rows
            // This is memoized and only recalculated when dependencies change
            const referenceListMembership = React.useMemo(() => {
                if (!showReferencePanel) return new Map(); // Skip if panel is closed
                
                const membership = new Map();
                data.forEach((row, index) => {
                    // Filter by portfolio if one is selected
                    if (referencePortfolio && getPortfolioName(row) !== referencePortfolio) {
                        membership.set(index, false);
                        return;
                    }
                    
                    if (row.Entity === 'Keyword') {
                        const keyword = normalizeKeyword(row['Keyword Text'] || '');
                        membership.set(index, referenceKeywordSet.has(keyword));
                        return;
                    }
                    
                    if ((row.Entity === 'Product Ad' || row.Entity === 'Product Targeting') && referenceProductSet.size > 0) {
                        const sku = (row.SKU || '').toUpperCase();
                        const asin = (row['ASIN (Informational only)'] || '').toUpperCase();
                        const targeting = (row['Product Targeting Expression'] || '').toUpperCase();
                        
                        if (referenceProductSet.has(sku) || referenceProductSet.has(asin)) {
                            membership.set(index, true);
                            return;
                        }
                        
                        // Check if any reference product is in the targeting expression
                        for (const ref of referenceProductSet) {
                            if (targeting.includes(ref)) {
                                membership.set(index, true);
                                return;
                            }
                        }
                    }
                    
                    membership.set(index, false);
                });
                return membership;
            }, [data, showReferencePanel, referencePortfolio, referenceKeywordSet, referenceProductSet]);

            // OPTIMIZED: Check if an item is in the reference list using pre-computed membership
            const isInReferenceList = useCallback((row) => {
                if (!showReferencePanel) return false;
                const index = dataIndexMap.get(row);
                return index !== undefined ? referenceListMembership.get(index) || false : false;
            }, [showReferencePanel, dataIndexMap, referenceListMembership]);

            // Get list of unique portfolios
            const getPortfolioList = () => {
                const portfolios = new Set();
                data.forEach(row => {
                    const portfolio = getPortfolioName(row);
                    if (portfolio && portfolio !== '-') {
                        portfolios.add(portfolio);
                    }
                });
                return Array.from(portfolios).sort();
            };

            // PERFORMANCE OPTIMIZATION: Create lookup maps for O(1) campaign and ad group access
            // These are memoized and only rebuilt when data changes
            const campaignMap = React.useMemo(() => {
                const map = new Map();
                data.forEach(row => {
                    if (row.Entity === 'Campaign' && row['Campaign ID']) {
                        map.set(row['Campaign ID'], row);
                    }
                });
                return map;
            }, [data]);

            const adGroupMap = React.useMemo(() => {
                const map = new Map();
                data.forEach(row => {
                    if (row.Entity === 'Ad Group' && row['Campaign ID'] && row['Ad Group ID']) {
                        const key = `${row['Campaign ID']}_${row['Ad Group ID']}`;
                        map.set(key, row);
                    }
                });
                return map;
            }, [data]);

            // Check keyword status (exists in campaigns or not)
            // PERFORMANCE: Memoized to prevent recalculation on every render
            const getKeywordStatus = useMemo(() => {
                // Use table data if in table mode
                if (useTableMode && keywordTableData.length > 0) {
                    return keywordTableData.map(row => {
                        const keyword = row['Keyword'] || row[tableColumns[0]] || '';
                        const normalizedKeyword = normalizeKeyword(keyword);
                        const metadata = {};
                        
                        // Store all columns except Keyword as metadata
                        tableColumns.forEach((col, idx) => {
                            if (idx > 0) {
                                metadata[col] = row[col] || '';
                            }
                        });
                        
                        // PERFORMANCE: Use pre-computed map instead of filtering all data
                        let existing = keywordDataMap.get(normalizedKeyword) || [];
                        
                        // Apply portfolio filter if needed
                        if (referencePortfolio && existing.length > 0) {
                            existing = existing.filter(rowData => getPortfolioName(rowData) === referencePortfolio);
                        }
                        
                        // Get ALL match types (including paused) for display purposes
                        const allMatchTypes = [...new Set(existing.map(e => e['Match Type']))].filter(Boolean);
                        
                        // Check if keywords are truly active (keyword, campaign, and ad group all enabled)
                        const enabledKeywords = existing.filter(e => {
                            const keywordEnabled = (e.State || '').toLowerCase() === 'enabled';
                            if (!keywordEnabled) return false;
                            
                            // Check campaign state using map lookup (O(1) instead of O(n))
                            const campaignRow = campaignMap.get(e['Campaign ID']);
                            const campaignEnabled = !campaignRow || (campaignRow.State || '').toLowerCase() === 'enabled';
                            
                            // Check ad group state using map lookup (O(1) instead of O(n))
                            const adGroupKey = `${e['Campaign ID']}_${e['Ad Group ID']}`;
                            const adGroupRow = adGroupMap.get(adGroupKey);
                            const adGroupEnabled = !adGroupRow || (adGroupRow.State || '').toLowerCase() === 'enabled';
                            
                            return campaignEnabled && adGroupEnabled;
                        });
                        
                        // FIXED: Only count match types from ENABLED keywords for filtering purposes
                        const activeMatchTypes = [...new Set(enabledKeywords.map(e => e['Match Type']))].filter(Boolean);
                        
                        const pausedKeywords = existing.filter(e => {
                            const keywordPaused = (e.State || '').toLowerCase() === 'paused';
                            
                            // Check campaign state using map lookup (O(1) instead of O(n))
                            const campaignRow = campaignMap.get(e['Campaign ID']);
                            const campaignPaused = campaignRow && (campaignRow.State || '').toLowerCase() === 'paused';
                            
                            // Check ad group state using map lookup (O(1) instead of O(n))
                            const adGroupKey = `${e['Campaign ID']}_${e['Ad Group ID']}`;
                            const adGroupRow = adGroupMap.get(adGroupKey);
                            const adGroupPaused = adGroupRow && (adGroupRow.State || '').toLowerCase() === 'paused';
                            
                            // Keyword is effectively paused if any component is paused
                            return keywordPaused || campaignPaused || adGroupPaused;
                        });
                        
                        return {
                            keyword: keyword,
                            exists: existing.length > 0,
                            count: existing.length,
                            matchTypes: activeMatchTypes,  // FIXED: Use only enabled keywords for filtering
                            allMatchTypes: allMatchTypes,  // Keep all match types for display
                            metadata: metadata,
                            hasMetadata: tableColumns.length > 1,
                            enabledCount: enabledKeywords.length,
                            pausedCount: pausedKeywords.length,
                            isPaused: pausedKeywords.length > 0 && enabledKeywords.length === 0,
                            hasEnabledAndPaused: enabledKeywords.length > 0 && pausedKeywords.length > 0,
                            locations: existing.map(e => {
                                // Get campaign state using map lookup (O(1) instead of O(n))
                                const campaignRow = campaignMap.get(e['Campaign ID']);
                                const campaignState = campaignRow ? (campaignRow.State || '').toLowerCase() : 'unknown';
                                
                                // Get ad group state using map lookup (O(1) instead of O(n))
                                const adGroupKey = `${e['Campaign ID']}_${e['Ad Group ID']}`;
                                const adGroupRow = adGroupMap.get(adGroupKey);
                                const adGroupState = adGroupRow ? (adGroupRow.State || '').toLowerCase() : 'unknown';
                                
                                const keywordState = (e.State || '').toLowerCase();
                                
                                // Determine effective state
                                let effectiveState = 'enabled';
                                let pauseReason = '';
                                
                                if (keywordState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'keyword paused';
                                } else if (campaignState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'campaign paused';
                                } else if (adGroupState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'ad group paused';
                                }
                                
                                return {
                                    campaign: getCampaignName(e),
                                    adGroup: getAdGroupName(e),
                                    matchType: e['Match Type'],
                                    state: effectiveState,
                                    keywordState: keywordState,
                                    campaignState: campaignState,
                                    adGroupState: adGroupState,
                                    pauseReason: pauseReason
                                };
                            })
                        };
                    });
                }
                
                // Original text mode logic
                const lines = referenceKeywords.split('\n')
                    .map(k => k.trim())
                    .filter(k => k);
                
                // Detect if data has tabs (multi-column format from Google Sheets)
                const hasMultipleColumns = lines.some(line => line.includes('\t'));
                
                
                if (hasMultipleColumns) {
                    // Parse tab-separated data
                    const rows = lines.map(line => line.split('\t'));
                    
                    // First row might be headers, check if it looks like headers
                    const firstRow = rows[0];
                    const isHeaderRow = firstRow.some(cell => 
                        cell && /^[A-Za-z\s]+$/.test(cell) && !data.some(d => 
                            d.Entity === 'Keyword' && 
                            normalizeKeyword(d['Keyword Text'] || '') === normalizeKeyword(cell)
                        )
                    );
                    
                    const headers = isHeaderRow ? firstRow : ['Keyword', ...Array(firstRow.length - 1).fill('').map((_, i) => `Column ${i + 2}`)];
                    const dataRows = isHeaderRow ? rows.slice(1) : rows;
                    
                    return dataRows.map(row => {
                        const keyword = row[0] || '';
                        const normalizedKeyword = normalizeKeyword(keyword);
                        const metadata = {};
                        
                        // Store additional columns as metadata
                        for (let i = 1; i < row.length; i++) {
                            metadata[headers[i] || `Column ${i + 1}`] = row[i] || '';
                        }
                        
                        // PERFORMANCE: Use pre-computed map instead of filtering all data
                        let existing = keywordDataMap.get(normalizedKeyword) || [];
                        
                        // Apply portfolio filter if needed
                        if (referencePortfolio && existing.length > 0) {
                            existing = existing.filter(rowData => getPortfolioName(rowData) === referencePortfolio);
                        }
                        
                        // Get ALL unique match types (including paused) for display purposes
                        const allMatchTypes = [...new Set(existing.map(e => e['Match Type']))].filter(Boolean);
                        
                        // Check if keywords are truly active (keyword, campaign, and ad group all enabled)
                        const enabledKeywords = existing.filter(e => {
                            const keywordEnabled = (e.State || '').toLowerCase() === 'enabled';
                            if (!keywordEnabled) return false;
                            
                            const campaignRow = campaignMap.get(e['Campaign ID']);
                            const campaignEnabled = !campaignRow || (campaignRow.State || '').toLowerCase() === 'enabled';
                            
                            const adGroupKey = `${e['Campaign ID']}_${e['Ad Group ID']}`;
                            const adGroupRow = adGroupMap.get(adGroupKey);
                            const adGroupEnabled = !adGroupRow || (adGroupRow.State || '').toLowerCase() === 'enabled';
                            
                            return campaignEnabled && adGroupEnabled;
                        });
                        
                        // FIXED: Only count match types from ENABLED keywords for filtering purposes
                        const activeMatchTypes = [...new Set(enabledKeywords.map(e => e['Match Type']))].filter(Boolean);
                        
                        const pausedKeywords = existing.filter(e => {
                            const keywordPaused = (e.State || '').toLowerCase() === 'paused';
                            const campaignRow = campaignMap.get(e['Campaign ID']);
                            const campaignPaused = campaignRow && (campaignRow.State || '').toLowerCase() === 'paused';
                            const adGroupKey = `${e['Campaign ID']}_${e['Ad Group ID']}`;
                            const adGroupRow = adGroupMap.get(adGroupKey);
                            const adGroupPaused = adGroupRow && (adGroupRow.State || '').toLowerCase() === 'paused';
                            
                            return keywordPaused || campaignPaused || adGroupPaused;
                        });
                        
                        return {
                            keyword: keyword,
                            exists: existing.length > 0,
                            count: existing.length,
                            matchTypes: activeMatchTypes,  // FIXED: Use only enabled keywords for filtering
                            allMatchTypes: allMatchTypes,  // Keep all match types for display
                            metadata: metadata,
                            hasMetadata: true,
                            enabledCount: enabledKeywords.length,
                            pausedCount: pausedKeywords.length,
                            isPaused: pausedKeywords.length > 0 && enabledKeywords.length === 0,
                            hasEnabledAndPaused: enabledKeywords.length > 0 && pausedKeywords.length > 0,
                            locations: existing.map(e => {
                                const campaignRow = campaignMap.get(e['Campaign ID']);
                                const campaignState = campaignRow ? (campaignRow.State || '').toLowerCase() : 'unknown';
                                const adGroupKey = `${e['Campaign ID']}_${e['Ad Group ID']}`;
                                const adGroupRow = adGroupMap.get(adGroupKey);
                                const adGroupState = adGroupRow ? (adGroupRow.State || '').toLowerCase() : 'unknown';
                                const keywordState = (e.State || '').toLowerCase();
                                
                                let effectiveState = 'enabled';
                                let pauseReason = '';
                                
                                if (keywordState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'keyword paused';
                                } else if (campaignState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'campaign paused';
                                } else if (adGroupState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'ad group paused';
                                }
                                
                                return {
                                    campaign: getCampaignName(e),
                                    adGroup: getAdGroupName(e),
                                    matchType: e['Match Type'],
                                    state: effectiveState,
                                    keywordState: keywordState,
                                    campaignState: campaignState,
                                    adGroupState: adGroupState,
                                    pauseReason: pauseReason
                                };
                            })
                        };
                    });
                } else {
                    // Simple single-column format
                    return lines.map(keyword => {
                        const normalizedKeyword = normalizeKeyword(keyword);
                        
                        // PERFORMANCE: Use pre-computed map instead of filtering all data
                        let existing = keywordDataMap.get(normalizedKeyword) || [];
                        
                        // Apply portfolio filter if needed
                        if (referencePortfolio && existing.length > 0) {
                            existing = existing.filter(row => getPortfolioName(row) === referencePortfolio);
                        }
                        
                        // Get ALL unique match types (including paused) for display purposes
                        const allMatchTypes = [...new Set(existing.map(e => e['Match Type']))].filter(Boolean);
                        
                        // Check if keywords are truly active (keyword, campaign, and ad group all enabled)
                        const enabledKeywords = existing.filter(e => {
                            const keywordEnabled = (e.State || '').toLowerCase() === 'enabled';
                            if (!keywordEnabled) return false;
                            
                            const campaignRow = campaignMap.get(e['Campaign ID']);
                            const campaignEnabled = !campaignRow || (campaignRow.State || '').toLowerCase() === 'enabled';
                            
                            const adGroupKey = `${e['Campaign ID']}_${e['Ad Group ID']}`;
                            const adGroupRow = adGroupMap.get(adGroupKey);
                            const adGroupEnabled = !adGroupRow || (adGroupRow.State || '').toLowerCase() === 'enabled';
                            
                            return campaignEnabled && adGroupEnabled;
                        });
                        
                        // FIXED: Only count match types from ENABLED keywords for filtering purposes
                        const activeMatchTypes = [...new Set(enabledKeywords.map(e => e['Match Type']))].filter(Boolean);
                        
                        const pausedKeywords = existing.filter(e => {
                            const keywordPaused = (e.State || '').toLowerCase() === 'paused';
                            const campaignRow = campaignMap.get(e['Campaign ID']);
                            const campaignPaused = campaignRow && (campaignRow.State || '').toLowerCase() === 'paused';
                            const adGroupKey = `${e['Campaign ID']}_${e['Ad Group ID']}`;
                            const adGroupRow = adGroupMap.get(adGroupKey);
                            const adGroupPaused = adGroupRow && (adGroupRow.State || '').toLowerCase() === 'paused';
                            
                            return keywordPaused || campaignPaused || adGroupPaused;
                        });
                        
                        return {
                            keyword: keyword,
                            exists: existing.length > 0,
                            count: existing.length,
                            matchTypes: activeMatchTypes,  // FIXED: Use only enabled keywords for filtering
                            allMatchTypes: allMatchTypes,  // Keep all match types for display
                            hasMetadata: false,
                            enabledCount: enabledKeywords.length,
                            pausedCount: pausedKeywords.length,
                            isPaused: pausedKeywords.length > 0 && enabledKeywords.length === 0,
                            hasEnabledAndPaused: enabledKeywords.length > 0 && pausedKeywords.length > 0,
                            locations: existing.map(e => {
                                const campaignRow = campaignMap.get(e['Campaign ID']);
                                const campaignState = campaignRow ? (campaignRow.State || '').toLowerCase() : 'unknown';
                                const adGroupKey = `${e['Campaign ID']}_${e['Ad Group ID']}`;
                                const adGroupRow = adGroupMap.get(adGroupKey);
                                const adGroupState = adGroupRow ? (adGroupRow.State || '').toLowerCase() : 'unknown';
                                const keywordState = (e.State || '').toLowerCase();
                                
                                let effectiveState = 'enabled';
                                let pauseReason = '';
                                
                                if (keywordState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'keyword paused';
                                } else if (campaignState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'campaign paused';
                                } else if (adGroupState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'ad group paused';
                                }
                                
                                return {
                                    campaign: getCampaignName(e),
                                    adGroup: getAdGroupName(e),
                                    matchType: e['Match Type'],
                                    state: effectiveState,
                                    keywordState: keywordState,
                                    campaignState: campaignState,
                                    adGroupState: adGroupState,
                                    pauseReason: pauseReason
                                };
                            })
                        };
                    });
                }
            }, [useTableMode, keywordTableData, tableColumns, keywordDataMap, referencePortfolio, referenceKeywords, campaignMap, adGroupMap]);

            // PERFORMANCE: Pre-compute a Map for product lookups
            const productDataMap = React.useMemo(() => {
                const map = new Map();
                data.forEach(row => {
                    if (row.Entity === 'Product Ad' || row.Entity === 'Product Targeting') {
                        const sku = (row.SKU || '').toUpperCase();
                        const asin = (row['ASIN (Informational only)'] || '').toUpperCase();
                        
                        // Index by SKU
                        if (sku) {
                            if (!map.has(sku)) map.set(sku, []);
                            map.get(sku).push(row);
                        }
                        // Index by ASIN
                        if (asin) {
                            if (!map.has(asin)) map.set(asin, []);
                            map.get(asin).push(row);
                        }
                    }
                });
                return map;
            }, [data]);

            // Check product status - MEMOIZED
            const getProductStatus = useMemo(() => {
                if (!referenceProducts.trim()) return [];
                
                const products = referenceProducts.split('\n')
                    .map(p => p.trim().toUpperCase())
                    .filter(p => p);
                
                return products.map(product => {
                    // PERFORMANCE: Use pre-computed map for direct matches
                    let existing = productDataMap.get(product) || [];
                    
                    // Also check for products in targeting expressions (still need to search for this)
                    if (existing.length === 0) {
                        existing = data.filter(row => {
                            if (referencePortfolio && getPortfolioName(row) !== referencePortfolio) return false;
                            if (row.Entity === 'Product Ad' || row.Entity === 'Product Targeting') {
                                const targeting = (row['Product Targeting Expression'] || '').toUpperCase();
                                return targeting.includes(product);
                            }
                            return false;
                        });
                    } else if (referencePortfolio) {
                        existing = existing.filter(row => getPortfolioName(row) === referencePortfolio);
                    }
                    
                    // Check if any products are paused vs enabled
                    const enabledProducts = existing.filter(e => (e.State || '').toLowerCase() === 'enabled');
                    const pausedProducts = existing.filter(e => (e.State || '').toLowerCase() === 'paused');
                    
                    return {
                        product: product,
                        exists: existing.length > 0,
                        count: existing.length,
                        enabledCount: enabledProducts.length,
                        pausedCount: pausedProducts.length,
                        isPaused: pausedProducts.length > 0 && enabledProducts.length === 0,
                        hasEnabledAndPaused: enabledProducts.length > 0 && pausedProducts.length > 0,
                        locations: existing.map(e => ({
                            campaign: getCampaignName(e),
                            adGroup: getAdGroupName(e),
                            type: e.Entity,
                            state: (e.State || '').toLowerCase()
                        }))
                    };
                });
            }, [referenceProducts, productDataMap, referencePortfolio, data]);

            // Get keywords for an ad group with root word analysis
            const getAdGroupKeywords = (adGroupId) => {
                const keywords = data.filter(r => 
                    r.Entity === 'Keyword' && r['Ad Group ID'] === adGroupId
                )
                // Sort by sales (highest to lowest)
                .sort((a, b) => {
                    const salesA = parseNumber(a.Sales);
                    const salesB = parseNumber(b.Sales);
                    return salesB - salesA;
                });

                // Get Product Targeting items
                const productTargets = data.filter(r => 
                    r.Entity === 'Product Targeting' && r['Ad Group ID'] === adGroupId
                )
                // Sort by sales (highest to lowest)
                .sort((a, b) => {
                    const salesA = parseNumber(a.Sales);
                    const salesB = parseNumber(b.Sales);
                    return salesB - salesA;
                });

                // Root word analysis (only for keywords)
                const rootMap = {};
                keywords.forEach(kw => {
                    const keywordText = (kw['Keyword Text'] || '').toLowerCase();
                    const words = keywordText.split(/\s+/);
                    
                    words.forEach(word => {
                        if (word.length > 2) {
                            if (!rootMap[word]) {
                                rootMap[word] = {
                                    root: word,
                                    count: 0,
                                    spend: 0,
                                    sales: 0,
                                    keywords: []
                                };
                            }
                            
                            rootMap[word].count++;
                            rootMap[word].spend += parseNumber(kw.Spend);
                            rootMap[word].sales += parseNumber(kw.Sales);
                            rootMap[word].keywords.push(keywordText);
                        }
                    });
                });

                const roots = Object.values(rootMap)
                    .map(root => ({
                        ...root,
                        acos: root.sales > 0 ? (root.spend / root.sales) * 100 : 0
                    }))
                    .sort((a, b) => b.spend - a.spend);

                return { keywords, productTargets, roots };
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Loading Overlay */}
                    {isLoading && (
                        <LoadingOverlay message={loadingMessage} progress={loadingProgress} />
                    )}
                    
                    {/* Header - Enhanced Design */}
                    <div className="bg-gradient-to-br from-slate-50 via-cyan-50 to-slate-50 shadow-sm sticky top-0 z-30 border-b border-cyan-100/50 overflow-visible">
                        <div className="max-w-[98%] mx-auto px-4 py-3 overflow-visible">
                            <div className="flex items-center justify-between mb-3 overflow-visible">
                                {/* Logo & Title */}
                                <div className="flex items-center gap-3">
                                    <div className="w-11 h-11 bg-gradient-to-br from-cyan-500 via-cyan-600 to-teal-600 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20 ring-2 ring-cyan-200/50">
                                        <span className="text-xl">üì¶</span>
                                    </div>
                                    <div>
                                        <h1 className="text-lg font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">Amazon PPC Manager</h1>
                                        <p className="text-xs text-gray-500 flex items-center gap-2">
                                            Bulk Campaign Editor
                                            {data.length > 0 && (
                                                <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-cyan-100 text-cyan-700 rounded-full text-[10px] font-medium">
                                                    {data.length.toLocaleString()} rows
                                                </span>
                                            )}
                                        </p>
                                    </div>
                                </div>
                                
                                {/* Action Buttons */}
                                <div className="flex items-center gap-2 overflow-visible">
                                    {/* Keyboard shortcut hint */}
                                    {data.length > 0 && (
                                        <div className="hidden lg:flex items-center gap-2 text-[10px] text-gray-400 mr-2">
                                            <span className="kbd">‚åò</span><span className="kbd">F</span> Search
                                            <span className="mx-1">¬∑</span>
                                            <span className="kbd">‚åò</span><span className="kbd">S</span> Export
                                        </div>
                                    )}
                                    
                                    {/* Import Dropdown */}
                                    <Dropdown
                                        trigger={
                                            <button className="h-9 px-4 bg-white border border-gray-200 hover:border-cyan-300 hover:bg-cyan-50 text-gray-700 rounded-lg text-sm font-medium flex items-center gap-2 transition-all duration-200 shadow-sm hover:shadow">
                                                <span>üìÇ</span> Import
                                                <svg className="w-3 h-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                                </svg>
                                            </button>
                                        }
                                    >
                                        <div className="bg-white rounded-xl shadow-xl border border-gray-100 py-2" style={{ width: '280px', minWidth: '280px' }}>
                                            <label className="block px-3 py-2.5 text-left text-gray-700 hover:bg-cyan-50 cursor-pointer rounded-lg mx-1 transition-colors">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-9 h-9 bg-cyan-100 rounded-lg flex items-center justify-center">
                                                        <span className="text-base">üìÑ</span>
                                                    </div>
                                                    <div>
                                                        <div className="font-medium text-sm">Upload CSV</div>
                                                        <div className="text-xs text-gray-500">Import bulksheet data</div>
                                                    </div>
                                                </div>
                                                <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                                            </label>
                                            <label className="block px-3 py-2.5 text-left text-gray-700 hover:bg-cyan-50 cursor-pointer rounded-lg mx-1 transition-colors">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-9 h-9 bg-purple-100 rounded-lg flex items-center justify-center">
                                                        <span className="text-base">üìÇ</span>
                                                    </div>
                                                    <div>
                                                        <div className="font-medium text-sm">Load Changes</div>
                                                        <div className="text-xs text-gray-500">Resume saved work</div>
                                                    </div>
                                                </div>
                                                <input type="file" accept=".json" onChange={uploadChangesFile} className="hidden" />
                                            </label>
                                        </div>
                                    </Dropdown>
                                    
                                    {data.length > 0 && (
                                        <>
                                            {/* Export Dropdown */}
                                            <Dropdown
                                                align="right"
                                                trigger={
                                                    <button className={`h-9 px-4 rounded-lg text-sm font-medium flex items-center gap-2 transition-all duration-200 ${
                                                        changes.length > 0 
                                                            ? 'bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white shadow-lg shadow-emerald-500/25 hover:shadow-emerald-500/40' 
                                                            : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                                    }`}>
                                                        <span>üì•</span> Export
                                                        {changes.length > 0 && (
                                                            <span className="bg-white/25 px-2 py-0.5 rounded-md text-xs font-bold">{changes.length}</span>
                                                        )}
                                                        <svg className="w-3 h-3 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                                        </svg>
                                                    </button>
                                                }
                                            >
                                                <div className="bg-white rounded-xl shadow-xl border border-gray-100 py-2 w-64">
                                                    <button 
                                                        onClick={downloadChanges}
                                                        disabled={changes.length === 0}
                                                        className={`w-full px-4 py-3 text-left flex items-center justify-between rounded-lg mx-1 w-[calc(100%-8px)] ${
                                                            changes.length > 0 ? 'hover:bg-emerald-50' : 'opacity-50 cursor-not-allowed'
                                                        }`}
                                                    >
                                                        <span className="flex items-center gap-3">
                                                            <span className="text-lg">üìä</span>
                                                            <div>
                                                                <div className="font-medium text-gray-700">Amazon Bulksheet</div>
                                                                <div className="text-xs text-gray-500">Ready to upload</div>
                                                            </div>
                                                        </span>
                                                        {changes.length > 0 && (
                                                            <span className="text-emerald-600 text-xs bg-emerald-100 px-2 py-1 rounded-full font-bold">{changes.length}</span>
                                                        )}
                                                    </button>
                                                    <button 
                                                        onClick={downloadCSV}
                                                        className="w-full px-4 py-2.5 text-left text-gray-700 hover:bg-gray-50 text-sm rounded-lg mx-1 w-[calc(100%-8px)] flex items-center gap-3"
                                                    >
                                                        <span className="text-lg">üíæ</span>
                                                        <div>
                                                            <div className="font-medium">Download All</div>
                                                            <div className="text-xs text-gray-500">Complete dataset</div>
                                                        </div>
                                                    </button>
                                                    <div className="border-t border-gray-100 my-2 mx-3"></div>
                                                    <button 
                                                        onClick={downloadChangesFile}
                                                        disabled={!hasSavedChanges}
                                                        className={`w-full px-4 py-2.5 text-left text-sm rounded-lg mx-1 w-[calc(100%-8px)] flex items-center gap-3 ${
                                                            hasSavedChanges ? 'text-gray-700 hover:bg-purple-50' : 'text-gray-400 cursor-not-allowed'
                                                        }`}
                                                    >
                                                        <span className="text-lg">üíæ</span>
                                                        <div>
                                                            <div className="font-medium">Save Changes</div>
                                                            <div className="text-xs text-gray-500">Backup your work</div>
                                                        </div>
                                                    </button>
                                                </div>
                                            </Dropdown>
                                            
                                            {/* Tools Dropdown */}
                                            <Dropdown
                                                align="right"
                                                trigger={
                                                    <button className={`h-10 px-4 rounded-full text-sm font-medium flex items-center gap-2 transition shadow-sm ${
                                                        showReferencePanel 
                                                            ? 'bg-orange-500 text-white hover:bg-orange-600' 
                                                            : 'bg-white border border-gray-200 text-gray-700 hover:border-gray-300 hover:bg-gray-50'
                                                    }`}>
                                                        <span>üõ†Ô∏è</span> Tools
                                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                                        </svg>
                                                    </button>
                                                }
                                            >
                                                <div className="bg-white rounded-2xl shadow-xl border py-2 w-56">
                                                    <button 
                                                        onClick={() => setShowReferencePanel(!showReferencePanel)}
                                                        className={`w-full px-4 py-2.5 text-left text-sm flex items-center gap-3 ${
                                                            showReferencePanel ? 'bg-orange-50 text-orange-700' : 'text-gray-700 hover:bg-orange-50'
                                                        }`}
                                                    >
                                                        <span className="text-orange-500 text-lg">üéØ</span>
                                                        <div>
                                                            <div className="font-medium">Target Checker</div>
                                                            <div className="text-xs text-gray-500">Verify keywords & ASINs</div>
                                                        </div>
                                                        {showReferencePanel && <span className="ml-auto text-orange-500">‚úì</span>}
                                                    </button>
                                                    <button 
                                                        onClick={() => setShowFindReplaceModal(true)}
                                                        className="w-full px-4 py-2.5 text-left text-gray-700 hover:bg-blue-50 text-sm flex items-center gap-3"
                                                    >
                                                        <span className="text-blue-500 text-lg">üîç</span>
                                                        <div>
                                                            <div className="font-medium">Find & Replace</div>
                                                            <div className="text-xs text-gray-500">Bulk text edits</div>
                                                        </div>
                                                    </button>
                                                </div>
                                            </Dropdown>
                                            
                                            {/* Auto-save indicator */}
                                            {hasSavedChanges && (
                                                <div className="flex items-center gap-1.5 px-3 py-2 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium border border-emerald-200">
                                                    <span className="animate-pulse text-emerald-500">‚óè</span>
                                                    <span>{savedChangesCount} saved</span>
                                                </div>
                                            )}
                                        </>
                                    )}
                                </div>
                            </div>
                            
                            {/* Pill Navigation Tabs */}
                            {data.length > 0 && (
                                <div className="bg-white rounded-full p-1.5 shadow-sm border border-gray-200 flex items-center gap-1 w-fit">
                                    {[
                                        { id: 'campaigns', label: 'Campaigns', icon: 'üì¢', count: data.filter(r => r.Entity === 'Campaign').length },
                                        { id: 'adgroups', label: 'Ad Groups', icon: 'üìÅ', count: data.filter(r => r.Entity === 'Ad Group').length },
                                        { id: 'products', label: 'Products', icon: 'üì¶', count: data.filter(r => r.Entity === 'Product Ad').length },
                                        { id: 'keywords', label: 'Keywords', icon: 'üîë', count: data.filter(r => r.Entity === 'Keyword').length },
                                        { id: 'targeting', label: 'Targeting', icon: 'üéØ', count: data.filter(r => r.Entity === 'Product Targeting').length },
                                        { id: 'negative', label: 'Negatives', icon: 'üö´', count: data.filter(r => r.Entity === 'Negative Keyword' || r.Entity === 'Campaign Negative Keyword').length },
                                        { id: 'matchtypes', label: 'Match Types', icon: 'üîÄ', count: (() => { const types = new Set(); data.forEach(r => { if (r['Match Type']) types.add(r['Match Type']); }); return types.size; })() },
                                        { id: 'coverage', label: 'ASIN Coverage', icon: 'üìä', count: (() => { const asins = new Set(); data.forEach(r => { if (r.Entity === 'Product Ad' && r['ASIN (Informational only)']) asins.add(r['ASIN (Informational only)']); if (r.Entity === 'Product Targeting') { const m = (r['Product Targeting Expression'] || '').match(/asin[^"]*"([A-Z0-9]{10})"/i); if (m) asins.add(m[1]); } }); return asins.size; })() },
                                        { id: 'changes', label: 'Changes', icon: '‚úèÔ∏è', count: changes.length }
                                    ].map(tab => (
                                        <button
                                            key={tab.id}
                                            onClick={() => setActiveTab(tab.id)}
                                            className={`flex items-center gap-2 px-4 py-2 rounded-full transition text-sm font-medium whitespace-nowrap ${
                                                activeTab === tab.id
                                                    ? 'bg-cyan-500 text-white shadow-sm'
                                                    : 'text-gray-600 hover:bg-gray-100'
                                            }`}
                                        >
                                            <span>{tab.icon}</span>
                                            <span>{tab.label}</span>
                                            <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${
                                                activeTab === tab.id
                                                    ? 'bg-white/25 text-white'
                                                    : 'bg-gray-200 text-gray-600'
                                            }`}>
                                                {tab.count}
                                            </span>
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Export Tip Banner */}
                    {data.length > 0 && changes.length > 0 && showExportTip && (
                        <div className="bg-cyan-50 border-b border-cyan-200">
                            <div className="max-w-[98%] mx-auto px-4 py-2 flex items-center justify-between">
                                <p className="text-xs text-cyan-700">
                                    üí° <strong>Tip:</strong> Export Bulksheet creates an Amazon-compatible CSV with {changes.length} {changes.length === 1 ? 'change' : 'changes'} 
                                    (new items will be created, modified items will be updated)
                                    &nbsp;‚Ä¢&nbsp;<span className="font-medium">Changes are auto-saved</span> - safe to close/reload anytime!
                                </p>
                                <button
                                    onClick={() => setShowExportTip(false)}
                                    className="text-cyan-500 hover:text-cyan-700 font-bold text-sm ml-4"
                                    title="Close tip"
                                >
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* Recovery Banner */}
                    {showRecoveryBanner && (
                        <div className="bg-orange-100 border-l-4 border-orange-500 px-4 py-3 shadow-sm sticky top-[68px] z-20">
                            <div className="max-w-[98%] mx-auto flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <span className="text-2xl">‚ö†Ô∏è</span>
                                    <div>
                                        <p className="text-sm font-bold text-orange-900">Unsaved Changes Detected!</p>
                                        <p className="text-xs text-orange-800">
                                            You have <strong>{savedChangesCount} unsaved changes</strong>. Upload your CSV to restore them or download the changes file as backup.
                                        </p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={downloadChangesFile}
                                        className="px-3 py-1.5 bg-orange-600 text-white rounded text-xs font-medium hover:bg-orange-700"
                                    >
                                        üíæ Download Changes
                                    </button>
                                    <label className="cursor-pointer px-3 py-1.5 bg-blue-600 text-white rounded text-xs font-medium hover:bg-blue-700">
                                        üìÇ Upload CSV
                                        <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                                    </label>
                                    <button
                                        onClick={async () => {
                                            if (confirm('Are you sure you want to discard all saved changes? This will revert all modifications and remove all new items.')) {
                                                console.log('=== DISCARDING ALL CHANGES ===');
                                                
                                                // Clear saved changes from storage
                                                await clearSavedChanges();
                                                
                                                // Explicitly clear all state
                                                setHasSavedChanges(false);
                                                setSavedChangesCount(0);
                                                setShowRecoveryBanner(false);
                                                
                                                // Also revert the in-memory data to original state
                                                if (data.length > 0 && originalRowMap.size > 0) {
                                                    const newData = data.filter(row => {
                                                        const rowId = getRowId(row);
                                                        return originalRowMap.has(rowId);
                                                    }).map(row => {
                                                        const rowId = getRowId(row);
                                                        const original = originalRowMap.get(rowId);
                                                        return { ...original };
                                                    });
                                                    
                                                    setData(newData);
                                                    setSelectedItems(new Set());
                                                    
                                                    console.log('Reverted to original data:', newData.length, 'rows');
                                                }
                                                
                                                console.log('=== DISCARD COMPLETE ===');
                                            }
                                        }}
                                        className="px-3 py-1.5 bg-gray-600 text-white rounded text-xs font-medium hover:bg-gray-700"
                                    >
                                        üóëÔ∏è Discard
                                    </button>
                                    <button
                                        onClick={() => setShowRecoveryBanner(false)}
                                        className="px-3 py-1.5 bg-gray-200 text-gray-700 rounded text-xs font-medium hover:bg-gray-300"
                                    >
                                        ‚úï
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="max-w-[98%] mx-auto px-4 py-6 bg-gray-50">
                            {data.length > 0 && (
                                <>
                                    {/* Search and Actions */}
                                    <div className="bg-white rounded-2xl shadow-sm p-4 mb-4 border border-gray-200">
                                        <div className="flex flex-col gap-3">
                                            <input
                                                type="text"
                                                placeholder="Search..."
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                className="px-4 py-2 border border-gray-200 rounded-full focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-sm"
                                            />
                                            <div className="flex items-center gap-2">
                                                {/* Add New dropdown with Campaign always accessible */}
                                                <div className="relative inline-block">
                                                    <button
                                                        onClick={(e) => {
                                                            const dropdown = e.currentTarget.nextElementSibling;
                                                            dropdown.classList.toggle('hidden');
                                                        }}
                                                        onBlur={(e) => {
                                                            // Delay to allow click on dropdown items
                                                            setTimeout(() => {
                                                                const dropdown = e.currentTarget.nextElementSibling;
                                                                if (dropdown && !dropdown.matches(':hover')) {
                                                                    dropdown.classList.add('hidden');
                                                                }
                                                            }, 200);
                                                        }}
                                                        className="px-4 py-2 bg-cyan-500 text-white rounded-full hover:bg-cyan-600 text-xs font-medium flex items-center gap-1.5 shadow-sm transition"
                                                    >
                                                        <span>‚ûï</span>
                                                        <span>Add New</span>
                                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                                        </svg>
                                                    </button>
                                                    <div className="hidden absolute left-0 mt-1 w-48 bg-white rounded-2xl shadow-xl border border-gray-200 z-50 py-1">
                                                        <button
                                                            onClick={() => {
                                                                setShowModal(true);
                                                                setModalType('campaigns');
                                                            }}
                                                            className="w-full text-left px-4 py-2.5 text-xs hover:bg-cyan-50 flex items-center gap-2"
                                                        >
                                                            <span>üì¢</span>
                                                            <span>Campaign</span>
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                setShowModal(true);
                                                                setModalType('adgroups');
                                                            }}
                                                            className="w-full text-left px-4 py-2.5 text-xs hover:bg-cyan-50 flex items-center gap-2"
                                                        >
                                                            <span>üìÅ</span>
                                                            <span>Ad Group</span>
                                                        </button>
                                                        {activeTab === 'keywords' && (
                                                            <button
                                                                onClick={() => {
                                                                    setShowModal(true);
                                                                    setModalType('keywords');
                                                                }}
                                                                className="w-full text-left px-4 py-2.5 text-xs hover:bg-cyan-50 flex items-center gap-2"
                                                            >
                                                                <span>üîë</span>
                                                                <span>Keywords</span>
                                                            </button>
                                                        )}
                                                        {activeTab === 'negative' && (
                                                            <button
                                                                onClick={() => {
                                                                    setShowModal(true);
                                                                    setModalType('negative');
                                                                }}
                                                                className="w-full text-left px-4 py-2.5 text-xs hover:bg-cyan-50 flex items-center gap-2"
                                                            >
                                                                <span>üö´</span>
                                                                <span>Negative Keywords</span>
                                                            </button>
                                                        )}
                                                        {(activeTab === 'products' || activeTab === 'adgroups') && (
                                                            <button
                                                                onClick={() => {
                                                                    setShowModal(true);
                                                                    setModalType('products');
                                                                }}
                                                                className="w-full text-left px-4 py-2.5 text-xs hover:bg-cyan-50 flex items-center gap-2"
                                                            >
                                                                <span>üì¶</span>
                                                                <span>Products</span>
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>

                                                {activeTab === 'changes' && changes.length > 0 && (
                                                    <>
                                                        <button
                                                            onClick={selectAll}
                                                            className="px-3 py-1.5 bg-cyan-500 text-white rounded-full hover:bg-cyan-600 text-xs font-medium flex items-center gap-1 transition"
                                                            title={`Select all ${changes.length} changed items`}
                                                        >
                                                            <span>‚òë</span>
                                                            <span>
                                                                {changes.length > 0 && changes.every(item => selectedItems.has(getDataIndex(item))) ? 
                                                                    'Deselect All' : 
                                                                    `Select All (${changes.length})`
                                                                }
                                                            </span>
                                                        </button>
                                                        <button
                                                            onClick={undoAllChanges}
                                                            className="px-3 py-1.5 bg-orange-500 text-white rounded-full hover:bg-orange-600 text-xs font-medium flex items-center gap-1 transition"
                                                            title="Revert all changes and remove all new items"
                                                        >
                                                            <span>‚Ü∂</span>
                                                            <span>Undo All ({changes.length})</span>
                                                        </button>
                                                    </>
                                                )}
                                                
                                                {/* Status Filter */}
                                                {data.length > 0 && activeTab !== 'changes' && (
                                                    <select
                                                        value={statusFilterValue}
                                                        onChange={(e) => setStatusFilterValue(e.target.value)}
                                                        className="px-3 py-1.5 text-xs border border-gray-200 rounded-full bg-white hover:bg-gray-50 font-medium"
                                                    >
                                                        <option value="all">All Items</option>
                                                        <option value="modified">üìù Modified Only</option>
                                                        <option value="new">‚ú® New Only</option>
                                                        <option value="unchanged">Unchanged Only</option>
                                                    </select>
                                                )}

                                                {selectedItems.size > 0 && (
                                                    <>
                                                        <span className="text-xs text-gray-600 font-medium px-2 py-1 bg-gray-100 rounded-full">
                                                            {selectedItems.size} selected
                                                        </span>
                                                        <button
                                                            onClick={() => bulkUpdateState('enabled')}
                                                            className="px-3 py-1.5 text-xs bg-emerald-500 text-white rounded-full hover:bg-emerald-600 transition"
                                                        >
                                                            ‚ñ∂ Enable
                                                        </button>
                                                        <button
                                                            onClick={() => bulkUpdateState('paused')}
                                                            className="px-3 py-1.5 text-xs bg-amber-500 text-white rounded-full hover:bg-amber-600 transition"
                                                        >
                                                            ‚è∏ Pause
                                                        </button>
                                                        <button
                                                            onClick={() => bulkUpdateState('archived')}
                                                            className="px-3 py-1.5 text-xs bg-gray-500 text-white rounded-full hover:bg-gray-600 transition"
                                                        >
                                                            üì¶ Archive
                                                        </button>
                                                        <button
                                                            onClick={undoSelected}
                                                            className="px-3 py-1.5 text-xs bg-orange-500 text-white rounded-full hover:bg-orange-600 transition"
                                                            title="Revert selected items to original state or remove if new"
                                                        >
                                                            ‚Ü∂ Undo
                                                        </button>
                                                        <button
                                                            onClick={deleteSelected}
                                                            className="px-3 py-1.5 text-xs bg-red-500 text-white rounded-full hover:bg-red-600 transition"
                                                        >
                                                            üóëÔ∏è Delete
                                                        </button>
                                                    </>
                                                )}

                                                <div className="ml-auto text-xs text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full">
                                                    Showing {getFilteredData().length} items
                                                </div>
                                            </div>
                                        </div>

                                        {/* Active Column Filters Display */}
                                        {Object.keys(columnFilters).length > 0 && (
                                            <div className="bg-cyan-50 rounded-2xl shadow-sm p-3 mt-4 border border-cyan-200">
                                                <div className="flex items-center gap-2 flex-wrap">
                                                    <span className="text-xs font-semibold text-cyan-900">Column Filters:</span>
                                                    {Object.entries(columnFilters).map(([column, values]) => (
                                                        <div key={column} className="flex items-center gap-1 bg-white border border-cyan-300 text-cyan-800 px-3 py-1 rounded-full text-xs">
                                                            <span className="font-medium">{column.replace(' (Informational only)', '')}:</span>
                                                            <span>{values.size} selected</span>
                                                            <button
                                                                onClick={() => {
                                                                    const newFilters = { ...columnFilters };
                                                                    delete newFilters[column];
                                                                    setColumnFilters(newFilters);
                                                                }}
                                                                className="ml-1 text-cyan-600 hover:text-cyan-800 font-bold"
                                                            >
                                                                √ó
                                                            </button>
                                                        </div>
                                                    ))}
                                                    <button
                                                        onClick={() => setColumnFilters({})}
                                                        className="text-xs text-red-500 hover:text-red-700 underline ml-2"
                                                    >
                                                        Clear all column filters
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Data Table or Coverage View */}
                                    {data.length > 0 ? (
                                        activeTab === 'coverage' ? (
                                            <ASINCoverageView data={getFilteredData()} allData={data} />
                                        ) : activeTab === 'matchtypes' ? (
                                            <MatchTypeCoverageView data={getFilteredData()} allData={data} />
                                        ) : (
                                        <div className="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-200">
                                            {showReferencePanel && (referenceKeywords || referenceProducts) && (
                                                <div className="bg-orange-50 px-4 py-2 border-b border-orange-200 flex items-center gap-2 text-sm">
                                                    <span className="text-orange-700 font-medium">üéØ Target Checker Active:</span>
                                                    <span className="text-orange-600">Rows matching your reference list are highlighted in orange</span>
                                                </div>
                                            )}
                                            <DataTable
                                                data={getFilteredData()}
                                                activeTab={activeTab}
                                                updateRow={updateRow}
                                                setData={setData}
                                                selectedItems={selectedItems}
                                                toggleSelection={toggleSelection}
                                                selectAll={selectAll}
                                                changes={changes}
                                                originalRowMap={originalRowMap}
                                                columnWidths={columnWidths}
                                                setColumnWidths={setColumnWidths}
                                                columnFilters={columnFilters}
                                                setColumnFilters={setColumnFilters}
                                                setActiveFilterColumn={setActiveFilterColumn}
                                                setFilterPosition={setFilterPosition}
                                                columnSort={columnSort}
                                                allData={data}
                                                isInReferenceList={isInReferenceList}
                                                showReferencePanel={showReferencePanel}
                                                getAdGroupKeywords={getAdGroupKeywords}
                                                undoChange={undoChange}
                                                productTargetFilters={productTargetFilters}
                                                setProductTargetFilters={setProductTargetFilters}
                                            />
                                        </div>
                                        )
                                    ) : (
                                        <div className="bg-white rounded-lg shadow-sm p-12 text-center">
                                            {hasSavedChanges ? (
                                                <>
                                                    <div className="text-6xl mb-4">‚ö†Ô∏è</div>
                                                    <h2 className="text-2xl font-semibold text-gray-900 mb-2">Unsaved Changes Detected</h2>
                                                    <p className="text-gray-600 mb-4">
                                                        You have <strong className="text-orange-600">{savedChangesCount} saved changes</strong> waiting to be applied.<br/>
                                                        Upload your CSV file to restore your work.
                                                    </p>
                                                    <div className="flex gap-3 justify-center">
                                                        <label className="cursor-pointer px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium">
                                                            üìÇ Upload CSV to Restore
                                                            <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                                                        </label>
                                                        <button
                                                            onClick={downloadChangesFile}
                                                            className="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm font-medium"
                                                        >
                                                            üíæ Download Changes Backup
                                                        </button>
                                                    </div>
                                                </>
                                            ) : (
                                                <>
                                                    <div className="text-6xl mb-4">üöÄ</div>
                                                    <h2 className="text-2xl font-semibold text-gray-900 mb-2">Ready to Build Campaigns</h2>
                                                    <p className="text-gray-600 mb-4">
                                                        Click <strong>"‚ûï Add New"</strong> above to start building campaigns from scratch,<br/>
                                                        or upload a CSV file to edit existing campaigns.
                                                    </p>
                                                    {showBulkModeTip && (
                                                        <div className="text-sm text-gray-500 bg-gray-50 px-3 py-2 rounded relative inline-block">
                                                            <button
                                                                onClick={() => setShowBulkModeTip(false)}
                                                                className="absolute top-1 right-1 text-gray-500 hover:text-gray-800 font-bold text-base leading-none"
                                                                title="Close tip"
                                                            >
                                                                √ó
                                                            </button>
                                                            üí° Tip: Use <strong>Bulk Mode</strong> in the campaign builder to create multiple campaigns at once!
                                                        </div>
                                                    )}
                                                </>
                                            )}
                                        </div>
                                    )}
                                </>
                            )}
                            
                            {/* Empty State - No Data Loaded */}
                            {data.length === 0 && (
                                <div className="flex flex-col items-center justify-center py-20 fade-in bg-gray-50 min-h-[60vh]">
                                    <div className="relative mb-8">
                                        <div className="w-28 h-28 bg-gradient-to-br from-cyan-100 via-cyan-50 to-teal-100 rounded-3xl flex items-center justify-center shadow-xl shadow-cyan-500/10 ring-4 ring-cyan-100/50">
                                            <span className="text-5xl">üì¶</span>
                                        </div>
                                        <div className="absolute -bottom-2 -right-2 w-10 h-10 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-xl flex items-center justify-center shadow-lg">
                                            <span className="text-xl">+</span>
                                        </div>
                                    </div>
                                    <h2 className="text-2xl font-bold text-gray-800 mb-2">Welcome to Amazon PPC Manager</h2>
                                    <p className="text-gray-500 mb-8 text-center max-w-md leading-relaxed">
                                        Upload your Amazon Sponsored Products bulksheet to start managing campaigns, keywords, and more with powerful bulk editing tools.
                                    </p>
                                    <label className="group cursor-pointer px-8 py-4 bg-gradient-to-r from-cyan-500 via-cyan-600 to-teal-500 text-white rounded-2xl hover:from-cyan-600 hover:via-cyan-700 hover:to-teal-600 transition-all duration-300 flex items-center gap-3 text-lg font-medium shadow-xl shadow-cyan-500/30 hover:shadow-cyan-500/50 hover:scale-[1.02] active:scale-[0.98]">
                                        <span className="text-2xl group-hover:scale-110 transition-transform">üìÇ</span>
                                        <span>Upload CSV File</span>
                                        <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                                    </label>
                                    <p className="text-xs text-gray-400 mt-6 flex items-center gap-2">
                                        <span className="w-1.5 h-1.5 bg-emerald-400 rounded-full"></span>
                                        Supports Amazon Sponsored Products bulk files (.csv)
                                    </p>
                                    <div className="mt-8 pt-6 border-t border-gray-100 flex items-center gap-6 text-xs text-gray-400">
                                        <div className="flex items-center gap-2">
                                            <span>‚ö°</span> Fast processing
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span>üíæ</span> Auto-save
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span>üîÑ</span> Change tracking
                                        </div>
                                    </div>
                                </div>
                            )}
                    </div>

                    {/* Reference Panel Sidebar */}
                    {showReferencePanel && (
                        <div className="fixed top-0 right-0 h-full bg-white shadow-2xl border-l border-gray-200 z-40 overflow-y-auto" style={{ width: `${panelWidth}px` }}>
                            {/* Resize Handle */}
                            <div
                                className="absolute left-0 top-0 h-full w-2 cursor-ew-resize hover:bg-blue-500 bg-gray-400 transition-colors flex items-center justify-center"
                                onMouseDown={(e) => {
                                    e.preventDefault();
                                    const startX = e.clientX;
                                    const startWidth = panelWidth;
                                    
                                    const handleMouseMove = (e) => {
                                        const diff = startX - e.clientX;
                                        const newWidth = Math.max(400, Math.min(window.innerWidth * 0.8, startWidth + diff));
                                        setPanelWidth(newWidth);
                                    };
                                    
                                    const handleMouseUp = () => {
                                        document.removeEventListener('mousemove', handleMouseMove);
                                        document.removeEventListener('mouseup', handleMouseUp);
                                    };
                                    
                                    document.addEventListener('mousemove', handleMouseMove);
                                    document.addEventListener('mouseup', handleMouseUp);
                                }}
                                title="‚óÑ‚ñ∫ Drag to resize panel"
                            >
                                <div className="text-gray-600 text-xs writing-mode-vertical">‚ãÆ</div>
                            </div>
                            <div className="p-4">
                                {/* Header */}
                                <div className="flex items-center justify-between mb-4 pb-3 border-b">
                                    <h3 className="text-lg font-bold text-gray-900">üéØ Target Checker</h3>
                                    <div className="flex items-center gap-2">
                                        <button
                                            onClick={async () => {
                                                const savedData = await loadTargetCheckerFromDB();
                                                if (savedData && savedData.tableData && savedData.tableData.length > 0) {
                                                    const shouldRestore = confirm(
                                                        `Restore saved data from ${new Date(savedData.timestamp).toLocaleString()}?\n\n` +
                                                        `${savedData.tableData.length} rows in your table.\n\n` +
                                                        `This will replace your current table data.`
                                                    );
                                                    
                                                    if (shouldRestore) {
                                                        setKeywordTableData(savedData.tableData);
                                                        setTableColumns(savedData.columns);
                                                    }
                                                } else {
                                                    alert('No saved data found.');
                                                }
                                            }}
                                            className="px-2 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 font-medium"
                                            title="Restore last saved data"
                                        >
                                            ‚èÆÔ∏è Restore Last Data
                                        </button>
                                        <button
                                            onClick={() => setShowReferencePanel(false)}
                                            className="text-gray-500 hover:text-gray-700 text-xl"
                                        >
                                            √ó
                                        </button>
                                    </div>
                                </div>

                                {/* Info Box */}
                                {showTargetCheckerTip && (
                                    <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-900 mb-4 relative">
                                        <button
                                            onClick={() => setShowTargetCheckerTip(false)}
                                            className="absolute top-2 right-2 text-blue-600 hover:text-blue-800 font-bold text-lg leading-none"
                                            title="Close tip"
                                        >
                                            √ó
                                        </button>
                                        üí° <strong>How it works:</strong> Build your keyword table with custom columns. Items already in your campaigns are highlighted in orange.
                                        <div className="mt-2 pt-2 border-t border-blue-200">
                                            <strong>‚ú® Features:</strong>
                                            <ul className="mt-1 ml-4 space-y-1 text-[11px]">
                                                <li>‚Ä¢ <strong>Drag the left edge</strong> of this panel to resize it</li>
                                                <li>‚Ä¢ Add custom columns (Volume, Match Type, Group, etc.)</li>
                                                <li>‚Ä¢ Paste multiple keywords at once in any cell</li>
                                                <li>‚Ä¢ Sort, filter, search, and export your data</li>
                                                <li>‚Ä¢ Select keywords with checkboxes</li>
                                            </ul>
                                        </div>
                                    </div>
                                )}

                                {/* Portfolio Filter */}
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Filter by Portfolio (optional)
                                    </label>
                                    <select
                                        value={referencePortfolio}
                                        onChange={(e) => setReferencePortfolio(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                    >
                                        <option value="">All Portfolios</option>
                                        {getPortfolioList().map((p, i) => (
                                            <option key={i} value={p}>{p}</option>
                                        ))}
                                    </select>
                                    {referencePortfolio && (
                                        <div className="mt-1 text-xs text-gray-600">
                                            Checking only in: <strong>{referencePortfolio}</strong>
                                        </div>
                                    )}
                                </div>

                                {/* Status Legend */}
                                <div className="mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                                    <div className="text-xs font-semibold text-gray-700 mb-2">Status Legend:</div>
                                    <div className="grid grid-cols-2 gap-2 text-[10px]">
                                        <div className="flex items-center gap-1.5">
                                            <span className="inline-block px-1.5 py-0.5 bg-green-600 text-white rounded text-[9px] font-bold">NEW</span>
                                            <span className="text-gray-600">Not in your campaigns yet</span>
                                        </div>
                                        <div className="flex items-center gap-1.5">
                                            <span className="inline-block px-1.5 py-0.5 bg-orange-600 text-white rounded text-[9px] font-bold">‚úì ACTIVE</span>
                                            <span className="text-gray-600">Active &amp; performing</span>
                                        </div>
                                        <div className="flex items-center gap-1.5">
                                            <span className="inline-block px-1.5 py-0.5 bg-yellow-600 text-white rounded text-[9px] font-bold">‚ö†Ô∏è MIXED</span>
                                            <span className="text-gray-600">Some active, some paused</span>
                                        </div>
                                        <div className="flex items-center gap-1.5">
                                            <span className="inline-block px-1.5 py-0.5 bg-gray-500 text-white rounded text-[9px] font-bold">‚ö†Ô∏è PAUSED</span>
                                            <span className="text-gray-600">All instances paused</span>
                                        </div>
                                    </div>
                                    <div className="mt-2 text-[10px] text-gray-600 italic">
                                        üí° Hover over status badges or click ‚ñ∂ to see which campaigns contain each keyword
                                    </div>
                                    <div className="mt-2 pt-2 border-t border-gray-300 text-[10px] text-gray-700">
                                        <strong>Important:</strong> A keyword is only <span className="text-orange-600 font-semibold">ACTIVE</span> if the keyword itself, its campaign, AND its ad group are all enabled. If any component is paused, the status shows <span className="text-gray-600 font-semibold">PAUSED</span> with the reason (keyword paused / campaign paused / ad group paused).
                                    </div>
                                </div>

                                {/* Tabs */}
                                <div className="flex gap-2 mb-4">
                                    <button
                                        onClick={() => {
                                            setReferenceTab('keywords');
                                            setStatusFilter('all');
                                            setStatusSearch('');
                                            setMatchTypeHas({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
                                            setMatchTypeMissing({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
                                        }}
                                        className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition ${
                                            referenceTab === 'keywords'
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        Keywords
                                    </button>
                                    <button
                                        onClick={() => {
                                            setReferenceTab('products');
                                            setStatusFilter('all');
                                            setStatusSearch('');
                                            setMatchTypeHas({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
                                            setMatchTypeMissing({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
                                        }}
                                        className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition ${
                                            referenceTab === 'products'
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        Products/ASINs
                                    </button>
                                </div>

                                {/* Content */}
                                {referenceTab === 'keywords' ? (
                                    <div>
                                        {/* Table Mode - Editable table */}
                                        <>
                                            <div className="mb-2 flex items-center justify-between">
                                                <label className="text-sm font-medium text-gray-700">
                                                    Build Your Keyword Table
                                                </label>
                                                    <div className="flex gap-1">
                                                        <button
                                                            onClick={() => {
                                                                const pasteText = prompt('Paste your keywords here (one per line, or tab-separated for multiple columns):');
                                                                if (!pasteText) return;
                                                                
                                                                const lines = pasteText.split('\n').filter(l => l.trim());
                                                                if (lines.length === 0) return;
                                                                
                                                                const hasMultipleCols = lines[0].includes('\t');
                                                                
                                                                if (hasMultipleCols) {
                                                                    // Multi-column paste
                                                                    const rows = lines.map(line => line.split('\t'));
                                                                    const firstRow = rows[0];
                                                                    
                                                                    // Check if first row is header
                                                                    const isHeaderRow = firstRow.some(cell => 
                                                                        cell && /^[A-Za-z\s]+$/.test(cell) && cell.length > 0
                                                                    );
                                                                    
                                                                    if (isHeaderRow) {
                                                                        // Use first row as headers
                                                                        setTableColumns(firstRow);
                                                                        const dataRows = rows.slice(1);
                                                                        setKeywordTableData(dataRows.map(row => 
                                                                            Object.fromEntries(firstRow.map((h, i) => [h, row[i] || '']))
                                                                        ));
                                                                    } else {
                                                                        // No header, auto-generate column names
                                                                        const numCols = Math.max(...rows.map(r => r.length));
                                                                        const neededCols = numCols - tableColumns.length;
                                                                        
                                                                        if (neededCols > 0) {
                                                                            const newCols = [...tableColumns];
                                                                            for (let i = 0; i < neededCols; i++) {
                                                                                newCols.push(`Column ${tableColumns.length + i + 1}`);
                                                                            }
                                                                            setTableColumns(newCols);
                                                                        }
                                                                        
                                                                        const cols = tableColumns.length > numCols ? tableColumns : [...tableColumns, ...Array(neededCols).fill('').map((_, i) => `Column ${tableColumns.length + i + 1}`)];
                                                                        
                                                                        const newRows = rows.map(row => 
                                                                            Object.fromEntries(cols.map((col, i) => [col, row[i] || '']))
                                                                        );
                                                                        
                                                                        setKeywordTableData([...keywordTableData, ...newRows]);
                                                                    }
                                                                } else {
                                                                    // Single column paste
                                                                    const newRows = lines.map(line => ({
                                                                        ...Object.fromEntries(tableColumns.map(col => [col, ''])),
                                                                        [tableColumns[0]]: line.trim()
                                                                    }));
                                                                    setKeywordTableData([...keywordTableData, ...newRows]);
                                                                }
                                                            }}
                                                            className="px-2 py-1 text-xs bg-orange-600 text-white rounded hover:bg-orange-700 font-medium"
                                                            title="Quick paste multiple keywords"
                                                        >
                                                            ‚ö° Quick Paste
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                const newColName = prompt('Enter column name:');
                                                                if (newColName && !tableColumns.includes(newColName)) {
                                                                    setTableColumns([...tableColumns, newColName]);
                                                                    // Add empty values for new column
                                                                    setKeywordTableData(keywordTableData.map(row => ({
                                                                        ...row,
                                                                        [newColName]: ''
                                                                    })));
                                                                }
                                                            }}
                                                            className="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700"
                                                        >
                                                            + Column
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                setKeywordTableData([...keywordTableData, Object.fromEntries(tableColumns.map(col => [col, '']))]);
                                                            }}
                                                            className="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                                                        >
                                                            + Row
                                                        </button>
                                                        <button
                                                            onClick={async () => {
                                                                if (confirm('Clear all table data? This will also clear any saved data.')) {
                                                                    setKeywordTableData([{ Keyword: '' }]);
                                                                    setTableColumns(['Keyword']);
                                                                    await clearTargetCheckerData();
                                                                }
                                                            }}
                                                            className="px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700"
                                                        >
                                                            üóëÔ∏è Clear
                                                        </button>
                                                    </div>
                                                </div>

                                                {showTableModeTip && (
                                                    <div className="mb-2 text-xs text-gray-600 bg-gray-50 p-2 rounded border border-gray-200 relative">
                                                        <button
                                                            onClick={() => setShowTableModeTip(false)}
                                                            className="absolute top-1 right-1 text-gray-500 hover:text-gray-800 font-bold text-base leading-none"
                                                            title="Close tip"
                                                        >
                                                            √ó
                                                        </button>
                                                        üí° <strong>Tip:</strong> Click any cell and paste (Ctrl+V / Cmd+V) keywords. Each line becomes a new row. Or use <strong>Quick Paste</strong> button to paste with auto-detected column headers!
                                                    </div>
                                                )}

                                                <div className="border rounded-lg overflow-auto" style={{ maxHeight: '400px' }}>
                                                    <table className="w-full text-xs">
                                                        <thead className="bg-gray-100 sticky top-0">
                                                            <tr>
                                                                <th className="px-2 py-1 text-left w-8">#</th>
                                                                {tableColumns.map((col, colIdx) => (
                                                                    <th key={colIdx} className="px-2 py-1 text-left">
                                                                        <div className="flex items-center gap-1">
                                                                            {colIdx === 0 ? (
                                                                                <span className="font-semibold">{col}</span>
                                                                            ) : (
                                                                                <input
                                                                                    type="text"
                                                                                    value={col}
                                                                                    onChange={(e) => {
                                                                                        const newCols = [...tableColumns];
                                                                                        const oldName = newCols[colIdx];
                                                                                        newCols[colIdx] = e.target.value;
                                                                                        setTableColumns(newCols);
                                                                                        
                                                                                        // Update data keys
                                                                                        setKeywordTableData(keywordTableData.map(row => {
                                                                                            const newRow = { ...row };
                                                                                            newRow[e.target.value] = row[oldName];
                                                                                            delete newRow[oldName];
                                                                                            return newRow;
                                                                                        }));
                                                                                    }}
                                                                                    className="w-full px-1 py-0.5 border border-gray-300 rounded text-xs font-semibold"
                                                                                    placeholder="Column name"
                                                                                />
                                                                            )}
                                                                            {colIdx > 0 && (
                                                                                <button
                                                                                    onClick={() => {
                                                                                        const newCols = tableColumns.filter((_, i) => i !== colIdx);
                                                                                        setTableColumns(newCols);
                                                                                        setKeywordTableData(keywordTableData.map(row => {
                                                                                            const newRow = { ...row };
                                                                                            delete newRow[col];
                                                                                            return newRow;
                                                                                        }));
                                                                                    }}
                                                                                    className="text-red-600 hover:text-red-800"
                                                                                    title="Remove column"
                                                                                >
                                                                                    √ó
                                                                                </button>
                                                                            )}
                                                                        </div>
                                                                    </th>
                                                                ))}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {keywordTableData.map((row, rowIdx) => (
                                                                <tr key={rowIdx} className="border-b hover:bg-gray-50">
                                                                    <td className="px-2 py-1 text-gray-500">
                                                                        <div className="flex items-center gap-1">
                                                                            {rowIdx + 1}
                                                                            <button
                                                                                onClick={() => {
                                                                                    setKeywordTableData(keywordTableData.filter((_, i) => i !== rowIdx));
                                                                                }}
                                                                                className="text-red-600 hover:text-red-800 text-xs"
                                                                                title="Delete row"
                                                                            >
                                                                                üóëÔ∏è
                                                                            </button>
                                                                        </div>
                                                                    </td>
                                                                    {tableColumns.map((col, colIdx) => (
                                                                        <td key={colIdx} className="px-2 py-1">
                                                                            <input
                                                                                type="text"
                                                                                value={row[col] || ''}
                                                                                onChange={(e) => {
                                                                                    const newData = [...keywordTableData];
                                                                                    newData[rowIdx][col] = e.target.value;
                                                                                    setKeywordTableData(newData);
                                                                                }}
                                                                                onPaste={(e) => {
                                                                                    e.preventDefault();
                                                                                    const pastedText = e.clipboardData.getData('text');
                                                                                    
                                                                                    // Split by newlines to get rows
                                                                                    const pastedRows = pastedText.split('\n').filter(line => line.trim());
                                                                                    
                                                                                    if (pastedRows.length === 0) return;
                                                                                    
                                                                                    // Check if pasted data has tabs (multiple columns)
                                                                                    const hasMultipleCols = pastedRows[0].includes('\t');
                                                                                    
                                                                                    const newData = [...keywordTableData];
                                                                                    
                                                                                    pastedRows.forEach((pastedRow, pasteRowIdx) => {
                                                                                        const targetRowIdx = rowIdx + pasteRowIdx;
                                                                                        
                                                                                        // Create new row if needed
                                                                                        if (targetRowIdx >= newData.length) {
                                                                                            newData.push(Object.fromEntries(tableColumns.map(c => [c, ''])));
                                                                                        }
                                                                                        
                                                                                        if (hasMultipleCols) {
                                                                                            // Paste across multiple columns
                                                                                            const cells = pastedRow.split('\t');
                                                                                            cells.forEach((cell, cellIdx) => {
                                                                                                const targetColIdx = colIdx + cellIdx;
                                                                                                if (targetColIdx < tableColumns.length) {
                                                                                                    newData[targetRowIdx][tableColumns[targetColIdx]] = cell;
                                                                                                }
                                                                                            });
                                                                                        } else {
                                                                                            // Single column paste
                                                                                            newData[targetRowIdx][col] = pastedRow.trim();
                                                                                        }
                                                                                    });
                                                                                    
                                                                                    setKeywordTableData(newData);
                                                                                }}
                                                                                className="w-full px-1 py-0.5 border border-gray-200 rounded text-xs focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                                                                placeholder={col}
                                                                            />
                                                                        </td>
                                                                    ))}
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>

                                                <div className="mt-2 text-xs text-gray-600">
                                                    {keywordTableData.length} row{keywordTableData.length !== 1 ? 's' : ''} √ó {tableColumns.length} column{tableColumns.length !== 1 ? 's' : ''}
                                                </div>
                                            </>
                                        
                                        {/* Keyword Status List */}
                                        {((useTableMode && keywordTableData.length > 0) || (!useTableMode && referenceKeywords.trim())) && (() => {
                                            const allStatus = getKeywordStatus; // Now a memoized value, not a function
                                            const existingCount = allStatus.filter(s => s.exists).length;
                                            const newCount = allStatus.filter(s => !s.exists).length;
                                            
                                            // Apply filters
                                            let filteredStatus = allStatus;
                                            
                                            // Apply metadata column filters
                                            if (Object.keys(metadataFilters).length > 0 && allStatus[0]?.hasMetadata) {
                                                filteredStatus = filteredStatus.filter(item => {
                                                    return Object.entries(metadataFilters).every(([column, values]) => {
                                                        const itemValue = item.metadata?.[column] || '';
                                                        return values.has(String(itemValue));
                                                    });
                                                });
                                            }
                                            
                                            // Apply match type filters
                                            const hasMatchTypeHasFilters = Object.values(matchTypeHas).some(v => v);
                                            const hasMatchTypeMissingFilters = Object.values(matchTypeMissing).some(v => v);
                                            
                                            if (hasMatchTypeHasFilters || hasMatchTypeMissingFilters) {
                                                filteredStatus = filteredStatus.filter(s => {
                                                    const keywordMatchTypes = (s.matchTypes || []).map(mt => mt.toLowerCase());
                                                    
                                                    // Check "Must have at least one of these" filters
                                                    if (hasMatchTypeHasFilters) {
                                                        const hasMatch = (
                                                            (matchTypeHas.broad && keywordMatchTypes.includes('broad')) ||
                                                            (matchTypeHas.phrase && keywordMatchTypes.includes('phrase')) ||
                                                            (matchTypeHas.exact && keywordMatchTypes.includes('exact')) ||
                                                            (matchTypeHas.negativeExact && keywordMatchTypes.includes('negative exact')) ||
                                                            (matchTypeHas.negativePhrase && keywordMatchTypes.includes('negative phrase'))
                                                        );
                                                        if (!hasMatch) return false;
                                                    }
                                                    
                                                    // Check "Must NOT have any of these" filters
                                                    if (hasMatchTypeMissingFilters) {
                                                        const hasForbidden = (
                                                            (matchTypeMissing.broad && keywordMatchTypes.includes('broad')) ||
                                                            (matchTypeMissing.phrase && keywordMatchTypes.includes('phrase')) ||
                                                            (matchTypeMissing.exact && keywordMatchTypes.includes('exact')) ||
                                                            (matchTypeMissing.negativeExact && keywordMatchTypes.includes('negative exact')) ||
                                                            (matchTypeMissing.negativePhrase && keywordMatchTypes.includes('negative phrase'))
                                                        );
                                                        if (hasForbidden) return false;
                                                    }
                                                    
                                                    return true;
                                                });
                                            } else {
                                                // If no match type filters, apply the old Exists/New filter
                                                if (statusFilter === 'exists') {
                                                    filteredStatus = allStatus.filter(s => s.exists);
                                                } else if (statusFilter === 'new') {
                                                    filteredStatus = allStatus.filter(s => !s.exists);
                                                }
                                            }
                                            
                                            // Apply search
                                            if (statusSearch) {
                                                filteredStatus = filteredStatus.filter(s => {
                                                    // Search in keyword
                                                    if (s.keyword.toLowerCase().includes(statusSearch.toLowerCase())) {
                                                        return true;
                                                    }
                                                    // Search in metadata if available
                                                    if (s.metadata) {
                                                        return Object.values(s.metadata).some(value => 
                                                            String(value).toLowerCase().includes(statusSearch.toLowerCase())
                                                        );
                                                    }
                                                    return false;
                                                });
                                            }
                                            
                                            // Apply metadata sorting
                                            if (metadataSort.column && metadataSort.direction) {
                                                filteredStatus.sort((a, b) => {
                                                    let aVal = '';
                                                    let bVal = '';
                                                    
                                                    if (metadataSort.column === 'keyword') {
                                                        aVal = a.keyword;
                                                        bVal = b.keyword;
                                                    } else if (metadataSort.column === 'status') {
                                                        aVal = a.exists ? '1' : '0';
                                                        bVal = b.exists ? '1' : '0';
                                                    } else {
                                                        aVal = a.metadata?.[metadataSort.column] || '';
                                                        bVal = b.metadata?.[metadataSort.column] || '';
                                                    }
                                                    
                                                    // Try numeric comparison first (handle European comma format)
                                                    const aNum = parseNumber(aVal);
                                                    const bNum = parseNumber(bVal);
                                                    // Check if both values are actually numbers (not empty strings parsed as 0)
                                                    if ((aVal !== '' && !isNaN(aNum)) && (bVal !== '' && !isNaN(bNum))) {
                                                        return metadataSort.direction === 'asc' ? aNum - bNum : bNum - aNum;
                                                    }
                                                    
                                                    // String comparison
                                                    const comparison = String(aVal).localeCompare(String(bVal));
                                                    return metadataSort.direction === 'asc' ? comparison : -comparison;
                                                });
                                            }
                                            
                                            return (
                                            <div className="mt-4">
                                                <h4 className="text-sm font-semibold text-gray-900 mb-2">Status:</h4>
                                                
                                                {/* Summary Stats */}
                                                <div className="grid grid-cols-3 gap-2 mb-3">
                                                    <div className="bg-gray-100 p-2 rounded text-center">
                                                        <div className="text-lg font-bold text-gray-900">{allStatus.length}</div>
                                                        <div className="text-[10px] text-gray-600">Total</div>
                                                    </div>
                                                    <div className="bg-orange-100 p-2 rounded text-center">
                                                        <div className="text-lg font-bold text-orange-700">{existingCount}</div>
                                                        <div className="text-[10px] text-orange-600">Exists</div>
                                                    </div>
                                                    <div className="bg-green-100 p-2 rounded text-center">
                                                        <div className="text-lg font-bold text-green-700">{newCount}</div>
                                                        <div className="text-[10px] text-green-600">New</div>
                                                    </div>
                                                </div>
                                                
                                                {/* Filter Buttons */}
                                                <div className="flex gap-1 mb-2">
                                                    <button
                                                        onClick={() => setStatusFilter('all')}
                                                        className={`flex-1 px-2 py-1 text-xs rounded transition ${
                                                            statusFilter === 'all'
                                                                ? 'bg-gray-700 text-white'
                                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                        }`}
                                                    >
                                                        All ({allStatus.length})
                                                    </button>
                                                    <button
                                                        onClick={() => setStatusFilter('exists')}
                                                        className={`flex-1 px-2 py-1 text-xs rounded transition ${
                                                            statusFilter === 'exists'
                                                                ? 'bg-orange-600 text-white'
                                                                : 'bg-orange-100 text-orange-700 hover:bg-orange-200'
                                                        }`}
                                                    >
                                                        Exists ({existingCount})
                                                    </button>
                                                    <button
                                                        onClick={() => setStatusFilter('new')}
                                                        className={`flex-1 px-2 py-1 text-xs rounded transition ${
                                                            statusFilter === 'new'
                                                                ? 'bg-green-600 text-white'
                                                                : 'bg-green-100 text-green-700 hover:bg-green-200'
                                                        }`}
                                                    >
                                                        New ({newCount})
                                                    </button>
                                                </div>
                                                
                                                {/* Match Type Filters */}
                                                <div className="mb-2 p-2 bg-gray-50 rounded border border-gray-200">
                                                    <div 
                                                        className="flex items-center justify-between cursor-pointer hover:bg-gray-100 -m-2 p-2 rounded"
                                                        onClick={() => setMatchTypeFiltersExpanded(!matchTypeFiltersExpanded)}
                                                    >
                                                        <div className="text-[10px] font-semibold text-gray-700">Filter by Match Type:</div>
                                                        <span className="text-gray-500 text-xs">
                                                            {matchTypeFiltersExpanded ? '‚ñº' : '‚ñ∂'}
                                                        </span>
                                                    </div>
                                                    
                                                    {matchTypeFiltersExpanded && (
                                                        <div className="mt-2">
                                                            {/* Has at least one of these */}
                                                            <div className="mb-2">
                                                                <div className="text-[9px] font-medium text-green-700 mb-1">‚úì Has at least one of:</div>
                                                                <div className="grid grid-cols-2 gap-1">
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-green-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeHas.broad}
                                                                            onChange={(e) => setMatchTypeHas({...matchTypeHas, broad: e.target.checked})}
                                                                            className="rounded text-green-600"
                                                                        />
                                                                        <span>Broad</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-green-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeHas.phrase}
                                                                            onChange={(e) => setMatchTypeHas({...matchTypeHas, phrase: e.target.checked})}
                                                                            className="rounded text-green-600"
                                                                        />
                                                                        <span>Phrase</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-green-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeHas.exact}
                                                                            onChange={(e) => setMatchTypeHas({...matchTypeHas, exact: e.target.checked})}
                                                                            className="rounded text-green-600"
                                                                        />
                                                                        <span>Exact</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-green-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeHas.negativeExact}
                                                                            onChange={(e) => setMatchTypeHas({...matchTypeHas, negativeExact: e.target.checked})}
                                                                            className="rounded text-green-600"
                                                                        />
                                                                        <span>Neg. Exact</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-green-50 p-1 rounded col-span-2">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeHas.negativePhrase}
                                                                            onChange={(e) => setMatchTypeHas({...matchTypeHas, negativePhrase: e.target.checked})}
                                                                            className="rounded text-green-600"
                                                                        />
                                                                        <span>Neg. Phrase</span>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Missing all of these */}
                                                            <div className="mb-1">
                                                                <div className="text-[9px] font-medium text-red-700 mb-1">‚úó Missing (not in any of):</div>
                                                                <div className="grid grid-cols-2 gap-1">
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-red-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeMissing.broad}
                                                                            onChange={(e) => setMatchTypeMissing({...matchTypeMissing, broad: e.target.checked})}
                                                                            className="rounded text-red-600"
                                                                        />
                                                                        <span>Broad</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-red-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeMissing.phrase}
                                                                            onChange={(e) => setMatchTypeMissing({...matchTypeMissing, phrase: e.target.checked})}
                                                                            className="rounded text-red-600"
                                                                        />
                                                                        <span>Phrase</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-red-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeMissing.exact}
                                                                            onChange={(e) => setMatchTypeMissing({...matchTypeMissing, exact: e.target.checked})}
                                                                            className="rounded text-red-600"
                                                                        />
                                                                        <span>Exact</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-red-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeMissing.negativeExact}
                                                                            onChange={(e) => setMatchTypeMissing({...matchTypeMissing, negativeExact: e.target.checked})}
                                                                            className="rounded text-red-600"
                                                                        />
                                                                        <span>Neg. Exact</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-red-50 p-1 rounded col-span-2">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeMissing.negativePhrase}
                                                                            onChange={(e) => setMatchTypeMissing({...matchTypeMissing, negativePhrase: e.target.checked})}
                                                                            className="rounded text-red-600"
                                                                        />
                                                                        <span>Neg. Phrase</span>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                            
                                                            {(Object.values(matchTypeHas).some(v => v) || Object.values(matchTypeMissing).some(v => v)) && (
                                                                <button
                                                                    onClick={() => {
                                                                        setMatchTypeHas({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
                                                                        setMatchTypeMissing({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
                                                                    }}
                                                                    className="mt-1 w-full text-[10px] px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                                                                >
                                                                    Clear Match Type Filters
                                                                </button>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                {/* Search Bar */}
                                                <input
                                                    type="text"
                                                    placeholder="Search keywords or metadata..."
                                                    value={statusSearch}
                                                    onChange={(e) => setStatusSearch(e.target.value)}
                                                    className="w-full px-3 py-1.5 text-xs border border-gray-300 rounded mb-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                />
                                                
                                                {/* Active Metadata Filters */}
                                                {Object.keys(metadataFilters).length > 0 && (
                                                    <div className="mb-2 p-2 bg-blue-50 rounded border border-blue-200">
                                                        <div className="flex items-center justify-between mb-1">
                                                            <span className="text-[10px] font-semibold text-blue-900">Active Filters:</span>
                                                            <button
                                                                onClick={() => setMetadataFilters({})}
                                                                className="text-[10px] text-red-600 hover:text-red-800 underline"
                                                            >
                                                                Clear All
                                                            </button>
                                                        </div>
                                                        <div className="flex flex-wrap gap-1">
                                                            {Object.entries(metadataFilters).map(([col, vals]) => (
                                                                <span key={col} className="inline-flex items-center gap-1 px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-[9px]">
                                                                    {col}: {vals.size} selected
                                                                    <button
                                                                        onClick={() => {
                                                                            const newFilters = {...metadataFilters};
                                                                            delete newFilters[col];
                                                                            setMetadataFilters(newFilters);
                                                                        }}
                                                                        className="hover:text-red-600"
                                                                    >
                                                                        √ó
                                                                    </button>
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Results Count & Copy Actions */}
                                                <div className="flex items-center justify-between mb-2 gap-2">
                                                    <div className="text-xs text-gray-600">
                                                        Showing {filteredStatus.length} of {allStatus.length}
                                                    </div>
                                                    <div className="flex gap-1">
                                                        {filteredStatus.length > 0 && referenceKeywordSelections.size > 0 && (
                                                            <>
                                                                <button
                                                                    onClick={() => {
                                                                        const selectedItems = filteredStatus.filter((_, i) => referenceKeywordSelections.has(i));
                                                                        const keywords = selectedItems.map(s => s.keyword).join('\n');
                                                                        navigator.clipboard.writeText(keywords);
                                                                        alert(`Copied ${selectedItems.length} keywords!`);
                                                                    }}
                                                                    className="px-2 py-1 text-[10px] bg-green-600 text-white rounded hover:bg-green-700 font-medium"
                                                                >
                                                                    üìã Copy Selected KWs ({referenceKeywordSelections.size})
                                                                </button>
                                                                {filteredStatus[0]?.hasMetadata && (
                                                                    <button
                                                                        onClick={() => {
                                                                            const selectedItems = filteredStatus.filter((_, i) => referenceKeywordSelections.has(i));
                                                                            const headers = selectedItems[0].metadata ? Object.keys(selectedItems[0].metadata) : [];
                                                                            const rows = selectedItems.map(s => {
                                                                                const metadataValues = headers.map(h => s.metadata[h] || '');
                                                                                return [s.keyword, ...metadataValues].join('\t');
                                                                            });
                                                                            const content = ['Keyword', ...headers].join('\t') + '\n' + rows.join('\n');
                                                                            navigator.clipboard.writeText(content);
                                                                            alert(`Copied ${selectedItems.length} rows with all columns!`);
                                                                        }}
                                                                        className="px-2 py-1 text-[10px] bg-purple-600 text-white rounded hover:bg-purple-700 font-medium"
                                                                    >
                                                                        üìä + Metadata
                                                                    </button>
                                                                )}
                                                            </>
                                                        )}
                                                        {filteredStatus.length > 0 && (
                                                            <>
                                                                <button
                                                                    onClick={() => {
                                                                        const keywords = filteredStatus.map(s => s.keyword).join('\n');
                                                                        navigator.clipboard.writeText(keywords);
                                                                        alert(`Copied ${filteredStatus.length} keywords!`);
                                                                    }}
                                                                    className="px-2 py-1 text-[10px] bg-blue-600 text-white rounded hover:bg-blue-700 font-medium"
                                                                >
                                                                    üìã Copy All KWs ({filteredStatus.length})
                                                                </button>
                                                                {filteredStatus[0]?.hasMetadata && (
                                                                    <button
                                                                        onClick={() => {
                                                                            const headers = filteredStatus[0].metadata ? Object.keys(filteredStatus[0].metadata) : [];
                                                                            const rows = filteredStatus.map(s => {
                                                                                const metadataValues = headers.map(h => s.metadata[h] || '');
                                                                                return [s.keyword, ...metadataValues].join('\t');
                                                                            });
                                                                            const content = ['Keyword', ...headers].join('\t') + '\n' + rows.join('\n');
                                                                            navigator.clipboard.writeText(content);
                                                                            alert(`Copied ${filteredStatus.length} rows with all columns!`);
                                                                        }}
                                                                        className="px-2 py-1 text-[10px] bg-purple-600 text-white rounded hover:bg-purple-700 font-medium"
                                                                    >
                                                                        üìä + Metadata
                                                                    </button>
                                                                )}
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                                
                                                {/* List or Table View based on metadata */}
                                                <div className="border rounded-lg max-h-80 overflow-auto bg-gray-50">
                                                    {filteredStatus.length === 0 ? (
                                                        <div className="p-4 text-center text-xs text-gray-500">
                                                            No keywords match your filters
                                                        </div>
                                                    ) : filteredStatus[0]?.hasMetadata ? (
                                                        // Table view for multi-column data
                                                        <div className="overflow-x-auto">
                                                            <table className="w-full text-[10px]">
                                                                <thead className="bg-gray-100 sticky top-0 border-b">
                                                                    <tr>
                                                                        <th className="px-2 py-1 w-8">
                                                                            <input
                                                                                type="checkbox"
                                                                                checked={referenceKeywordSelections.size === filteredStatus.length && filteredStatus.length > 0}
                                                                                onChange={(e) => {
                                                                                    if (e.target.checked) {
                                                                                        setReferenceKeywordSelections(new Set(filteredStatus.map((_, i) => i)));
                                                                                    } else {
                                                                                        setReferenceKeywordSelections(new Set());
                                                                                    }
                                                                                }}
                                                                                className="rounded"
                                                                            />
                                                                        </th>
                                                                        <th className="px-2 py-1 text-left font-semibold">
                                                                            <div className="flex items-center gap-1 cursor-pointer hover:text-blue-600" onClick={() => {
                                                                                if (metadataSort.column === 'status' && metadataSort.direction === 'asc') {
                                                                                    setMetadataSort({ column: 'status', direction: 'desc' });
                                                                                } else if (metadataSort.column === 'status' && metadataSort.direction === 'desc') {
                                                                                    setMetadataSort({ column: null, direction: null });
                                                                                } else {
                                                                                    setMetadataSort({ column: 'status', direction: 'asc' });
                                                                                }
                                                                            }}>
                                                                                Status
                                                                                {metadataSort.column === 'status' && (
                                                                                    <span className="text-blue-600">{metadataSort.direction === 'asc' ? '‚Üë' : '‚Üì'}</span>
                                                                                )}
                                                                            </div>
                                                                        </th>
                                                                        <th className="px-2 py-1 text-left font-semibold">
                                                                            <div className="flex items-center gap-1 cursor-pointer hover:text-blue-600" onClick={() => {
                                                                                if (metadataSort.column === 'keyword' && metadataSort.direction === 'asc') {
                                                                                    setMetadataSort({ column: 'keyword', direction: 'desc' });
                                                                                } else if (metadataSort.column === 'keyword' && metadataSort.direction === 'desc') {
                                                                                    setMetadataSort({ column: null, direction: null });
                                                                                } else {
                                                                                    setMetadataSort({ column: 'keyword', direction: 'asc' });
                                                                                }
                                                                            }}>
                                                                                Keyword
                                                                                {metadataSort.column === 'keyword' && (
                                                                                    <span className="text-blue-600">{metadataSort.direction === 'asc' ? '‚Üë' : '‚Üì'}</span>
                                                                                )}
                                                                            </div>
                                                                        </th>
                                                                        {filteredStatus[0]?.metadata && Object.keys(filteredStatus[0].metadata).map((header, i) => (
                                                                            <th key={i} className="px-2 py-1 text-left font-semibold">
                                                                                <div className="flex items-center gap-1">
                                                                                    <span 
                                                                                        className="cursor-pointer hover:text-blue-600"
                                                                                        onClick={() => {
                                                                                            if (metadataSort.column === header && metadataSort.direction === 'asc') {
                                                                                                setMetadataSort({ column: header, direction: 'desc' });
                                                                                            } else if (metadataSort.column === header && metadataSort.direction === 'desc') {
                                                                                                setMetadataSort({ column: null, direction: null });
                                                                                            } else {
                                                                                                setMetadataSort({ column: header, direction: 'asc' });
                                                                                            }
                                                                                        }}
                                                                                    >
                                                                                        {header}
                                                                                        {metadataSort.column === header && (
                                                                                            <span className="text-blue-600 ml-1">{metadataSort.direction === 'asc' ? '‚Üë' : '‚Üì'}</span>
                                                                                        )}
                                                                                    </span>
                                                                                    <button
                                                                                        className={`text-gray-500 hover:text-blue-600 ${metadataFilters[header] ? 'text-blue-600' : ''}`}
                                                                                        onClick={() => {
                                                                                            // Create filter for this column
                                                                                            const uniqueValues = [...new Set(allStatus.map(s => s.metadata?.[header] || ''))].sort();
                                                                                            const currentFilters = metadataFilters[header] || new Set();
                                                                                            
                                                                                            // Simple toggle all on/off for now
                                                                                            if (currentFilters.size === 0) {
                                                                                                setMetadataFilters({
                                                                                                    ...metadataFilters,
                                                                                                    [header]: new Set(uniqueValues)
                                                                                                });
                                                                                            } else {
                                                                                                const newFilters = {...metadataFilters};
                                                                                                delete newFilters[header];
                                                                                                setMetadataFilters(newFilters);
                                                                                            }
                                                                                        }}
                                                                                        title="Click to filter this column"
                                                                                    >
                                                                                        üîç
                                                                                    </button>
                                                                                </div>
                                                                            </th>
                                                                        ))}
                                                                        <th className="px-2 py-1 text-center font-semibold">Match Types</th>
                                                                        <th className="px-2 py-1 text-center font-semibold w-12">üìã</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {filteredStatus.map((item, i) => (
                                                                        <React.Fragment key={i}>
                                                                        <tr 
                                                                            className={`border-b last:border-b-0 hover:bg-gray-100 ${
                                                                                item.isPaused ? 'bg-gray-100' : 
                                                                                item.hasEnabledAndPaused ? 'bg-yellow-50' :
                                                                                item.exists ? 'bg-orange-50' : 'bg-white'
                                                                            }`}
                                                                        >
                                                                            <td className="px-2 py-1.5">
                                                                                <input
                                                                                    type="checkbox"
                                                                                    checked={referenceKeywordSelections.has(i)}
                                                                                    onChange={(e) => {
                                                                                        const newSelections = new Set(referenceKeywordSelections);
                                                                                        if (e.target.checked) {
                                                                                            newSelections.add(i);
                                                                                        } else {
                                                                                            newSelections.delete(i);
                                                                                        }
                                                                                        setReferenceKeywordSelections(newSelections);
                                                                                    }}
                                                                                    className="rounded"
                                                                                />
                                                                            </td>
                                                                            <td className="px-2 py-1.5 text-center">
                                                                                <div className="flex items-center justify-center gap-1">
                                                                                {item.isPaused ? (
                                                                                    <span 
                                                                                        className="inline-block px-1.5 py-0.5 bg-gray-500 text-white rounded text-[9px] font-bold cursor-help" 
                                                                                        title={`‚ö†Ô∏è ALL PAUSED - Not performing!\n\nPaused locations:\n${item.locations.filter(l => l.state === 'paused').map(l => `‚Ä¢ ${l.campaign} / ${l.adGroup} [${l.matchType}]${l.pauseReason ? ' - ' + l.pauseReason : ''}`).join('\n')}`}
                                                                                    >
                                                                                        ‚ö†Ô∏è PAUSED
                                                                                    </span>
                                                                                ) : item.hasEnabledAndPaused ? (
                                                                                    <span 
                                                                                        className="inline-block px-1.5 py-0.5 bg-yellow-600 text-white rounded text-[9px] font-bold cursor-help" 
                                                                                        title={`‚ö†Ô∏è MIXED STATE - Some active, some paused\n\nACTIVE locations:\n${item.locations.filter(l => l.state === 'enabled').map(l => `‚Ä¢ ${l.campaign} / ${l.adGroup} [${l.matchType}]`).join('\n')}\n\nPAUSED locations:\n${item.locations.filter(l => l.state === 'paused').map(l => `‚Ä¢ ${l.campaign} / ${l.adGroup} [${l.matchType}]${l.pauseReason ? ' - ' + l.pauseReason : ''}`).join('\n')}`}
                                                                                    >
                                                                                        ‚ö†Ô∏è MIXED
                                                                                    </span>
                                                                                ) : item.exists ? (
                                                                                    <span 
                                                                                        className="inline-block px-1.5 py-0.5 bg-orange-600 text-white rounded text-[9px] font-bold cursor-help" 
                                                                                        title={`‚úì ACTIVE - Performing well!\n\nActive in:\n${item.locations.filter(l => l.state === 'enabled').map(l => `‚Ä¢ ${l.campaign} / ${l.adGroup} [${l.matchType}]`).join('\n')}`}
                                                                                    >
                                                                                        ‚úì ACTIVE
                                                                                    </span>
                                                                                ) : (
                                                                                    <span className="inline-block px-1.5 py-0.5 bg-green-600 text-white rounded text-[9px] font-bold">
                                                                                        NEW
                                                                                    </span>
                                                                                )}
                                                                                {item.exists && item.locations && item.locations.length > 0 && (
                                                                                    <button
                                                                                        onClick={() => {
                                                                                            const newExpanded = new Set(expandedKeywordRows);
                                                                                            if (newExpanded.has(i)) {
                                                                                                newExpanded.delete(i);
                                                                                            } else {
                                                                                                newExpanded.add(i);
                                                                                            }
                                                                                            setExpandedKeywordRows(newExpanded);
                                                                                        }}
                                                                                        className="text-xs text-blue-600 hover:text-blue-800 p-0.5"
                                                                                        title="Show/hide campaign details"
                                                                                    >
                                                                                        {expandedKeywordRows.has(i) ? '‚ñº' : '‚ñ∂'}
                                                                                    </button>
                                                                                )}
                                                                                </div>
                                                                            </td>
                                                                            <td className="px-2 py-1.5 font-mono" style={{ minWidth: '200px', maxWidth: '300px' }}>
                                                                                <div className={`break-words ${item.exists ? 'text-gray-500' : 'text-gray-900'}`} title={item.keyword}>
                                                                                    {item.keyword}
                                                                                </div>
                                                                            </td>
                                                                            {item.metadata && Object.values(item.metadata).map((value, j) => (
                                                                                <td key={j} className="px-2 py-1.5 text-gray-700">
                                                                                    <div className="max-w-[100px] truncate" title={value}>
                                                                                        {value}
                                                                                    </div>
                                                                                </td>
                                                                            ))}
                                                                            <td className="px-2 py-1.5 text-center">
                                                                                {item.matchTypes && item.matchTypes.length > 0 ? (
                                                                                    <span className="inline-block px-1.5 py-0.5 bg-blue-100 text-blue-800 rounded text-[9px]" title={item.matchTypes.join(', ')}>
                                                                                        {item.matchTypes.length} type{item.matchTypes.length > 1 ? 's' : ''}
                                                                                    </span>
                                                                                ) : (
                                                                                    <span className="text-gray-400">-</span>
                                                                                )}
                                                                            </td>
                                                                            <td className="px-2 py-1.5 text-center">
                                                                                <button
                                                                                    onClick={() => {
                                                                                        navigator.clipboard.writeText(item.keyword);
                                                                                    }}
                                                                                    className="p-1 hover:bg-gray-200 rounded text-gray-600 hover:text-gray-900"
                                                                                    title="Copy keyword"
                                                                                >
                                                                                    üìã
                                                                                </button>
                                                                            </td>
                                                                        </tr>
                                                                        {expandedKeywordRows.has(i) && item.exists && item.locations && item.locations.length > 0 && (
                                                                            <tr className="bg-blue-50 border-b">
                                                                                <td colSpan={item.hasMetadata ? Object.keys(item.metadata).length + 5 : 5} className="px-4 py-3">
                                                                                    <div className="text-xs">
                                                                                        <div className="font-semibold text-gray-700 mb-2">
                                                                                            Found in {item.locations.length} location{item.locations.length > 1 ? 's' : ''}:
                                                                                        </div>
                                                                                        <div className="space-y-1.5">
                                                                                            {item.locations.filter(l => l.state === 'enabled').length > 0 && (
                                                                                                <div>
                                                                                                    <div className="font-semibold text-green-700 mb-1">‚úì Active ({item.locations.filter(l => l.state === 'enabled').length}):</div>
                                                                                                    {item.locations.filter(l => l.state === 'enabled').map((loc, idx) => (
                                                                                                        <div key={idx} className="ml-4 text-gray-700">
                                                                                                            ‚Ä¢ {loc.campaign} / {loc.adGroup} <span className="text-blue-600 font-medium">[{loc.matchType}]</span>
                                                                                                        </div>
                                                                                                    ))}
                                                                                                </div>
                                                                                            )}
                                                                                            {item.locations.filter(l => l.state === 'paused').length > 0 && (
                                                                                                <div>
                                                                                                    <div className="font-semibold text-red-700 mb-1">‚ö†Ô∏è Paused ({item.locations.filter(l => l.state === 'paused').length}):</div>
                                                                                                    {item.locations.filter(l => l.state === 'paused').map((loc, idx) => (
                                                                                                        <div key={idx} className="ml-4 text-gray-600">
                                                                                                            ‚Ä¢ {loc.campaign} / {loc.adGroup} <span className="text-blue-600 font-medium">[{loc.matchType}]</span>
                                                                                                            {loc.pauseReason && <span className="text-red-600 font-medium ml-1">({loc.pauseReason})</span>}
                                                                                                        </div>
                                                                                                    ))}
                                                                                                </div>
                                                                                            )}
                                                                                        </div>
                                                                                    </div>
                                                                                </td>
                                                                            </tr>
                                                                        )}
                                                                    </React.Fragment>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    ) : (
                                                        // Simple list view for single-column data
                                                        filteredStatus.map((item, i) => (
                                                            <div 
                                                                key={i} 
                                                                className={`px-3 py-2 text-xs border-b last:border-b-0 ${
                                                                    item.isPaused ? 'bg-gray-100' : 
                                                                    item.hasEnabledAndPaused ? 'bg-yellow-50' :
                                                                    item.exists ? 'bg-orange-50' : 'bg-white'
                                                                }`}
                                                            >
                                                                <div className="flex items-center justify-between gap-2">
                                                                    <span 
                                                                        className={`font-mono flex-1 select-text ${item.exists ? 'line-through text-gray-500' : 'text-gray-900'}`}
                                                                        style={{ userSelect: 'text' }}
                                                                    >
                                                                        {item.keyword}
                                                                    </span>
                                                                    <div className="flex items-center gap-1">
                                                                        <button
                                                                            onClick={() => {
                                                                                navigator.clipboard.writeText(item.keyword);
                                                                            }}
                                                                            className="p-1 hover:bg-gray-200 rounded text-gray-600 hover:text-gray-900"
                                                                            title="Copy this keyword"
                                                                        >
                                                                            üìã
                                                                        </button>
                                                                        {item.isPaused ? (
                                                                            <span className="text-gray-600 font-semibold text-[10px]">‚ö†Ô∏è PAUSED</span>
                                                                        ) : item.hasEnabledAndPaused ? (
                                                                            <span className="text-yellow-600 font-semibold text-[10px]">‚ö†Ô∏è MIXED</span>
                                                                        ) : item.exists ? (
                                                                            <span className="text-orange-600 font-semibold text-[10px]">‚úì ACTIVE</span>
                                                                        ) : (
                                                                            <span className="text-green-600 font-semibold text-[10px]">‚óã NEW</span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                {item.exists && (
                                                                    <div className="mt-1 text-[10px] text-gray-600">
                                                                        {item.isPaused ? (
                                                                            <span className="text-red-700 font-medium">‚ö†Ô∏è All instances paused - </span>
                                                                        ) : item.hasEnabledAndPaused ? (
                                                                            <span className="text-yellow-700 font-medium">‚ö†Ô∏è {item.enabledCount} active, {item.pausedCount} paused - </span>
                                                                        ) : (
                                                                            <span className="text-green-700 font-medium">‚úì All active - </span>
                                                                        )}
                                                                        Found in {item.count} place{item.count > 1 ? 's' : ''}
                                                                        {item.matchTypes && item.matchTypes.length > 0 && (
                                                                            <span className="ml-1">
                                                                                ({item.matchTypes.join(', ')})
                                                                            </span>
                                                                        )}
                                                                        {item.locations && item.locations.length > 0 && (
                                                                            <button
                                                                                onClick={() => {
                                                                                    const newExpanded = new Set(expandedKeywordRows);
                                                                                    if (newExpanded.has(i)) {
                                                                                        newExpanded.delete(i);
                                                                                    } else {
                                                                                        newExpanded.add(i);
                                                                                    }
                                                                                    setExpandedKeywordRows(newExpanded);
                                                                                }}
                                                                                className="ml-2 text-blue-600 hover:text-blue-800"
                                                                            >
                                                                                {expandedKeywordRows.has(i) ? '‚ñº Hide details' : '‚ñ∂ Show campaigns'}
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                )}
                                                                {expandedKeywordRows.has(i) && item.exists && item.locations && item.locations.length > 0 && (
                                                                    <div className="mt-2 pl-4 pr-2 py-2 bg-white rounded border border-gray-200 text-[10px]">
                                                                        {item.locations.filter(l => l.state === 'enabled').length > 0 && (
                                                                            <div className="mb-2">
                                                                                <div className="font-semibold text-green-700 mb-1">‚úì Active ({item.locations.filter(l => l.state === 'enabled').length}):</div>
                                                                                {item.locations.filter(l => l.state === 'enabled').map((loc, idx) => (
                                                                                    <div key={idx} className="ml-2 text-gray-700">
                                                                                        ‚Ä¢ {loc.campaign} / {loc.adGroup} <span className="text-blue-600 font-medium">[{loc.matchType}]</span>
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        )}
                                                                        {item.locations.filter(l => l.state === 'paused').length > 0 && (
                                                                            <div>
                                                                                <div className="font-semibold text-red-700 mb-1">‚ö†Ô∏è Paused ({item.locations.filter(l => l.state === 'paused').length}):</div>
                                                                                {item.locations.filter(l => l.state === 'paused').map((loc, idx) => (
                                                                                    <div key={idx} className="ml-2 text-gray-600">
                                                                                        ‚Ä¢ {loc.campaign} / {loc.adGroup} <span className="text-blue-600 font-medium">[{loc.matchType}]</span>
                                                                                        {loc.pauseReason && <span className="text-red-600 font-medium ml-1">({loc.pauseReason})</span>}
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))
                                                    )}
                                                </div>
                                            </div>
                                            );
                                        })()}
                                    </div>
                                ) : (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Target Products/ASINs (one per line)
                                        </label>
                                        <textarea
                                            value={referenceProducts}
                                            onChange={(e) => setReferenceProducts(e.target.value)}
                                            placeholder="B07XYZ1234&#10;B08ABC5678&#10;MY-SKU-001&#10;&#10;Paste ASINs or SKUs..."
                                            className="w-full h-48 px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            style={{ resize: 'vertical' }}
                                        />
                                        <div className="mt-2 flex gap-2">
                                            <button
                                                onClick={() => setReferenceProducts('')}
                                                className="flex-1 px-3 py-1.5 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                                            >
                                                Clear
                                            </button>
                                            <div className="flex-1 text-xs text-gray-600 flex items-center justify-center">
                                                {referenceProducts.split('\n').filter(p => p.trim()).length} products
                                            </div>
                                        </div>

                                        {/* Product Status List */}
                                        {referenceProducts.trim() && (() => {
                                            const allStatus = getProductStatus; // Now a memoized value
                                            const existingCount = allStatus.filter(s => s.exists).length;
                                            const newCount = allStatus.filter(s => !s.exists).length;
                                            
                                            // Apply filters
                                            let filteredStatus = allStatus;
                                            if (statusFilter === 'exists') {
                                                filteredStatus = allStatus.filter(s => s.exists);
                                            } else if (statusFilter === 'new') {
                                                filteredStatus = allStatus.filter(s => !s.exists);
                                            }
                                            
                                            // Apply search
                                            if (statusSearch) {
                                                filteredStatus = filteredStatus.filter(s => 
                                                    s.product.toLowerCase().includes(statusSearch.toLowerCase())
                                                );
                                            }
                                            
                                            return (
                                            <div className="mt-4">
                                                <h4 className="text-sm font-semibold text-gray-900 mb-2">Status:</h4>
                                                
                                                {/* Summary Stats */}
                                                <div className="grid grid-cols-3 gap-2 mb-3">
                                                    <div className="bg-gray-100 p-2 rounded text-center">
                                                        <div className="text-lg font-bold text-gray-900">{allStatus.length}</div>
                                                        <div className="text-[10px] text-gray-600">Total</div>
                                                    </div>
                                                    <div className="bg-orange-100 p-2 rounded text-center">
                                                        <div className="text-lg font-bold text-orange-700">{existingCount}</div>
                                                        <div className="text-[10px] text-orange-600">Exists</div>
                                                    </div>
                                                    <div className="bg-green-100 p-2 rounded text-center">
                                                        <div className="text-lg font-bold text-green-700">{newCount}</div>
                                                        <div className="text-[10px] text-green-600">New</div>
                                                    </div>
                                                </div>
                                                
                                                {/* Filter Buttons */}
                                                <div className="flex gap-1 mb-2">
                                                    <button
                                                        onClick={() => setStatusFilter('all')}
                                                        className={`flex-1 px-2 py-1 text-xs rounded transition ${
                                                            statusFilter === 'all'
                                                                ? 'bg-gray-700 text-white'
                                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                        }`}
                                                    >
                                                        All ({allStatus.length})
                                                    </button>
                                                    <button
                                                        onClick={() => setStatusFilter('exists')}
                                                        className={`flex-1 px-2 py-1 text-xs rounded transition ${
                                                            statusFilter === 'exists'
                                                                ? 'bg-orange-600 text-white'
                                                                : 'bg-orange-100 text-orange-700 hover:bg-orange-200'
                                                        }`}
                                                    >
                                                        Exists ({existingCount})
                                                    </button>
                                                    <button
                                                        onClick={() => setStatusFilter('new')}
                                                        className={`flex-1 px-2 py-1 text-xs rounded transition ${
                                                            statusFilter === 'new'
                                                                ? 'bg-green-600 text-white'
                                                                : 'bg-green-100 text-green-700 hover:bg-green-200'
                                                        }`}
                                                    >
                                                        New ({newCount})
                                                    </button>
                                                </div>
                                                
                                                {/* Search Bar */}
                                                <input
                                                    type="text"
                                                    placeholder="Search products/ASINs..."
                                                    value={statusSearch}
                                                    onChange={(e) => setStatusSearch(e.target.value)}
                                                    className="w-full px-3 py-1.5 text-xs border border-gray-300 rounded mb-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                />
                                                
                                                {/* Results Count & Copy Actions */}
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="text-xs text-gray-600">
                                                        Showing {filteredStatus.length} of {allStatus.length}
                                                    </div>
                                                    {filteredStatus.length > 0 && (
                                                        <button
                                                            onClick={() => {
                                                                const products = filteredStatus.map(s => s.product).join('\n');
                                                                navigator.clipboard.writeText(products);
                                                                alert(`Copied ${filteredStatus.length} products to clipboard!`);
                                                            }}
                                                            className="px-2 py-1 text-[10px] bg-blue-600 text-white rounded hover:bg-blue-700 font-medium"
                                                        >
                                                            üìã Copy All ({filteredStatus.length})
                                                        </button>
                                                    )}
                                                </div>
                                                
                                                {/* List */}
                                                <div className="border rounded-lg max-h-80 overflow-y-auto bg-gray-50">
                                                    {filteredStatus.length === 0 ? (
                                                        <div className="p-4 text-center text-xs text-gray-500">
                                                            No products match your filters
                                                        </div>
                                                    ) : (
                                                        filteredStatus.map((item, i) => (
                                                            <div 
                                                                key={i} 
                                                                className={`px-3 py-2 text-xs border-b last:border-b-0 ${
                                                                    item.isPaused ? 'bg-gray-100' : 
                                                                    item.hasEnabledAndPaused ? 'bg-yellow-50' :
                                                                    item.exists ? 'bg-orange-50' : 'bg-white'
                                                                }`}
                                                            >
                                                                <div className="flex items-center justify-between gap-2">
                                                                    <span 
                                                                        className={`font-mono flex-1 select-text ${item.exists ? 'line-through text-gray-500' : 'text-gray-900'}`}
                                                                        style={{ userSelect: 'text' }}
                                                                    >
                                                                        {item.product}
                                                                    </span>
                                                                    <div className="flex items-center gap-1">
                                                                        <button
                                                                            onClick={() => {
                                                                                navigator.clipboard.writeText(item.product);
                                                                            }}
                                                                            className="p-1 hover:bg-gray-200 rounded text-gray-600 hover:text-gray-900"
                                                                            title="Copy this product"
                                                                        >
                                                                            üìã
                                                                        </button>
                                                                        {item.isPaused ? (
                                                                            <span className="text-gray-600 font-semibold text-[10px]">‚è∏ PAUSED</span>
                                                                        ) : item.hasEnabledAndPaused ? (
                                                                            <span className="text-yellow-600 font-semibold text-[10px]">‚ö†Ô∏è MIXED</span>
                                                                        ) : item.exists ? (
                                                                            <span className="text-orange-600 font-semibold text-[10px]">‚úì ACTIVE</span>
                                                                        ) : (
                                                                            <span className="text-green-600 font-semibold text-[10px]">‚óã NEW</span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                {item.exists && (
                                                                    <div className="mt-1 text-[10px] text-gray-600">
                                                                        {item.isPaused ? (
                                                                            <span>All instances paused - </span>
                                                                        ) : item.hasEnabledAndPaused ? (
                                                                            <span>{item.enabledCount} active, {item.pausedCount} paused - </span>
                                                                        ) : null}
                                                                        Found in {item.count} place{item.count > 1 ? 's' : ''}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))
                                                    )}
                                                </div>
                                            </div>
                                            );
                                        })()}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Modal */}
                    {showModal && (
                        <AddModal
                            type={modalType}
                            data={data}
                            onClose={() => setShowModal(false)}
                            onAdd={addNewItems}
                            setData={setData}
                        />
                    )}

                    {/* Excel-style Filter Modal */}
                    {activeFilterColumn && (
                        <FilterModal
                            column={activeFilterColumn}
                            uniqueValues={(() => {
                                const values = new Set();
                                data.forEach(row => {
                                    let value;
                                    if (activeFilterColumn === 'Portfolio Name') {
                                        value = getPortfolioName(row);
                                    } else if (activeFilterColumn === 'Campaign Name') {
                                        value = getCampaignName(row);
                                    } else if (activeFilterColumn === 'Ad Group Name') {
                                        value = getAdGroupName(row);
                                    } else {
                                        value = row[activeFilterColumn];
                                    }
                                    if (value !== undefined && value !== null) {
                                        values.add(String(value));
                                    }
                                });
                                return Array.from(values).sort();
                            })()}
                            selectedFilters={columnFilters[activeFilterColumn]}
                            onApply={(column, selectedValues) => {
                                const newFilters = { ...columnFilters };
                                if (selectedValues.size === 0) {
                                    delete newFilters[column];
                                } else {
                                    newFilters[column] = selectedValues;
                                }
                                setColumnFilters(newFilters);
                            }}
                            onClose={() => setActiveFilterColumn(null)}
                            position={filterPosition}
                            currentSort={columnSort}
                            onSort={(column, direction) => {
                                if (direction === null) {
                                    setColumnSort({ column: null, direction: null });
                                } else {
                                    setColumnSort({ column, direction });
                                }
                            }}
                        />
                    )}

                    {/* Find & Replace Modal */}
                    {showFindReplaceModal && (
                        <FindReplaceModal
                            settings={findReplaceSettings}
                            setSettings={setFindReplaceSettings}
                            onExecute={executeFindReplace}
                            onClose={() => setShowFindReplaceModal(false)}
                            data={data}
                        />
                    )}
                </div>
            );
        }

        // ASIN Coverage Analyzer Component
        function ASINCoverageView({ data, allData }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [coverageFilter, setCoverageFilter] = useState('all');
            const [portfolioFilter, setPortfolioFilter] = useState('');
            const [sortConfig, setSortConfig] = useState({ key: 'spend', direction: 'desc' });
            const [expandedAsins, setExpandedAsins] = useState(new Set());
            
            // Parse number helper (handles European format)
            const parseNum = (val) => {
                if (val === null || val === undefined || val === '') return 0;
                const str = String(val).replace(/[^0-9.,-]/g, '');
                if (str.includes(',') && str.includes('.')) {
                    if (str.lastIndexOf(',') > str.lastIndexOf('.')) {
                        return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
                    }
                    return parseFloat(str.replace(/,/g, '')) || 0;
                }
                if (str.includes(',') && !str.includes('.')) {
                    const parts = str.split(',');
                    if (parts.length === 2 && parts[1].length <= 2) {
                        return parseFloat(str.replace(',', '.')) || 0;
                    }
                    return parseFloat(str.replace(/,/g, '')) || 0;
                }
                return parseFloat(str) || 0;
            };
            
            // Get portfolio name helper
            const getPortfolioName = (row) => {
                return row['Portfolio Name (Informational only)'] || row['Portfolio Name'] || '-';
            };
            
            // Get campaign name helper
            const getCampaignName = (row) => {
                return row['Campaign Name'] || row['Campaign Name (Informational only)'] || '-';
            };
            
            // Get ad group name helper
            const getAdGroupName = (row) => {
                return row['Ad Group Name'] || row['Ad Group Name (Informational only)'] || '-';
            };
            
            // Extract ASIN from Product Targeting Expression
            const extractTargetingAsin = (expression) => {
                if (!expression) return null;
                const match = expression.match(/asin[^"]*"([A-Z0-9]{10})"/i);
                return match ? match[1].toUpperCase() : null;
            };
            
            // Build ASIN coverage data
            const asinCoverageData = useMemo(() => {
                const asinMap = new Map();
                
                // Process Product Ads
                allData.filter(r => r.Entity === 'Product Ad').forEach(row => {
                    const asin = (row['ASIN (Informational only)'] || '').toUpperCase();
                    if (!asin || asin.length !== 10) return;
                    
                    if (!asinMap.has(asin)) {
                        asinMap.set(asin, {
                            asin,
                            productAds: [],
                            productTargeting: [],
                            metrics: { impressions: 0, clicks: 0, spend: 0, sales: 0, orders: 0 },
                            skus: new Set(),
                            campaigns: new Set(),
                            portfolios: new Set()
                        });
                    }
                    
                    const entry = asinMap.get(asin);
                    entry.productAds.push({
                        campaign: getCampaignName(row),
                        campaignId: row['Campaign ID'],
                        adGroup: getAdGroupName(row),
                        adGroupId: row['Ad Group ID'],
                        sku: row.SKU || '-',
                        state: (row.State || '').toLowerCase(),
                        impressions: parseNum(row.Impressions),
                        clicks: parseNum(row.Clicks),
                        spend: parseNum(row.Spend),
                        sales: parseNum(row.Sales),
                        orders: parseNum(row.Orders)
                    });
                    
                    entry.metrics.impressions += parseNum(row.Impressions);
                    entry.metrics.clicks += parseNum(row.Clicks);
                    entry.metrics.spend += parseNum(row.Spend);
                    entry.metrics.sales += parseNum(row.Sales);
                    entry.metrics.orders += parseNum(row.Orders);
                    
                    if (row.SKU) entry.skus.add(row.SKU);
                    entry.campaigns.add(getCampaignName(row));
                    const portfolio = getPortfolioName(row);
                    if (portfolio !== '-') entry.portfolios.add(portfolio);
                });
                
                // Process Product Targeting
                allData.filter(r => r.Entity === 'Product Targeting').forEach(row => {
                    const asin = extractTargetingAsin(row['Product Targeting Expression']);
                    if (!asin) return;
                    
                    if (!asinMap.has(asin)) {
                        asinMap.set(asin, {
                            asin,
                            productAds: [],
                            productTargeting: [],
                            metrics: { impressions: 0, clicks: 0, spend: 0, sales: 0, orders: 0 },
                            skus: new Set(),
                            campaigns: new Set(),
                            portfolios: new Set()
                        });
                    }
                    
                    const entry = asinMap.get(asin);
                    entry.productTargeting.push({
                        campaign: getCampaignName(row),
                        campaignId: row['Campaign ID'],
                        adGroup: getAdGroupName(row),
                        adGroupId: row['Ad Group ID'],
                        expression: row['Product Targeting Expression'] || '-',
                        bid: row.Bid || '-',
                        state: (row.State || '').toLowerCase(),
                        impressions: parseNum(row.Impressions),
                        clicks: parseNum(row.Clicks),
                        spend: parseNum(row.Spend),
                        sales: parseNum(row.Sales),
                        orders: parseNum(row.Orders)
                    });
                    
                    entry.metrics.impressions += parseNum(row.Impressions);
                    entry.metrics.clicks += parseNum(row.Clicks);
                    entry.metrics.spend += parseNum(row.Spend);
                    entry.metrics.sales += parseNum(row.Sales);
                    entry.metrics.orders += parseNum(row.Orders);
                    
                    entry.campaigns.add(getCampaignName(row));
                    const portfolio = getPortfolioName(row);
                    if (portfolio !== '-') entry.portfolios.add(portfolio);
                });
                
                // Calculate derived metrics and coverage status
                return Array.from(asinMap.values()).map(entry => {
                    const hasProductAds = entry.productAds.length > 0;
                    const hasProductTargeting = entry.productTargeting.length > 0;
                    const productAdsEnabled = entry.productAds.some(pa => pa.state === 'enabled');
                    const productTargetingEnabled = entry.productTargeting.some(pt => pt.state === 'enabled');
                    
                    let coverage = 'missing';
                    if (hasProductAds && hasProductTargeting) coverage = 'full';
                    else if (hasProductAds || hasProductTargeting) coverage = 'partial';
                    
                    let status = 'none';
                    if (productAdsEnabled || productTargetingEnabled) status = 'enabled';
                    else if (hasProductAds || hasProductTargeting) status = 'paused';
                    
                    return {
                        ...entry,
                        skus: Array.from(entry.skus),
                        campaigns: Array.from(entry.campaigns),
                        portfolios: Array.from(entry.portfolios),
                        hasProductAds,
                        hasProductTargeting,
                        productAdsEnabled,
                        productTargetingEnabled,
                        coverage,
                        status,
                        acos: entry.metrics.spend > 0 && entry.metrics.sales > 0 
                            ? (entry.metrics.spend / entry.metrics.sales * 100) 
                            : 0,
                        ctr: entry.metrics.impressions > 0 
                            ? (entry.metrics.clicks / entry.metrics.impressions * 100) 
                            : 0,
                        cpc: entry.metrics.clicks > 0 
                            ? (entry.metrics.spend / entry.metrics.clicks) 
                            : 0,
                        convRate: entry.metrics.clicks > 0 
                            ? (entry.metrics.orders / entry.metrics.clicks * 100) 
                            : 0
                    };
                });
            }, [allData]);
            
            // Get unique portfolios
            const portfolioList = useMemo(() => {
                const portfolios = new Set();
                asinCoverageData.forEach(entry => {
                    entry.portfolios.forEach(p => portfolios.add(p));
                });
                return Array.from(portfolios).sort();
            }, [asinCoverageData]);
            
            // Filter and sort data
            const filteredData = useMemo(() => {
                let result = [...asinCoverageData];
                
                // Search filter
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    result = result.filter(entry => 
                        entry.asin.toLowerCase().includes(term) ||
                        entry.skus.some(s => s.toLowerCase().includes(term)) ||
                        entry.campaigns.some(c => c.toLowerCase().includes(term))
                    );
                }
                
                // Status filter
                if (statusFilter !== 'all') {
                    result = result.filter(entry => entry.status === statusFilter);
                }
                
                // Coverage filter
                if (coverageFilter !== 'all') {
                    result = result.filter(entry => entry.coverage === coverageFilter);
                }
                
                // Portfolio filter
                if (portfolioFilter) {
                    result = result.filter(entry => entry.portfolios.includes(portfolioFilter));
                }
                
                // Sort
                result.sort((a, b) => {
                    let aVal, bVal;
                    switch (sortConfig.key) {
                        case 'asin': aVal = a.asin; bVal = b.asin; break;
                        case 'spend': aVal = a.metrics.spend; bVal = b.metrics.spend; break;
                        case 'sales': aVal = a.metrics.sales; bVal = b.metrics.sales; break;
                        case 'acos': aVal = a.acos; bVal = b.acos; break;
                        case 'ctr': aVal = a.ctr; bVal = b.ctr; break;
                        case 'convRate': aVal = a.convRate; bVal = b.convRate; break;
                        case 'impressions': aVal = a.metrics.impressions; bVal = b.metrics.impressions; break;
                        case 'clicks': aVal = a.metrics.clicks; bVal = b.metrics.clicks; break;
                        case 'coverage': aVal = a.coverage; bVal = b.coverage; break;
                        default: aVal = a.metrics.spend; bVal = b.metrics.spend;
                    }
                    
                    if (typeof aVal === 'string') {
                        return sortConfig.direction === 'asc' 
                            ? aVal.localeCompare(bVal) 
                            : bVal.localeCompare(aVal);
                    }
                    return sortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal;
                });
                
                return result;
            }, [asinCoverageData, searchTerm, statusFilter, coverageFilter, portfolioFilter, sortConfig]);
            
            // Summary stats
            const summaryStats = useMemo(() => {
                const stats = {
                    totalAsins: asinCoverageData.length,
                    fullCoverage: asinCoverageData.filter(e => e.coverage === 'full').length,
                    partialCoverage: asinCoverageData.filter(e => e.coverage === 'partial').length,
                    missingCoverage: asinCoverageData.filter(e => e.coverage === 'missing').length,
                    totalSpend: asinCoverageData.reduce((sum, e) => sum + e.metrics.spend, 0),
                    totalSales: asinCoverageData.reduce((sum, e) => sum + e.metrics.sales, 0),
                    totalImpressions: asinCoverageData.reduce((sum, e) => sum + e.metrics.impressions, 0),
                    totalClicks: asinCoverageData.reduce((sum, e) => sum + e.metrics.clicks, 0)
                };
                stats.overallAcos = stats.totalSales > 0 ? (stats.totalSpend / stats.totalSales * 100) : 0;
                return stats;
            }, [asinCoverageData]);
            
            // Toggle expand
            const toggleExpand = (asin) => {
                const newExpanded = new Set(expandedAsins);
                if (newExpanded.has(asin)) {
                    newExpanded.delete(asin);
                } else {
                    newExpanded.add(asin);
                }
                setExpandedAsins(newExpanded);
            };
            
            // Handle sort
            const handleSort = (key) => {
                setSortConfig(prev => ({
                    key,
                    direction: prev.key === key && prev.direction === 'desc' ? 'asc' : 'desc'
                }));
            };
            
            // Export to CSV
            const exportToCsv = () => {
                const headers = ['ASIN', 'SKUs', 'Coverage', 'Status', 'Has Product Ads', 'Has Product Targeting', 
                    'Impressions', 'Clicks', 'Spend', 'Sales', 'ACOS', 'CTR', 'CPC', 'Conv Rate', 'Campaigns', 'Portfolios'];
                
                const rows = filteredData.map(entry => [
                    entry.asin,
                    entry.skus.join('; '),
                    entry.coverage,
                    entry.status,
                    entry.hasProductAds ? 'Yes' : 'No',
                    entry.hasProductTargeting ? 'Yes' : 'No',
                    entry.metrics.impressions,
                    entry.metrics.clicks,
                    entry.metrics.spend.toFixed(2),
                    entry.metrics.sales.toFixed(2),
                    entry.acos.toFixed(2) + '%',
                    entry.ctr.toFixed(2) + '%',
                    entry.cpc.toFixed(2),
                    entry.convRate.toFixed(2) + '%',
                    entry.campaigns.join('; '),
                    entry.portfolios.join('; ')
                ]);
                
                const csvContent = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `asin-coverage-report-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            };
            
            // Format number helper
            const formatNum = (num, decimals = 0) => {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toFixed(decimals);
            };
            
            // Get ACOS color
            const getAcosColor = (acos) => {
                if (acos === 0) return 'text-gray-400';
                if (acos <= 25) return 'text-green-600';
                if (acos <= 50) return 'text-yellow-600';
                return 'text-red-600';
            };
            
            // Get coverage badge
            const getCoverageBadge = (coverage) => {
                switch (coverage) {
                    case 'full': return <span className="px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">Full</span>;
                    case 'partial': return <span className="px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">Partial</span>;
                    default: return <span className="px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">Missing</span>;
                }
            };
            
            // Get status badge
            const getStatusBadge = (status) => {
                switch (status) {
                    case 'enabled': return <span className="px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">Enabled</span>;
                    case 'paused': return <span className="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">Paused</span>;
                    default: return <span className="px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-600">None</span>;
                }
            };
            
            // Sort indicator
            const SortIndicator = ({ column }) => {
                if (sortConfig.key !== column) return <span className="text-gray-300 ml-1">‚Üï</span>;
                return <span className="text-cyan-600 ml-1">{sortConfig.direction === 'asc' ? '‚Üë' : '‚Üì'}</span>;
            };
            
            return (
                <div className="space-y-4">
                    {/* Summary Cards */}
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
                        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                            <div className="text-2xl font-bold text-gray-900">{summaryStats.totalAsins}</div>
                            <div className="text-xs text-gray-500">Total ASINs</div>
                        </div>
                        <div className="bg-green-50 rounded-xl p-4 shadow-sm border border-green-200">
                            <div className="text-2xl font-bold text-green-700">{summaryStats.fullCoverage}</div>
                            <div className="text-xs text-green-600">Full Coverage</div>
                        </div>
                        <div className="bg-yellow-50 rounded-xl p-4 shadow-sm border border-yellow-200">
                            <div className="text-2xl font-bold text-yellow-700">{summaryStats.partialCoverage}</div>
                            <div className="text-xs text-yellow-600">Partial Coverage</div>
                        </div>
                        <div className="bg-red-50 rounded-xl p-4 shadow-sm border border-red-200">
                            <div className="text-2xl font-bold text-red-700">{summaryStats.missingCoverage}</div>
                            <div className="text-xs text-red-600">Missing Coverage</div>
                        </div>
                        <div className="bg-blue-50 rounded-xl p-4 shadow-sm border border-blue-200">
                            <div className="text-2xl font-bold text-blue-700">${formatNum(summaryStats.totalSpend, 0)}</div>
                            <div className="text-xs text-blue-600">Total Spend</div>
                        </div>
                        <div className="bg-purple-50 rounded-xl p-4 shadow-sm border border-purple-200">
                            <div className="text-2xl font-bold text-purple-700">${formatNum(summaryStats.totalSales, 0)}</div>
                            <div className="text-xs text-purple-600">Total Sales</div>
                        </div>
                        <div className="bg-cyan-50 rounded-xl p-4 shadow-sm border border-cyan-200">
                            <div className={`text-2xl font-bold ${getAcosColor(summaryStats.overallAcos)}`}>
                                {summaryStats.overallAcos.toFixed(1)}%
                            </div>
                            <div className="text-xs text-cyan-600">Overall ACOS</div>
                        </div>
                    </div>
                    
                    {/* Filters */}
                    <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                        <div className="flex flex-wrap gap-3 items-center">
                            <div className="flex-1 min-w-[200px]">
                                <input
                                    type="text"
                                    placeholder="Search ASIN, SKU, or Campaign..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                />
                            </div>
                            <select
                                value={statusFilter}
                                onChange={(e) => setStatusFilter(e.target.value)}
                                className="px-4 py-2 border border-gray-300 rounded-lg text-sm"
                            >
                                <option value="all">All Status</option>
                                <option value="enabled">Enabled</option>
                                <option value="paused">Paused</option>
                                <option value="none">None</option>
                            </select>
                            <select
                                value={coverageFilter}
                                onChange={(e) => setCoverageFilter(e.target.value)}
                                className="px-4 py-2 border border-gray-300 rounded-lg text-sm"
                            >
                                <option value="all">All Coverage</option>
                                <option value="full">Full Coverage</option>
                                <option value="partial">Partial Coverage</option>
                                <option value="missing">Missing</option>
                            </select>
                            {portfolioList.length > 0 && (
                                <select
                                    value={portfolioFilter}
                                    onChange={(e) => setPortfolioFilter(e.target.value)}
                                    className="px-4 py-2 border border-gray-300 rounded-lg text-sm"
                                >
                                    <option value="">All Portfolios</option>
                                    {portfolioList.map(p => (
                                        <option key={p} value={p}>{p}</option>
                                    ))}
                                </select>
                            )}
                            <button
                                onClick={exportToCsv}
                                className="px-4 py-2 bg-cyan-600 text-white rounded-lg text-sm font-medium hover:bg-cyan-700 transition flex items-center gap-2"
                            >
                                üì• Export CSV
                            </button>
                        </div>
                        <div className="mt-2 text-xs text-gray-500">
                            Showing {filteredData.length} of {asinCoverageData.length} ASINs
                        </div>
                    </div>
                    
                    {/* Data Table */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div className="overflow-x-auto" style={{ maxHeight: '60vh' }}>
                            <table className="w-full text-sm">
                                <thead className="bg-gray-50 border-b border-gray-200 sticky top-0">
                                    <tr>
                                        <th className="px-4 py-3 text-left font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onClick={() => handleSort('asin')}>
                                            ASIN <SortIndicator column="asin" />
                                        </th>
                                        <th className="px-4 py-3 text-left font-medium text-gray-700">SKU(s)</th>
                                        <th className="px-4 py-3 text-center font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onClick={() => handleSort('coverage')}>
                                            Coverage <SortIndicator column="coverage" />
                                        </th>
                                        <th className="px-4 py-3 text-center font-medium text-gray-700">Status</th>
                                        <th className="px-4 py-3 text-right font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onClick={() => handleSort('impressions')}>
                                            Impr. <SortIndicator column="impressions" />
                                        </th>
                                        <th className="px-4 py-3 text-right font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onClick={() => handleSort('clicks')}>
                                            Clicks <SortIndicator column="clicks" />
                                        </th>
                                        <th className="px-4 py-3 text-right font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onClick={() => handleSort('spend')}>
                                            Spend <SortIndicator column="spend" />
                                        </th>
                                        <th className="px-4 py-3 text-right font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onClick={() => handleSort('sales')}>
                                            Sales <SortIndicator column="sales" />
                                        </th>
                                        <th className="px-4 py-3 text-right font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onClick={() => handleSort('ctr')}>
                                            CTR <SortIndicator column="ctr" />
                                        </th>
                                        <th className="px-4 py-3 text-right font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onClick={() => handleSort('convRate')}>
                                            CVR <SortIndicator column="convRate" />
                                        </th>
                                        <th className="px-4 py-3 text-right font-medium text-gray-700 cursor-pointer hover:bg-gray-100" onClick={() => handleSort('acos')}>
                                            ACOS <SortIndicator column="acos" />
                                        </th>
                                        <th className="px-4 py-3 text-center font-medium text-gray-700">Details</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {filteredData.map((entry) => (
                                        <React.Fragment key={entry.asin}>
                                            <tr className="hover:bg-gray-50 transition">
                                                <td className="px-4 py-3 font-mono text-xs font-medium text-gray-900">{entry.asin}</td>
                                                <td className="px-4 py-3 text-xs text-gray-600 max-w-[150px] truncate" title={entry.skus.join(', ')}>
                                                    {entry.skus.length > 0 ? entry.skus.slice(0, 2).join(', ') + (entry.skus.length > 2 ? ` +${entry.skus.length - 2}` : '') : '-'}
                                                </td>
                                                <td className="px-4 py-3 text-center">{getCoverageBadge(entry.coverage)}</td>
                                                <td className="px-4 py-3 text-center">{getStatusBadge(entry.status)}</td>
                                                <td className="px-4 py-3 text-right text-xs text-gray-600">{formatNum(entry.metrics.impressions)}</td>
                                                <td className="px-4 py-3 text-right text-xs text-gray-600">{formatNum(entry.metrics.clicks)}</td>
                                                <td className="px-4 py-3 text-right text-xs font-medium text-gray-900">${formatNum(entry.metrics.spend, 2)}</td>
                                                <td className="px-4 py-3 text-right text-xs font-medium text-gray-900">${formatNum(entry.metrics.sales, 2)}</td>
                                                <td className="px-4 py-3 text-right text-xs text-gray-600">
                                                    {entry.ctr > 0 ? entry.ctr.toFixed(2) + '%' : '-'}
                                                </td>
                                                <td className="px-4 py-3 text-right text-xs text-gray-600">
                                                    {entry.convRate > 0 ? entry.convRate.toFixed(2) + '%' : '-'}
                                                </td>
                                                <td className={`px-4 py-3 text-right text-xs font-bold ${getAcosColor(entry.acos)}`}>
                                                    {entry.acos > 0 ? entry.acos.toFixed(1) + '%' : '-'}
                                                </td>
                                                <td className="px-4 py-3 text-center">
                                                    <button
                                                        onClick={() => toggleExpand(entry.asin)}
                                                        className="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded transition"
                                                    >
                                                        {expandedAsins.has(entry.asin) ? '‚ñ≤ Less' : '‚ñº More'}
                                                    </button>
                                                </td>
                                            </tr>
                                            {expandedAsins.has(entry.asin) && (
                                                <tr>
                                                    <td colSpan="12" className="px-4 py-4 bg-gray-50">
                                                        <div className="space-y-4">
                                                            {/* Coverage Status */}
                                                            <div className="grid grid-cols-2 gap-4">
                                                                <div className={`p-3 rounded-lg border ${entry.hasProductAds ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                                                    <div className="flex items-center gap-2 mb-2">
                                                                        <span className="text-lg">{entry.hasProductAds ? '‚úÖ' : '‚ùå'}</span>
                                                                        <span className="font-semibold text-sm">Product Ads</span>
                                                                        <span className="text-xs text-gray-500">({entry.productAds.length} found)</span>
                                                                    </div>
                                                                    {entry.productAds.length > 0 ? (
                                                                        <div className="space-y-1 max-h-32 overflow-y-auto">
                                                                            {entry.productAds.map((pa, idx) => (
                                                                                <div key={idx} className="text-xs p-2 bg-white rounded border border-gray-200">
                                                                                    <div className="flex justify-between">
                                                                                        <span className="font-medium truncate max-w-[200px]" title={pa.campaign}>{pa.campaign}</span>
                                                                                        <span className={`px-1.5 py-0.5 rounded text-[10px] ${pa.state === 'enabled' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>
                                                                                            {pa.state}
                                                                                        </span>
                                                                                    </div>
                                                                                    <div className="text-gray-500 truncate" title={pa.adGroup}>{pa.adGroup} ‚Ä¢ SKU: {pa.sku}</div>
                                                                                    <div className="text-gray-400 mt-1">
                                                                                        Spend: ${pa.spend.toFixed(2)} ‚Ä¢ Sales: ${pa.sales.toFixed(2)}
                                                                                    </div>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    ) : (
                                                                        <div className="text-xs text-red-600 p-2 bg-white rounded border border-red-200">
                                                                            ‚ö†Ô∏è No Product Ads found for this ASIN. Consider adding it as a Product Ad.
                                                                        </div>
                                                                    )}
                                                                </div>
                                                                
                                                                <div className={`p-3 rounded-lg border ${entry.hasProductTargeting ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                                                    <div className="flex items-center gap-2 mb-2">
                                                                        <span className="text-lg">{entry.hasProductTargeting ? '‚úÖ' : '‚ùå'}</span>
                                                                        <span className="font-semibold text-sm">Product Targeting</span>
                                                                        <span className="text-xs text-gray-500">({entry.productTargeting.length} found)</span>
                                                                    </div>
                                                                    {entry.productTargeting.length > 0 ? (
                                                                        <div className="space-y-1 max-h-32 overflow-y-auto">
                                                                            {entry.productTargeting.map((pt, idx) => (
                                                                                <div key={idx} className="text-xs p-2 bg-white rounded border border-gray-200">
                                                                                    <div className="flex justify-between">
                                                                                        <span className="font-medium truncate max-w-[200px]" title={pt.campaign}>{pt.campaign}</span>
                                                                                        <span className={`px-1.5 py-0.5 rounded text-[10px] ${pt.state === 'enabled' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>
                                                                                            {pt.state}
                                                                                        </span>
                                                                                    </div>
                                                                                    <div className="text-gray-500 truncate" title={pt.adGroup}>{pt.adGroup} ‚Ä¢ Bid: {pt.bid}</div>
                                                                                    <div className="text-gray-400 mt-1">
                                                                                        Spend: ${pt.spend.toFixed(2)} ‚Ä¢ Sales: ${pt.sales.toFixed(2)}
                                                                                    </div>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    ) : (
                                                                        <div className="text-xs text-red-600 p-2 bg-white rounded border border-red-200">
                                                                            ‚ö†Ô∏è No Product Targeting found for this ASIN. Consider adding ASIN targeting.
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Additional Info */}
                                                            <div className="grid grid-cols-3 gap-4 text-xs">
                                                                <div className="bg-white p-3 rounded-lg border border-gray-200">
                                                                    <div className="font-semibold text-gray-700 mb-1">Portfolios</div>
                                                                    <div className="text-gray-600">{entry.portfolios.length > 0 ? entry.portfolios.join(', ') : 'None'}</div>
                                                                </div>
                                                                <div className="bg-white p-3 rounded-lg border border-gray-200">
                                                                    <div className="font-semibold text-gray-700 mb-1">Campaigns ({entry.campaigns.length})</div>
                                                                    <div className="text-gray-600 max-h-16 overflow-y-auto">{entry.campaigns.join(', ')}</div>
                                                                </div>
                                                                <div className="bg-white p-3 rounded-lg border border-gray-200">
                                                                    <div className="font-semibold text-gray-700 mb-1">Additional Metrics</div>
                                                                    <div className="text-gray-600">
                                                                        CTR: {entry.ctr.toFixed(2)}% ‚Ä¢ CPC: ${entry.cpc.toFixed(2)} ‚Ä¢ Conv: {entry.convRate.toFixed(2)}%
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                        </React.Fragment>
                                    ))}
                                </tbody>
                            </table>
                            {filteredData.length === 0 && (
                                <div className="text-center py-12 text-gray-500">
                                    <div className="text-4xl mb-3">üìä</div>
                                    <div className="font-medium">No ASINs Found</div>
                                    <div className="text-sm">Try adjusting your filters or upload a bulksheet with Product Ads/Targeting</div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // MATCH TYPE COVERAGE VIEW - ROI-Focused Analysis
        // ============================================
        function MatchTypeCoverageView({ data, allData }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [sortConfig, setSortConfig] = useState({ key: 'spend', direction: 'desc' });
            const [expandedMatchTypes, setExpandedMatchTypes] = useState(new Set());
            const [selectedColumn, setSelectedColumn] = useState(null);
            const [showColumnSelector, setShowColumnSelector] = useState(false);
            
            // All available columns
            const allColumns = [
                { key: 'matchType', label: 'Match Type', sortable: true },
                { key: 'impressions', label: 'Impressions', sortable: true, format: 'number' },
                { key: 'clicks', label: 'Clicks', sortable: true, format: 'number' },
                { key: 'orders', label: 'Orders', sortable: true, format: 'number' },
                { key: 'units', label: 'Units', sortable: true, format: 'number' },
                { key: 'sales', label: 'Sales', sortable: true, format: 'currency' },
                { key: 'spend', label: 'Spend', sortable: true, format: 'currency' },
                { key: 'cpc', label: 'CPC', sortable: true, format: 'currency' },
                { key: 'ctr', label: 'CTR', sortable: true, format: 'percent' },
                { key: 'acos', label: 'ACOS', sortable: true, format: 'percent' },
                { key: 'roas', label: 'ROAS', sortable: true, format: 'decimal' },
                { key: 'convRate', label: 'Conversion', sortable: true, format: 'percent' },
            ];
            
            const [visibleColumns, setVisibleColumns] = useState([
                'matchType', 'impressions', 'clicks', 'orders', 'units', 'sales', 'spend', 'cpc', 'ctr', 'acos', 'roas'
            ]);
            
            // Parse number helper (handles European format)
            const parseNum = (val) => {
                if (val === null || val === undefined || val === '') return 0;
                const str = String(val).replace(/[^0-9.,-]/g, '');
                if (str.includes(',') && str.includes('.')) {
                    if (str.lastIndexOf(',') > str.lastIndexOf('.')) {
                        return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
                    }
                    return parseFloat(str.replace(/,/g, '')) || 0;
                }
                if (str.includes(',') && !str.includes('.')) {
                    const parts = str.split(',');
                    if (parts.length === 2 && parts[1].length <= 2) {
                        return parseFloat(str.replace(',', '.')) || 0;
                    }
                    return parseFloat(str.replace(/,/g, '')) || 0;
                }
                return parseFloat(str) || 0;
            };
            
            // Get helpers
            const getCampaignName = (row) => row['Campaign Name'] || row['Campaign Name (Informational only)'] || '-';
            const getAdGroupName = (row) => row['Ad Group Name'] || row['Ad Group Name (Informational only)'] || '-';
            const getPortfolioName = (row) => row['Portfolio Name (Informational only)'] || row['Portfolio Name'] || '-';
            
            // Get ALL ASINs in the account (from Product Ads)
            const allAsins = useMemo(() => {
                const asinSet = new Set();
                const asinDetails = new Map();
                
                allData.filter(r => r.Entity === 'Product Ad').forEach(row => {
                    const asin = (row['ASIN (Informational only)'] || '').toUpperCase();
                    if (asin && asin.length === 10) {
                        asinSet.add(asin);
                        if (!asinDetails.has(asin)) {
                            asinDetails.set(asin, {
                                asin,
                                sku: row.SKU || '-',
                                portfolios: new Set(),
                                campaigns: new Set()
                            });
                        }
                        const detail = asinDetails.get(asin);
                        const portfolio = getPortfolioName(row);
                        if (portfolio !== '-') detail.portfolios.add(portfolio);
                        detail.campaigns.add(getCampaignName(row));
                    }
                });
                
                return { set: asinSet, details: asinDetails };
            }, [allData]);
            
            // Build Match Type coverage data
            const matchTypeCoverageData = useMemo(() => {
                const matchTypeMap = new Map();
                
                // Process Keywords
                allData.filter(r => r.Entity === 'Keyword').forEach(row => {
                    const matchType = row['Match Type'] || 'Unknown';
                    const state = (row.State || '').toLowerCase();
                    const asin = (row['ASIN (Informational only)'] || '').toUpperCase();
                    
                    if (!matchTypeMap.has(matchType)) {
                        matchTypeMap.set(matchType, {
                            matchType,
                            category: matchType.startsWith('Negative') ? 'Negative' : 'Keyword',
                            metrics: { impressions: 0, clicks: 0, orders: 0, units: 0, spend: 0, sales: 0 },
                            activeAsins: new Set(),
                            pausedAsins: new Map(), // Map to store ASIN -> pause details
                            locations: [] // Where this match type is used
                        });
                    }
                    
                    const entry = matchTypeMap.get(matchType);
                    entry.metrics.impressions += parseNum(row.Impressions);
                    entry.metrics.clicks += parseNum(row.Clicks);
                    entry.metrics.orders += parseNum(row.Orders);
                    entry.metrics.units += parseNum(row.Units);
                    entry.metrics.spend += parseNum(row.Spend);
                    entry.metrics.sales += parseNum(row.Sales);
                    
                    // Track which ASINs have this match type
                    // We need to find the ASIN for this keyword's ad group
                    const adGroupId = row['Ad Group ID'];
                    const campaignId = row['Campaign ID'];
                    
                    // Find Product Ads in the same Ad Group to get ASINs
                    const relatedProductAds = allData.filter(r => 
                        r.Entity === 'Product Ad' && 
                        r['Ad Group ID'] === adGroupId
                    );
                    
                    relatedProductAds.forEach(pa => {
                        const paAsin = (pa['ASIN (Informational only)'] || '').toUpperCase();
                        if (paAsin && paAsin.length === 10) {
                            if (state === 'enabled') {
                                entry.activeAsins.add(paAsin);
                            } else if (state === 'paused') {
                                if (!entry.pausedAsins.has(paAsin)) {
                                    entry.pausedAsins.set(paAsin, []);
                                }
                                entry.pausedAsins.get(paAsin).push({
                                    campaign: getCampaignName(row),
                                    adGroup: getAdGroupName(row),
                                    keyword: row['Keyword Text'] || '-',
                                    bid: row.Bid || '-'
                                });
                            }
                            
                            entry.locations.push({
                                asin: paAsin,
                                campaign: getCampaignName(row),
                                adGroup: getAdGroupName(row),
                                keyword: row['Keyword Text'] || '-',
                                bid: row.Bid || '-',
                                state: state
                            });
                        }
                    });
                });
                
                // Process Product Targeting (SP Product, SP Category, Auto types, etc.)
                allData.filter(r => r.Entity === 'Product Targeting').forEach(row => {
                    const expression = row['Product Targeting Expression'] || '';
                    const state = (row.State || '').toLowerCase();
                    
                    // Determine targeting type - check Auto types FIRST
                    let matchType = null;
                    let category = 'Product Targeting';
                    
                    // Auto targeting types (check these first!)
                    // Amazon bulksheet uses: close-match, loose-match, substitutes, complements
                    // API uses: queryHighRelMatches, queryBroadRelMatches, etc.
                    if (expression.includes('close-match') || expression.includes('queryHighRelMatches')) {
                        matchType = 'Auto Close Match';
                        category = 'Auto';
                    } else if (expression.includes('loose-match') || expression.includes('queryBroadRelMatches')) {
                        matchType = 'Auto Loose Match';
                        category = 'Auto';
                    } else if (expression.includes('substitutes') || expression.includes('querySubstituteMatches')) {
                        matchType = 'Auto Substitutes';
                        category = 'Auto';
                    } else if (expression.includes('complements') || expression.includes('queryComplementMatches')) {
                        matchType = 'Auto Complements';
                        category = 'Auto';
                    }
                    // Manual product targeting types
                    else if (expression.includes('category=')) {
                        matchType = 'SP Category';
                    } else if (expression.includes('asin-expanded=') || expression.includes('expanded-asin=')) {
                        matchType = 'SP Product Expanded';
                    } else if (expression.includes('asin=') || expression.includes('asin"')) {
                        matchType = 'SP Product';
                    } else {
                        // Skip unknown expressions
                        return;
                    }
                    
                    if (!matchTypeMap.has(matchType)) {
                        matchTypeMap.set(matchType, {
                            matchType,
                            category: category,
                            metrics: { impressions: 0, clicks: 0, orders: 0, units: 0, spend: 0, sales: 0 },
                            activeAsins: new Set(),
                            pausedAsins: new Map(),
                            locations: []
                        });
                    }
                    
                    const entry = matchTypeMap.get(matchType);
                    entry.metrics.impressions += parseNum(row.Impressions);
                    entry.metrics.clicks += parseNum(row.Clicks);
                    entry.metrics.orders += parseNum(row.Orders);
                    entry.metrics.units += parseNum(row.Units);
                    entry.metrics.spend += parseNum(row.Spend);
                    entry.metrics.sales += parseNum(row.Sales);
                    
                    // Find ASINs in the same ad group
                    const adGroupId = row['Ad Group ID'];
                    const relatedProductAds = allData.filter(r => 
                        r.Entity === 'Product Ad' && 
                        r['Ad Group ID'] === adGroupId
                    );
                    
                    relatedProductAds.forEach(pa => {
                        const paAsin = (pa['ASIN (Informational only)'] || '').toUpperCase();
                        if (paAsin && paAsin.length === 10) {
                            if (state === 'enabled') {
                                entry.activeAsins.add(paAsin);
                            } else if (state === 'paused') {
                                if (!entry.pausedAsins.has(paAsin)) {
                                    entry.pausedAsins.set(paAsin, []);
                                }
                                entry.pausedAsins.get(paAsin).push({
                                    campaign: getCampaignName(row),
                                    adGroup: getAdGroupName(row),
                                    expression: expression,
                                    bid: row.Bid || '-'
                                });
                            }
                            
                            entry.locations.push({
                                asin: paAsin,
                                campaign: getCampaignName(row),
                                adGroup: getAdGroupName(row),
                                expression: expression,
                                bid: row.Bid || '-',
                                state: state
                            });
                        }
                    });
                });
                
                // Calculate derived metrics and coverage gaps
                return Array.from(matchTypeMap.values()).map(entry => {
                    const m = entry.metrics;
                    
                    // Find missing ASINs (ASINs in account but NOT in this match type)
                    const missingAsins = [];
                    allAsins.set.forEach(asin => {
                        if (!entry.activeAsins.has(asin) && !entry.pausedAsins.has(asin)) {
                            const detail = allAsins.details.get(asin);
                            missingAsins.push({
                                asin,
                                sku: detail?.sku || '-',
                                portfolios: detail?.portfolios ? Array.from(detail.portfolios) : [],
                                campaigns: detail?.campaigns ? Array.from(detail.campaigns) : []
                            });
                        }
                    });
                    
                    // Convert paused ASINs map to array
                    const pausedAsinsList = [];
                    entry.pausedAsins.forEach((details, asin) => {
                        const asinDetail = allAsins.details.get(asin);
                        pausedAsinsList.push({
                            asin,
                            sku: asinDetail?.sku || '-',
                            portfolios: asinDetail?.portfolios ? Array.from(asinDetail.portfolios) : [],
                            pausedIn: details
                        });
                    });
                    
                    return {
                        ...entry,
                        impressions: m.impressions,
                        clicks: m.clicks,
                        orders: m.orders,
                        units: m.units,
                        spend: m.spend,
                        sales: m.sales,
                        cpc: m.clicks > 0 ? m.spend / m.clicks : 0,
                        ctr: m.impressions > 0 ? (m.clicks / m.impressions * 100) : 0,
                        acos: m.sales > 0 ? (m.spend / m.sales * 100) : 0,
                        roas: m.spend > 0 ? (m.sales / m.spend) : 0,
                        convRate: m.clicks > 0 ? (m.orders / m.clicks * 100) : 0,
                        activeCount: entry.activeAsins.size,
                        pausedCount: entry.pausedAsins.size,
                        missingCount: missingAsins.length,
                        missingAsins,
                        pausedAsinsList,
                        totalAsins: allAsins.set.size,
                        coveragePercent: allAsins.set.size > 0 
                            ? ((entry.activeAsins.size / allAsins.set.size) * 100) 
                            : 0
                    };
                }).filter(e => e.spend > 0 || e.activeCount > 0 || e.pausedCount > 0);
            }, [allData, allAsins]);
            
            // Sort data
            const sortedData = useMemo(() => {
                let result = [...matchTypeCoverageData];
                
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    result = result.filter(e => e.matchType.toLowerCase().includes(term));
                }
                
                result.sort((a, b) => {
                    let aVal = a[sortConfig.key];
                    let bVal = b[sortConfig.key];
                    
                    if (typeof aVal === 'string') {
                        return sortConfig.direction === 'asc' 
                            ? aVal.localeCompare(bVal) 
                            : bVal.localeCompare(aVal);
                    }
                    return sortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal;
                });
                
                return result;
            }, [matchTypeCoverageData, sortConfig, searchTerm]);
            
            // Totals row
            const totals = useMemo(() => {
                const t = { impressions: 0, clicks: 0, orders: 0, units: 0, spend: 0, sales: 0 };
                sortedData.forEach(e => {
                    t.impressions += e.impressions;
                    t.clicks += e.clicks;
                    t.orders += e.orders;
                    t.units += e.units;
                    t.spend += e.spend;
                    t.sales += e.sales;
                });
                return {
                    ...t,
                    cpc: t.clicks > 0 ? t.spend / t.clicks : 0,
                    ctr: t.impressions > 0 ? (t.clicks / t.impressions * 100) : 0,
                    acos: t.sales > 0 ? (t.spend / t.sales * 100) : 0,
                    roas: t.spend > 0 ? (t.sales / t.spend) : 0,
                    convRate: t.clicks > 0 ? (t.orders / t.clicks * 100) : 0
                };
            }, [sortedData]);
            
            // Format helpers
            const formatNum = (num) => {
                if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
                if (num >= 1000) return num.toLocaleString('de-DE', { maximumFractionDigits: 0 });
                return num.toLocaleString('de-DE', { maximumFractionDigits: 0 });
            };
            
            const formatCurrency = (num) => {
                return num.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
            };
            
            const formatPercent = (num) => {
                return num.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '%';
            };
            
            const formatValue = (value, format) => {
                switch (format) {
                    case 'currency': return formatCurrency(value);
                    case 'percent': return formatPercent(value);
                    case 'decimal': return value.toFixed(2);
                    case 'number': return formatNum(value);
                    default: return value;
                }
            };
            
            // Toggle expand
            const toggleExpand = (matchType) => {
                const newExpanded = new Set(expandedMatchTypes);
                if (newExpanded.has(matchType)) {
                    newExpanded.delete(matchType);
                } else {
                    newExpanded.add(matchType);
                }
                setExpandedMatchTypes(newExpanded);
            };
            
            // Handle sort
            const handleSort = (key) => {
                setSortConfig(prev => ({
                    key,
                    direction: prev.key === key && prev.direction === 'desc' ? 'asc' : 'desc'
                }));
            };
            
            // Sort indicator
            const SortIndicator = ({ column }) => {
                const isActive = sortConfig.key === column;
                return (
                    <span className={`ml-1 inline-flex flex-col text-[8px] leading-none ${isActive ? 'text-cyan-600' : 'text-gray-300'}`}>
                        <span className={sortConfig.key === column && sortConfig.direction === 'asc' ? 'text-cyan-600' : ''}>‚ñ≤</span>
                        <span className={sortConfig.key === column && sortConfig.direction === 'desc' ? 'text-cyan-600' : ''}>‚ñº</span>
                    </span>
                );
            };
            
            // Get ACOS color
            const getAcosColor = (acos) => {
                if (acos === 0) return 'text-gray-400';
                if (acos <= 20) return 'text-green-600';
                if (acos <= 35) return 'text-yellow-600';
                return 'text-red-600';
            };
            
            // Get ROAS color
            const getRoasColor = (roas) => {
                if (roas === 0) return 'text-gray-400';
                if (roas >= 5) return 'text-green-600';
                if (roas >= 2.5) return 'text-yellow-600';
                return 'text-red-600';
            };
            
            // Get coverage badge color
            const getCoverageBadgeColor = (percent) => {
                if (percent >= 80) return 'bg-green-100 text-green-700';
                if (percent >= 50) return 'bg-yellow-100 text-yellow-700';
                return 'bg-red-100 text-red-700';
            };
            
            return (
                <div className="space-y-4">
                    {/* Header */}
                    <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h2 className="text-lg font-bold text-gray-900">Match Type Coverage Analysis</h2>
                                <p className="text-sm text-gray-500">See performance by match type and identify coverage gaps for maximum ROI</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="relative">
                                    <input
                                        type="text"
                                        placeholder="üîç Search match types..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 focus:border-transparent w-64"
                                    />
                                </div>
                                <button
                                    onClick={() => setShowColumnSelector(!showColumnSelector)}
                                    className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 flex items-center gap-2"
                                >
                                    <span>‚ò∞</span> Columns
                                </button>
                            </div>
                        </div>
                        
                        {/* Column selector dropdown */}
                        {showColumnSelector && (
                            <div className="absolute right-8 mt-2 bg-white border border-gray-200 rounded-lg shadow-xl p-4 z-50 w-64">
                                <div className="text-sm font-medium text-gray-700 mb-2">Show/Hide Columns</div>
                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                    {allColumns.filter(c => c.key !== 'matchType').map(col => (
                                        <label key={col.key} className="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-1 rounded">
                                            <input
                                                type="checkbox"
                                                checked={visibleColumns.includes(col.key)}
                                                onChange={(e) => {
                                                    if (e.target.checked) {
                                                        setVisibleColumns([...visibleColumns, col.key]);
                                                    } else {
                                                        setVisibleColumns(visibleColumns.filter(c => c !== col.key));
                                                    }
                                                }}
                                                className="rounded text-cyan-600"
                                            />
                                            {col.label}
                                        </label>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* Summary Stats */}
                        <div className="grid grid-cols-4 gap-4">
                            <div className="bg-blue-50 rounded-lg p-3 border border-blue-200">
                                <div className="text-2xl font-bold text-blue-700">{allAsins.set.size}</div>
                                <div className="text-xs text-blue-600">Total ASINs in Account</div>
                            </div>
                            <div className="bg-green-50 rounded-lg p-3 border border-green-200">
                                <div className="text-2xl font-bold text-green-700">{sortedData.length}</div>
                                <div className="text-xs text-green-600">Active Match Types</div>
                            </div>
                            <div className="bg-purple-50 rounded-lg p-3 border border-purple-200">
                                <div className="text-2xl font-bold text-purple-700">{formatCurrency(totals.spend)}</div>
                                <div className="text-xs text-purple-600">Total Spend</div>
                            </div>
                            <div className="bg-cyan-50 rounded-lg p-3 border border-cyan-200">
                                <div className={`text-2xl font-bold ${getAcosColor(totals.acos)}`}>{formatPercent(totals.acos)}</div>
                                <div className="text-xs text-cyan-600">Overall ACOS</div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Main Table */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th className="w-8 px-2 py-3"></th>
                                        {allColumns.filter(c => visibleColumns.includes(c.key)).map(col => (
                                            <th 
                                                key={col.key}
                                                className={`px-4 py-3 text-left font-medium text-gray-700 cursor-pointer hover:bg-gray-100 whitespace-nowrap ${col.key === 'matchType' ? 'sticky left-0 bg-gray-50 z-10' : ''}`}
                                                onClick={() => col.sortable && handleSort(col.key)}
                                            >
                                                <div className="flex items-center">
                                                    {col.label}
                                                    {col.sortable && <SortIndicator column={col.key} />}
                                                </div>
                                            </th>
                                        ))}
                                        <th className="px-4 py-3 text-center font-medium text-gray-700">Coverage</th>
                                        <th className="px-4 py-3 text-center font-medium text-gray-700">Gaps</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {sortedData.map((entry, idx) => (
                                        <React.Fragment key={entry.matchType}>
                                            <tr 
                                                className={`hover:bg-gray-50 cursor-pointer ${expandedMatchTypes.has(entry.matchType) ? 'bg-cyan-50' : ''}`}
                                                onClick={() => toggleExpand(entry.matchType)}
                                            >
                                                <td className="px-2 py-3 text-center">
                                                    <span className={`text-gray-400 transition-transform inline-block ${expandedMatchTypes.has(entry.matchType) ? 'rotate-90' : ''}`}>
                                                        ‚ñ∂
                                                    </span>
                                                </td>
                                                {allColumns.filter(c => visibleColumns.includes(c.key)).map(col => (
                                                    <td 
                                                        key={col.key} 
                                                        className={`px-4 py-3 ${col.key === 'matchType' ? 'sticky left-0 bg-white font-medium text-gray-900 z-10' : 'text-gray-600'} ${col.key === 'acos' ? getAcosColor(entry.acos) : ''} ${col.key === 'roas' ? getRoasColor(entry.roas) : ''}`}
                                                    >
                                                        {col.format ? formatValue(entry[col.key], col.format) : entry[col.key]}
                                                    </td>
                                                ))}
                                                <td className="px-4 py-3 text-center">
                                                    <div className="flex items-center justify-center gap-2">
                                                        <div className={`px-2 py-1 rounded-full text-xs font-medium ${getCoverageBadgeColor(entry.coveragePercent)}`}>
                                                            {entry.coveragePercent.toFixed(0)}%
                                                        </div>
                                                        <span className="text-xs text-gray-400">
                                                            ({entry.activeCount}/{entry.totalAsins})
                                                        </span>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3 text-center">
                                                    <div className="flex items-center justify-center gap-2">
                                                        {entry.missingCount > 0 && (
                                                            <span className="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium" title="Missing - opportunity to expand">
                                                                {entry.missingCount} missing
                                                            </span>
                                                        )}
                                                        {entry.pausedCount > 0 && (
                                                            <span className="px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-medium" title="Paused - review for reactivation">
                                                                {entry.pausedCount} paused
                                                            </span>
                                                        )}
                                                        {entry.missingCount === 0 && entry.pausedCount === 0 && (
                                                            <span className="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                                                                ‚úì Full
                                                            </span>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                            
                                            {/* Expanded Row - Coverage Gap Details */}
                                            {expandedMatchTypes.has(entry.matchType) && (
                                                <tr>
                                                    <td colSpan={visibleColumns.length + 3} className="bg-gray-50 p-0">
                                                        <div className="p-4 border-t border-gray-200">
                                                            <div className="grid grid-cols-2 gap-4">
                                                                {/* Missing ASINs */}
                                                                <div className="bg-white rounded-lg border border-red-200 overflow-hidden">
                                                                    <div className="bg-red-50 px-4 py-2 border-b border-red-200 flex items-center justify-between">
                                                                        <div className="flex items-center gap-2">
                                                                            <span className="text-red-600 font-bold">üéØ</span>
                                                                            <span className="font-semibold text-red-800">Missing ASINs</span>
                                                                            <span className="text-xs text-red-600">({entry.missingCount} opportunities)</span>
                                                                        </div>
                                                                        <span className="text-xs text-red-500">ASINs without {entry.matchType}</span>
                                                                    </div>
                                                                    <div className="max-h-64 overflow-y-auto">
                                                                        {entry.missingAsins.length > 0 ? (
                                                                            <table className="w-full text-xs">
                                                                                <thead className="bg-gray-50 sticky top-0">
                                                                                    <tr>
                                                                                        <th className="px-3 py-2 text-left text-gray-600">ASIN</th>
                                                                                        <th className="px-3 py-2 text-left text-gray-600">SKU</th>
                                                                                        <th className="px-3 py-2 text-left text-gray-600">Portfolio</th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody className="divide-y divide-gray-100">
                                                                                    {entry.missingAsins.slice(0, 50).map((asin, i) => (
                                                                                        <tr key={i} className="hover:bg-red-50">
                                                                                            <td className="px-3 py-2 font-mono text-gray-900">{asin.asin}</td>
                                                                                            <td className="px-3 py-2 text-gray-600">{asin.sku}</td>
                                                                                            <td className="px-3 py-2 text-gray-600">{asin.portfolios.join(', ') || '-'}</td>
                                                                                        </tr>
                                                                                    ))}
                                                                                </tbody>
                                                                            </table>
                                                                        ) : (
                                                                            <div className="p-4 text-center text-green-600">
                                                                                <span className="text-2xl">‚úì</span>
                                                                                <div className="text-sm mt-1">All ASINs have {entry.matchType} coverage!</div>
                                                                            </div>
                                                                        )}
                                                                        {entry.missingAsins.length > 50 && (
                                                                            <div className="px-3 py-2 bg-gray-50 text-xs text-gray-500 text-center">
                                                                                ... and {entry.missingAsins.length - 50} more
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                
                                                                {/* Paused ASINs */}
                                                                <div className="bg-white rounded-lg border border-orange-200 overflow-hidden">
                                                                    <div className="bg-orange-50 px-4 py-2 border-b border-orange-200 flex items-center justify-between">
                                                                        <div className="flex items-center gap-2">
                                                                            <span className="text-orange-600 font-bold">‚è∏Ô∏è</span>
                                                                            <span className="font-semibold text-orange-800">Paused ASINs</span>
                                                                            <span className="text-xs text-orange-600">({entry.pausedCount} to review)</span>
                                                                        </div>
                                                                        <span className="text-xs text-orange-500">Has {entry.matchType} but paused</span>
                                                                    </div>
                                                                    <div className="max-h-64 overflow-y-auto">
                                                                        {entry.pausedAsinsList.length > 0 ? (
                                                                            <table className="w-full text-xs">
                                                                                <thead className="bg-gray-50 sticky top-0">
                                                                                    <tr>
                                                                                        <th className="px-3 py-2 text-left text-gray-600">ASIN</th>
                                                                                        <th className="px-3 py-2 text-left text-gray-600">SKU</th>
                                                                                        <th className="px-3 py-2 text-left text-gray-600">Paused In</th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody className="divide-y divide-gray-100">
                                                                                    {entry.pausedAsinsList.slice(0, 50).map((asin, i) => (
                                                                                        <tr key={i} className="hover:bg-orange-50">
                                                                                            <td className="px-3 py-2 font-mono text-gray-900">{asin.asin}</td>
                                                                                            <td className="px-3 py-2 text-gray-600">{asin.sku}</td>
                                                                                            <td className="px-3 py-2 text-gray-600 text-xs">
                                                                                                {asin.pausedIn.slice(0, 2).map((p, j) => (
                                                                                                    <div key={j} className="truncate max-w-[200px]" title={`${p.campaign} / ${p.adGroup}`}>
                                                                                                        {p.campaign}
                                                                                                    </div>
                                                                                                ))}
                                                                                                {asin.pausedIn.length > 2 && (
                                                                                                    <div className="text-orange-500">+{asin.pausedIn.length - 2} more</div>
                                                                                                )}
                                                                                            </td>
                                                                                        </tr>
                                                                                    ))}
                                                                                </tbody>
                                                                            </table>
                                                                        ) : (
                                                                            <div className="p-4 text-center text-green-600">
                                                                                <span className="text-2xl">‚úì</span>
                                                                                <div className="text-sm mt-1">No paused {entry.matchType} campaigns!</div>
                                                                            </div>
                                                                        )}
                                                                        {entry.pausedAsinsList.length > 50 && (
                                                                            <div className="px-3 py-2 bg-gray-50 text-xs text-gray-500 text-center">
                                                                                ... and {entry.pausedAsinsList.length - 50} more
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* ROI Insight */}
                                                            {entry.roas > 2 && entry.missingCount > 0 && (
                                                                <div className="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                                                                    <div className="flex items-center gap-2 text-green-800">
                                                                        <span className="text-xl">üí∞</span>
                                                                        <span className="font-semibold">ROI Opportunity:</span>
                                                                        <span className="text-sm">
                                                                            {entry.matchType} has {entry.roas.toFixed(2)}x ROAS. 
                                                                            Adding {entry.missingCount} missing ASINs could significantly increase revenue!
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            
                                                            {entry.acos > 40 && entry.pausedCount > 0 && (
                                                                <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                                                    <div className="flex items-center gap-2 text-yellow-800">
                                                                        <span className="text-xl">‚ö†Ô∏è</span>
                                                                        <span className="font-semibold">Review Suggestion:</span>
                                                                        <span className="text-sm">
                                                                            {entry.matchType} has {entry.acos.toFixed(1)}% ACOS. 
                                                                            The {entry.pausedCount} paused ASINs may have been paused for good reason.
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                        </React.Fragment>
                                    ))}
                                    
                                    {/* Totals Row */}
                                    <tr className="bg-gray-100 font-semibold border-t-2 border-gray-300">
                                        <td className="px-2 py-3"></td>
                                        {allColumns.filter(c => visibleColumns.includes(c.key)).map(col => (
                                            <td 
                                                key={col.key} 
                                                className={`px-4 py-3 ${col.key === 'matchType' ? 'sticky left-0 bg-gray-100 z-10' : ''} ${col.key === 'acos' ? getAcosColor(totals.acos) : ''} ${col.key === 'roas' ? getRoasColor(totals.roas) : ''}`}
                                            >
                                                {col.key === 'matchType' 
                                                    ? `Total (${sortedData.length} types)` 
                                                    : col.format ? formatValue(totals[col.key], col.format) : totals[col.key]
                                                }
                                            </td>
                                        ))}
                                        <td className="px-4 py-3"></td>
                                        <td className="px-4 py-3"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        {sortedData.length === 0 && (
                            <div className="text-center py-12 text-gray-500">
                                <div className="text-4xl mb-3">üìä</div>
                                <div className="font-medium">No Match Types Found</div>
                                <div className="text-sm">Upload a bulksheet with keywords or product targeting to see match type coverage</div>
                            </div>
                        )}
                    </div>
                    
                    {/* Legend */}
                    <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                        <div className="text-sm font-medium text-gray-700 mb-2">Understanding Coverage Gaps</div>
                        <div className="flex flex-wrap gap-4 text-xs text-gray-600">
                            <div className="flex items-center gap-2">
                                <span className="px-2 py-1 bg-red-100 text-red-700 rounded-full font-medium">Missing</span>
                                <span>= ASIN exists but has no campaigns with this match type (opportunity!)</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="px-2 py-1 bg-orange-100 text-orange-700 rounded-full font-medium">Paused</span>
                                <span>= ASIN has this match type but it's currently paused (review for reactivation)</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="px-2 py-1 bg-green-100 text-green-700 rounded-full font-medium">‚úì Full</span>
                                <span>= All ASINs have active coverage for this match type</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function DataTable({ 
            data, 
            activeTab, 
            updateRow,
            setData,
            selectedItems, 
            toggleSelection, 
            selectAll, 
            changes, 
            originalRowMap, 
            columnWidths, 
            setColumnWidths,
            columnFilters,
            setColumnFilters,
            setActiveFilterColumn,
            setFilterPosition,
            columnSort,
            allData,
            isInReferenceList,
            showReferencePanel,
            getAdGroupKeywords,
            undoChange,
            productTargetFilters,
            setProductTargetFilters
        }) {
            const [resizing, setResizing] = useState(null);
            const [expandedAdGroups, setExpandedAdGroups] = useState(new Set());
            const [addKeywordForms, setAddKeywordForms] = useState({});
            const [keywordFormData, setKeywordFormData] = useState({});
            const [keywordSearchTerms, setKeywordSearchTerms] = useState({});
            const [selectedKeywords, setSelectedKeywords] = useState({});
            
            // PERFORMANCE: Limit visible rows for better rendering performance
            const [visibleRowLimit, setVisibleRowLimit] = useState(100);
            const ROW_INCREMENT = 100;
            
            // Reset visible limit when data changes significantly
            useEffect(() => {
                setVisibleRowLimit(100);
            }, [activeTab]);
            
            // PERFORMANCE: Pre-compute index map for O(1) lookups instead of O(n) indexOf
            const allDataIndexMap = useMemo(() => {
                const map = new Map();
                allData.forEach((row, index) => {
                    map.set(row, index);
                });
                return map;
            }, [allData]);
            
            const getActualIndex = useCallback((row) => {
                return allDataIndexMap.get(row) ?? -1;
            }, [allDataIndexMap]);

            const toggleAdGroupExpansion = (adGroupId) => {
                const newExpanded = new Set(expandedAdGroups);
                if (newExpanded.has(adGroupId)) {
                    newExpanded.delete(adGroupId);
                } else {
                    newExpanded.add(adGroupId);
                }
                setExpandedAdGroups(newExpanded);
            };

            const toggleAddKeywordForm = (adGroupId) => {
                setAddKeywordForms(prev => ({
                    ...prev,
                    [adGroupId]: !prev[adGroupId]
                }));
                // Initialize form data for this ad group if it doesn't exist
                if (!keywordFormData[adGroupId]) {
                    setKeywordFormData(prev => ({
                        ...prev,
                        [adGroupId]: { kwText: '', kwBid: '', kwMatch: 'Exact' }
                    }));
                }
            };

            const updateKeywordFormData = (adGroupId, field, value) => {
                setKeywordFormData(prev => ({
                    ...prev,
                    [adGroupId]: {
                        ...((prev[adGroupId] || { kwText: '', kwBid: '', kwMatch: 'Exact' })),
                        [field]: value
                    }
                }));
            };

            const getKeywordFormData = (adGroupId) => {
                return keywordFormData[adGroupId] || { kwText: '', kwBid: '', kwMatch: 'Exact' };
            };

            const toggleKeywordSelection = (adGroupId, keywordId) => {
                setSelectedKeywords(prev => {
                    const adGroupSelections = prev[adGroupId] || new Set();
                    const newSelections = new Set(adGroupSelections);
                    if (newSelections.has(keywordId)) {
                        newSelections.delete(keywordId);
                    } else {
                        newSelections.add(keywordId);
                    }
                    return {
                        ...prev,
                        [adGroupId]: newSelections
                    };
                });
            };

            const toggleAllKeywords = (adGroupId, keywords) => {
                setSelectedKeywords(prev => {
                    const adGroupSelections = prev[adGroupId] || new Set();
                    const allSelected = keywords.every(kw => adGroupSelections.has(kw['Keyword ID']));
                    
                    if (allSelected) {
                        return {
                            ...prev,
                            [adGroupId]: new Set()
                        };
                    } else {
                        return {
                            ...prev,
                            [adGroupId]: new Set(keywords.map(kw => kw['Keyword ID']))
                        };
                    }
                });
            };

            const bulkUpdateKeywordState = (adGroupId, newState) => {
                const selections = selectedKeywords[adGroupId] || new Set();
                if (selections.size === 0) return;

                // Create a new data array with all selected keywords updated
                const newData = allData.map(row => {
                    // Check if this row is a selected keyword
                    if (selections.has(row['Keyword ID']) && row.Entity === 'Keyword') {
                        return {
                            ...row,
                            State: newState
                        };
                    }
                    return row;
                });

                // Update the data in one batch
                setData(newData);

                // Clear selections after action
                setSelectedKeywords(prev => ({
                    ...prev,
                    [adGroupId]: new Set()
                }));
            };

            const addKeywordsToAdGroup = (adGroupId, keywordsText, bid, matchType) => {
                const row = data.find(r => r['Ad Group ID'] === adGroupId);
                if (!row) return;

                const keywords = keywordsText.split('\n').map(k => k.trim()).filter(k => k);
                const newItems = [];

                keywords.forEach(keyword => {
                    const newKeyword = {
                        Product: 'Sponsored Products',
                        Entity: 'Keyword',
                        Operation: 'Create',
                        'Campaign ID': row['Campaign ID'],
                        'Ad Group ID': adGroupId,
                        'Portfolio ID': row['Portfolio ID'] || '',
                        'Ad ID': '',
                        'Keyword ID': `kw_${Date.now()}_${Math.random()}`,
                        'Product Targeting ID': '',
                        'Campaign Name': row['Campaign Name'] || row['Campaign Name (Informational only)'] || '',
                        'Ad Group Name': row['Ad Group Name'] || row['Ad Group Name (Informational only)'] || '',
                        'Campaign Name (Informational only)': row['Campaign Name (Informational only)'] || '',
                        'Ad Group Name (Informational only)': row['Ad Group Name (Informational only)'] || '',
                        'Portfolio Name (Informational only)': row['Portfolio Name (Informational only)'] || '',
                        'Start Date': '',
                        'End Date': '',
                        'Targeting Type': '',
                        State: 'enabled',
                        'Campaign State (Informational only)': '',
                        'Ad Group State (Informational only)': '',
                        'Daily Budget': '',
                        SKU: '',
                        'ASIN (Informational only)': '',
                        'Eligibility Status (Informational only)': '',
                        'Reason for Ineligibility (Informational only)': '',
                        'Ad Group Default Bid': '',
                        'Ad Group Default Bid (Informational only)': '',
                        Bid: bid || '',
                        'Keyword Text': keyword,
                        'Native Language Keyword': '',
                        'Native Language Locale': '',
                        'Match Type': matchType,
                        'Bidding Strategy': '',
                        Placement: '',
                        Percentage: '',
                        'Product Targeting Expression': '',
                        'Resolved Product Targeting Expression (Informational only)': '',
                        Impressions: '0',
                        Clicks: '0',
                        'Click-through Rate': '',
                        Spend: '0',
                        Sales: '0',
                        Orders: '0',
                        Units: '',
                        'Conversion Rate': '',
                        ACOS: '',
                        CPC: '',
                        ROAS: ''
                    };
                    newItems.push(newKeyword);
                });

                // Add to main data array
                const event = new CustomEvent('addKeywords', { detail: newItems });
                window.dispatchEvent(event);
                
                // Hide the form
                setAddKeywordForms(prev => ({ ...prev, [adGroupId]: false }));
            };

            const addProductTargetsToAdGroup = (adGroupId, targetsText, bid) => {
                const row = data.find(r => r['Ad Group ID'] === adGroupId);
                if (!row) return;

                const targets = targetsText.split('\n').map(t => t.trim()).filter(t => t);
                const newItems = [];

                targets.forEach(target => {
                    // Auto-format the targeting expression
                    const formattedExpression = formatProductTargetingExpression(target, 'auto');
                    
                    const newTarget = {
                        Product: 'Sponsored Products',
                        Entity: 'Product Targeting',
                        Operation: 'Create',
                        'Campaign ID': row['Campaign ID'],
                        'Ad Group ID': adGroupId,
                        'Portfolio ID': row['Portfolio ID'] || '',
                        'Ad ID': '',
                        'Keyword ID': '',
                        'Product Targeting ID': `pt_${Date.now()}_${Math.random()}`,
                        'Campaign Name': row['Campaign Name'] || row['Campaign Name (Informational only)'] || '',
                        'Ad Group Name': row['Ad Group Name'] || row['Ad Group Name (Informational only)'] || '',
                        'Campaign Name (Informational only)': row['Campaign Name (Informational only)'] || '',
                        'Ad Group Name (Informational only)': row['Ad Group Name (Informational only)'] || '',
                        'Portfolio Name (Informational only)': row['Portfolio Name (Informational only)'] || '',
                        'Start Date': '',
                        'End Date': '',
                        'Targeting Type': '',
                        State: 'enabled',
                        'Campaign State (Informational only)': '',
                        'Ad Group State (Informational only)': '',
                        'Daily Budget': '',
                        SKU: '',
                        'ASIN (Informational only)': '',
                        'Eligibility Status (Informational only)': '',
                        'Reason for Ineligibility (Informational only)': '',
                        'Ad Group Default Bid': '',
                        'Ad Group Default Bid (Informational only)': '',
                        Bid: bid || '',
                        'Keyword Text': '',
                        'Native Language Keyword': '',
                        'Native Language Locale': '',
                        'Match Type': '',
                        'Bidding Strategy': '',
                        Placement: '',
                        Percentage: '',
                        'Product Targeting Expression': formattedExpression,
                        'Resolved Product Targeting Expression (Informational only)': '',
                        Impressions: '0',
                        Clicks: '0',
                        'Click-through Rate': '',
                        Spend: '0',
                        Sales: '0',
                        Orders: '0',
                        Units: '',
                        'Conversion Rate': '',
                        ACOS: '',
                        CPC: '',
                        ROAS: ''
                    };
                    newItems.push(newTarget);
                });

                // Add to main data array
                const event = new CustomEvent('addKeywords', { detail: newItems });
                window.dispatchEvent(event);
                
                // Hide the form
                setAddKeywordForms(prev => ({ ...prev, [adGroupId + '_targets']: false }));
            };

            // PERFORMANCE: Pre-compute row status (new/changed) for all visible rows
            // This prevents recalculating during each row render
            const rowStatusMap = useMemo(() => {
                const statusMap = new Map();
                data.slice(0, visibleRowLimit).forEach((row, index) => {
                    const rowId = getRowId(row);
                    const isNew = !originalRowMap.has(rowId);
                    const original = originalRowMap.get(rowId);
                    const isChanged = original && hasRowChanged(original, row);
                    statusMap.set(index, { isNew, isChanged });
                });
                return statusMap;
            }, [data, visibleRowLimit, originalRowMap]);

            const isRowNew = useCallback((row, index) => {
                const status = rowStatusMap.get(index);
                return status ? status.isNew : false;
            }, [rowStatusMap]);

            const isRowChanged = useCallback((row, index) => {
                const status = rowStatusMap.get(index);
                return status ? status.isChanged : false;
            }, [rowStatusMap]);

            const handleMouseDown = (e, column) => {
                setResizing({ column, startX: e.pageX, startWidth: columnWidths[column] || 150 });
            };

            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (resizing) {
                        const diff = e.pageX - resizing.startX;
                        const newWidth = Math.max(50, resizing.startWidth + diff);
                        setColumnWidths(prev => ({ ...prev, [resizing.column]: newWidth }));
                    }
                };

                const handleMouseUp = () => {
                    setResizing(null);
                };

                if (resizing) {
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                }

                return () => {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
            }, [resizing]);

            const renderCell = (row, field, index) => {
                // Handle hierarchy columns - get values from either direct or informational columns
                let displayValue;
                if (field === 'Portfolio Name') {
                    displayValue = getPortfolioName(row);
                } else if (field === 'Campaign Name') {
                    displayValue = getCampaignName(row);
                } else if (field === 'Ad Group Name') {
                    displayValue = getAdGroupName(row);
                } else {
                    displayValue = row[field] || '';
                }
                
                if (field === 'State') {
                    return (
                        <select
                            value={displayValue || 'enabled'}
                            onChange={(e) => updateRow(row, field, e.target.value)}
                            className={`w-full px-2 py-1 rounded text-xs font-medium ${
                                displayValue === 'enabled' ? 'bg-green-100 text-green-800' :
                                displayValue === 'paused' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-gray-100 text-gray-800'
                            }`}
                        >
                            <option value="enabled">Enabled</option>
                            <option value="paused">Paused</option>
                            <option value="archived">Archived</option>
                        </select>
                    );
                }

                // Campaign State column in Ad Groups tab - allows controlling campaign state
                if (field === 'Campaign State (Informational only)' && activeTab === 'adgroups' && row.Entity === 'Ad Group') {
                    // Find the parent campaign to get/update its state
                    const campaignRow = allData.find(r => r.Entity === 'Campaign' && r['Campaign ID'] === row['Campaign ID']);
                    const campaignState = campaignRow ? campaignRow.State : displayValue;
                    
                    return (
                        <select
                            value={campaignState || 'enabled'}
                            onChange={(e) => {
                                // Update the campaign entity's state
                                if (campaignRow) {
                                    updateRow(campaignRow, 'State', e.target.value);
                                }
                            }}
                            className={`w-full px-2 py-1 rounded text-xs font-medium ${
                                campaignState === 'enabled' ? 'bg-green-100 text-green-800' :
                                campaignState === 'paused' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-gray-100 text-gray-800'
                            }`}
                            title="Control parent campaign state"
                        >
                            <option value="enabled">Enabled</option>
                            <option value="paused">Paused</option>
                            <option value="archived">Archived</option>
                        </select>
                    );
                }

                // Only allow editing of actual field columns, not derived hierarchy display
                const editableFields = [
                    'Daily Budget', 'Bidding Strategy', 
                    'Targeting Type', 'Ad Group Default Bid', 'Bid', 'Keyword Text', 
                    'Match Type', 'Product Targeting Expression', 'SKU', 'Percentage'
                ];

                // Campaign Name editable for Campaign entities AND when viewing from Ad Groups tab
                if (field === 'Campaign Name' && (row.Entity === 'Campaign' || (row.Entity === 'Ad Group' && activeTab === 'adgroups'))) {
                    return (
                        <input
                            type="text"
                            value={displayValue}
                            onChange={(e) => updateRow(row, 'Campaign Name', e.target.value)}
                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-blue-500"
                            title={displayValue}
                        />
                    );
                }

                if (field === 'Ad Group Name' && row.Entity === 'Ad Group') {
                    return (
                        <input
                            type="text"
                            value={displayValue}
                            onChange={(e) => updateRow(row, field, e.target.value)}
                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-blue-500"
                            title={displayValue}
                        />
                    );
                }

                if (editableFields.includes(field)) {
                    if (field === 'Match Type' && row.Entity === 'Keyword') {
                        return (
                            <select
                                value={displayValue || 'Broad'}
                                onChange={(e) => updateRow(row, field, e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                            >
                                <option value="Broad">Broad</option>
                                <option value="Phrase">Phrase</option>
                                <option value="Exact">Exact</option>
                            </select>
                        );
                    }

                    if (field === 'Match Type' && (row.Entity === 'Negative Keyword' || row.Entity === 'Campaign Negative Keyword')) {
                        return (
                            <select
                                value={displayValue || 'negativeExact'}
                                onChange={(e) => updateRow(row, field, e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                            >
                                <option value="negativeExact">Negative Exact</option>
                                <option value="negativePhrase">Negative Phrase</option>
                            </select>
                        );
                    }

                    if (field === 'Targeting Type') {
                        return (
                            <select
                                value={displayValue || 'Manual'}
                                onChange={(e) => updateRow(row, field, e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                            >
                                <option value="Auto">Auto</option>
                                <option value="Manual">Manual</option>
                            </select>
                        );
                    }

                    if (field === 'Bidding Strategy') {
                        return (
                            <select
                                value={displayValue || 'Dynamic bids - down only'}
                                onChange={(e) => updateRow(row, field, e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                            >
                                <option value="Dynamic bids - down only">Dynamic bids - down only</option>
                                <option value="Dynamic bids - up and down">Dynamic bids - up and down</option>
                                <option value="Fixed bid">Fixed bid</option>
                            </select>
                        );
                    }

                    return (
                        <input
                            type="text"
                            value={displayValue}
                            onChange={(e) => updateRow(row, field, e.target.value)}
                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-blue-500"
                            title={displayValue}
                        />
                    );
                }

                return <span className="text-xs text-gray-700" title={displayValue}>{displayValue || '-'}</span>;
            };

            const getColumns = () => {
                const portfolioCol = 'Portfolio Name';
                const campaignCol = 'Campaign Name';
                const adGroupCol = 'Ad Group Name';
                
                switch(activeTab) {
                    case 'campaigns':
                        return [
                            portfolioCol,
                            campaignCol,
                            'State',
                            'Targeting Type',
                            'Daily Budget',
                            'Bidding Strategy',
                            'Impressions',
                            'Clicks',
                            'Spend',
                            'Sales',
                            'ACOS',
                            'ROAS'
                        ];
                    
                    case 'adgroups':
                        return [
                            portfolioCol,
                            campaignCol,
                            'Campaign State (Informational only)',
                            adGroupCol,
                            'State',
                            'Ad Group Default Bid',
                            'Impressions',
                            'Clicks',
                            'Spend',
                            'Sales',
                            'ACOS',
                            'ROAS'
                        ];
                    
                    case 'products':
                        return [
                            portfolioCol,
                            campaignCol,
                            adGroupCol,
                            'State',
                            'SKU',
                            'ASIN (Informational only)',
                            'Impressions',
                            'Clicks',
                            'Spend',
                            'Sales',
                            'ACOS',
                            'ROAS'
                        ];
                    
                    case 'keywords':
                        return [
                            portfolioCol,
                            campaignCol,
                            adGroupCol,
                            'State',
                            'Keyword Text',
                            'Match Type',
                            'Bid',
                            'Impressions',
                            'Clicks',
                            'Spend',
                            'Sales',
                            'ACOS',
                            'ROAS'
                        ];
                    
                    case 'targeting':
                        return [
                            portfolioCol,
                            campaignCol,
                            adGroupCol,
                            'State',
                            'Product Targeting Expression',
                            'Bid',
                            'Impressions',
                            'Clicks',
                            'Spend',
                            'Sales',
                            'ACOS',
                            'ROAS'
                        ];
                    
                    case 'negative':
                        return [
                            portfolioCol,
                            campaignCol,
                            adGroupCol,
                            'Entity',
                            'State',
                            'Keyword Text',
                            'Match Type'
                        ];
                    
                    case 'changes':
                        return [
                            'Status',
                            'Entity',
                            portfolioCol,
                            campaignCol,
                            adGroupCol,
                            'State',
                            'Keyword Text',
                            'SKU',
                            'Bid',
                            'Actions'
                        ];
                    
                    default:
                        return [portfolioCol, campaignCol, adGroupCol];
                }
            };

            const columns = getColumns();

            return (
                <div className="overflow-x-auto scrollbar-thin" style={{ maxHeight: '65vh' }}>
                    <table className="w-full text-xs">
                        <thead className="bg-gray-50 border-b border-gray-200 sticky top-0">
                            <tr>
                                <th className="px-3 py-2 text-left" style={{ width: '40px' }}>
                                    <input
                                        type="checkbox"
                                        checked={data.length > 0 && data.every(item => selectedItems.has(getActualIndex(item)))}
                                        onChange={selectAll}
                                        className="rounded"
                                        title={`Select all ${data.length} visible items`}
                                    />
                                </th>
                                {columns.map(col => (
                                    <th 
                                        key={col} 
                                        className="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider"
                                        style={{ width: columnWidths[col] || '150px', minWidth: '80px' }}
                                    >
                                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '8px' }}>
                                            <span>{col.replace(' (Informational only)', '')}</span>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                {columnSort.column === col && (
                                                    <span className="text-blue-600 font-bold text-xs">
                                                        {columnSort.direction === 'asc' ? '‚Üë' : '‚Üì'}
                                                    </span>
                                                )}
                                                <div
                                                    className={`filter-icon ${columnFilters && columnFilters[col] ? 'active' : ''}`}
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        const rect = e.currentTarget.getBoundingClientRect();
                                                        setFilterPosition({
                                                            top: rect.bottom + window.scrollY + 5,
                                                            left: rect.left + window.scrollX
                                                        });
                                                        setActiveFilterColumn(col);
                                                    }}
                                                    title={`Filter ${col.replace(' (Informational only)', '')}`}
                                                >
                                                    {columnFilters && columnFilters[col] ? (
                                                        <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fillRule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clipRule="evenodd" />
                                                        </svg>
                                                    ) : (
                                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                                        </svg>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                        <div
                                            className="resizer"
                                            onMouseDown={(e) => handleMouseDown(e, col)}
                                        />
                                    </th>
                                ))}
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {data.length === 0 ? (
                                <tr>
                                    <td colSpan={columns.length + 1} className="px-4 py-12 text-center">
                                        <div className="text-gray-500">
                                            <div className="text-4xl mb-2">üîç</div>
                                            <div className="font-medium">No items found</div>
                                            <div className="text-sm mt-1">Try adjusting your filters</div>
                                        </div>
                                    </td>
                                </tr>
                            ) : (
                            <>
                            {/* PERFORMANCE: Only render visible rows */}
                            {data.slice(0, visibleRowLimit).map((row, index) => {
                                const actualIndex = getActualIndex(row); // PERFORMANCE: O(1) lookup instead of O(n)
                                const inReferenceList = isInReferenceList && isInReferenceList(row);
                                const rowIsNew = isRowNew(row, index);
                                const rowIsChanged = isRowChanged(row, index);
                                const rowClasses = inReferenceList && showReferencePanel
                                    ? 'bg-orange-100 border-l-4 border-orange-400'
                                    : rowIsNew 
                                    ? 'new-row' 
                                    : rowIsChanged 
                                    ? 'changed-row' 
                                    : '';
                                
                                const isAdGroup = row.Entity === 'Ad Group';
                                const adGroupId = row['Ad Group ID'];
                                const isExpanded = isAdGroup && expandedAdGroups.has(adGroupId);
                                
                                return (
                                    <React.Fragment key={index}>
                                        <tr 
                                            className={`hover:bg-gray-50 ${selectedItems.has(actualIndex) ? 'bg-blue-50' : rowClasses}`}
                                            title={inReferenceList && showReferencePanel ? 'üéØ In your target list' : ''}
                                        >
                                            <td className="px-3 py-2">
                                                <div className="flex items-center gap-1">
                                                    {isAdGroup && getAdGroupKeywords && (
                                                        <button
                                                            onClick={() => toggleAdGroupExpansion(adGroupId)}
                                                            className="text-gray-600 hover:text-blue-600 text-xs"
                                                            title="Show keywords and root analysis"
                                                        >
                                                            {isExpanded ? '‚ñº' : '‚ñ∂'}
                                                        </button>
                                                    )}
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedItems.has(actualIndex)}
                                                        onChange={() => toggleSelection(actualIndex)}
                                                        className="rounded"
                                                    />
                                                </div>
                                            </td>
                                            {columns.map((col) => {
                                                if (col === 'Status') {
                                                    return (
                                                        <td key={col} className="px-3 py-2">
                                                            <span className={`px-2 py-1 text-xs rounded font-medium ${
                                                                rowIsNew ? 'bg-green-100 text-green-800' :
                                                                rowIsChanged ? 'bg-yellow-100 text-yellow-800' :
                                                                'bg-gray-100 text-gray-800'
                                                            }`}>
                                                                {rowIsNew ? 'NEW' : rowIsChanged ? 'MODIFIED' : 'UNCHANGED'}
                                                            </span>
                                                        </td>
                                                    );
                                                }
                                                
                                                if (col === 'Actions' && activeTab === 'changes') {
                                                    return (
                                                        <td key={col} className="px-3 py-2">
                                                            <button
                                                                onClick={() => undoChange(row)}
                                                                className="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-medium hover:bg-red-200 flex items-center gap-1"
                                                                title={rowIsNew ? "Remove this new item" : "Revert to original"}
                                                            >
                                                                <span>‚Ü∂</span>
                                                                <span>{rowIsNew ? 'Remove' : 'Undo'}</span>
                                                            </button>
                                                        </td>
                                                    );
                                                }
                                                
                                                return (
                                                    <td 
                                                        key={col} 
                                                        className="px-3 py-2"
                                                        style={{ width: columnWidths[col] || '150px' }}
                                                    >
                                                        {renderCell(row, col, index)}
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                        
                                        {/* Expanded keyword and root analysis */}
                                        {isExpanded && (() => {
                                            const { keywords, productTargets, roots } = getAdGroupKeywords(adGroupId);
                                            const hasKeywords = keywords.length > 0;
                                            const hasTargets = productTargets.length > 0;
                                            const hasRoots = roots.length > 0 && hasKeywords;
                                            
                                            // Determine grid layout
                                            let gridCols = 'grid-cols-1';
                                            if (hasKeywords && hasTargets && hasRoots) {
                                                gridCols = 'grid-cols-3'; // All three sections
                                            } else if ((hasKeywords && hasTargets) || (hasKeywords && hasRoots)) {
                                                gridCols = 'grid-cols-2'; // Two sections
                                            } else if (hasKeywords || hasTargets) {
                                                gridCols = 'grid-cols-1'; // One section
                                            }
                                            
                                            return (
                                                <tr className="bg-gray-50">
                                                    <td colSpan={columns.length + 1} className="px-6 py-4">
                                                        <div className={`grid ${gridCols} gap-4`}>
                                                            {/* Keywords List - Show only if there are keywords OR if there are no targets */}
                                                            {(hasKeywords || !hasTargets) && (
                                                            <div>
                                                                <h4 className="text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                                                                    üìù Keywords ({keywords.length})
                                                                </h4>
                                                                
                                                                {/* Search and Bulk Actions */}
                                                                {keywords.length > 0 && (
                                                                    <div className="mb-2 space-y-2">
                                                                        <input
                                                                            type="text"
                                                                            placeholder="üîç Search keywords..."
                                                                            className="w-full px-3 py-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                                                            value={keywordSearchTerms[adGroupId] || ''}
                                                                            onChange={(e) => setKeywordSearchTerms(prev => ({
                                                                                ...prev,
                                                                                [adGroupId]: e.target.value
                                                                            }))}
                                                                        />
                                                                        
                                                                        {(selectedKeywords[adGroupId] && selectedKeywords[adGroupId].size > 0) && (
                                                                            <div className="flex items-center gap-2">
                                                                                <span className="text-xs text-gray-600">
                                                                                    {selectedKeywords[adGroupId].size} selected
                                                                                </span>
                                                                                <button
                                                                                    onClick={() => bulkUpdateKeywordState(adGroupId, 'paused')}
                                                                                    className="px-2 py-1 text-xs bg-yellow-600 text-white rounded hover:bg-yellow-700 font-medium"
                                                                                    title="Pause selected keywords"
                                                                                >
                                                                                    ‚è∏ Pause Selected
                                                                                </button>
                                                                                <button
                                                                                    onClick={() => bulkUpdateKeywordState(adGroupId, 'enabled')}
                                                                                    className="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700 font-medium"
                                                                                    title="Enable selected keywords"
                                                                                >
                                                                                    ‚ñ∂ Enable Selected
                                                                                </button>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                                
                                                                <div className="bg-white border rounded-lg p-3 max-h-60 overflow-y-auto text-xs">
                                                                    {keywords.length > 0 ? (
                                                                        <table className="w-full">
                                                                            <thead className="text-[10px] text-gray-600 border-b">
                                                                                <tr>
                                                                                    <th className="text-left pb-1 pr-2" style={{ width: '30px' }}>
                                                                                        <input
                                                                                            type="checkbox"
                                                                                            checked={(() => {
                                                                                                const searchTerm = (keywordSearchTerms[adGroupId] || '').toLowerCase();
                                                                                                const filteredKws = keywords.filter(kw => 
                                                                                                    !searchTerm || 
                                                                                                    (kw['Keyword Text'] || '').toLowerCase().includes(searchTerm)
                                                                                                );
                                                                                                const selections = selectedKeywords[adGroupId] || new Set();
                                                                                                return filteredKws.length > 0 && filteredKws.every(kw => selections.has(kw['Keyword ID']));
                                                                                            })()}
                                                                                            onChange={() => {
                                                                                                const searchTerm = (keywordSearchTerms[adGroupId] || '').toLowerCase();
                                                                                                const filteredKws = keywords.filter(kw => 
                                                                                                    !searchTerm || 
                                                                                                    (kw['Keyword Text'] || '').toLowerCase().includes(searchTerm)
                                                                                                );
                                                                                                toggleAllKeywords(adGroupId, filteredKws);
                                                                                            }}
                                                                                            className="rounded cursor-pointer"
                                                                                            title="Select all keywords"
                                                                                        />
                                                                                    </th>
                                                                                    <th className="text-left pb-1">Keyword</th>
                                                                                    <th className="text-left pb-1">Match</th>
                                                                                    <th className="text-left pb-1">State</th>
                                                                                    <th className="text-right pb-1">Bid</th>
                                                                                    <th className="text-right pb-1">CPC</th>
                                                                                    <th className="text-right pb-1">Clicks</th>
                                                                                    <th className="text-right pb-1">Impr.</th>
                                                                                    <th className="text-right pb-1">Orders</th>
                                                                                    <th className="text-right pb-1">Spend</th>
                                                                                    <th className="text-right pb-1">Sales</th>
                                                                                    <th className="text-right pb-1">ACOS</th>
                                                                                    <th className="text-center pb-1">Actions</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                {keywords
                                                                                    .filter(kw => {
                                                                                        const searchTerm = (keywordSearchTerms[adGroupId] || '').toLowerCase();
                                                                                        if (!searchTerm) return true;
                                                                                        return (kw['Keyword Text'] || '').toLowerCase().includes(searchTerm);
                                                                                    })
                                                                                    .map((kw, i) => {
                                                                                    const clicks = parseInt(kw.Clicks || 0);
                                                                                    const spend = parseNumber(kw.Spend);
                                                                                    const sales = parseNumber(kw.Sales);
                                                                                    const cpc = clicks > 0 ? spend / clicks : 0;
                                                                                    const acos = sales > 0 ? (spend / sales) * 100 : (spend > 0 ? Infinity : 0);
                                                                                    const inReferenceList = isInReferenceList && isInReferenceList(kw);
                                                                                    const isSelected = (selectedKeywords[adGroupId] || new Set()).has(kw['Keyword ID']);
                                                                                    
                                                                                    return (
                                                                                    <tr key={i} className={`border-b last:border-0 ${
                                                                                        isSelected ? 'bg-blue-50' :
                                                                                        inReferenceList && showReferencePanel ? 'bg-orange-100' : ''
                                                                                    }`}>
                                                                                        <td className="py-1 pr-2">
                                                                                            <input
                                                                                                type="checkbox"
                                                                                                checked={isSelected}
                                                                                                onChange={() => toggleKeywordSelection(adGroupId, kw['Keyword ID'])}
                                                                                                className="rounded cursor-pointer"
                                                                                            />
                                                                                        </td>
                                                                                        <td className="py-1">{kw['Keyword Text']}</td>
                                                                                        <td className="py-1">{kw['Match Type']}</td>
                                                                                        <td className="py-1">
                                                                                            <span className={`px-1 rounded text-[10px] ${
                                                                                                kw.State === 'enabled' ? 'bg-green-100 text-green-800' : 
                                                                                                kw.State === 'paused' ? 'bg-yellow-100 text-yellow-800' : 
                                                                                                'bg-gray-100 text-gray-800'
                                                                                            }`}>
                                                                                                {kw.State}
                                                                                            </span>
                                                                                        </td>
                                                                                        <td className="py-1 text-right font-medium text-blue-700">${parseNumber(kw.Bid).toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">${cpc.toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">{clicks}</td>
                                                                                        <td className="py-1 text-right">{parseInt(kw.Impressions || 0)}</td>
                                                                                        <td className="py-1 text-right">{parseInt(kw.Orders || 0)}</td>
                                                                                        <td className="py-1 text-right">${spend.toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">${parseNumber(kw.Sales).toFixed(2)}</td>
                                                                                        <td className={`py-1 text-right font-medium ${
                                                                                            acos === 0 ? 'text-gray-400' :
                                                                                            acos === Infinity ? 'text-red-600' :
                                                                                            acos <= 25 ? 'text-green-600' :
                                                                                            acos <= 50 ? 'text-yellow-600' :
                                                                                            'text-red-600'
                                                                                        }`}>
                                                                                            {acos === 0 ? '-' : acos === Infinity ? '‚àû' : acos.toFixed(1) + '%'}
                                                                                        </td>
                                                                                        <td className="py-1 text-center">
                                                                                            <div className="flex gap-1 justify-center">
                                                                                                {kw.State !== 'enabled' && (
                                                                                                    <button
                                                                                                        onClick={() => {
                                                                                                            const kwRow = allData.find(r => 
                                                                                                                r['Keyword ID'] === kw['Keyword ID']
                                                                                                            );
                                                                                                            if (kwRow) {
                                                                                                                updateRow(kwRow, 'State', 'enabled');
                                                                                                            }
                                                                                                        }}
                                                                                                        className="px-1.5 py-0.5 bg-green-600 text-white rounded text-[10px] hover:bg-green-700"
                                                                                                        title="Enable keyword"
                                                                                                    >
                                                                                                        ‚ñ∂
                                                                                                    </button>
                                                                                                )}
                                                                                                {kw.State !== 'paused' && (
                                                                                                    <button
                                                                                                        onClick={() => {
                                                                                                            const kwRow = allData.find(r => 
                                                                                                                r['Keyword ID'] === kw['Keyword ID']
                                                                                                            );
                                                                                                            if (kwRow) {
                                                                                                                updateRow(kwRow, 'State', 'paused');
                                                                                                            }
                                                                                                        }}
                                                                                                        className="px-1.5 py-0.5 bg-yellow-600 text-white rounded text-[10px] hover:bg-yellow-700"
                                                                                                        title="Pause keyword"
                                                                                                    >
                                                                                                        ‚è∏
                                                                                                    </button>
                                                                                                )}
                                                                                            </div>
                                                                                        </td>
                                                                                    </tr>
                                                                                    );
                                                                                })}
                                                                            </tbody>
                                                                        </table>
                                                                    ) : (
                                                                        <div className="text-gray-500 text-center py-4">No keywords found</div>
                                                                    )}
                                                                    
                                                                    {/* Show message when search has no results */}
                                                                    {keywords.length > 0 && (() => {
                                                                        const searchTerm = (keywordSearchTerms[adGroupId] || '').toLowerCase();
                                                                        const filteredCount = keywords.filter(kw => 
                                                                            !searchTerm || 
                                                                            (kw['Keyword Text'] || '').toLowerCase().includes(searchTerm)
                                                                        ).length;
                                                                        
                                                                        if (searchTerm && filteredCount === 0) {
                                                                            return (
                                                                                <div className="text-gray-500 text-center py-3 text-xs">
                                                                                    No keywords match "{keywordSearchTerms[adGroupId]}"
                                                                                </div>
                                                                            );
                                                                        }
                                                                        return null;
                                                                    })()}
                                                                </div>
                                                                
                                                                {/* Add Keywords Form */}
                                                                <div className="mt-3">
                                                                    {!addKeywordForms[adGroupId] ? (
                                                                        <button
                                                                            onClick={() => toggleAddKeywordForm(adGroupId)}
                                                                            className="w-full px-3 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 text-xs font-medium border border-blue-200"
                                                                        >
                                                                            ‚ûï Add Keywords to This Ad Group
                                                                        </button>
                                                                    ) : (
                                                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                                                            <div className="flex items-center justify-between mb-2">
                                                                                <span className="text-xs font-bold text-gray-900">Add Keywords</span>
                                                                                <button
                                                                                    onClick={() => toggleAddKeywordForm(adGroupId)}
                                                                                    className="text-gray-500 hover:text-gray-700"
                                                                                >
                                                                                    √ó
                                                                                </button>
                                                                            </div>
                                                                            <div className="space-y-2">
                                                                                <textarea
                                                                                    placeholder="Keywords (one per line)&#10;badewannenmatte&#10;duschmatte&#10;rutschfeste matte"
                                                                                    className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                                                    rows="4"
                                                                                    value={getKeywordFormData(adGroupId).kwText}
                                                                                    onChange={(e) => updateKeywordFormData(adGroupId, 'kwText', e.target.value)}
                                                                                />
                                                                                <div className="grid grid-cols-2 gap-2">
                                                                                    <div>
                                                                                        <label className="text-[10px] text-gray-600 block mb-1">Bid $</label>
                                                                                        <input
                                                                                            type="number"
                                                                                            step="0.01"
                                                                                            placeholder="0.50"
                                                                                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                                                            value={getKeywordFormData(adGroupId).kwBid}
                                                                                            onChange={(e) => updateKeywordFormData(adGroupId, 'kwBid', e.target.value)}
                                                                                        />
                                                                                    </div>
                                                                                    <div>
                                                                                        <label className="text-[10px] text-gray-600 block mb-1">Match Type</label>
                                                                                        <select
                                                                                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                                                            value={getKeywordFormData(adGroupId).kwMatch}
                                                                                            onChange={(e) => updateKeywordFormData(adGroupId, 'kwMatch', e.target.value)}
                                                                                        >
                                                                                            <option value="Broad">Broad</option>
                                                                                            <option value="Phrase">Phrase</option>
                                                                                            <option value="Exact">Exact</option>
                                                                                        </select>
                                                                                    </div>
                                                                                </div>
                                                                                <button
                                                                                    onClick={() => {
                                                                                        const formData = getKeywordFormData(adGroupId);
                                                                                        if (formData.kwText.trim()) {
                                                                                            addKeywordsToAdGroup(adGroupId, formData.kwText, formData.kwBid, formData.kwMatch);
                                                                                            // Reset form
                                                                                            setKeywordFormData(prev => ({
                                                                                                ...prev,
                                                                                                [adGroupId]: { kwText: '', kwBid: '', kwMatch: 'Exact' }
                                                                                            }));
                                                                                        }
                                                                                    }}
                                                                                    className="w-full px-3 py-1.5 bg-blue-600 text-white rounded text-xs font-medium hover:bg-blue-700"
                                                                                >
                                                                                    Add {getKeywordFormData(adGroupId).kwText.split('\n').filter(k => k.trim()).length} Keyword(s)
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            )}
                                                            
                                                            {/* Product Targeting List - Show only if there are targets OR if there are no keywords */}
                                                            {(hasTargets || !hasKeywords) && (
                                                            <div>
                                                                <h4 className="text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                                                                    üéØ Product Targets ({productTargets.length})
                                                                </h4>
                                                                
                                                                {/* Filter Controls for Product Targets */}
                                                                {productTargets.length > 0 && (
                                                                <div className="mb-2 p-2 bg-gray-50 rounded-lg border border-gray-200">
                                                                    <div className="flex flex-wrap items-center gap-2 text-[10px]">
                                                                        <span className="font-medium text-gray-700">Filters:</span>
                                                                        <select
                                                                            className="px-2 py-1 border border-gray-300 rounded text-[10px] bg-white"
                                                                            value={(productTargetFilters[adGroupId] || {}).state || ''}
                                                                            onChange={(e) => setProductTargetFilters(prev => ({
                                                                                ...prev,
                                                                                [adGroupId]: { ...(prev[adGroupId] || {}), state: e.target.value }
                                                                            }))}
                                                                        >
                                                                            <option value="">All States</option>
                                                                            <option value="enabled">Enabled</option>
                                                                            <option value="paused">Paused</option>
                                                                            <option value="archived">Archived</option>
                                                                        </select>
                                                                        <select
                                                                            className="px-2 py-1 border border-gray-300 rounded text-[10px] bg-white"
                                                                            value={(productTargetFilters[adGroupId] || {}).acos || ''}
                                                                            onChange={(e) => setProductTargetFilters(prev => ({
                                                                                ...prev,
                                                                                [adGroupId]: { ...(prev[adGroupId] || {}), acos: e.target.value }
                                                                            }))}
                                                                        >
                                                                            <option value="">All ACOS</option>
                                                                            <option value="0-20">ACOS 0-20%</option>
                                                                            <option value="20-40">ACOS 20-40%</option>
                                                                            <option value="40-60">ACOS 40-60%</option>
                                                                            <option value="60-100">ACOS 60-100%</option>
                                                                            <option value="100+">ACOS 100%+</option>
                                                                            <option value="no-sales">No Sales</option>
                                                                        </select>
                                                                        <select
                                                                            className="px-2 py-1 border border-gray-300 rounded text-[10px] bg-white"
                                                                            value={(productTargetFilters[adGroupId] || {}).clicks || ''}
                                                                            onChange={(e) => setProductTargetFilters(prev => ({
                                                                                ...prev,
                                                                                [adGroupId]: { ...(prev[adGroupId] || {}), clicks: e.target.value }
                                                                            }))}
                                                                        >
                                                                            <option value="">All Clicks</option>
                                                                            <option value="0">0 Clicks</option>
                                                                            <option value="1-10">1-10 Clicks</option>
                                                                            <option value="10-50">10-50 Clicks</option>
                                                                            <option value="50+">50+ Clicks</option>
                                                                        </select>
                                                                        <input
                                                                            type="text"
                                                                            placeholder="Search ASIN..."
                                                                            className="px-2 py-1 border border-gray-300 rounded text-[10px] w-28"
                                                                            value={(productTargetFilters[adGroupId] || {}).search || ''}
                                                                            onChange={(e) => setProductTargetFilters(prev => ({
                                                                                ...prev,
                                                                                [adGroupId]: { ...(prev[adGroupId] || {}), search: e.target.value }
                                                                            }))}
                                                                        />
                                                                        {((productTargetFilters[adGroupId] || {}).state || 
                                                                          (productTargetFilters[adGroupId] || {}).acos || 
                                                                          (productTargetFilters[adGroupId] || {}).clicks || 
                                                                          (productTargetFilters[adGroupId] || {}).search) && (
                                                                            <button
                                                                                onClick={() => setProductTargetFilters(prev => ({
                                                                                    ...prev,
                                                                                    [adGroupId]: {}
                                                                                }))}
                                                                                className="px-2 py-1 text-[10px] text-red-600 hover:bg-red-50 rounded"
                                                                            >
                                                                                Clear
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                )}
                                                                
                                                                <div className="bg-white border rounded-lg p-3 max-h-60 overflow-y-auto text-xs">
                                                                    {productTargets.length > 0 ? (
                                                                        (() => {
                                                                            const filters = productTargetFilters[adGroupId] || {};
                                                                            const filteredTargets = productTargets.filter(pt => {
                                                                                const clicks = parseInt(pt.Clicks || 0);
                                                                                const spend = parseNumber(pt.Spend);
                                                                                const sales = parseNumber(pt.Sales);
                                                                                const acos = sales > 0 ? (spend / sales) * 100 : (spend > 0 ? Infinity : 0);
                                                                                
                                                                                // State filter
                                                                                if (filters.state && pt.State !== filters.state) return false;
                                                                                
                                                                                // ACOS filter
                                                                                if (filters.acos) {
                                                                                    if (filters.acos === 'no-sales' && sales > 0) return false;
                                                                                    if (filters.acos === '0-20' && (acos < 0 || acos > 20 || acos === Infinity)) return false;
                                                                                    if (filters.acos === '20-40' && (acos < 20 || acos > 40 || acos === Infinity)) return false;
                                                                                    if (filters.acos === '40-60' && (acos < 40 || acos > 60 || acos === Infinity)) return false;
                                                                                    if (filters.acos === '60-100' && (acos < 60 || acos > 100 || acos === Infinity)) return false;
                                                                                    if (filters.acos === '100+' && acos <= 100 && acos !== Infinity) return false;
                                                                                }
                                                                                
                                                                                // Clicks filter
                                                                                if (filters.clicks) {
                                                                                    if (filters.clicks === '0' && clicks !== 0) return false;
                                                                                    if (filters.clicks === '1-10' && (clicks < 1 || clicks > 10)) return false;
                                                                                    if (filters.clicks === '10-50' && (clicks < 10 || clicks > 50)) return false;
                                                                                    if (filters.clicks === '50+' && clicks < 50) return false;
                                                                                }
                                                                                
                                                                                // Search filter
                                                                                if (filters.search) {
                                                                                    const expr = (pt['Product Targeting Expression'] || '').toLowerCase();
                                                                                    if (!expr.includes(filters.search.toLowerCase())) return false;
                                                                                }
                                                                                
                                                                                return true;
                                                                            });
                                                                            
                                                                            if (filteredTargets.length === 0) {
                                                                                return (
                                                                                    <div className="text-gray-500 text-center py-4">
                                                                                        No targets match filters ({productTargets.length} total)
                                                                                    </div>
                                                                                );
                                                                            }
                                                                            
                                                                            return (
                                                                        <table className="w-full">
                                                                            <thead className="text-[10px] text-gray-600 border-b">
                                                                                <tr>
                                                                                    <th className="text-left pb-1">Target Expression</th>
                                                                                    <th className="text-left pb-1">State</th>
                                                                                    <th className="text-right pb-1">Bid</th>
                                                                                    <th className="text-right pb-1">CPC</th>
                                                                                    <th className="text-right pb-1">Clicks</th>
                                                                                    <th className="text-right pb-1">Spend</th>
                                                                                    <th className="text-right pb-1">Sales</th>
                                                                                    <th className="text-right pb-1">ACOS</th>
                                                                                    <th className="text-center pb-1">Actions</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                {filteredTargets.map((pt, i) => {
                                                                                    const clicks = parseInt(pt.Clicks || 0);
                                                                                    const spend = parseNumber(pt.Spend);
                                                                                    const sales = parseNumber(pt.Sales);
                                                                                    const cpc = clicks > 0 ? spend / clicks : 0;
                                                                                    const acos = sales > 0 ? (spend / sales) * 100 : (spend > 0 ? Infinity : 0);
                                                                                    const inReferenceList = isInReferenceList && isInReferenceList(pt);
                                                                                    
                                                                                    return (
                                                                                    <tr key={i} className={`border-b last:border-0 target-row ${
                                                                                        inReferenceList && showReferencePanel ? 'bg-orange-100' : ''
                                                                                    }`}>
                                                                                        <td className="py-1 max-w-[200px] truncate" title={pt['Product Targeting Expression']}>
                                                                                            {pt['Product Targeting Expression']}
                                                                                        </td>
                                                                                        <td className="py-1">
                                                                                            <span className={`px-1 rounded text-[10px] ${
                                                                                                pt.State === 'enabled' ? 'bg-green-100 text-green-800' : 
                                                                                                pt.State === 'paused' ? 'bg-yellow-100 text-yellow-800' : 
                                                                                                'bg-gray-100 text-gray-800'
                                                                                            }`}>
                                                                                                {pt.State}
                                                                                            </span>
                                                                                        </td>
                                                                                        <td className="py-1 text-right font-medium text-blue-700">${parseNumber(pt.Bid).toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">${cpc.toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">{clicks}</td>
                                                                                        <td className="py-1 text-right">${spend.toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">${sales.toFixed(2)}</td>
                                                                                        <td className={`py-1 text-right font-medium ${
                                                                                            acos === 0 ? 'text-gray-400' :
                                                                                            acos === Infinity ? 'text-red-600' :
                                                                                            acos <= 25 ? 'text-green-600' :
                                                                                            acos <= 50 ? 'text-yellow-600' :
                                                                                            'text-red-600'
                                                                                        }`}>
                                                                                            {acos === 0 ? '-' : acos === Infinity ? '‚àû' : acos.toFixed(1) + '%'}
                                                                                        </td>
                                                                                        <td className="py-1 text-center">
                                                                                            <div className="flex gap-1 justify-center">
                                                                                                {pt.State !== 'enabled' && (
                                                                                                    <button
                                                                                                        onClick={() => {
                                                                                                            const ptRow = allData.find(r => 
                                                                                                                r['Product Targeting ID'] === pt['Product Targeting ID']
                                                                                                            );
                                                                                                            if (ptRow) {
                                                                                                                updateRow(ptRow, 'State', 'enabled');
                                                                                                            }
                                                                                                        }}
                                                                                                        className="px-1.5 py-0.5 bg-green-600 text-white rounded text-[10px] hover:bg-green-700"
                                                                                                        title="Enable target"
                                                                                                    >
                                                                                                        ‚ñ∂
                                                                                                    </button>
                                                                                                )}
                                                                                                {pt.State !== 'paused' && (
                                                                                                    <button
                                                                                                        onClick={() => {
                                                                                                            const ptRow = allData.find(r => 
                                                                                                                r['Product Targeting ID'] === pt['Product Targeting ID']
                                                                                                            );
                                                                                                            if (ptRow) {
                                                                                                                updateRow(ptRow, 'State', 'paused');
                                                                                                            }
                                                                                                        }}
                                                                                                        className="px-1.5 py-0.5 bg-yellow-600 text-white rounded text-[10px] hover:bg-yellow-700"
                                                                                                        title="Pause target"
                                                                                                    >
                                                                                                        ‚è∏
                                                                                                    </button>
                                                                                                )}
                                                                                            </div>
                                                                                        </td>
                                                                                    </tr>
                                                                                    );
                                                                                })}
                                                                            </tbody>
                                                                        </table>
                                                                            );
                                                                        })()
                                                                    ) : (
                                                                        <div className="text-gray-500 text-center py-4">No product targets found</div>
                                                                    )}}
                                                                </div>
                                                                
                                                                {/* Add Product Targets Form */}
                                                                <div className="mt-3">
                                                                    {!addKeywordForms[adGroupId + '_targets'] ? (
                                                                        <button
                                                                            onClick={() => toggleAddKeywordForm(adGroupId + '_targets')}
                                                                            className="w-full px-3 py-2 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 text-xs font-medium border border-purple-200"
                                                                        >
                                                                            ‚ûï Add Product Targets to This Ad Group
                                                                        </button>
                                                                    ) : (
                                                                        <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                                                            <div className="flex items-center justify-between mb-2">
                                                                                <span className="text-xs font-bold text-gray-900">Add Product Targets</span>
                                                                                <button
                                                                                    onClick={() => toggleAddKeywordForm(adGroupId + '_targets')}
                                                                                    className="text-gray-500 hover:text-gray-700"
                                                                                >
                                                                                    √ó
                                                                                </button>
                                                                            </div>
                                                                            <div className="space-y-2">
                                                                                <textarea
                                                                                    placeholder="ASINs or Expressions (one per line, auto-formatted on export)&#10;B07XYZ1234&#10;B08ABC5678&#10;category=&quot;12345678&quot;"
                                                                                    className="w-full px-2 py-1 border border-gray-300 rounded text-xs font-mono"
                                                                                    rows="4"
                                                                                    value={getKeywordFormData(adGroupId + '_targets').kwText}
                                                                                    onChange={(e) => updateKeywordFormData(adGroupId + '_targets', 'kwText', e.target.value)}
                                                                                />
                                                                                <div className="text-[10px] text-gray-600 italic">
                                                                                    üí° Just enter ASINs (B0CL21ZDS3) - they'll be auto-formatted to asin="..." on export
                                                                                </div>
                                                                                <div>
                                                                                    <label className="text-[10px] text-gray-600 block mb-1">Bid $</label>
                                                                                    <input
                                                                                        type="number"
                                                                                        step="0.01"
                                                                                        placeholder="0.50"
                                                                                        className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                                                        value={getKeywordFormData(adGroupId + '_targets').kwBid}
                                                                                        onChange={(e) => updateKeywordFormData(adGroupId + '_targets', 'kwBid', e.target.value)}
                                                                                    />
                                                                                </div>
                                                                                <button
                                                                                    onClick={() => {
                                                                                        const formData = getKeywordFormData(adGroupId + '_targets');
                                                                                        if (formData.kwText.trim()) {
                                                                                            addProductTargetsToAdGroup(adGroupId, formData.kwText, formData.kwBid);
                                                                                            // Reset form
                                                                                            setKeywordFormData(prev => ({
                                                                                                ...prev,
                                                                                                [adGroupId + '_targets']: { kwText: '', kwBid: '', kwMatch: 'Exact' }
                                                                                            }));
                                                                                        }
                                                                                    }}
                                                                                    className="w-full px-3 py-1.5 bg-purple-600 text-white rounded text-xs font-medium hover:bg-purple-700"
                                                                                >
                                                                                    Add {getKeywordFormData(adGroupId + '_targets').kwText.split('\n').filter(k => k.trim()).length} Target(s)
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            )}
                                                            
                                                            {/* Root Analysis - Only show when there are keywords */}
                                                            {hasRoots && (
                                                            <div>
                                                                <h4 className="text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                                                                    üå± Root Word Analysis ({roots.length} roots)
                                                                </h4>
                                                                <div className="bg-white border rounded-lg p-3 max-h-60 overflow-y-auto text-xs">
                                                                    {roots.length > 0 ? (
                                                                        <table className="w-full">
                                                                            <thead className="text-[10px] text-gray-600 border-b">
                                                                                <tr>
                                                                                    <th className="text-left pb-1">Root Word</th>
                                                                                    <th className="text-center pb-1">KW Count</th>
                                                                                    <th className="text-right pb-1">Spend</th>
                                                                                    <th className="text-right pb-1">Sales</th>
                                                                                    <th className="text-right pb-1">ACOS</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                {roots.map((root, i) => (
                                                                                    <tr key={i} className="border-b last:border-0" title={`Used in: ${root.keywords.join(', ')}`}>
                                                                                        <td className="py-1 font-medium">{root.root}</td>
                                                                                        <td className="py-1 text-center">
                                                                                            <span className="bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded">
                                                                                                {root.count}
                                                                                            </span>
                                                                                        </td>
                                                                                        <td className="py-1 text-right">${root.spend.toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">${root.sales.toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">
                                                                                            <span className={`px-1 rounded ${
                                                                                                root.acos < 20 ? 'bg-green-100 text-green-800' :
                                                                                                root.acos < 40 ? 'bg-yellow-100 text-yellow-800' :
                                                                                                'bg-red-100 text-red-800'
                                                                                            }`}>
                                                                                                {root.acos > 0 ? root.acos.toFixed(1) + '%' : '-'}
                                                                                            </span>
                                                                                        </td>
                                                                                    </tr>
                                                                                ))}
                                                                            </tbody>
                                                                        </table>
                                                                    ) : (
                                                                        <div className="text-gray-500 text-center py-4">No keyword data available</div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            )}
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })()}
                                    </React.Fragment>
                                );
                            })}
                            {/* Load More Button */}
                            {data.length > visibleRowLimit && (
                                <tr>
                                    <td colSpan={columns.length + 1} className="px-4 py-3 text-center bg-gradient-to-r from-gray-50 to-white">
                                        <button
                                            onClick={() => setVisibleRowLimit(prev => prev + ROW_INCREMENT)}
                                            className="px-6 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition-colors text-sm font-medium shadow-sm"
                                        >
                                            Load More ({Math.min(ROW_INCREMENT, data.length - visibleRowLimit)} of {data.length - visibleRowLimit} remaining)
                                        </button>
                                        <span className="ml-3 text-xs text-gray-500">
                                            Showing {Math.min(visibleRowLimit, data.length)} of {data.length} rows
                                        </span>
                                    </td>
                                </tr>
                            )}
                            </>
                            )}
                        </tbody>
                    </table>
                </div>
            );
        }

        function AddModal({ type, data, onClose, onAdd, setData }) {
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({
                keywords: '',
                negativeKeywords: ''
            });
            const [bulkMode, setBulkMode] = useState(false);
            const [bulkCampaigns, setBulkCampaigns] = useState([]);
            const [createdCampaigns, setCreatedCampaigns] = useState([]);
            const [loadedExisting, setLoadedExisting] = useState(false);
            const [showExistingCampaigns, setShowExistingCampaigns] = useState(false);
            const [selectedExistingCampaign, setSelectedExistingCampaign] = useState('');
            const [campaignSearchText, setCampaignSearchText] = useState('');
            const [selectedPortfolioFilter, setSelectedPortfolioFilter] = useState('');
            const [singleKeywordMode, setSingleKeywordMode] = useState(false);
            const [singleKeywordTemplate, setSingleKeywordTemplate] = useState({
                campaignName: '',
                portfolioName: '',
                portfolioId: '',
                dailyBudget: '',
                targetingType: 'Manual',
                biddingStrategy: 'Dynamic bids - down only',
                adGroupName: '',
                defaultBid: '',
                keywords: '',
                matchType: 'Exact',
                keywordBid: '',
                products: '',
                productTargets: '',
                targetingMethod: 'asin',
                productTargetBid: '',
                topOfSearchMod: '',
                restOfSearchMod: '',
                productPagesMod: '',
                negativeKeywords: '',
                negativeMatchType: 'Negative exact'
            });

            const campaigns = data.filter(r => r.Entity === 'Campaign');
            const adGroups = data.filter(r => r.Entity === 'Ad Group');
            
            // Build portfolios map with both ID and Name
            const portfoliosMap = new Map();
            data.forEach(r => {
                const portfolioId = r['Portfolio ID'];
                const portfolioName = getPortfolioName(r);
                if (portfolioId && portfolioName && portfolioName !== '-') {
                    portfoliosMap.set(portfolioName, portfolioId);
                }
            });
            const portfolios = [...portfoliosMap.keys()];

            // Check for duplicate keywords and ASINs in existing data
            const checkDuplicates = (text, type, campaignId = null, adGroupId = null) => {
                if (!text || data.length === 0) return [];
                
                const items = text.split('\n').map(s => s.trim()).filter(s => s);
                const duplicates = [];
                
                items.forEach(item => {
                    if (type === 'keywords') {
                        // Check against existing keywords
                        const existing = data.find(row => 
                            row.Entity === 'Keyword' && 
                            row['Keyword Text'] && 
                            row['Keyword Text'].toLowerCase() === item.toLowerCase() &&
                            (!campaignId || row['Campaign ID'] === campaignId) &&
                            (!adGroupId || row['Ad Group ID'] === adGroupId)
                        );
                        if (existing) {
                            duplicates.push({
                                text: item,
                                campaign: getCampaignName(existing),
                                adGroup: getAdGroupName(existing),
                                matchType: existing['Match Type'] || '-'
                            });
                        }
                    } else if (type === 'products') {
                        // Check against existing product ads (SKUs)
                        const existing = data.find(row => 
                            row.Entity === 'Product Ad' && 
                            row.SKU && 
                            row.SKU.toLowerCase() === item.toLowerCase() &&
                            (!campaignId || row['Campaign ID'] === campaignId) &&
                            (!adGroupId || row['Ad Group ID'] === adGroupId)
                        );
                        if (existing) {
                            duplicates.push({
                                text: item,
                                campaign: getCampaignName(existing),
                                adGroup: getAdGroupName(existing)
                            });
                        }
                    } else if (type === 'negatives') {
                        // Check against existing negative keywords
                        const existing = data.find(row => 
                            (row.Entity === 'Campaign Negative Keyword' || row.Entity === 'Negative Keyword') && 
                            row['Keyword Text'] && 
                            row['Keyword Text'].toLowerCase() === item.toLowerCase() &&
                            (!campaignId || row['Campaign ID'] === campaignId) &&
                            (!adGroupId || row['Ad Group ID'] === adGroupId)
                        );
                        if (existing) {
                            duplicates.push({
                                text: item,
                                campaign: getCampaignName(existing),
                                adGroup: getAdGroupName(existing) || 'Campaign-level',
                                matchType: existing['Match Type'] || '-'
                            });
                        }
                    }
                });
                
                return duplicates;
            };

            // Load only newly created campaigns (not all existing campaigns)
            const loadExistingCampaigns = () => {
                if (!data || data.length === 0 || loadedExisting) return;
                
                // Only load campaigns that are NEW (Operation = 'Create')
                const newCampaignRows = data.filter(r => 
                    r.Entity === 'Campaign' && 
                    r.Operation === 'Create'
                );
                
                const parsedCampaigns = [];
                
                newCampaignRows.forEach(campaignRow => {
                    const campaignId = campaignRow['Campaign ID'];
                    const campaignName = getCampaignName(campaignRow);
                    
                    if (!campaignId || !campaignName) return;
                    
                    // Find ad group for this campaign (also must be NEW)
                    const adGroupRow = data.find(r => 
                        r.Entity === 'Ad Group' && 
                        r['Campaign ID'] === campaignId &&
                        r.Operation === 'Create'
                    );
                    
                    const adGroupId = adGroupRow ? adGroupRow['Ad Group ID'] : null;
                    const adGroupName = adGroupRow ? getAdGroupName(adGroupRow) : '';
                    
                    // Get keywords for this ad group (only NEW ones)
                    const keywords = data
                        .filter(r => 
                            r.Entity === 'Keyword' && 
                            r['Campaign ID'] === campaignId && 
                            r['Ad Group ID'] === adGroupId &&
                            r.Operation === 'Create'
                        )
                        .map(r => r['Keyword Text'])
                        .filter(k => k)
                        .join('\n');
                    
                    // Get products (SKUs) for this ad group (only NEW ones)
                    const products = data
                        .filter(r => 
                            r.Entity === 'Product Ad' && 
                            r['Campaign ID'] === campaignId && 
                            r['Ad Group ID'] === adGroupId &&
                            r.Operation === 'Create'
                        )
                        .map(r => r.SKU)
                        .filter(s => s)
                        .join('\n');
                    
                    // Get product targets for this ad group (only NEW ones)
                    const productTargets = data
                        .filter(r => 
                            r.Entity === 'Product Targeting' && 
                            r['Campaign ID'] === campaignId && 
                            r['Ad Group ID'] === adGroupId &&
                            r.Operation === 'Create'
                        )
                        .map(r => r['Product Targeting Expression'])
                        .filter(t => t)
                        .join('\n');
                    
                    // Get match type from first keyword
                    const firstKeyword = data.find(r => 
                        r.Entity === 'Keyword' && 
                        r['Campaign ID'] === campaignId && 
                        r['Ad Group ID'] === adGroupId &&
                        r.Operation === 'Create'
                    );
                    const matchType = firstKeyword ? firstKeyword['Match Type'] || 'Broad' : 'Broad';
                    
                    // Get keyword bid from first keyword
                    const keywordBid = firstKeyword ? firstKeyword['Bid'] || '' : '';
                    
                    // Get product target bid from first product target
                    const firstProductTarget = data.find(r => 
                        r.Entity === 'Product Targeting' && 
                        r['Campaign ID'] === campaignId && 
                        r['Ad Group ID'] === adGroupId &&
                        r.Operation === 'Create'
                    );
                    const productTargetBid = firstProductTarget ? firstProductTarget['Bid'] || '' : '';
                    
                    // Get placement modifiers (only NEW ones)
                    const topOfSearchRow = data.find(r => 
                        r.Entity === 'Campaign Placement' && 
                        r['Campaign ID'] === campaignId && 
                        r['Placement'] === 'Placement Top' &&
                        r.Operation === 'Create'
                    );
                    const restOfSearchRow = data.find(r => 
                        r.Entity === 'Campaign Placement' && 
                        r['Campaign ID'] === campaignId && 
                        r['Placement'] === 'Placement Rest of Search' &&
                        r.Operation === 'Create'
                    );
                    const productPagesRow = data.find(r => 
                        r.Entity === 'Campaign Placement' && 
                        r['Campaign ID'] === campaignId && 
                        r['Placement'] === 'Placement Product Page' &&
                        r.Operation === 'Create'
                    );
                    
                    parsedCampaigns.push({
                        id: Date.now() + Math.random(),
                        portfolioId: campaignRow['Portfolio ID'] || '',
                        portfolioName: getPortfolioName(campaignRow) || '',
                        campaignName: campaignName,
                        dailyBudget: campaignRow['Daily Budget'] || '',
                        targetingType: campaignRow['Targeting Type'] || 'Manual',
                        biddingStrategy: campaignRow['Bidding Strategy'] || 'Dynamic bids - down only',
                        adGroupName: adGroupName,
                        defaultBid: adGroupRow ? adGroupRow['Ad Group Default Bid'] || '' : '',
                        products: products,
                        keywords: keywords,
                        matchType: matchType,
                        keywordBid: keywordBid,
                        productTargets: productTargets,
                        targetingMethod: 'asin',
                        productTargetBid: productTargetBid,
                        topOfSearchMod: topOfSearchRow ? topOfSearchRow['Percentage'] || '' : '',
                        restOfSearchMod: restOfSearchRow ? restOfSearchRow['Percentage'] || '' : '',
                        productPagesMod: productPagesRow ? productPagesRow['Percentage'] || '' : ''
                    });
                });
                
                // Sort by most recent and take up to 50 campaigns
                parsedCampaigns.sort((a, b) => b.id - a.id);
                setCreatedCampaigns(parsedCampaigns.slice(0, 50));
                setLoadedExisting(true);
            };

            // NEW FEATURE: Get all existing campaigns (not just newly created ones)
            const getAllExistingCampaigns = () => {
                if (!data || data.length === 0) return [];
                
                // Get ALL campaigns regardless of operation type
                const allCampaignRows = data.filter(r => r.Entity === 'Campaign');
                
                const existingCampaigns = [];
                const processedCampaignIds = new Set();
                
                allCampaignRows.forEach(campaignRow => {
                    const campaignId = campaignRow['Campaign ID'];
                    const campaignName = getCampaignName(campaignRow);
                    
                    if (!campaignId || !campaignName || processedCampaignIds.has(campaignId)) return;
                    processedCampaignIds.add(campaignId);
                    
                    existingCampaigns.push({
                        campaignId: campaignId,
                        campaignName: campaignName,
                        portfolioName: getPortfolioName(campaignRow) || '',
                        dailyBudget: campaignRow['Daily Budget'] || '',
                        targetingType: campaignRow['Targeting Type'] || 'Manual',
                        biddingStrategy: campaignRow['Bidding Strategy'] || 'Dynamic bids - down only',
                        state: campaignRow['State'] || ''
                    });
                });
                
                return existingCampaigns.sort((a, b) => a.campaignName.localeCompare(b.campaignName));
            };

            // NEW FEATURE: Get filtered campaigns based on search and portfolio
            const getFilteredCampaigns = () => {
                let campaigns = getAllExistingCampaigns();
                
                // Filter by search text
                if (campaignSearchText.trim()) {
                    const searchLower = campaignSearchText.toLowerCase();
                    campaigns = campaigns.filter(camp => 
                        camp.campaignName.toLowerCase().includes(searchLower) ||
                        (camp.portfolioName && camp.portfolioName.toLowerCase().includes(searchLower))
                    );
                }
                
                // Filter by portfolio
                if (selectedPortfolioFilter) {
                    campaigns = campaigns.filter(camp => 
                        camp.portfolioName === selectedPortfolioFilter
                    );
                }
                
                return campaigns;
            };

            // NEW FEATURE: Get unique portfolios from all campaigns
            const getUniquePortfolios = () => {
                const campaigns = getAllExistingCampaigns();
                const portfolios = [...new Set(campaigns.map(c => c.portfolioName).filter(p => p))];
                return portfolios.sort();
            };

            // NEW FEATURE: Load selected existing campaign into bulk editor for duplication/editing
            const loadSelectedExistingCampaign = () => {
                if (!selectedExistingCampaign) {
                    alert('Please select a campaign to duplicate');
                    return;
                }
                
                const campaignId = selectedExistingCampaign;
                
                // Find the campaign row
                const campaignRow = data.find(r => 
                    r.Entity === 'Campaign' && 
                    r['Campaign ID'] === campaignId
                );
                
                if (!campaignRow) {
                    alert('Campaign not found');
                    return;
                }
                
                const campaignName = getCampaignName(campaignRow);
                
                // Find all ad groups for this campaign
                const adGroupRows = data.filter(r => 
                    r.Entity === 'Ad Group' && 
                    r['Campaign ID'] === campaignId
                );
                
                // If no ad groups, just duplicate the campaign structure
                if (adGroupRows.length === 0) {
                    // Get placement modifiers
                    const topOfSearchRow = data.find(r => 
                        r.Entity === 'Campaign Placement' && 
                        r['Campaign ID'] === campaignId && 
                        r['Placement'] === 'Placement Top'
                    );
                    const restOfSearchRow = data.find(r => 
                        r.Entity === 'Campaign Placement' && 
                        r['Campaign ID'] === campaignId && 
                        r['Placement'] === 'Placement Rest of Search'
                    );
                    const productPagesRow = data.find(r => 
                        r.Entity === 'Campaign Placement' && 
                        r['Campaign ID'] === campaignId && 
                        r['Placement'] === 'Placement Product Page'
                    );
                    
                    setBulkCampaigns(prev => [...prev, {
                        id: Date.now() + Math.random(),
                        portfolioId: campaignRow['Portfolio ID'] || '',
                        portfolioName: getPortfolioName(campaignRow) || '',
                        campaignName: `${campaignName} (Copy)`,
                        dailyBudget: campaignRow['Daily Budget'] || '',
                        targetingType: campaignRow['Targeting Type'] || 'Manual',
                        biddingStrategy: campaignRow['Bidding Strategy'] || 'Dynamic bids - down only',
                        adGroupName: '',
                        defaultBid: '',
                        products: '',
                        keywords: '',
                        matchType: 'Broad',
                        keywordBid: '',
                        productTargets: '',
                        targetingMethod: 'asin',
                        productTargetBid: '',
                        topOfSearchMod: topOfSearchRow ? topOfSearchRow['Percentage'] || '' : '',
                        restOfSearchMod: restOfSearchRow ? restOfSearchRow['Percentage'] || '' : '',
                        productPagesMod: productPagesRow ? productPagesRow['Percentage'] || '' : ''
                    }]);
                } else {
                    // Create a campaign entry for each ad group
                    adGroupRows.forEach(adGroupRow => {
                        const adGroupId = adGroupRow['Ad Group ID'];
                        const adGroupName = getAdGroupName(adGroupRow);
                        
                        // Get keywords for this ad group
                        const keywords = data
                            .filter(r => 
                                r.Entity === 'Keyword' && 
                                r['Campaign ID'] === campaignId && 
                                r['Ad Group ID'] === adGroupId
                            )
                            .map(r => r['Keyword Text'])
                            .filter(k => k)
                            .join('\n');
                        
                        // Get products (SKUs) for this ad group
                        const products = data
                            .filter(r => 
                                r.Entity === 'Product Ad' && 
                                r['Campaign ID'] === campaignId && 
                                r['Ad Group ID'] === adGroupId
                            )
                            .map(r => r.SKU)
                            .filter(s => s)
                            .join('\n');
                        
                        // Get product targets for this ad group
                        const productTargets = data
                            .filter(r => 
                                r.Entity === 'Product Targeting' && 
                                r['Campaign ID'] === campaignId && 
                                r['Ad Group ID'] === adGroupId
                            )
                            .map(r => r['Product Targeting Expression'])
                            .filter(t => t)
                            .join('\n');
                        
                        // Get match type from first keyword
                        const firstKeyword = data.find(r => 
                            r.Entity === 'Keyword' && 
                            r['Campaign ID'] === campaignId && 
                            r['Ad Group ID'] === adGroupId
                        );
                        const matchType = firstKeyword ? firstKeyword['Match Type'] || 'Broad' : 'Broad';
                        
                        // Get keyword bid from first keyword
                        const keywordBid = firstKeyword ? firstKeyword['Bid'] || '' : '';
                        
                        // Get product target bid from first product target
                        const firstProductTarget = data.find(r => 
                            r.Entity === 'Product Targeting' && 
                            r['Campaign ID'] === campaignId && 
                            r['Ad Group ID'] === adGroupId
                        );
                        const productTargetBid = firstProductTarget ? firstProductTarget['Bid'] || '' : '';
                        
                        // Get placement modifiers
                        const topOfSearchRow = data.find(r => 
                            r.Entity === 'Campaign Placement' && 
                            r['Campaign ID'] === campaignId && 
                            r['Placement'] === 'Placement Top'
                        );
                        const restOfSearchRow = data.find(r => 
                            r.Entity === 'Campaign Placement' && 
                            r['Campaign ID'] === campaignId && 
                            r['Placement'] === 'Placement Rest of Search'
                        );
                        const productPagesRow = data.find(r => 
                            r.Entity === 'Campaign Placement' && 
                            r['Campaign ID'] === campaignId && 
                            r['Placement'] === 'Placement Product Page'
                        );
                        
                        setBulkCampaigns(prev => [...prev, {
                            id: Date.now() + Math.random(),
                            portfolioId: campaignRow['Portfolio ID'] || '',
                            portfolioName: getPortfolioName(campaignRow) || '',
                            campaignName: `${campaignName} (Copy)`,
                            dailyBudget: campaignRow['Daily Budget'] || '',
                            targetingType: campaignRow['Targeting Type'] || 'Manual',
                            biddingStrategy: campaignRow['Bidding Strategy'] || 'Dynamic bids - down only',
                            adGroupName: `${adGroupName} (Copy)`,
                            defaultBid: adGroupRow['Ad Group Default Bid'] || '',
                            products: products,
                            keywords: keywords,
                            matchType: matchType,
                            keywordBid: keywordBid,
                            productTargets: productTargets,
                            targetingMethod: 'asin',
                            productTargetBid: productTargetBid,
                            topOfSearchMod: topOfSearchRow ? topOfSearchRow['Percentage'] || '' : '',
                            restOfSearchMod: restOfSearchRow ? restOfSearchRow['Percentage'] || '' : '',
                            productPagesMod: productPagesRow ? productPagesRow['Percentage'] || '' : ''
                        }]);
                    });
                }
                
                // Close the selector and reset
                setShowExistingCampaigns(false);
                setSelectedExistingCampaign('');
            };

            // Load existing campaigns when entering bulk mode
            React.useEffect(() => {
                if (bulkMode && type === 'campaigns' && !loadedExisting) {
                    loadExistingCampaigns();
                }
            }, [bulkMode, type]);

            // Bulk campaign builder functions
            const addEmptyBulkCampaign = () => {
                setBulkCampaigns([...bulkCampaigns, {
                    id: Date.now(),
                    portfolioName: '',
                    campaignName: '',
                    dailyBudget: '',
                    targetingType: 'Manual',
                    biddingStrategy: 'Dynamic bids - down only',
                    adGroupName: '',
                    defaultBid: '',
                    products: '',
                    keywords: '',
                    matchType: 'Broad',
                    keywordBid: '',
                    productTargets: '',
                    targetingMethod: 'asin',
                    productTargetBid: '',
                    topOfSearchMod: '',
                    restOfSearchMod: '',
                    productPagesMod: '',
                    negativeKeywords: '',
                    negativeMatchType: 'Negative exact'
                }]);
            };

            const duplicateBulkCampaign = (index) => {
                const campaign = bulkCampaigns[index];
                const duplicated = { ...campaign, id: Date.now(), campaignName: campaign.campaignName + ' - Copy' };
                const newCampaigns = [...bulkCampaigns];
                newCampaigns.splice(index + 1, 0, duplicated);
                setBulkCampaigns(newCampaigns);
            };

            const removeBulkCampaign = (index) => {
                setBulkCampaigns(bulkCampaigns.filter((_, i) => i !== index));
            };

            const updateBulkCampaign = (index, field, value) => {
                const newCampaigns = [...bulkCampaigns];
                newCampaigns[index][field] = value;
                setBulkCampaigns(newCampaigns);
            };

            const createBulkCampaigns = () => {
                // Handle Single Keyword Mode
                if (singleKeywordMode) {
                    if (!singleKeywordTemplate.campaignName) {
                        alert('Please enter a campaign name template');
                        return;
                    }
                    if (!singleKeywordTemplate.keywords) {
                        alert('Please enter at least one keyword');
                        return;
                    }
                    if (!singleKeywordTemplate.campaignName.includes('{keyword}')) {
                        alert('Campaign name must include {keyword} placeholder');
                        return;
                    }

                    const keywords = singleKeywordTemplate.keywords.split('\n').map(k => k.trim()).filter(k => k);
                    if (keywords.length === 0) {
                        alert('Please enter at least one keyword');
                        return;
                    }

                    const newItems = [];
                    keywords.forEach(keyword => {
                        const campaignName = singleKeywordTemplate.campaignName.replace(/{keyword}/g, keyword);
                        const campaignId = campaignName.replace(/[^a-zA-Z0-9]/g, '_');
                        const adGroupName = singleKeywordTemplate.adGroupName 
                            ? singleKeywordTemplate.adGroupName.replace(/{keyword}/g, keyword)
                            : '';
                        const adGroupId = adGroupName ? adGroupName.replace(/[^a-zA-Z0-9]/g, '_') : '';

                        // Create Campaign
                        newItems.push(createRow('Campaign', {
                            'Campaign ID': campaignId,
                            'Campaign Name': campaignName,
                            'Campaign Name (Informational only)': campaignName,
                            'Portfolio ID': singleKeywordTemplate.portfolioId || '',
                            'Portfolio Name (Informational only)': singleKeywordTemplate.portfolioName || '',
                            'Daily Budget': singleKeywordTemplate.dailyBudget || '',
                            'Targeting Type': singleKeywordTemplate.targetingType,
                            'Bidding Strategy': singleKeywordTemplate.biddingStrategy
                        }));

                        // Add Placement bid modifiers if specified
                        if (singleKeywordTemplate.topOfSearchMod && singleKeywordTemplate.topOfSearchMod !== '0' && singleKeywordTemplate.topOfSearchMod !== '') {
                            newItems.push(createRow('Campaign Placement', {
                                'Campaign ID': campaignId,
                                'Campaign Name (Informational only)': campaignName,
                                'Placement': 'Placement Top',
                                'Percentage': singleKeywordTemplate.topOfSearchMod,
                                'Portfolio Name (Informational only)': singleKeywordTemplate.portfolioName || ''
                            }));
                        }
                        
                        if (singleKeywordTemplate.restOfSearchMod && singleKeywordTemplate.restOfSearchMod !== '0' && singleKeywordTemplate.restOfSearchMod !== '') {
                            newItems.push(createRow('Campaign Placement', {
                                'Campaign ID': campaignId,
                                'Campaign Name (Informational only)': campaignName,
                                'Placement': 'Placement Rest of Search',
                                'Percentage': singleKeywordTemplate.restOfSearchMod,
                                'Portfolio Name (Informational only)': singleKeywordTemplate.portfolioName || ''
                            }));
                        }
                        
                        if (singleKeywordTemplate.productPagesMod && singleKeywordTemplate.productPagesMod !== '0' && singleKeywordTemplate.productPagesMod !== '') {
                            newItems.push(createRow('Campaign Placement', {
                                'Campaign ID': campaignId,
                                'Campaign Name (Informational only)': campaignName,
                                'Placement': 'Placement Product Page',
                                'Percentage': singleKeywordTemplate.productPagesMod,
                                'Portfolio Name (Informational only)': singleKeywordTemplate.portfolioName || ''
                            }));
                        }

                        // Create Ad Group if specified
                        if (adGroupName) {
                            newItems.push(createRow('Ad Group', {
                                'Campaign ID': campaignId,
                                'Campaign Name (Informational only)': campaignName,
                                'Ad Group ID': adGroupId,
                                'Ad Group Name': adGroupName,
                                'Ad Group Name (Informational only)': adGroupName,
                                'Ad Group Default Bid': singleKeywordTemplate.defaultBid || '',
                                'Portfolio Name (Informational only)': singleKeywordTemplate.portfolioName || ''
                            }));

                            // Add the single keyword to this campaign
                            newItems.push(createRow('Keyword', {
                                'Campaign ID': campaignId,
                                'Campaign Name (Informational only)': campaignName,
                                'Ad Group ID': adGroupId,
                                'Ad Group Name (Informational only)': adGroupName,
                                'Keyword Text': keyword,
                                'Match Type': singleKeywordTemplate.matchType,
                                'Bid': singleKeywordTemplate.keywordBid || singleKeywordTemplate.defaultBid || '',
                                'Portfolio Name (Informational only)': singleKeywordTemplate.portfolioName || ''
                            }));

                            // Add Products
                            if (singleKeywordTemplate.products) {
                                const skus = singleKeywordTemplate.products.split('\n').map(s => s.trim()).filter(s => s);
                                skus.forEach(sku => {
                                    newItems.push(createRow('Product Ad', {
                                        'Campaign ID': campaignId,
                                        'Campaign Name (Informational only)': campaignName,
                                        'Ad Group ID': adGroupId,
                                        'Ad Group Name (Informational only)': adGroupName,
                                        'SKU': sku,
                                        'Portfolio Name (Informational only)': singleKeywordTemplate.portfolioName || ''
                                    }));
                                });
                            }

                            // Add Product Targets
                            if (singleKeywordTemplate.productTargets) {
                                const targets = singleKeywordTemplate.productTargets.split('\n').map(t => t.trim()).filter(t => t);
                                const targetingMethod = singleKeywordTemplate.targetingMethod || 'asin';
                                
                                targets.forEach(target => {
                                    const formattedExpression = formatProductTargetingExpression(target, targetingMethod);
                                    
                                    newItems.push(createRow('Product Targeting', {
                                        'Campaign ID': campaignId,
                                        'Campaign Name (Informational only)': campaignName,
                                        'Ad Group ID': adGroupId,
                                        'Ad Group Name (Informational only)': adGroupName,
                                        'Product Targeting Expression': formattedExpression,
                                        'Bid': singleKeywordTemplate.productTargetBid || singleKeywordTemplate.defaultBid || '',
                                        'Portfolio Name (Informational only)': singleKeywordTemplate.portfolioName || ''
                                    }));
                                });
                            }

                            // Add Negative Keywords
                            if (singleKeywordTemplate.negativeKeywords) {
                                const negKeywords = singleKeywordTemplate.negativeKeywords.split('\n').map(k => k.trim()).filter(k => k);
                                negKeywords.forEach(negKeyword => {
                                    newItems.push(createRow('Negative Keyword', {
                                        'Campaign ID': campaignId,
                                        'Campaign Name (Informational only)': campaignName,
                                        'Ad Group ID': adGroupId,
                                        'Ad Group Name (Informational only)': adGroupName,
                                        'Keyword Text': negKeyword,
                                        'Match Type': singleKeywordTemplate.negativeMatchType || 'Negative exact',
                                        'Portfolio Name (Informational only)': singleKeywordTemplate.portfolioName || ''
                                    }));
                                });
                            }
                        }
                    });

                    if (newItems.length > 0) {
                        onAdd(newItems);
                        // Reset the template
                        setSingleKeywordTemplate({
                            campaignName: '',
                            portfolioName: '',
                            portfolioId: '',
                            dailyBudget: '',
                            targetingType: 'Manual',
                            biddingStrategy: 'Dynamic bids - down only',
                            adGroupName: '',
                            defaultBid: '',
                            keywords: '',
                            matchType: 'Exact',
                            keywordBid: '',
                            products: '',
                            productTargets: '',
                            targetingMethod: 'asin',
                            productTargetBid: '',
                            topOfSearchMod: '',
                            restOfSearchMod: '',
                            productPagesMod: '',
                            negativeKeywords: '',
                            negativeMatchType: 'Negative exact'
                        });
                    }
                    return;
                }

                // Normal Bulk Mode
                if (bulkCampaigns.length === 0) {
                    alert('Please add at least one campaign');
                    return;
                }

                const newItems = [];
                bulkCampaigns.forEach(camp => {
                    if (!camp.campaignName) {
                        alert('All campaigns must have a name');
                        return;
                    }

                    const campaignId = camp.campaignName.replace(/[^a-zA-Z0-9]/g, '_');
                    const adGroupId = camp.adGroupName ? camp.adGroupName.replace(/[^a-zA-Z0-9]/g, '_') : '';

                    // Create Campaign
                    newItems.push(createRow('Campaign', {
                        'Campaign ID': campaignId,
                        'Campaign Name': camp.campaignName,
                        'Campaign Name (Informational only)': camp.campaignName,
                        'Portfolio ID': camp.portfolioId || '',
                        'Portfolio Name (Informational only)': camp.portfolioName || '',
                        'Daily Budget': camp.dailyBudget || '',
                        'Targeting Type': camp.targetingType,
                        'Bidding Strategy': camp.biddingStrategy
                    }));

                    // Add Placement bid modifiers if specified
                    if (camp.topOfSearchMod && camp.topOfSearchMod !== '0' && camp.topOfSearchMod !== '') {
                        newItems.push(createRow('Campaign Placement', {
                            'Campaign ID': campaignId,
                            'Campaign Name (Informational only)': camp.campaignName,
                            'Placement': 'Placement Top',
                            'Percentage': camp.topOfSearchMod,
                            'Portfolio Name (Informational only)': camp.portfolioName || ''
                        }));
                    }
                    
                    if (camp.restOfSearchMod && camp.restOfSearchMod !== '0' && camp.restOfSearchMod !== '') {
                        newItems.push(createRow('Campaign Placement', {
                            'Campaign ID': campaignId,
                            'Campaign Name (Informational only)': camp.campaignName,
                            'Placement': 'Placement Rest of Search',
                            'Percentage': camp.restOfSearchMod,
                            'Portfolio Name (Informational only)': camp.portfolioName || ''
                        }));
                    }
                    
                    if (camp.productPagesMod && camp.productPagesMod !== '0' && camp.productPagesMod !== '') {
                        newItems.push(createRow('Campaign Placement', {
                            'Campaign ID': campaignId,
                            'Campaign Name (Informational only)': camp.campaignName,
                            'Placement': 'Placement Product Page',
                            'Percentage': camp.productPagesMod,
                            'Portfolio Name (Informational only)': camp.portfolioName || ''
                        }));
                    }

                    // Create Ad Group if specified
                    if (camp.adGroupName) {
                        newItems.push(createRow('Ad Group', {
                            'Campaign ID': campaignId,
                            'Campaign Name (Informational only)': camp.campaignName,
                            'Ad Group ID': adGroupId,
                            'Ad Group Name': camp.adGroupName,
                            'Ad Group Name (Informational only)': camp.adGroupName,
                            'Ad Group Default Bid': camp.defaultBid || '',
                            'Portfolio Name (Informational only)': camp.portfolioName || ''
                        }));

                        // Add Products
                        if (camp.products) {
                            const skus = camp.products.split('\n').map(s => s.trim()).filter(s => s);
                            skus.forEach(sku => {
                                newItems.push(createRow('Product Ad', {
                                    'Campaign ID': campaignId,
                                    'Campaign Name (Informational only)': camp.campaignName,
                                    'Ad Group ID': adGroupId,
                                    'Ad Group Name (Informational only)': camp.adGroupName,
                                    'SKU': sku,
                                    'Portfolio Name (Informational only)': camp.portfolioName || ''
                                }));
                            });
                        }

                        // Add Keywords
                        if (camp.keywords) {
                            const keywords = camp.keywords.split('\n').map(k => k.trim()).filter(k => k);
                            keywords.forEach(keyword => {
                                newItems.push(createRow('Keyword', {
                                    'Campaign ID': campaignId,
                                    'Campaign Name (Informational only)': camp.campaignName,
                                    'Ad Group ID': adGroupId,
                                    'Ad Group Name (Informational only)': camp.adGroupName,
                                    'Keyword Text': keyword,
                                    'Match Type': camp.matchType,
                                    'Bid': camp.keywordBid || camp.defaultBid || '',
                                    'Portfolio Name (Informational only)': camp.portfolioName || ''
                                }));
                            });
                        }

                        // Add Product Targets
                        if (camp.productTargets) {
                            const targets = camp.productTargets.split('\n').map(t => t.trim()).filter(t => t);
                            const targetingMethod = camp.targetingMethod || 'asin';
                            
                            targets.forEach(target => {
                                // Format the expression
                                const formattedExpression = formatProductTargetingExpression(target, targetingMethod);
                                
                                newItems.push(createRow('Product Targeting', {
                                    'Campaign ID': campaignId,
                                    'Campaign Name (Informational only)': camp.campaignName,
                                    'Ad Group ID': adGroupId,
                                    'Ad Group Name (Informational only)': camp.adGroupName,
                                    'Product Targeting Expression': formattedExpression,
                                    'Bid': camp.productTargetBid || camp.defaultBid || '',
                                    'Portfolio Name (Informational only)': camp.portfolioName || ''
                                }));
                            });
                        }

                        // Add Negative Keywords
                        if (camp.negativeKeywords) {
                            const negKeywords = camp.negativeKeywords.split('\n').map(k => k.trim()).filter(k => k);
                            negKeywords.forEach(negKeyword => {
                                newItems.push(createRow('Negative Keyword', {
                                    'Campaign ID': campaignId,
                                    'Campaign Name (Informational only)': camp.campaignName,
                                    'Ad Group ID': adGroupId,
                                    'Ad Group Name (Informational only)': camp.adGroupName,
                                    'Keyword Text': negKeyword,
                                    'Match Type': camp.negativeMatchType || 'Negative exact',
                                    'Portfolio Name (Informational only)': camp.portfolioName || ''
                                }));
                            });
                        }
                    }
                });

                if (newItems.length > 0) {
                    onAdd(newItems);
                    // Move campaigns to createdCampaigns and clear bulkCampaigns
                    setCreatedCampaigns(prev => [...prev, ...bulkCampaigns]);
                    setBulkCampaigns([]);
                }
            };

            // Functions to manage created campaigns
            const removeCreatedCampaign = (index) => {
                const campaign = createdCampaigns[index];
                const campaignId = campaign.campaignName.replace(/[^a-zA-Z0-9]/g, '_');
                
                // Remove all rows related to this campaign from the main data array
                const newData = data.filter(row => row['Campaign ID'] !== campaignId);
                setData(newData);
                
                // Remove from createdCampaigns list
                const newCreated = [...createdCampaigns];
                newCreated.splice(index, 1);
                setCreatedCampaigns(newCreated);
            };

            const duplicateCreatedCampaign = (index) => {
                const campaign = createdCampaigns[index];
                const duplicated = {
                    ...campaign,
                    id: Date.now() + Math.random(),
                    campaignName: `${campaign.campaignName} (Copy)`
                };
                setCreatedCampaigns(prev => [...prev, duplicated]);
            };

            const editCreatedCampaign = (index) => {
                const campaign = createdCampaigns[index];
                const campaignId = campaign.campaignName.replace(/[^a-zA-Z0-9]/g, '_');
                
                // Remove all rows related to this campaign from the main data array
                const newData = data.filter(row => row['Campaign ID'] !== campaignId);
                setData(newData);
                
                // Remove from createdCampaigns and add back to bulkCampaigns for editing
                const newCreated = [...createdCampaigns];
                newCreated.splice(index, 1);
                setCreatedCampaigns(newCreated);
                setBulkCampaigns(prev => [...prev, campaign]);
            };

            const createRow = (entity, overrides = {}) => {
                return {
                    Product: 'Sponsored Products',
                    Entity: entity,
                    Operation: 'Create',
                    'Campaign ID': formData.campaignId || '',
                    'Ad Group ID': formData.adGroupId || '',
                    'Portfolio ID': formData.portfolioId || '',
                    'Ad ID': '',
                    'Keyword ID': '',
                    'Product Targeting ID': '',
                    'Campaign Name': formData.campaignName || '',
                    'Ad Group Name': formData.adGroupName || '',
                    'Campaign Name (Informational only)': formData.campaignName || '',
                    'Ad Group Name (Informational only)': formData.adGroupName || '',
                    'Portfolio Name (Informational only)': formData.portfolioName || '',
                    'Start Date': '',
                    'End Date': '',
                    'Targeting Type': '',
                    State: 'enabled',
                    'Campaign State (Informational only)': '',
                    'Ad Group State (Informational only)': '',
                    'Daily Budget': '',
                    SKU: '',
                    'ASIN (Informational only)': '',
                    'Eligibility Status (Informational only)': '',
                    'Reason for Ineligibility (Informational only)': '',
                    'Ad Group Default Bid': '',
                    'Ad Group Default Bid (Informational only)': '',
                    Bid: '',
                    'Keyword Text': '',
                    'Native Language Keyword': '',
                    'Native Language Locale': '',
                    'Match Type': '',
                    'Bidding Strategy': '',
                    Placement: '',
                    Percentage: '',
                    'Product Targeting Expression': '',
                    'Resolved Product Targeting Expression (Informational only)': '',
                    Impressions: '',
                    Clicks: '',
                    'Click-through Rate': '',
                    Spend: '',
                    Sales: '',
                    Orders: '',
                    Units: '',
                    'Conversion Rate': '',
                    ACOS: '',
                    CPC: '',
                    ROAS: '',
                    ...overrides
                };
            };

            const handleAdd = () => {
                const newItems = [];

                if (type === 'campaigns') {
                    const campaignId = formData.name?.replace(/[^a-zA-Z0-9]/g, '_') || '';
                    const campaign = createRow('Campaign', {
                        'Campaign ID': campaignId,
                        'Campaign Name': formData.name,
                        'Targeting Type': formData.targetingType || 'Manual',
                        'Daily Budget': formData.budget || '10',
                        'Bidding Strategy': formData.biddingStrategy || 'Dynamic bids - down only',
                        'Start Date': new Date().toISOString().split('T')[0].replace(/-/g, ''),
                        'Portfolio ID': formData.portfolioId || '',
                        'Portfolio Name (Informational only)': formData.portfolioName || ''
                    });
                    newItems.push(campaign);

                    // Add Placement bid modifiers if specified
                    if (formData.topOfSearchMod && formData.topOfSearchMod !== '0' && formData.topOfSearchMod !== '') {
                        const placement1 = createRow('Campaign Placement', {
                            'Campaign ID': campaignId,
                            'Campaign Name (Informational only)': formData.name,
                            'Placement': 'Placement Top',
                            'Percentage': formData.topOfSearchMod,
                            'Portfolio Name (Informational only)': formData.portfolioName || ''
                        });
                        newItems.push(placement1);
                    }
                    
                    if (formData.restOfSearchMod && formData.restOfSearchMod !== '0' && formData.restOfSearchMod !== '') {
                        const placement2 = createRow('Campaign Placement', {
                            'Campaign ID': campaignId,
                            'Campaign Name (Informational only)': formData.name,
                            'Placement': 'Placement Rest of Search',
                            'Percentage': formData.restOfSearchMod,
                            'Portfolio Name (Informational only)': formData.portfolioName || ''
                        });
                        newItems.push(placement2);
                    }
                    
                    if (formData.productPagesMod && formData.productPagesMod !== '0' && formData.productPagesMod !== '') {
                        const placement3 = createRow('Campaign Placement', {
                            'Campaign ID': campaignId,
                            'Campaign Name (Informational only)': formData.name,
                            'Placement': 'Placement Product Page',
                            'Percentage': formData.productPagesMod,
                            'Portfolio Name (Informational only)': formData.portfolioName || ''
                        });
                        newItems.push(placement3);
                    }

                    // Add ad group if provided
                    if (formData.adGroupName) {
                        const adGroupId = formData.adGroupName.replace(/[^a-zA-Z0-9]/g, '_');
                        const adGroup = createRow('Ad Group', {
                            'Campaign ID': campaignId,
                            'Campaign Name': formData.name,
                            'Ad Group ID': adGroupId,
                            'Ad Group Name': formData.adGroupName,
                            'Ad Group Default Bid': formData.defaultBid || '0.50'
                        });
                        newItems.push(adGroup);

                        // Add products if provided
                        if (formData.skus) {
                            const skus = formData.skus.split('\n').map(s => s.trim()).filter(Boolean);
                            skus.forEach(sku => {
                                const product = createRow('Product Ad', {
                                    'Campaign ID': campaignId,
                                    'Campaign Name': formData.name,
                                    'Ad Group ID': adGroupId,
                                    'Ad Group Name': formData.adGroupName,
                                    SKU: sku
                                });
                                newItems.push(product);
                            });
                        }

                        // Add keywords if provided
                        if (formData.keywords) {
                            const keywords = formData.keywords.split('\n').map(k => k.trim()).filter(Boolean);
                            keywords.forEach(keyword => {
                                const kw = createRow('Keyword', {
                                    'Campaign ID': campaignId,
                                    'Campaign Name': formData.name,
                                    'Ad Group ID': adGroupId,
                                    'Ad Group Name': formData.adGroupName,
                                    'Keyword Text': keyword,
                                    'Match Type': formData.matchType || 'Broad',
                                    Bid: formData.keywordBid || ''
                                });
                                newItems.push(kw);
                            });
                        }

                        // Add product targets if provided
                        if (formData.productTargets) {
                            const targets = formData.productTargets.split('\n').map(t => t.trim()).filter(Boolean);
                            const targetingMethod = formData.targetingMethod || 'asin';
                            
                            targets.forEach(target => {
                                // Format the expression
                                const formattedExpression = formatProductTargetingExpression(target, targetingMethod);
                                
                                const productTarget = createRow('Product Targeting', {
                                    'Campaign ID': campaignId,
                                    'Campaign Name': formData.name,
                                    'Ad Group ID': adGroupId,
                                    'Ad Group Name': formData.adGroupName,
                                    'Product Targeting Expression': formattedExpression,
                                    Bid: formData.productTargetBid || ''
                                });
                                newItems.push(productTarget);
                            });
                        }

                        // Add negative keywords if provided
                        if (formData.negativeKeywords) {
                            const negKeywords = formData.negativeKeywords.split('\n').map(k => k.trim()).filter(Boolean);
                            negKeywords.forEach(negKeyword => {
                                const negKw = createRow('Negative Keyword', {
                                    'Campaign ID': campaignId,
                                    'Campaign Name': formData.name,
                                    'Ad Group ID': adGroupId,
                                    'Ad Group Name': formData.adGroupName,
                                    'Keyword Text': negKeyword,
                                    'Match Type': formData.negativeMatchType || 'Negative exact'
                                });
                                newItems.push(negKw);
                            });
                        }
                    }
                } else if (type === 'keywords') {
                    // Bulk keyword adding
                    const keywords = formData.keywords.split('\n').map(k => k.trim()).filter(Boolean);
                    keywords.forEach(keyword => {
                        const kw = createRow('Keyword', {
                            'Keyword Text': keyword,
                            'Match Type': formData.matchType || 'Broad',
                            Bid: formData.bid || ''
                        });
                        newItems.push(kw);
                    });
                } else if (type === 'adgroups') {
                    // Add new ad group to existing campaign
                    if (!formData.campaignId || !formData.adGroupName) {
                        alert('Please select a campaign and enter an ad group name');
                        return;
                    }

                    const campaign = campaigns.find(c => c['Campaign ID'] === formData.campaignId);
                    const adGroupId = formData.adGroupName.replace(/[^a-zA-Z0-9]/g, '_');
                    
                    const adGroup = createRow('Ad Group', {
                        'Campaign ID': formData.campaignId,
                        'Campaign Name': getCampaignName(campaign),
                        'Campaign Name (Informational only)': getCampaignName(campaign),
                        'Ad Group ID': adGroupId,
                        'Ad Group Name': formData.adGroupName,
                        'Ad Group Name (Informational only)': formData.adGroupName,
                        'Ad Group Default Bid': formData.defaultBid || '0.50',
                        'Portfolio ID': campaign['Portfolio ID'] || '',
                        'Portfolio Name (Informational only)': getPortfolioName(campaign) || ''
                    });
                    newItems.push(adGroup);

                    // Add products if provided
                    if (formData.skus) {
                        const skus = formData.skus.split('\n').map(s => s.trim()).filter(Boolean);
                        skus.forEach(sku => {
                            const product = createRow('Product Ad', {
                                'Campaign ID': formData.campaignId,
                                'Campaign Name': getCampaignName(campaign),
                                'Campaign Name (Informational only)': getCampaignName(campaign),
                                'Ad Group ID': adGroupId,
                                'Ad Group Name': formData.adGroupName,
                                'Ad Group Name (Informational only)': formData.adGroupName,
                                SKU: sku,
                                'Portfolio ID': campaign['Portfolio ID'] || '',
                                'Portfolio Name (Informational only)': getPortfolioName(campaign) || ''
                            });
                            newItems.push(product);
                        });
                    }

                    // Add keywords if provided
                    if (formData.keywords) {
                        const keywords = formData.keywords.split('\n').map(k => k.trim()).filter(Boolean);
                        keywords.forEach(keyword => {
                            const kw = createRow('Keyword', {
                                'Campaign ID': formData.campaignId,
                                'Campaign Name': getCampaignName(campaign),
                                'Campaign Name (Informational only)': getCampaignName(campaign),
                                'Ad Group ID': adGroupId,
                                'Ad Group Name': formData.adGroupName,
                                'Ad Group Name (Informational only)': formData.adGroupName,
                                'Keyword Text': keyword,
                                'Match Type': formData.matchType || 'Broad',
                                Bid: formData.keywordBid || '',
                                'Portfolio ID': campaign['Portfolio ID'] || '',
                                'Portfolio Name (Informational only)': getPortfolioName(campaign) || ''
                            });
                            newItems.push(kw);
                        });
                    }
                } else if (type === 'negative') {
                    // Bulk negative keyword adding
                    const keywords = formData.negativeKeywords.split('\n').map(k => k.trim()).filter(Boolean);
                    const entity = formData.level === 'campaign' ? 'Campaign Negative Keyword' : 'Negative Keyword';
                    keywords.forEach(keyword => {
                        const neg = createRow(entity, {
                            'Keyword Text': keyword,
                            'Match Type': formData.matchType || 'negativeExact',
                            'Ad Group ID': formData.level === 'adgroup' ? formData.adGroupId : ''
                        });
                        newItems.push(neg);
                    });
                } else if (type === 'products') {
                    const skus = formData.skus.split('\n').map(s => s.trim()).filter(Boolean);
                    skus.forEach(sku => {
                        const product = createRow('Product Ad', {
                            SKU: sku
                        });
                        newItems.push(product);
                    });
                }

                if (newItems.length > 0) {
                    onAdd(newItems);
                    onClose();
                }
            };

            const renderFormContent = () => {
                if (type === 'campaigns') {
                    if (bulkMode) {
                        return (
                            <div className="space-y-3">
                                <div className="flex items-center justify-between">
                                    <h3 className="text-lg font-semibold">Campaign Builder - Bulk Mode</h3>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => {
                                                setSingleKeywordMode(!singleKeywordMode);
                                                if (!singleKeywordMode) {
                                                    setBulkCampaigns([]);
                                                    setCreatedCampaigns([]);
                                                }
                                            }}
                                            className={`text-sm px-3 py-1 rounded ${
                                                singleKeywordMode 
                                                    ? 'bg-green-600 text-white hover:bg-green-700' 
                                                    : 'bg-green-100 text-green-700 hover:bg-green-200'
                                            }`}
                                        >
                                            {singleKeywordMode ? '‚úì Single Keyword Mode' : 'Single Keyword Mode'}
                                        </button>
                                        <button
                                            onClick={() => setBulkMode(false)}
                                            className="text-sm text-blue-600 hover:text-blue-800 underline"
                                        >
                                            Switch to Single Mode
                                        </button>
                                    </div>
                                </div>
                                
                                {!singleKeywordMode ? (
                                    <>
                                        <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-900 mb-3">
                                            üí° Build multiple campaigns at once! Your newly created campaigns (marked as NEW in Changes tab) are shown above. Duplicate or edit them to create similar campaigns. Add new rows below to build more.
                                        </div>
                                    </>
                                ) : (
                                    <div className="bg-green-50 p-3 rounded-lg text-xs text-green-900 mb-3 border border-green-200">
                                        üí° <strong>Single Keyword Campaign Mode:</strong> Create multiple campaigns where each keyword gets its own campaign. Use {'{keyword}'} as a placeholder in the campaign name (e.g., "Brand | Product | {'{keyword}'}"). The placeholder will be replaced with each keyword from your list.
                                    </div>
                                )}

                                {singleKeywordMode && (
                                    <div className="bg-white p-4 rounded-lg border-2 border-green-300 space-y-3">
                                        <h4 className="font-semibold text-green-900">Single Keyword Campaign Template</h4>
                                        
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                                    Campaign Name Template * <span className="text-green-700">(include {'{keyword}'})</span>
                                                </label>
                                                <input
                                                    type="text"
                                                    value={singleKeywordTemplate.campaignName}
                                                    onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, campaignName: e.target.value})}
                                                    placeholder="KK | SSB | DE | BM_35x16_green_US | SP | SKC | MANUAL | EXACT | {keyword}"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">Portfolio (optional)</label>
                                                <input
                                                    type="text"
                                                    value={singleKeywordTemplate.portfolioName}
                                                    onChange={(e) => {
                                                        const portfolioName = e.target.value;
                                                        const portfolioId = portfolioName ? portfoliosMap.get(portfolioName) : '';
                                                        setSingleKeywordTemplate({
                                                            ...singleKeywordTemplate,
                                                            portfolioName: portfolioName,
                                                            portfolioId: portfolioId || ''
                                                        });
                                                    }}
                                                    list="portfolio-list-skc"
                                                    placeholder="Portfolio name"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                />
                                                {portfolios.length > 0 && (
                                                    <datalist id="portfolio-list-skc">
                                                        {portfolios.map(p => <option key={p} value={p} />)}
                                                    </datalist>
                                                )}
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-4 gap-3">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">Daily Budget</label>
                                                <input
                                                    type="text"
                                                    value={singleKeywordTemplate.dailyBudget}
                                                    onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, dailyBudget: e.target.value})}
                                                    placeholder="10.00"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">Targeting Type</label>
                                                <select
                                                    value={singleKeywordTemplate.targetingType}
                                                    onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, targetingType: e.target.value})}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                >
                                                    <option value="Manual">Manual</option>
                                                    <option value="Auto">Auto</option>
                                                </select>
                                            </div>
                                            <div className="col-span-2">
                                                <label className="block text-xs font-medium text-gray-700 mb-1">Bidding Strategy</label>
                                                <select
                                                    value={singleKeywordTemplate.biddingStrategy}
                                                    onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, biddingStrategy: e.target.value})}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                >
                                                    <option value="Dynamic bids - down only">Dynamic bids - down only</option>
                                                    <option value="Dynamic bids - up and down">Dynamic bids - up and down</option>
                                                    <option value="Fixed bid">Fixed bid</option>
                                                </select>
                                            </div>
                                        </div>

                                        <hr className="my-2" />
                                        <h5 className="text-sm font-medium text-gray-800">Ad Group Settings</h5>

                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                                    Ad Group Name <span className="text-green-700">(can include {'{keyword}'})</span>
                                                </label>
                                                <input
                                                    type="text"
                                                    value={singleKeywordTemplate.adGroupName}
                                                    onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, adGroupName: e.target.value})}
                                                    placeholder="Ad Group - {keyword}"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">Default Bid</label>
                                                <input
                                                    type="text"
                                                    value={singleKeywordTemplate.defaultBid}
                                                    onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, defaultBid: e.target.value})}
                                                    placeholder="0.50"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                />
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">Match Type</label>
                                                <select
                                                    value={singleKeywordTemplate.matchType}
                                                    onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, matchType: e.target.value})}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                >
                                                    <option value="Exact">Exact</option>
                                                    <option value="Phrase">Phrase</option>
                                                    <option value="Broad">Broad</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">Keyword Bid (optional)</label>
                                                <input
                                                    type="text"
                                                    value={singleKeywordTemplate.keywordBid}
                                                    onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, keywordBid: e.target.value})}
                                                    placeholder="0.50"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                />
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-medium text-gray-700 mb-1">
                                                Keywords * <span className="text-green-700">(one per line - each will create a separate campaign)</span>
                                            </label>
                                            <textarea
                                                value={singleKeywordTemplate.keywords}
                                                onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, keywords: e.target.value})}
                                                placeholder={'bath mats\nshower mat\nbath mat non slip anti mould'}
                                                rows="6"
                                                className="w-full px-3 py-2 border border-gray-300 rounded text-sm font-mono"
                                            />
                                            <div className="text-xs text-gray-600 mt-1">
                                                {singleKeywordTemplate.keywords.split('\n').filter(k => k.trim()).length} keyword(s) will create {singleKeywordTemplate.keywords.split('\n').filter(k => k.trim()).length} campaign(s)
                                            </div>
                                        </div>

                                        <details className="bg-gray-50 p-3 rounded">
                                            <summary className="cursor-pointer text-sm font-medium text-gray-700">Optional: Products (SKUs)</summary>
                                            <div className="mt-3">
                                                <textarea
                                                    value={singleKeywordTemplate.products}
                                                    onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, products: e.target.value})}
                                                    placeholder="SKU1&#10;SKU2"
                                                    rows="3"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                />
                                                <p className="text-xs text-gray-600 mt-1">These SKUs will be added to all campaigns</p>
                                            </div>
                                        </details>

                                        <details className="bg-gray-50 p-3 rounded">
                                            <summary className="cursor-pointer text-sm font-medium text-gray-700">Optional: Product Targeting</summary>
                                            <div className="mt-3 space-y-2">
                                                <div className="grid grid-cols-2 gap-3">
                                                    <select
                                                        value={singleKeywordTemplate.targetingMethod}
                                                        onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, targetingMethod: e.target.value})}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                    >
                                                        <option value="asin">Individual ASINs</option>
                                                        <option value="asin-expanded">Expanded ASIN</option>
                                                        <option value="category">Category</option>
                                                    </select>
                                                    <input
                                                        type="text"
                                                        value={singleKeywordTemplate.productTargetBid}
                                                        onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, productTargetBid: e.target.value})}
                                                        placeholder="Product Target Bid"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                    />
                                                </div>
                                                <textarea
                                                    value={singleKeywordTemplate.productTargets}
                                                    onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, productTargets: e.target.value})}
                                                    placeholder="B0CL21ZDS3"
                                                    rows="3"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm font-mono"
                                                />
                                            </div>
                                        </details>

                                        <details className="bg-gray-50 p-3 rounded">
                                            <summary className="cursor-pointer text-sm font-medium text-gray-700">Optional: Placement Bid Adjustments</summary>
                                            <div className="mt-3 grid grid-cols-3 gap-3">
                                                <div>
                                                    <label className="block text-xs text-gray-700 mb-1">Top of Search %</label>
                                                    <input
                                                        type="text"
                                                        value={singleKeywordTemplate.topOfSearchMod}
                                                        onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, topOfSearchMod: e.target.value})}
                                                        placeholder="0"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-gray-700 mb-1">Rest of Search %</label>
                                                    <input
                                                        type="text"
                                                        value={singleKeywordTemplate.restOfSearchMod}
                                                        onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, restOfSearchMod: e.target.value})}
                                                        placeholder="0"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-gray-700 mb-1">Product Pages %</label>
                                                    <input
                                                        type="text"
                                                        value={singleKeywordTemplate.productPagesMod}
                                                        onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, productPagesMod: e.target.value})}
                                                        placeholder="0"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                    />
                                                </div>
                                            </div>
                                        </details>

                                        <details className="bg-gray-50 p-3 rounded">
                                            <summary className="cursor-pointer text-sm font-medium text-gray-700">Optional: Negative Keywords</summary>
                                            <div className="mt-3 space-y-2">
                                                <div className="grid grid-cols-3 gap-3">
                                                    <div className="col-span-2">
                                                        <label className="block text-xs text-gray-700 mb-1">Negative Match Type</label>
                                                        <select
                                                            value={singleKeywordTemplate.negativeMatchType}
                                                            onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, negativeMatchType: e.target.value})}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                        >
                                                            <option value="Negative exact">Negative Exact</option>
                                                            <option value="Negative phrase">Negative Phrase</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <textarea
                                                    value={singleKeywordTemplate.negativeKeywords}
                                                    onChange={(e) => setSingleKeywordTemplate({...singleKeywordTemplate, negativeKeywords: e.target.value})}
                                                    placeholder="Enter negative keywords (one per line)&#10;competitor brand&#10;cheap&#10;free"
                                                    rows="4"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                />
                                                <p className="text-xs text-gray-600">These negative keywords will be added to all campaigns created</p>
                                            </div>
                                        </details>

                                        <div className="flex gap-3 pt-3">
                                            <button
                                                onClick={createBulkCampaigns}
                                                disabled={!singleKeywordTemplate.campaignName || !singleKeywordTemplate.keywords || !singleKeywordTemplate.campaignName.includes('{keyword}')}
                                                className={`flex-1 px-4 py-2 rounded-lg font-medium ${
                                                    singleKeywordTemplate.campaignName && singleKeywordTemplate.keywords && singleKeywordTemplate.campaignName.includes('{keyword}')
                                                        ? 'bg-green-600 text-white hover:bg-green-700'
                                                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                }`}
                                            >
                                                Create {singleKeywordTemplate.keywords.split('\n').filter(k => k.trim()).length} Campaign(s)
                                            </button>
                                            <button
                                                onClick={onClose}
                                                className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {data.length > 0 && !singleKeywordMode && (
                                    <div className="bg-orange-50 p-3 rounded-lg text-xs text-orange-900 mb-3 border border-orange-200">
                                        ‚ö†Ô∏è <strong>Duplicate Checker Active:</strong> Keywords and SKUs that already exist in your campaigns will be highlighted in orange with a warning icon. Hover over the ‚ö†Ô∏è to see which campaign/ad group contains the duplicate.
                                    </div>
                                )}

                                {/* NEW FEATURE: Load Existing Campaign Section */}
                                {data.length > 0 && getAllExistingCampaigns().length > 0 && !singleKeywordMode && (
                                    <div className="mb-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
                                        <div className="flex items-center justify-between mb-2">
                                            <h4 className="text-sm font-semibold text-purple-900">üìã Duplicate Existing Campaign</h4>
                                            <button
                                                onClick={() => setShowExistingCampaigns(!showExistingCampaigns)}
                                                className="text-xs px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700"
                                            >
                                                {showExistingCampaigns ? 'Hide' : 'Show Campaigns'}
                                            </button>
                                        </div>
                                        
                                        {showExistingCampaigns && (
                                            <div className="space-y-3 mt-3">
                                                <p className="text-xs text-purple-800">
                                                    Select an existing campaign to duplicate and edit. All ad groups, keywords, products, and settings will be copied.
                                                </p>
                                                
                                                {/* Search and Filter Row */}
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="text-xs font-medium text-purple-900 block mb-1">
                                                            üîç Search Campaigns
                                                        </label>
                                                        <input
                                                            type="text"
                                                            placeholder="Search by campaign or portfolio name..."
                                                            value={campaignSearchText}
                                                            onChange={(e) => setCampaignSearchText(e.target.value)}
                                                            className="w-full px-3 py-2 border border-purple-300 rounded text-sm"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="text-xs font-medium text-purple-900 block mb-1">
                                                            üìÅ Filter by Portfolio
                                                        </label>
                                                        <select
                                                            value={selectedPortfolioFilter}
                                                            onChange={(e) => setSelectedPortfolioFilter(e.target.value)}
                                                            className="w-full px-3 py-2 border border-purple-300 rounded text-sm"
                                                        >
                                                            <option value="">All Portfolios</option>
                                                            {getUniquePortfolios().map((portfolio, idx) => (
                                                                <option key={idx} value={portfolio}>
                                                                    {portfolio}
                                                                </option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                </div>

                                                {/* Campaign Selection and Load Button */}
                                                <div className="flex gap-2">
                                                    <div className="flex-1">
                                                        <label className="text-xs font-medium text-purple-900 block mb-1">
                                                            Select Campaign {getFilteredCampaigns().length > 0 && `(${getFilteredCampaigns().length} found)`}
                                                        </label>
                                                        <select
                                                            value={selectedExistingCampaign}
                                                            onChange={(e) => setSelectedExistingCampaign(e.target.value)}
                                                            className="w-full px-3 py-2 border border-purple-300 rounded text-sm"
                                                            size="6"
                                                        >
                                                            <option value="">-- Select a campaign to duplicate --</option>
                                                            {getFilteredCampaigns().map((camp, idx) => (
                                                                <option key={idx} value={camp.campaignId}>
                                                                    {camp.campaignName} {camp.portfolioName && `[${camp.portfolioName}]`} {camp.state === 'archived' ? '(Archived)' : ''}
                                                                </option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                    <div className="flex items-end">
                                                        <button
                                                            onClick={loadSelectedExistingCampaign}
                                                            disabled={!selectedExistingCampaign}
                                                            className={`px-6 py-2 rounded text-sm font-medium h-10 ${
                                                                selectedExistingCampaign
                                                                    ? 'bg-purple-600 text-white hover:bg-purple-700'
                                                                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                            }`}
                                                        >
                                                            Load & Edit
                                                        </button>
                                                    </div>
                                                </div>

                                                {/* Clear Filters Button */}
                                                {(campaignSearchText || selectedPortfolioFilter) && (
                                                    <button
                                                        onClick={() => {
                                                            setCampaignSearchText('');
                                                            setSelectedPortfolioFilter('');
                                                        }}
                                                        className="text-xs text-purple-700 hover:text-purple-900 underline"
                                                    >
                                                        Clear all filters
                                                    </button>
                                                )}

                                                {getFilteredCampaigns().length === 0 && (
                                                    <div className="text-center py-4 text-purple-700 bg-purple-100 rounded border border-purple-200">
                                                        <p className="text-sm">No campaigns found matching your filters.</p>
                                                        <button
                                                            onClick={() => {
                                                                setCampaignSearchText('');
                                                                setSelectedPortfolioFilter('');
                                                            }}
                                                            className="mt-2 text-xs text-purple-600 hover:text-purple-800 underline"
                                                        >
                                                            Clear filters
                                                        </button>
                                                    </div>
                                                )}
                                                
                                                {selectedExistingCampaign && (
                                                    <div className="text-xs text-purple-700 mt-2 p-2 bg-purple-100 rounded">
                                                        <strong>Note:</strong> The campaign will be added to your draft list below where you can edit the name, budget, targets, bids, and all other settings before creating it.
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* Created Campaigns Section */}
                                {createdCampaigns.length > 0 && !singleKeywordMode && (
                                    <div className="mb-4">
                                        <div className="flex items-center justify-between mb-2">
                                            <h4 className="text-sm font-semibold text-green-800">‚úÖ Newly Created Campaigns ({createdCampaigns.length})</h4>
                                            <span className="text-xs text-gray-600">Ready to export - you can edit, duplicate, or delete before closing</span>
                                        </div>
                                        <div className="bg-blue-50 p-2 rounded text-xs text-blue-900 mb-2 border border-blue-200">
                                            üí° <strong>Quick Actions:</strong> Edit (‚úèÔ∏è) to modify settings, Duplicate (üìã) to create similar campaigns, or Delete (üóëÔ∏è) to remove completely.
                                        </div>
                                        <div className="overflow-x-auto max-h-[35vh] border rounded-lg bg-green-50">
                                            <table className="w-full text-xs">
                                                <thead className="bg-green-100 sticky top-0">
                                                    <tr>
                                                        <th className="px-2 py-2 text-left font-medium w-8">#</th>
                                                        <th className="px-2 py-2 text-left font-medium min-w-[150px]">Campaign Name</th>
                                                        <th className="px-2 py-2 text-left font-medium min-w-[120px]">Portfolio</th>
                                                        <th className="px-2 py-2 text-left font-medium w-24">Budget</th>
                                                        <th className="px-2 py-2 text-left font-medium min-w-[150px]">Ad Group Name</th>
                                                        <th className="px-2 py-2 text-left font-medium min-w-[100px]">Keywords</th>
                                                        <th className="px-2 py-2 text-left font-medium min-w-[100px]">Products (SKUs)</th>
                                                        <th className="px-2 py-2 text-left font-medium w-32">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {createdCampaigns.map((camp, index) => (
                                                        <tr key={camp.id} className="border-t hover:bg-green-100">
                                                            <td className="px-2 py-2 text-gray-600">{index + 1}</td>
                                                            <td className="px-2 py-2 font-medium">{camp.campaignName}</td>
                                                            <td className="px-2 py-2">{camp.portfolioName || '-'}</td>
                                                            <td className="px-2 py-2">{camp.dailyBudget || '-'}</td>
                                                            <td className="px-2 py-2">{camp.adGroupName || '-'}</td>
                                                            <td className="px-2 py-2">
                                                                <div className="max-w-[100px] truncate" title={camp.keywords}>
                                                                    {camp.keywords ? camp.keywords.split('\n').filter(k => k.trim()).length + ' keyword(s)' : '-'}
                                                                </div>
                                                            </td>
                                                            <td className="px-2 py-2">
                                                                <div className="max-w-[100px] truncate" title={camp.products}>
                                                                    {camp.products ? camp.products.split('\n').filter(p => p.trim()).length + ' SKU(s)' : '-'}
                                                                </div>
                                                            </td>
                                                            <td className="px-2 py-2">
                                                                <div className="flex gap-1">
                                                                    <button
                                                                        onClick={() => editCreatedCampaign(index)}
                                                                        className="p-1 text-blue-600 hover:bg-blue-100 rounded"
                                                                        title="Edit - move back to draft to modify"
                                                                    >
                                                                        ‚úèÔ∏è
                                                                    </button>
                                                                    <button
                                                                        onClick={() => duplicateCreatedCampaign(index)}
                                                                        className="p-1 text-green-600 hover:bg-green-100 rounded"
                                                                        title="Duplicate to create another similar campaign"
                                                                    >
                                                                        üìã
                                                                    </button>
                                                                    <button
                                                                        onClick={() => removeCreatedCampaign(index)}
                                                                        className="p-1 text-red-600 hover:bg-red-100 rounded"
                                                                        title="Delete completely from changes"
                                                                    >
                                                                        üóëÔ∏è
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {/* Draft Campaigns Section */}
                                {bulkCampaigns.length > 0 && !singleKeywordMode && (
                                    <div className="flex items-center justify-between mb-3">
                                        <h4 className="text-base font-semibold text-gray-800 flex items-center gap-2">
                                            <span className="text-xl">üìù</span> Draft Campaigns 
                                            <span className="ml-2 px-2.5 py-0.5 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">
                                                {bulkCampaigns.length}
                                            </span>
                                        </h4>
                                        <span className="text-xs text-gray-500">Expand cards for advanced options</span>
                                    </div>
                                )}

                                {bulkCampaigns.length === 0 && createdCampaigns.length === 0 && !singleKeywordMode && (
                                    <div className="text-center py-12 text-gray-500 bg-gradient-to-br from-gray-50 to-blue-50 rounded-xl border-2 border-dashed border-gray-300">
                                        <div className="text-4xl mb-3">üì¶</div>
                                        <p className="text-base font-medium text-gray-600">No campaigns yet</p>
                                        <p className="text-sm text-gray-500 mt-1">Click "Add New Campaign" below to start building</p>
                                    </div>
                                )}

                                {bulkCampaigns.length === 0 && createdCampaigns.length > 0 && !singleKeywordMode && (
                                    <div className="text-center py-10 text-green-700 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border border-green-200">
                                        <div className="text-4xl mb-3">‚úÖ</div>
                                        <p className="text-base font-medium">All campaigns created successfully!</p>
                                        <p className="text-sm text-green-600 mt-1">Click "Add New Campaign" to build more, or duplicate from your newly created ones above.</p>
                                    </div>
                                )}

                                {bulkCampaigns.length > 0 && !singleKeywordMode && (
                                <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                                    {bulkCampaigns.map((camp, index) => {
                                        const keywordDuplicates = checkDuplicates(camp.keywords, 'keywords');
                                        const productDuplicates = checkDuplicates(camp.products, 'products');
                                        
                                        return (
                                        <div key={camp.id} className="bg-white border-2 border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                                            {/* Card Header */}
                                            <div className="flex items-center justify-between px-4 py-3 bg-gradient-to-r from-gray-50 to-gray-100 border-b rounded-t-xl">
                                                <div className="flex items-center gap-3">
                                                    <span className="flex items-center justify-center w-8 h-8 bg-blue-600 text-white rounded-full text-sm font-bold">
                                                        {index + 1}
                                                    </span>
                                                    <div className="flex-1 min-w-0">
                                                        <input
                                                            type="text"
                                                            value={camp.campaignName}
                                                            onChange={(e) => updateBulkCampaign(index, 'campaignName', e.target.value)}
                                                            placeholder="Enter Campaign Name *"
                                                            className="w-full text-base font-semibold bg-transparent border-0 border-b-2 border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-0 px-0 py-1 transition-colors"
                                                            style={{minWidth: '400px'}}
                                                        />
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <button
                                                        onClick={() => duplicateBulkCampaign(index)}
                                                        className="px-3 py-1.5 text-sm text-blue-600 hover:bg-blue-50 rounded-lg flex items-center gap-1 transition-colors"
                                                        title="Duplicate Campaign"
                                                    >
                                                        üìã Duplicate
                                                    </button>
                                                    <button
                                                        onClick={() => removeBulkCampaign(index)}
                                                        className="px-3 py-1.5 text-sm text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-1 transition-colors"
                                                        title="Remove Campaign"
                                                    >
                                                        üóëÔ∏è Remove
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            {/* Card Body */}
                                            <div className="p-4 space-y-4">
                                                {/* Row 1: Campaign Settings */}
                                                <div className="grid grid-cols-5 gap-4">
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1.5">Portfolio</label>
                                                        <input
                                                            type="text"
                                                            value={camp.portfolioName}
                                                            onChange={(e) => {
                                                                const portfolioName = e.target.value;
                                                                const portfolioId = portfolioName ? portfoliosMap.get(portfolioName) : '';
                                                                const newCampaigns = [...bulkCampaigns];
                                                                newCampaigns[index].portfolioName = portfolioName;
                                                                newCampaigns[index].portfolioId = portfolioId || '';
                                                                setBulkCampaigns(newCampaigns);
                                                            }}
                                                            list={`portfolio-list-${index}`}
                                                            placeholder="Select portfolio..."
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                        />
                                                        {portfolios.length > 0 && (
                                                            <datalist id={`portfolio-list-${index}`}>
                                                                {portfolios.map(p => <option key={p} value={p} />)}
                                                            </datalist>
                                                        )}
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1.5">Daily Budget</label>
                                                        <input
                                                            type="text"
                                                            value={camp.dailyBudget}
                                                            onChange={(e) => updateBulkCampaign(index, 'dailyBudget', e.target.value)}
                                                            placeholder="10.00"
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1.5">Targeting</label>
                                                        <select
                                                            value={camp.targetingType}
                                                            onChange={(e) => updateBulkCampaign(index, 'targetingType', e.target.value)}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                                                        >
                                                            <option value="Manual">Manual</option>
                                                            <option value="Auto">Auto</option>
                                                        </select>
                                                    </div>
                                                    <div className="col-span-2">
                                                        <label className="block text-xs font-medium text-gray-600 mb-1.5">Bidding Strategy</label>
                                                        <select
                                                            value={camp.biddingStrategy}
                                                            onChange={(e) => updateBulkCampaign(index, 'biddingStrategy', e.target.value)}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                                                        >
                                                            <option value="Dynamic bids - down only">Dynamic bids - down only</option>
                                                            <option value="Dynamic bids - up and down">Dynamic bids - up and down</option>
                                                            <option value="Fixed bid">Fixed bid</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                {/* Row 2: Ad Group Settings */}
                                                <div className="grid grid-cols-3 gap-4 pt-2 border-t border-gray-100">
                                                    <div className="col-span-2">
                                                        <label className="block text-xs font-medium text-gray-600 mb-1.5">Ad Group Name</label>
                                                        <input
                                                            type="text"
                                                            value={camp.adGroupName}
                                                            onChange={(e) => updateBulkCampaign(index, 'adGroupName', e.target.value)}
                                                            placeholder="Enter ad group name..."
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1.5">Default Bid</label>
                                                        <input
                                                            type="text"
                                                            value={camp.defaultBid}
                                                            onChange={(e) => updateBulkCampaign(index, 'defaultBid', e.target.value)}
                                                            placeholder="0.50"
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                        />
                                                    </div>
                                                </div>

                                                {/* Row 3: Products & Keywords - Side by Side with Large Textareas */}
                                                <div className="grid grid-cols-2 gap-6 pt-2 border-t border-gray-100">
                                                    {/* Products (SKUs) */}
                                                    <div>
                                                        <div className="flex items-center justify-between mb-1.5">
                                                            <label className="text-xs font-medium text-gray-600 flex items-center gap-1">
                                                                üì¶ Products (SKUs)
                                                                {productDuplicates.length > 0 && (
                                                                    <span className="text-orange-600">‚ö†Ô∏è</span>
                                                                )}
                                                            </label>
                                                            <span className="text-xs text-gray-400">
                                                                {camp.products.split('\n').filter(s => s.trim()).length} items
                                                            </span>
                                                        </div>
                                                        <div className="relative">
                                                            <textarea
                                                                value={camp.products}
                                                                onChange={(e) => updateBulkCampaign(index, 'products', e.target.value)}
                                                                placeholder="Enter SKUs (one per line)&#10;SKU1&#10;SKU2&#10;SKU3"
                                                                rows="6"
                                                                className={`w-full px-3 py-2 border rounded-lg text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y ${
                                                                    productDuplicates.length > 0 ? 'border-orange-400 bg-orange-50' : 'border-gray-300'
                                                                }`}
                                                                style={{minHeight: '120px'}}
                                                            />
                                                        </div>
                                                        {productDuplicates.length > 0 && (
                                                            <div className="mt-1.5 px-2 py-1 bg-orange-100 rounded text-xs text-orange-700 font-medium">
                                                                ‚ö†Ô∏è {productDuplicates.length} duplicate{productDuplicates.length > 1 ? 's' : ''} found
                                                                <span 
                                                                    className="ml-1 cursor-help underline decoration-dotted"
                                                                    title={productDuplicates.map(d => `${d.text} ‚Üí ${d.campaign} / ${d.adGroup}`).join('\n')}
                                                                >
                                                                    (hover for details)
                                                                </span>
                                                            </div>
                                                        )}
                                                    </div>

                                                    {/* Keywords */}
                                                    <div>
                                                        <div className="flex items-center justify-between mb-1.5">
                                                            <label className="text-xs font-medium text-gray-600 flex items-center gap-1">
                                                                üîë Keywords
                                                                {keywordDuplicates.length > 0 && (
                                                                    <span className="text-orange-600">‚ö†Ô∏è</span>
                                                                )}
                                                            </label>
                                                            <span className="text-xs text-gray-400">
                                                                {camp.keywords.split('\n').filter(s => s.trim()).length} items
                                                            </span>
                                                        </div>
                                                        <div className="relative">
                                                            <textarea
                                                                value={camp.keywords}
                                                                onChange={(e) => updateBulkCampaign(index, 'keywords', e.target.value)}
                                                                placeholder="Enter keywords (one per line)&#10;keyword one&#10;keyword two&#10;keyword three"
                                                                rows="6"
                                                                className={`w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y ${
                                                                    keywordDuplicates.length > 0 ? 'border-orange-400 bg-orange-50' : 'border-gray-300'
                                                                }`}
                                                                style={{minHeight: '120px'}}
                                                            />
                                                        </div>
                                                        {keywordDuplicates.length > 0 && (
                                                            <div className="mt-1.5 px-2 py-1 bg-orange-100 rounded text-xs text-orange-700 font-medium">
                                                                ‚ö†Ô∏è {keywordDuplicates.length} duplicate{keywordDuplicates.length > 1 ? 's' : ''} found
                                                                <span 
                                                                    className="ml-1 cursor-help underline decoration-dotted"
                                                                    title={keywordDuplicates.map(d => `${d.text} (${d.matchType}) ‚Üí ${d.campaign} / ${d.adGroup}`).join('\n')}
                                                                >
                                                                    (hover for details)
                                                                </span>
                                                            </div>
                                                        )}
                                                        {/* Match Type & Bid inline */}
                                                        <div className="grid grid-cols-2 gap-3 mt-3">
                                                            <div>
                                                                <label className="block text-xs font-medium text-gray-500 mb-1">Match Type</label>
                                                                <select
                                                                    value={camp.matchType}
                                                                    onChange={(e) => updateBulkCampaign(index, 'matchType', e.target.value)}
                                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                                                                >
                                                                    <option value="Broad">Broad</option>
                                                                    <option value="Phrase">Phrase</option>
                                                                    <option value="Exact">Exact</option>
                                                                </select>
                                                            </div>
                                                            <div>
                                                                <label className="block text-xs font-medium text-gray-500 mb-1">Keyword Bid</label>
                                                                <input
                                                                    type="text"
                                                                    value={camp.keywordBid}
                                                                    onChange={(e) => updateBulkCampaign(index, 'keywordBid', e.target.value)}
                                                                    placeholder="0.50"
                                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                                />
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Collapsible: Product Targeting & Bid Modifiers */}
                                                <details className="pt-2 border-t border-gray-100">
                                                    <summary className="cursor-pointer text-sm font-medium text-gray-700 hover:text-blue-600 flex items-center gap-2 py-2">
                                                        <span className="text-gray-400">‚ñ∂</span>
                                                        Advanced Options (Product Targeting, Bid Modifiers & Negative Keywords)
                                                    </summary>
                                                    <div className="pt-3 space-y-4">
                                                        {/* Product Targets */}
                                                        <div className="grid grid-cols-3 gap-4">
                                                            <div className="col-span-2">
                                                                <label className="block text-xs font-medium text-gray-600 mb-1.5">üéØ Product Targets (ASINs)</label>
                                                                <textarea
                                                                    value={camp.productTargets || ''}
                                                                    onChange={(e) => updateBulkCampaign(index, 'productTargets', e.target.value)}
                                                                    placeholder="Enter ASINs (one per line)&#10;B0CL21ZDS3&#10;B09ABCDEF1"
                                                                    rows="4"
                                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y"
                                                                />
                                                            </div>
                                                            <div className="space-y-3">
                                                                <div>
                                                                    <label className="block text-xs font-medium text-gray-600 mb-1.5">Target Type</label>
                                                                    <select
                                                                        value={camp.targetingMethod || 'asin'}
                                                                        onChange={(e) => updateBulkCampaign(index, 'targetingMethod', e.target.value)}
                                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                                                                    >
                                                                        <option value="asin">ASIN</option>
                                                                        <option value="asin-expanded">ASIN Expanded</option>
                                                                        <option value="category">Category</option>
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-medium text-gray-600 mb-1.5">PT Bid</label>
                                                                    <input
                                                                        type="text"
                                                                        value={camp.productTargetBid || ''}
                                                                        onChange={(e) => updateBulkCampaign(index, 'productTargetBid', e.target.value)}
                                                                        placeholder="0.50"
                                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                                    />
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Bid Modifiers */}
                                                        <div>
                                                            <label className="block text-xs font-medium text-gray-600 mb-2">üìä Placement Bid Adjustments (%)</label>
                                                            <div className="grid grid-cols-3 gap-4">
                                                                <div>
                                                                    <label className="block text-xs text-gray-500 mb-1">Top of Search</label>
                                                                    <input
                                                                        type="text"
                                                                        value={camp.topOfSearchMod || ''}
                                                                        onChange={(e) => updateBulkCampaign(index, 'topOfSearchMod', e.target.value)}
                                                                        placeholder="0"
                                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs text-gray-500 mb-1">Rest of Search</label>
                                                                    <input
                                                                        type="text"
                                                                        value={camp.restOfSearchMod || ''}
                                                                        onChange={(e) => updateBulkCampaign(index, 'restOfSearchMod', e.target.value)}
                                                                        placeholder="0"
                                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs text-gray-500 mb-1">Product Pages</label>
                                                                    <input
                                                                        type="text"
                                                                        value={camp.productPagesMod || ''}
                                                                        onChange={(e) => updateBulkCampaign(index, 'productPagesMod', e.target.value)}
                                                                        placeholder="0"
                                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                                    />
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Negative Keywords */}
                                                        <div>
                                                            <label className="block text-xs font-medium text-gray-600 mb-2">üö´ Negative Keywords</label>
                                                            <div className="grid grid-cols-3 gap-4">
                                                                <div className="col-span-2">
                                                                    <textarea
                                                                        value={camp.negativeKeywords || ''}
                                                                        onChange={(e) => updateBulkCampaign(index, 'negativeKeywords', e.target.value)}
                                                                        placeholder="Enter negative keywords (one per line)&#10;competitor brand&#10;cheap&#10;free"
                                                                        rows="3"
                                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y"
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs text-gray-500 mb-1">Match Type</label>
                                                                    <select
                                                                        value={camp.negativeMatchType || 'Negative exact'}
                                                                        onChange={(e) => updateBulkCampaign(index, 'negativeMatchType', e.target.value)}
                                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                                                                    >
                                                                        <option value="Negative exact">Negative Exact</option>
                                                                        <option value="Negative phrase">Negative Phrase</option>
                                                                    </select>
                                                                    <p className="text-[10px] text-gray-500 mt-1">
                                                                        {(camp.negativeKeywords || '').split('\n').filter(k => k.trim()).length} negative keywords
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </details>
                                            </div>
                                        </div>
                                        );
                                    })}
                                </div>
                                )}
                                


                                {!singleKeywordMode && (
                                    <button
                                        onClick={addEmptyBulkCampaign}
                                        className="w-full px-4 py-3 bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-700 rounded-xl hover:from-blue-100 hover:to-indigo-100 text-sm font-medium border-2 border-dashed border-blue-300 hover:border-blue-400 transition-all flex items-center justify-center gap-2"
                                    >
                                        <span className="text-lg">‚ûï</span> Add New Campaign
                                    </button>
                                )}

                                {!singleKeywordMode && (
                                    <div className="flex gap-3 mt-4 pt-4 border-t border-gray-200">
                                    {bulkCampaigns.length > 0 ? (
                                        <>
                                            <button
                                                onClick={createBulkCampaigns}
                                                className="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl hover:from-blue-700 hover:to-blue-800 font-medium shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2"
                                            >
                                                <span>üöÄ</span> Create {bulkCampaigns.length} New Campaign{bulkCampaigns.length !== 1 ? 's' : ''}
                                            </button>
                                            <button
                                                onClick={onClose}
                                                className="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-medium transition-all"
                                            >
                                                Cancel
                                            </button>
                                        </>
                                    ) : (
                                        <button
                                            onClick={onClose}
                                            className="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl hover:from-green-700 hover:to-green-800 font-medium shadow-lg shadow-green-200 transition-all flex items-center justify-center gap-2"
                                        >
                                            <span>‚úì</span> Done {createdCampaigns.length > 0 ? `(${createdCampaigns.length} campaign${createdCampaigns.length !== 1 ? 's' : ''} created)` : ''}
                                        </button>
                                    )}
                                </div>
                                )}
                            </div>
                        );
                    }

                    // Single campaign mode
                    return (
                        <div className="space-y-3">
                            <div className="flex items-center justify-between">
                                <h3 className="text-lg font-semibold">Campaign Builder</h3>
                                <button
                                    onClick={() => setBulkMode(true)}
                                    className="text-sm text-blue-600 hover:text-blue-800 underline"
                                >
                                    Switch to Bulk Mode
                                </button>
                            </div>
                            
                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => {
                                    const portfolioName = e.target.value;
                                    const portfolioId = portfolioName ? portfoliosMap.get(portfolioName) : '';
                                    setFormData({
                                        ...formData, 
                                        portfolioName: portfolioName,
                                        portfolioId: portfolioId || ''
                                    });
                                }}
                            >
                                <option value="">Portfolio (optional)</option>
                                {portfolios.map((p, i) => (
                                    <option key={i} value={p}>{p}</option>
                                ))}
                            </select>

                            <input
                                type="text"
                                placeholder="Campaign Name *"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, name: e.target.value})}
                            />

                            <input
                                type="number"
                                placeholder="Daily Budget"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, budget: e.target.value})}
                            />

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, targetingType: e.target.value})}
                                defaultValue="Manual"
                            >
                                <option value="Manual">Manual</option>
                                <option value="Auto">Auto</option>
                            </select>

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, biddingStrategy: e.target.value})}
                                defaultValue="Dynamic bids - down only"
                            >
                                <option value="Dynamic bids - down only">Dynamic bids - down only</option>
                                <option value="Dynamic bids - up and down">Dynamic bids - up and down</option>
                                <option value="Fixed bid">Fixed bid</option>
                            </select>

                            <hr className="my-4" />
                            <h4 className="font-medium">Bid Adjustments (optional)</h4>
                            <p className="text-sm text-gray-600 mb-2">Enter percentage modifiers for different placements (e.g., 50 for +50%)</p>

                            <div className="grid grid-cols-3 gap-3">
                                <div>
                                    <label className="block text-sm text-gray-700 mb-1">Top of Search %</label>
                                    <input
                                        type="number"
                                        placeholder="0"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        onChange={(e) => setFormData({...formData, topOfSearchMod: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-700 mb-1">Rest of Search %</label>
                                    <input
                                        type="number"
                                        placeholder="0"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        onChange={(e) => setFormData({...formData, restOfSearchMod: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-700 mb-1">Product Pages %</label>
                                    <input
                                        type="number"
                                        placeholder="0"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        onChange={(e) => setFormData({...formData, productPagesMod: e.target.value})}
                                    />
                                </div>
                            </div>

                            <hr className="my-4" />
                            <h4 className="font-medium">Add Ad Group (optional)</h4>

                            <input
                                type="text"
                                placeholder="Ad Group Name"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, adGroupName: e.target.value})}
                            />

                            <input
                                type="number"
                                placeholder="Default Bid"
                                step="0.01"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, defaultBid: e.target.value})}
                            />

                            <textarea
                                placeholder="Products (one SKU per line)"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                rows="3"
                                onChange={(e) => setFormData({...formData, skus: e.target.value})}
                            />

                            <textarea
                                placeholder="Keywords (one per line)"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                rows="3"
                                onChange={(e) => setFormData({...formData, keywords: e.target.value})}
                            />

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, matchType: e.target.value})}
                                defaultValue="Broad"
                            >
                                <option value="Broad">Broad Match</option>
                                <option value="Phrase">Phrase Match</option>
                                <option value="Exact">Exact Match</option>
                            </select>

                            <input
                                type="number"
                                placeholder="Keyword Bid (optional)"
                                step="0.01"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, keywordBid: e.target.value})}
                            />

                            <hr className="my-4" />
                            <h4 className="font-medium">Product Targeting (optional)</h4>
                            <p className="text-sm text-gray-600 mb-2">Add ASINs for product targeting. They will be auto-formatted.</p>
                            
                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, targetingMethod: e.target.value})}
                                defaultValue="asin"
                            >
                                <option value="asin">Individual ASINs</option>
                                <option value="asin-expanded">Expanded ASIN Targeting</option>
                                <option value="category">Category Targeting</option>
                            </select>

                            <textarea
                                placeholder="ASINs or Category IDs (one per line, e.g., B0CL21ZDS3)"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg font-mono text-sm"
                                rows="4"
                                onChange={(e) => setFormData({...formData, productTargets: e.target.value})}
                            />

                            <input
                                type="number"
                                placeholder="Product Target Bid (optional)"
                                step="0.01"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, productTargetBid: e.target.value})}
                            />

                            <hr className="my-4" />
                            <h4 className="font-medium">Negative Keywords (optional)</h4>
                            <p className="text-sm text-gray-600 mb-2">Add negative keywords to exclude from targeting</p>

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, negativeMatchType: e.target.value})}
                                defaultValue="Negative exact"
                            >
                                <option value="Negative exact">Negative Exact</option>
                                <option value="Negative phrase">Negative Phrase</option>
                            </select>

                            <textarea
                                placeholder="Negative keywords (one per line)&#10;competitor brand&#10;cheap&#10;free"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                rows="4"
                                onChange={(e) => setFormData({...formData, negativeKeywords: e.target.value})}
                            />
                        </div>
                    );
                } else if (type === 'keywords') {
                    const keywordDuplicates = checkDuplicates(formData.keywords, 'keywords', formData.campaignId, formData.adGroupId);
                    
                    return (
                        <div className="space-y-3">
                            <h3 className="text-lg font-semibold">Add Keywords (Bulk)</h3>
                            
                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => {
                                    const campaign = campaigns.find(c => c['Campaign ID'] === e.target.value);
                                    setFormData({
                                        ...formData,
                                        campaignId: e.target.value,
                                        campaignName: getCampaignName(campaign)
                                    });
                                }}
                            >
                                <option value="">Select Campaign *</option>
                                {campaigns.map((c, i) => (
                                    <option key={i} value={c['Campaign ID']}>
                                        {getCampaignName(c)}
                                    </option>
                                ))}
                            </select>

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => {
                                    const ag = adGroups.find(a => a['Ad Group ID'] === e.target.value);
                                    setFormData({
                                        ...formData,
                                        adGroupId: e.target.value,
                                        adGroupName: getAdGroupName(ag)
                                    });
                                }}
                            >
                                <option value="">Select Ad Group *</option>
                                {adGroups
                                    .filter(ag => !formData.campaignId || ag['Campaign ID'] === formData.campaignId)
                                    .map((ag, i) => (
                                        <option key={i} value={ag['Ad Group ID']}>
                                            {getAdGroupName(ag)}
                                        </option>
                                    ))}
                            </select>

                            <div className="relative">
                                <textarea
                                    placeholder="Keywords (one per line) *"
                                    className={`w-full px-4 py-2 border rounded-lg ${
                                        keywordDuplicates.length > 0 ? 'border-orange-400 bg-orange-50' : 'border-gray-300'
                                    }`}
                                    rows="10"
                                    onChange={(e) => setFormData({...formData, keywords: e.target.value})}
                                />
                                {keywordDuplicates.length > 0 && (
                                    <div className="absolute top-0 right-0 mt-1 mr-1">
                                        <span 
                                            className="text-orange-600 cursor-help text-xs"
                                            title={`Duplicates found:\n${keywordDuplicates.map(d => `${d.text} (${d.matchType}) ‚Üí ${d.campaign} / ${d.adGroup}`).join('\n')}`}
                                        >
                                            ‚ö†Ô∏è
                                        </span>
                                    </div>
                                )}
                            </div>
                            {keywordDuplicates.length > 0 && (
                                <div className="mt-1 text-xs text-orange-700 font-medium">
                                    {keywordDuplicates.length} duplicate{keywordDuplicates.length > 1 ? 's' : ''} found
                                </div>
                            )}

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, matchType: e.target.value})}
                                defaultValue="Broad"
                            >
                                <option value="Broad">Broad</option>
                                <option value="Phrase">Phrase</option>
                                <option value="Exact">Exact</option>
                            </select>

                            <input
                                type="number"
                                placeholder="Bid (optional)"
                                step="0.01"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, bid: e.target.value})}
                            />
                        </div>
                    );
                } else if (type === 'negative') {
                    const negativeDuplicates = checkDuplicates(formData.negativeKeywords, 'negatives', formData.campaignId, formData.adGroupId);
                    
                    return (
                        <div className="space-y-3">
                            <h3 className="text-lg font-semibold">Add Negative Keywords (Bulk)</h3>
                            
                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, level: e.target.value})}
                                defaultValue="campaign"
                            >
                                <option value="campaign">Campaign-level</option>
                                <option value="adgroup">Ad Group-level</option>
                            </select>

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => {
                                    const campaign = campaigns.find(c => c['Campaign ID'] === e.target.value);
                                    setFormData({
                                        ...formData,
                                        campaignId: e.target.value,
                                        campaignName: getCampaignName(campaign)
                                    });
                                }}
                            >
                                <option value="">Select Campaign *</option>
                                {campaigns.map((c, i) => (
                                    <option key={i} value={c['Campaign ID']}>
                                        {getCampaignName(c)}
                                    </option>
                                ))}
                            </select>

                            {formData.level === 'adgroup' && (
                                <select
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    onChange={(e) => {
                                        const ag = adGroups.find(a => a['Ad Group ID'] === e.target.value);
                                        setFormData({
                                            ...formData,
                                            adGroupId: e.target.value,
                                            adGroupName: getAdGroupName(ag)
                                        });
                                    }}
                                >
                                    <option value="">Select Ad Group *</option>
                                    {adGroups
                                        .filter(ag => !formData.campaignId || ag['Campaign ID'] === formData.campaignId)
                                        .map((ag, i) => (
                                            <option key={i} value={ag['Ad Group ID']}>
                                                {getAdGroupName(ag)}
                                            </option>
                                        ))}
                                </select>
                            )}

                            <div className="relative">
                                <textarea
                                    placeholder="Negative Keywords (one per line) *"
                                    className={`w-full px-4 py-2 border rounded-lg ${
                                        negativeDuplicates.length > 0 ? 'border-orange-400 bg-orange-50' : 'border-gray-300'
                                    }`}
                                    rows="10"
                                    onChange={(e) => setFormData({...formData, negativeKeywords: e.target.value})}
                                />
                                {negativeDuplicates.length > 0 && (
                                    <div className="absolute top-0 right-0 mt-1 mr-1">
                                        <span 
                                            className="text-orange-600 cursor-help text-xs"
                                            title={`Duplicates found:\n${negativeDuplicates.map(d => `${d.text} (${d.matchType}) ‚Üí ${d.campaign} / ${d.adGroup}`).join('\n')}`}
                                        >
                                            ‚ö†Ô∏è
                                        </span>
                                    </div>
                                )}
                            </div>
                            {negativeDuplicates.length > 0 && (
                                <div className="mt-1 text-xs text-orange-700 font-medium">
                                    {negativeDuplicates.length} duplicate{negativeDuplicates.length > 1 ? 's' : ''} found
                                </div>
                            )}

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, matchType: e.target.value})}
                                defaultValue="negativeExact"
                            >
                                <option value="negativeExact">Negative Exact</option>
                                <option value="negativePhrase">Negative Phrase</option>
                            </select>
                        </div>
                    );
                } else if (type === 'products') {
                    const productDuplicates = checkDuplicates(formData.skus, 'products', formData.campaignId, formData.adGroupId);
                    
                    return (
                        <div className="space-y-3">
                            <h3 className="text-lg font-semibold">Add Products (Bulk)</h3>
                            
                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => {
                                    const campaign = campaigns.find(c => c['Campaign ID'] === e.target.value);
                                    setFormData({
                                        ...formData,
                                        campaignId: e.target.value,
                                        campaignName: getCampaignName(campaign)
                                    });
                                }}
                            >
                                <option value="">Select Campaign *</option>
                                {campaigns.map((c, i) => (
                                    <option key={i} value={c['Campaign ID']}>
                                        {getCampaignName(c)}
                                    </option>
                                ))}
                            </select>

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => {
                                    const ag = adGroups.find(a => a['Ad Group ID'] === e.target.value);
                                    setFormData({
                                        ...formData,
                                        adGroupId: e.target.value,
                                        adGroupName: getAdGroupName(ag)
                                    });
                                }}
                            >
                                <option value="">Select Ad Group *</option>
                                {adGroups
                                    .filter(ag => !formData.campaignId || ag['Campaign ID'] === formData.campaignId)
                                    .map((ag, i) => (
                                        <option key={i} value={ag['Ad Group ID']}>
                                            {getAdGroupName(ag)}
                                        </option>
                                    ))}
                            </select>

                            <div className="relative">
                                <textarea
                                    placeholder="SKUs (one per line) *"
                                    className={`w-full px-4 py-2 border rounded-lg ${
                                        productDuplicates.length > 0 ? 'border-orange-400 bg-orange-50' : 'border-gray-300'
                                    }`}
                                    rows="10"
                                    onChange={(e) => setFormData({...formData, skus: e.target.value})}
                                />
                                {productDuplicates.length > 0 && (
                                    <div className="absolute top-0 right-0 mt-1 mr-1">
                                        <span 
                                            className="text-orange-600 cursor-help text-xs"
                                            title={`Duplicates found:\n${productDuplicates.map(d => `${d.text} ‚Üí ${d.campaign} / ${d.adGroup}`).join('\n')}`}
                                        >
                                            ‚ö†Ô∏è
                                        </span>
                                    </div>
                                )}
                            </div>
                            {productDuplicates.length > 0 && (
                                <div className="mt-1 text-xs text-orange-700 font-medium">
                                    {productDuplicates.length} duplicate{productDuplicates.length > 1 ? 's' : ''} found
                                </div>
                            )}
                        </div>
                    );
                } else if (type === 'adgroups') {
                    return (
                        <div className="space-y-3">
                            <h3 className="text-lg font-semibold">Add New Ad Group</h3>
                            
                            <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-900">
                                üí° Create a new ad group within an existing campaign. Optionally add products and keywords to it.
                            </div>

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => {
                                    const campaign = campaigns.find(c => c['Campaign ID'] === e.target.value);
                                    setFormData({
                                        ...formData,
                                        campaignId: e.target.value,
                                        campaignName: getCampaignName(campaign)
                                    });
                                }}
                            >
                                <option value="">Select Campaign *</option>
                                {campaigns.map((c, i) => (
                                    <option key={i} value={c['Campaign ID']}>
                                        {getCampaignName(c)}
                                    </option>
                                ))}
                            </select>

                            <input
                                type="text"
                                placeholder="Ad Group Name *"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, adGroupName: e.target.value})}
                            />

                            <input
                                type="text"
                                placeholder="Default Bid (e.g., 0.50)"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, defaultBid: e.target.value})}
                            />

                            <div className="border-t pt-3 mt-3">
                                <p className="text-xs text-gray-600 mb-2 font-medium">Optional: Add products to this ad group</p>
                                <textarea
                                    placeholder="SKUs (one per line, optional)"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    rows="4"
                                    onChange={(e) => setFormData({...formData, skus: e.target.value})}
                                />
                            </div>

                            <div className="border-t pt-3 mt-3">
                                <p className="text-xs text-gray-600 mb-2 font-medium">Optional: Add keywords to this ad group</p>
                                <textarea
                                    placeholder="Keywords (one per line, optional)"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    rows="4"
                                    onChange={(e) => setFormData({...formData, keywords: e.target.value})}
                                />
                                
                                <div className="grid grid-cols-2 gap-3 mt-2">
                                    <select
                                        className="px-4 py-2 border border-gray-300 rounded-lg"
                                        onChange={(e) => setFormData({...formData, matchType: e.target.value})}
                                        defaultValue="Broad"
                                    >
                                        <option value="Broad">Broad Match</option>
                                        <option value="Phrase">Phrase Match</option>
                                        <option value="Exact">Exact Match</option>
                                    </select>
                                    
                                    <input
                                        type="text"
                                        placeholder="Keyword Bid (optional)"
                                        className="px-4 py-2 border border-gray-300 rounded-lg"
                                        onChange={(e) => setFormData({...formData, keywordBid: e.target.value})}
                                    />
                                </div>
                            </div>
                        </div>
                    );
                }
                
                // Default return to prevent undefined rendering error
                return null;
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 max-w-[95vw] w-full mx-4 max-h-[90vh] overflow-y-auto">
                        {renderFormContent()}
                        {!bulkMode && (
                            <div className="flex gap-3 mt-6">
                                <button
                                    onClick={handleAdd}
                                    className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                >
                                    Add
                                </button>
                                <button
                                    onClick={onClose}
                                    className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                                >
                                    Cancel
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
