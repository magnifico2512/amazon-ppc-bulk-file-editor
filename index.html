<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon PPC Bulk Manager - Enhanced</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .changed-row {
            background-color: #fef3c7;
        }
        .new-row {
            background-color: #d1fae5;
        }
        .resizer {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 5px;
            cursor: col-resize;
            user-select: none;
            background: transparent;
        }
        .resizer:hover {
            background: #3b82f6;
        }
        th {
            position: relative;
        }
        table {
            table-layout: fixed;
        }
        td {
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .filter-modal {
            position: absolute;
            z-index: 1000;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 320px;
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }
        .filter-header {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        .filter-items {
            max-height: 300px;
            overflow-y: auto;
            padding: 8px;
        }
        .filter-footer {
            padding: 12px 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }
        .filter-icon {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .filter-icon:hover {
            background-color: #f3f4f6;
        }
        .filter-icon.active {
            color: #3b82f6;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ========================================
        // AMAZON BULKSHEET EXPORT CONFIGURATION
        // Updated to match Amazon's official bulksheet format for Sponsored Products
        // ========================================
        const AMAZON_BULKSHEET_CONFIG = {
            // ALL possible columns in Amazon Sponsored Products bulksheets (in correct order)
            allColumns: [
                'Product',
                'Entity',
                'Operation',
                'Campaign ID',
                'Ad Group ID',
                'Portfolio ID',
                'Ad ID',
                'Keyword ID',
                'Product Targeting ID',
                'Campaign Name',
                'Ad Group Name',
                'Start Date',
                'End Date',
                'Targeting Type',
                'State',
                'Daily Budget',
                'SKU',
                'ASIN',
                'Ad Group Default Bid',
                'Bid',
                'Keyword Text',
                'Match Type',
                'Bidding Strategy',
                'Placement',
                'Percentage',
                'Product Targeting Expression'
            ],

            // Columns to EXCLUDE from exports (KPIs and read-only informational data)
            excludeColumns: [
                'Impressions', 'Clicks', 'Spend', 'Sales', 'Orders', 'Units',
                'Click-through Rate', 'Conversion Rate', 'ACOS', 'ROAS', 'CPC',
                'Portfolio Name (Informational only)',
                'Campaign State (Informational only)',
                'Ad Group State (Informational only)',
                'Eligibility Status (Informational only)',
                'Reason for Ineligibility (Informational only)',
                'ASIN (Informational only)',
                'Resolved Product Targeting Expression (Informational only)',
                'Campaign Name (Informational only)',
                'Ad Group Name (Informational only)',
                'Native Language Keyword',
                'Native Language Locale',
                'Ad Group Default Bid (Informational only)'
            ],

            // Map internal entity names to Amazon's bulksheet entity names
            entityNameMap: {
                'Campaign Placement': 'Bidding adjustment'
            },

            // Fields to always include (even if blank) for better compatibility
            alwaysIncludeFields: [
                'Product', 'Entity', 'Operation', 'Campaign ID', 'Ad Group ID',
                'Portfolio ID', 'Ad ID', 'Keyword ID', 'Product Targeting ID'
            ]
        };

        // Enhanced export data preparation for Amazon bulksheets
        const prepareAmazonBulksheet = (changes, originalRowMap) => {
            return changes.map(row => {
                const cleanRow = {};
                const original = originalRowMap.get(getRowId(row));
                
                // Determine operation
                const operation = original ? 'Update' : 'Create';
                
                // Map entity name if needed
                let entityName = row.Entity;
                if (AMAZON_BULKSHEET_CONFIG.entityNameMap[entityName]) {
                    entityName = AMAZON_BULKSHEET_CONFIG.entityNameMap[entityName];
                }
                
                // Process each column in the correct order
                AMAZON_BULKSHEET_CONFIG.allColumns.forEach(column => {
                    // Skip if in exclude list
                    if (AMAZON_BULKSHEET_CONFIG.excludeColumns.includes(column)) {
                        return;
                    }
                    
                    let value = '';
                    
                    // Set special field values
                    if (column === 'Product') {
                        value = 'Sponsored Products';
                    } else if (column === 'Entity') {
                        value = entityName;
                    } else if (column === 'Operation') {
                        value = operation;
                    } else if (column === 'Portfolio ID' && original && original['Portfolio ID']) {
                        // Preserve Portfolio ID for updates to avoid removing from portfolio
                        value = original['Portfolio ID'];
                    } else {
                        // Get value from current row
                        value = row[column] !== undefined ? row[column] : '';
                    }
                    
                    // Convert empty strings to actual empty values for CSV
                    if (value === null || value === undefined) {
                        value = '';
                    }
                    
                    // Trim whitespace
                    if (typeof value === 'string') {
                        value = value.trim();
                    }
                    
                    // Include field if:
                    // 1. It's in alwaysIncludeFields, OR
                    // 2. It has a non-empty value
                    if (AMAZON_BULKSHEET_CONFIG.alwaysIncludeFields.includes(column) ||
                        value !== '') {
                        cleanRow[column] = value;
                    }
                });
                
                return cleanRow;
            });
        };

        // Helper to get campaign/ad group names from either regular or informational columns
        const getCampaignName = (row) => {
            return row['Campaign Name'] || row['Campaign Name (Informational only)'] || '-';
        };

        const getAdGroupName = (row) => {
            return row['Ad Group Name'] || row['Ad Group Name (Informational only)'] || '-';
        };

        const getPortfolioName = (row) => {
            return row['Portfolio Name (Informational only)'] || '-';
        };

        // Improved change detection - only compare meaningful fields
        const hasRowChanged = (original, current) => {
            if (!original) return false;
            
            // Base fields that apply to all entities
            const baseCompareFields = [
                'State', 'Daily Budget', 'Ad Group Default Bid', 'Bid', 'Match Type', 
                'Bidding Strategy', 'Targeting Type', 'Keyword Text', 
                'Product Targeting Expression', 'Percentage', 'SKU', 'End Date'
            ];
            
            // Add name fields only for their specific entities
            const compareFields = [...baseCompareFields];
            if (current.Entity === 'Campaign') {
                compareFields.push('Campaign Name');
            }
            if (current.Entity === 'Ad Group') {
                compareFields.push('Ad Group Name');
            }
            
            return compareFields.some(field => {
                const origVal = String(original[field] || '').trim();
                const currVal = String(current[field] || '').trim();
                return origVal !== currVal;
            });
        };

        // Create unique ID for row comparison
        const getRowId = (row) => {
            return `${row.Entity}|${row['Campaign ID']}|${row['Ad Group ID']}|${row['Keyword ID']}|${row['Ad ID']}|${row['Product Targeting ID']}|${row['Keyword Text']}|${row.SKU}`;
        };

        // Format product targeting expressions from simple input
        const formatProductTargetingExpression = (input, type = 'auto') => {
            input = input.trim();
            if (!input) return '';
            
            // If already formatted, return as-is
            if (input.includes('=') && input.includes('"')) {
                return input;
            }
            
            // Auto-detect type if not specified
            if (type === 'auto') {
                // Check if it's a 10-character alphanumeric ASIN
                if (/^[A-Z0-9]{10}$/i.test(input)) {
                    type = 'asin';
                }
                // Check if it's purely numeric (likely a category)
                else if (/^\d+$/.test(input)) {
                    type = 'category';
                }
                // Default to ASIN
                else {
                    type = 'asin';
                }
            }
            
            // Format based on type
            switch(type) {
                case 'asin':
                    return `asin="${input}"`;
                case 'asin-expanded':
                    return `asin-expanded="${input}"`;
                case 'category':
                    return `category="${input}"`;
                default:
                    return `asin="${input}"`;
            }
        };

        // Filter Modal Component for Excel-style filtering
        function FilterModal({ column, uniqueValues, selectedFilters, onApply, onClose, position, currentSort, onSort }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [localSelected, setLocalSelected] = useState(new Set(selectedFilters || []));
            const modalRef = useRef(null);
            
            // Determine if this is a KPI column (numeric data)
            const kpiColumns = ['Impressions', 'Clicks', 'Spend', 'Sales', 'Orders', 'Units', 
                              'Click-through Rate', 'Conversion Rate', 'ACOS', 'ROAS', 'CPC',
                              'Ad Group Default Bid', 'Bid', 'Daily Budget', 'Percentage'];
            const isKPIColumn = kpiColumns.includes(column);

            // Close modal when clicking outside
            useEffect(() => {
                function handleClickOutside(event) {
                    if (modalRef.current && !modalRef.current.contains(event.target)) {
                        onClose();
                    }
                }
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [onClose]);

            const filteredValues = useMemo(() => {
                if (!searchTerm) return uniqueValues;
                return uniqueValues.filter(value => 
                    String(value).toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [uniqueValues, searchTerm]);

            const handleSelectAll = () => {
                // Get the count of filtered items that are currently selected
                const filteredSelectedCount = filteredValues.filter(v => localSelected.has(v)).length;
                
                // If all filtered items are selected, deselect only the filtered items
                if (filteredSelectedCount === filteredValues.length) {
                    const newSelected = new Set(localSelected);
                    filteredValues.forEach(v => newSelected.delete(v));
                    setLocalSelected(newSelected);
                } else {
                    // Otherwise, add all filtered items to selection
                    const newSelected = new Set(localSelected);
                    filteredValues.forEach(v => newSelected.add(v));
                    setLocalSelected(newSelected);
                }
            };

            const handleApply = () => {
                onApply(column, localSelected);
                onClose();
            };

            const handleClear = () => {
                setLocalSelected(new Set());
            };

            return (
                <div 
                    ref={modalRef}
                    className="filter-modal"
                    style={{
                        top: position.top,
                        left: Math.min(position.left, window.innerWidth - 340)
                    }}
                >
                    <div className="filter-header">
                        {isKPIColumn && (
                            <div className="mb-2 pb-2 border-b border-gray-200">
                                <div className="text-[10px] font-semibold text-gray-700 mb-1">Sort by {column}:</div>
                                <div className="flex gap-1">
                                    <button
                                        onClick={() => onSort(column, currentSort?.column === column && currentSort?.direction === 'asc' ? null : 'asc')}
                                        className={`flex-1 px-2 py-1 text-[10px] rounded transition ${
                                            currentSort?.column === column && currentSort?.direction === 'asc'
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        ↑ Lowest First
                                    </button>
                                    <button
                                        onClick={() => onSort(column, currentSort?.column === column && currentSort?.direction === 'desc' ? null : 'desc')}
                                        className={`flex-1 px-2 py-1 text-[10px] rounded transition ${
                                            currentSort?.column === column && currentSort?.direction === 'desc'
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        ↓ Highest First
                                    </button>
                                </div>
                            </div>
                        )}
                        <input
                            type="text"
                            placeholder="Search..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full px-3 py-1.5 border border-gray-300 rounded text-sm"
                            autoFocus
                        />
                    </div>
                    
                    <div className="filter-items scrollbar-thin">
                        <label className="flex items-center gap-2 px-2 py-1.5 hover:bg-gray-50 cursor-pointer text-sm font-medium">
                            <input
                                type="checkbox"
                                checked={filteredValues.length > 0 && filteredValues.every(v => localSelected.has(v))}
                                onChange={handleSelectAll}
                                className="rounded"
                            />
                            <span>Select All ({filteredValues.length})</span>
                        </label>
                        <div className="border-t my-1"></div>
                        {filteredValues.map((value, index) => (
                            <label 
                                key={index} 
                                className="flex items-center gap-2 px-2 py-1.5 hover:bg-gray-50 cursor-pointer text-sm"
                            >
                                <input
                                    type="checkbox"
                                    checked={localSelected.has(value)}
                                    onChange={(e) => {
                                        const newSelected = new Set(localSelected);
                                        if (e.target.checked) {
                                            newSelected.add(value);
                                        } else {
                                            newSelected.delete(value);
                                        }
                                        setLocalSelected(newSelected);
                                    }}
                                    className="rounded"
                                />
                                <span className="truncate">{value}</span>
                            </label>
                        ))}
                    </div>
                    
                    <div className="filter-footer">
                        <button
                            onClick={handleClear}
                            className="flex-1 px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                        >
                            Clear
                        </button>
                        <button
                            onClick={handleApply}
                            className="flex-1 px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700"
                        >
                            Apply
                        </button>
                    </div>
                </div>
            );
        }

        function App() {
            const [data, setData] = useState([]);
            const [originalRowMap, setOriginalRowMap] = useState(new Map());
            const [activeTab, setActiveTab] = useState('adgroups');
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedItems, setSelectedItems] = useState(new Set());
            const [showModal, setShowModal] = useState(false);
            const [modalType, setModalType] = useState('');
            const [columnWidths, setColumnWidths] = useState({});
            const [columnFilters, setColumnFilters] = useState({});
            const [columnSort, setColumnSort] = useState({ column: null, direction: null }); // null, 'asc', 'desc'
            const [activeFilterColumn, setActiveFilterColumn] = useState(null);
            const [filterPosition, setFilterPosition] = useState({ top: 0, left: 0 });
            const [showReferencePanel, setShowReferencePanel] = useState(false);
            const [referenceKeywords, setReferenceKeywords] = useState('');
            const [expandedKeywordRows, setExpandedKeywordRows] = useState(new Set());
            const [referenceProducts, setReferenceProducts] = useState('');
            const [referenceTab, setReferenceTab] = useState('keywords');
            const [referencePortfolio, setReferencePortfolio] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [statusSearch, setStatusSearch] = useState('');
            const [matchTypeFiltersExpanded, setMatchTypeFiltersExpanded] = useState(false);
            const [matchTypeHas, setMatchTypeHas] = useState({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
            const [matchTypeMissing, setMatchTypeMissing] = useState({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
            const [hasSavedChanges, setHasSavedChanges] = useState(false);
            const [savedChangesCount, setSavedChangesCount] = useState(0);
            const [showRecoveryBanner, setShowRecoveryBanner] = useState(false);
            const [originalFileName, setOriginalFileName] = useState('');
            const [referenceKeywordSelections, setReferenceKeywordSelections] = useState(new Set());
            const [metadataSort, setMetadataSort] = useState({ column: null, direction: null });
            const [metadataFilters, setMetadataFilters] = useState({});
            const [keywordTableData, setKeywordTableData] = useState([{ Keyword: '' }]);
            const [tableColumns, setTableColumns] = useState(['Keyword']);
            const [editingCell, setEditingCell] = useState(null);
            const [useTableMode, setUseTableMode] = useState(true);
            const [panelWidth, setPanelWidth] = useState(600); // Resizable panel width
            const [showTargetCheckerTip, setShowTargetCheckerTip] = useState(true);
            const [showTableModeTip, setShowTableModeTip] = useState(true);
            const [showExportTip, setShowExportTip] = useState(true);
            const [showBulkModeTip, setShowBulkModeTip] = useState(true);
            const [statusFilterValue, setStatusFilterValue] = useState('all'); // 'all', 'modified', 'new', 'unchanged'

            // ========================================
            // AUTO-SAVE SYSTEM - IndexedDB Utilities
            // ========================================
            
            const STORAGE_KEY = 'ppc_manager_changes';
            const TARGETCHECKER_STORAGE_KEY = 'target_checker_data';
            const DB_NAME = 'PPCManagerDB';
            const STORE_NAME = 'changes';
            
            // Initialize IndexedDB
            const initDB = () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME);
                        }
                    };
                });
            };
            
            // Save changes to IndexedDB
            const saveChangesToDB = async (changesData) => {
                try {
                    const db = await initDB();
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    
                    const saveData = {
                        changes: changesData.changes,
                        originalRowMap: changesData.originalRowMap,
                        timestamp: Date.now(),
                        fileName: changesData.fileName || 'unknown.csv'
                    };
                    
                    store.put(saveData, STORAGE_KEY);
                    
                    return new Promise((resolve, reject) => {
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = () => reject(transaction.error);
                    });
                } catch (error) {
                    console.error('Error saving to IndexedDB:', error);
                }
            };
            
            // Load changes from IndexedDB
            const loadChangesFromDB = async () => {
                try {
                    const db = await initDB();
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(STORAGE_KEY);
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('Error loading from IndexedDB:', error);
                    return null;
                }
            };
            
            // Clear saved changes from IndexedDB
            const clearSavedChanges = async () => {
                try {
                    const db = await initDB();
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.delete(STORAGE_KEY);
                    
                    return new Promise((resolve, reject) => {
                        transaction.oncomplete = () => {
                            setHasSavedChanges(false);
                            setSavedChangesCount(0);
                            setShowRecoveryBanner(false);
                            resolve();
                        };
                        transaction.onerror = () => reject(transaction.error);
                    });
                } catch (error) {
                    console.error('Error clearing saved changes:', error);
                }
            };
            
            // ========================================
            // TARGET CHECKER PERSISTENCE
            // ========================================
            
            // Save Target Checker data to IndexedDB
            const saveTargetCheckerToDB = async (tableData, columns) => {
                try {
                    const db = await initDB();
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    
                    const saveData = {
                        tableData: tableData,
                        columns: columns,
                        timestamp: Date.now()
                    };
                    
                    store.put(saveData, TARGETCHECKER_STORAGE_KEY);
                    
                    return new Promise((resolve, reject) => {
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = () => reject(transaction.error);
                    });
                } catch (error) {
                    console.error('Error saving Target Checker to IndexedDB:', error);
                }
            };
            
            // Load Target Checker data from IndexedDB
            const loadTargetCheckerFromDB = async () => {
                try {
                    const db = await initDB();
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(TARGETCHECKER_STORAGE_KEY);
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('Error loading Target Checker from IndexedDB:', error);
                    return null;
                }
            };
            
            // Clear Target Checker data from IndexedDB
            const clearTargetCheckerData = async () => {
                try {
                    const db = await initDB();
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.delete(TARGETCHECKER_STORAGE_KEY);
                    
                    return new Promise((resolve, reject) => {
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = () => reject(transaction.error);
                    });
                } catch (error) {
                    console.error('Error clearing Target Checker data:', error);
                }
            };
            
            // Check for saved changes on component mount
            useEffect(() => {
                const checkSavedChanges = async () => {
                    const savedData = await loadChangesFromDB();
                    if (savedData && savedData.changes && savedData.changes.length > 0) {
                        setHasSavedChanges(true);
                        setSavedChangesCount(savedData.changes.length);
                        setShowRecoveryBanner(true);
                    }
                };
                checkSavedChanges();
            }, []);
            
            // Auto-save Target Checker data when it changes
            useEffect(() => {
                // Skip saving if data is empty/default
                if (keywordTableData.length === 1 && 
                    keywordTableData[0].Keyword === '' && 
                    tableColumns.length === 1 && 
                    tableColumns[0] === 'Keyword') {
                    return;
                }
                
                // Save after a small delay to avoid too frequent saves
                const timeoutId = setTimeout(() => {
                    saveTargetCheckerToDB(keywordTableData, tableColumns);
                }, 500);
                
                return () => clearTimeout(timeoutId);
            }, [keywordTableData, tableColumns]);
            
            // Check for saved Target Checker data when panel opens
            useEffect(() => {
                if (!showReferencePanel) return;
                
                const checkSavedTargetChecker = async () => {
                    const savedData = await loadTargetCheckerFromDB();
                    if (savedData && savedData.tableData && savedData.tableData.length > 0) {
                        const shouldRestore = confirm(
                            `Found saved Target Checker data from ${new Date(savedData.timestamp).toLocaleString()}.\n\n` +
                            `${savedData.tableData.length} rows in your table.\n\n` +
                            `Would you like to restore it?`
                        );
                        
                        if (shouldRestore) {
                            setKeywordTableData(savedData.tableData);
                            setTableColumns(savedData.columns);
                        }
                    }
                };
                
                checkSavedTargetChecker();
            }, [showReferencePanel]);
            
            // Apply saved changes to uploaded data
            const applySavedChanges = async (baseData, baseRowMap) => {
                try {
                    const savedData = await loadChangesFromDB();
                    if (!savedData || !savedData.changes) return;
                    
                    console.log('=== APPLYING SAVED CHANGES ===');
                    console.log('Base CSV rows:', baseData.length);
                    console.log('Saved changes count:', savedData.changes.length);
                    
                    const changedRows = savedData.changes;
                    const savedOriginalMap = new Map(Object.entries(savedData.originalRowMap || {}));
                    
                    console.log('Saved original map size:', savedOriginalMap.size);
                    
                    // Build a complete dataset by merging base data with changes
                    // Strategy: Start with base CSV, then overlay all changes
                    
                    // Create ID -> row map for quick lookup
                    const baseDataById = new Map();
                    baseData.forEach(row => {
                        baseDataById.set(getRowId(row), row);
                    });
                    
                    const changedById = new Map();
                    changedRows.forEach(row => {
                        const id = getRowId(row);
                        changedById.set(id, row);
                        console.log('Changed:', row.Entity, row['Campaign Name'] || row['Ad Group Name'] || row['Keyword Text']);
                    });
                    
                    // Build final data: use changed version if exists, else base version
                    const finalData = [];
                    const processedIds = new Set();
                    
                    // First, process all base data rows
                    baseData.forEach(baseRow => {
                        const id = getRowId(baseRow);
                        const changedRow = changedById.get(id);
                        
                        if (changedRow) {
                            // Use the changed version
                            finalData.push({ ...changedRow });
                            console.log('Replaced:', baseRow.Entity, baseRow['Campaign Name'], '→', changedRow['Campaign Name']);
                        } else {
                            // Use base version
                            finalData.push({ ...baseRow });
                        }
                        
                        processedIds.add(id);
                    });
                    
                    // Then add any new rows that weren't in base data
                    changedRows.forEach(changedRow => {
                        const id = getRowId(changedRow);
                        if (!processedIds.has(id)) {
                            finalData.push({ ...changedRow });
                            console.log('Added new:', changedRow.Entity, changedRow['Campaign Name']);
                        }
                    });
                    
                    // Build originalRowMap: use saved originals for changed items, base data for unchanged
                    const finalOriginalMap = new Map();
                    baseData.forEach(row => {
                        const id = getRowId(row);
                        const savedOriginal = savedOriginalMap.get(id);
                        
                        if (savedOriginal) {
                            // This row was changed - use the saved original (from before any edits)
                            finalOriginalMap.set(id, savedOriginal);
                        } else {
                            // This row wasn't changed - use the base CSV as original
                            finalOriginalMap.set(id, { ...row });
                        }
                    });
                    
                    console.log('Final data size:', finalData.length);
                    console.log('Final original map size:', finalOriginalMap.size);
                    
                    // CASCADE CAMPAIGN NAME CHANGES TO CHILDREN
                    // Find all campaigns that have been renamed
                    const renamedCampaigns = new Map(); // campaignId -> newName
                    finalData.forEach(row => {
                        if (row.Entity === 'Campaign') {
                            const id = getRowId(row);
                            const original = finalOriginalMap.get(id);
                            if (original && original['Campaign Name'] !== row['Campaign Name']) {
                                renamedCampaigns.set(row['Campaign ID'], row['Campaign Name']);
                                console.log('Found renamed campaign:', original['Campaign Name'], '→', row['Campaign Name']);
                            }
                        }
                    });
                    
                    // If any campaigns were renamed, cascade to all children
                    if (renamedCampaigns.size > 0) {
                        console.log('Cascading campaign renames to children...');
                        finalData.forEach((row, index) => {
                            const campaignId = row['Campaign ID'];
                            if (campaignId && renamedCampaigns.has(campaignId) && row.Entity !== 'Campaign') {
                                const newName = renamedCampaigns.get(campaignId);
                                finalData[index] = {
                                    ...row,
                                    'Campaign Name': newName,
                                    'Campaign Name (Informational only)': newName
                                };
                                console.log('  Updated child:', row.Entity, 'to campaign:', newName);
                            }
                        });
                    }
                    
                    // CASCADE AD GROUP NAME CHANGES TO CHILDREN
                    // Find all ad groups that have been renamed
                    const renamedAdGroups = new Map(); // adGroupId -> newName
                    finalData.forEach(row => {
                        if (row.Entity === 'Ad Group') {
                            const id = getRowId(row);
                            const original = finalOriginalMap.get(id);
                            if (original && original['Ad Group Name'] !== row['Ad Group Name']) {
                                renamedAdGroups.set(row['Ad Group ID'], row['Ad Group Name']);
                                console.log('Found renamed ad group:', original['Ad Group Name'], '→', row['Ad Group Name']);
                            }
                        }
                    });
                    
                    // If any ad groups were renamed, cascade to all children
                    if (renamedAdGroups.size > 0) {
                        console.log('Cascading ad group renames to children...');
                        finalData.forEach((row, index) => {
                            const adGroupId = row['Ad Group ID'];
                            if (adGroupId && renamedAdGroups.has(adGroupId) && row.Entity !== 'Ad Group') {
                                const newName = renamedAdGroups.get(adGroupId);
                                finalData[index] = {
                                    ...row,
                                    'Ad Group Name': newName,
                                    'Ad Group Name (Informational only)': newName
                                };
                                console.log('  Updated child:', row.Entity, 'to ad group:', newName);
                            }
                        });
                    }
                    
                    // Debug: Print first few entries
                    console.log('=== SAMPLE DATA ===');
                    finalData.slice(0, 3).forEach(row => {
                        const id = getRowId(row);
                        const original = finalOriginalMap.get(id);
                        console.log('Row:', row.Entity, row['Campaign Name']);
                        console.log('  Has original?', !!original);
                        if (original) {
                            console.log('  Original campaign:', original['Campaign Name']);
                            console.log('  Current campaign:', row['Campaign Name']);
                            console.log('  Are they different?', original['Campaign Name'] !== row['Campaign Name']);
                        }
                    });
                    
                    console.log('=== SETTING STATE ===');
                    
                    // IMPORTANT: Reset the status filter dropdown to "All Items" so changes are visible
                    console.log('Resetting status filter to "all"');
                    setStatusFilterValue('all');
                    
                    // Set data - use simple array spread to create new reference
                    console.log('Setting data...');
                    setData(finalData);
                    
                    console.log('Setting originalRowMap...');
                    setOriginalRowMap(finalOriginalMap);
                    
                    console.log('State set! Now checking changes detection...');
                    
                    // Immediate check of what changes would be detected
                    const immediateChanges = finalData.filter(row => {
                        const rowId = getRowId(row);
                        const original = finalOriginalMap.get(rowId);
                        return !original || hasRowChanged(original, row);
                    });
                    console.log('IMMEDIATE changes count:', immediateChanges.length);
                    if (immediateChanges.length > 0) {
                        console.log('First change:', immediateChanges[0].Entity, immediateChanges[0]['Campaign Name']);
                    } else {
                        console.log('WARNING: No changes detected! This is the problem.');
                        console.log('Checking why...');
                        // Sample check
                        const sampleRow = finalData.find(r => r.Entity === 'Campaign');
                        if (sampleRow) {
                            const sampleId = getRowId(sampleRow);
                            const sampleOriginal = finalOriginalMap.get(sampleId);
                            console.log('Sample campaign:', sampleRow['Campaign Name']);
                            console.log('Sample original:', sampleOriginal ? sampleOriginal['Campaign Name'] : 'NOT FOUND');
                        }
                    }
                    
                    alert(`Successfully applied ${changedRows.length} saved changes!\n\nChanges detected: ${immediateChanges.length}\n\nFilter has been reset to "All Items" so you can see your changes.`);
                } catch (error) {
                    console.error('Error applying saved changes:', error);
                    alert('Error applying saved changes: ' + error.message);
                }
            };
            
            // Auto-save changes to IndexedDB
            useEffect(() => {
                if (data.length === 0) return; // Don't save empty state
                
                const saveChanges = async () => {
                    // Get current changes
                    const currentChanges = data.filter(row => {
                        const rowId = getRowId(row);
                        const original = originalRowMap.get(rowId);
                        return !original || hasRowChanged(original, row);
                    });
                    
                    if (currentChanges.length > 0) {
                        // Convert originalRowMap to plain object for storage
                        const originalMapObj = {};
                        originalRowMap.forEach((value, key) => {
                            originalMapObj[key] = value;
                        });
                        
                        await saveChangesToDB({
                            changes: currentChanges,
                            originalRowMap: originalMapObj,
                            fileName: originalFileName
                        });
                        
                        setHasSavedChanges(true);
                        setSavedChangesCount(currentChanges.length);
                    } else {
                        // No changes, clear any saved data
                        await clearSavedChanges();
                    }
                };
                
                // Debounce auto-save to avoid too frequent saves
                const timeoutId = setTimeout(saveChanges, 1000);
                return () => clearTimeout(timeoutId);
            }, [data, originalRowMap, originalFileName]);
            
            // Download changes as JSON file
            const downloadChangesFile = async () => {
                const savedData = await loadChangesFromDB();
                if (!savedData || !savedData.changes || savedData.changes.length === 0) {
                    alert('No changes to download');
                    return;
                }
                
                const exportData = {
                    version: '1.0',
                    timestamp: savedData.timestamp,
                    fileName: savedData.fileName,
                    changesCount: savedData.changes.length,
                    changes: savedData.changes,
                    originalRowMap: savedData.originalRowMap
                };
                
                const json = JSON.stringify(exportData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().split('T')[0];
                a.download = `ppc-changes-${date}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert(`Downloaded ${savedData.changes.length} changes`);
            };
            
            // Upload and apply changes from JSON file
            const uploadChangesFile = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const importData = JSON.parse(text);
                    
                    if (!importData.changes || !Array.isArray(importData.changes)) {
                        alert('Invalid changes file format');
                        return;
                    }
                    
                    // Save to IndexedDB
                    await saveChangesToDB({
                        changes: importData.changes,
                        originalRowMap: importData.originalRowMap || {},
                        fileName: importData.fileName || 'imported.csv'
                    });
                    
                    setHasSavedChanges(true);
                    setSavedChangesCount(importData.changes.length);
                    setShowRecoveryBanner(true);
                    
                    alert(`Loaded ${importData.changes.length} changes. Upload your CSV to apply them.`);
                } catch (error) {
                    console.error('Error loading changes file:', error);
                    alert('Error loading changes file. Please check the file format.');
                }
                
                // Reset file input
                event.target.value = '';
            };

            const changes = useMemo(() => {
                return data.filter(row => {
                    const rowId = getRowId(row);
                    const original = originalRowMap.get(rowId);
                    return !original || hasRowChanged(original, row);
                });
            }, [data, originalRowMap]);

            // Normalize column names and values to handle different capitalizations from Amazon exports
            const normalizeColumnNames = (data) => {
                // Mapping of lowercase column names to the expected format
                const columnMapping = {
                    'ad group id': 'Ad Group ID',
                    'campaign name': 'Campaign Name',
                    'ad group name': 'Ad Group Name',
                    'campaign name (informational only)': 'Campaign Name (Informational only)',
                    'ad group name (informational only)': 'Ad Group Name (Informational only)',
                    'portfolio name (informational only)': 'Portfolio Name (Informational only)',
                    'start date': 'Start Date',
                    'end date': 'End Date',
                    'targeting type': 'Targeting Type',
                    'campaign state (informational only)': 'Campaign State (Informational only)',
                    'ad group state (informational only)': 'Ad Group State (Informational only)',
                    'daily budget': 'Daily Budget',
                    'eligibility status (informational only)': 'Eligibility Status (Informational only)',
                    'reason for ineligibility (informational only)': 'Reason for Ineligibility (Informational only)',
                    'keyword text': 'Keyword Text',
                    'native language keyword': 'Native Language Keyword',
                    'native language locale': 'Native Language Locale',
                    'match type': 'Match Type',
                    'bidding strategy': 'Bidding Strategy',
                    'product targeting expression': 'Product Targeting Expression',
                    'resolved product targeting expression (informational only)': 'Resolved Product Targeting Expression (Informational only)',
                    'click-through rate': 'Click-through Rate',
                    'conversion rate': 'Conversion Rate'
                };

                // Mapping for Entity values to ensure consistency
                const entityMapping = {
                    'ad group': 'Ad Group',
                    'product ad': 'Product Ad',
                    'keyword': 'Keyword',
                    'campaign': 'Campaign',
                    'negative keyword': 'Negative Keyword',
                    'product targeting': 'Product Targeting',
                    'negative product targeting': 'Negative Product Targeting'
                };

                return data.map(row => {
                    const normalizedRow = {};
                    Object.keys(row).forEach(key => {
                        const lowerKey = key.toLowerCase();
                        const normalizedKey = columnMapping[lowerKey] || key;
                        let value = row[key];
                        
                        // Normalize Entity values
                        if (normalizedKey === 'Entity' && value) {
                            const lowerEntity = value.toLowerCase();
                            value = entityMapping[lowerEntity] || value;
                        }
                        
                        normalizedRow[normalizedKey] = value;
                    });
                    return normalizedRow;
                });
            };

            const parseCSV = (csvText) => {
                return new Promise((resolve, reject) => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            const normalizedData = normalizeColumnNames(results.data);
                            resolve(normalizedData);
                        },
                        error: (error) => reject(error)
                    });
                });
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const text = await file.text();
                const parsedData = await parseCSV(text);
                
                setData(parsedData);
                const rowMap = new Map();
                parsedData.forEach(row => {
                    rowMap.set(getRowId(row), { ...row });
                });
                setOriginalRowMap(rowMap);
                setOriginalFileName(file.name);
                setSelectedItems(new Set());
                
                // Check if there are saved changes to apply
                if (hasSavedChanges) {
                    const shouldApply = confirm(`Found ${savedChangesCount} saved changes. Apply them to this file?`);
                    if (shouldApply) {
                        await applySavedChanges(parsedData, rowMap);
                    } else {
                        // User chose not to apply, clear the saved changes
                        await clearSavedChanges();
                    }
                }
            };

            const downloadCSV = () => {
                const csv = Papa.unparse(data);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'amazon-ppc-export.csv';
                a.click();
            };

            const downloadChanges = () => {
                if (changes.length === 0) {
                    alert('No changes to export');
                    return;
                }
                
                // Prepare data in Amazon bulksheet format
                const exportData = prepareAmazonBulksheet(changes, originalRowMap);
                
                // Use Papa.unparse with column ordering
                const csv = Papa.unparse(exportData, {
                    columns: AMAZON_BULKSHEET_CONFIG.allColumns.filter(col => 
                        !AMAZON_BULKSHEET_CONFIG.excludeColumns.includes(col)
                    )
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'amazon-ppc-bulksheet-upload.csv';
                a.click();
            };

            const updateRow = (row, field, value) => {
                let newData = [...data];
                
                // Find the actual index in the full data array using row identity
                const actualIndex = newData.findIndex(r => 
                    r.Entity === row.Entity &&
                    r['Campaign ID'] === row['Campaign ID'] &&
                    r['Ad Group ID'] === row['Ad Group ID'] &&
                    r['Keyword ID'] === row['Keyword ID'] &&
                    r['Ad ID'] === row['Ad ID'] &&
                    r['Product Targeting ID'] === row['Product Targeting ID']
                );
                
                if (actualIndex === -1) return; // Row not found
                
                // Handle Campaign Name updates
                if (field === 'Campaign Name') {
                    const campaignId = row['Campaign ID'];
                    const oldCampaignName = getCampaignName(row);
                    
                    // Find the actual Campaign entity
                    const campaignIndex = newData.findIndex(r => 
                        r.Entity === 'Campaign' && r['Campaign ID'] === campaignId
                    );
                    
                    if (campaignIndex !== -1) {
                        // Update the Campaign entity
                        newData[campaignIndex] = {
                            ...newData[campaignIndex],
                            'Campaign Name': value,
                            'Campaign Name (Informational only)': value
                        };
                    }
                    
                    // Update both fields on ALL child rows (won't trigger change detection)
                    newData = newData.map((r, i) => {
                        if (r['Campaign ID'] === campaignId && i !== campaignIndex) {
                            return {
                                ...r,
                                'Campaign Name': value,
                                'Campaign Name (Informational only)': value
                            };
                        }
                        return r;
                    });
                    
                    // Update column filters to include the new name
                    if (columnFilters['Campaign Name'] && oldCampaignName !== value) {
                        const newFilters = { ...columnFilters };
                        if (newFilters['Campaign Name'].has(oldCampaignName)) {
                            newFilters['Campaign Name'].delete(oldCampaignName);
                            newFilters['Campaign Name'].add(value);
                            setColumnFilters(newFilters);
                        }
                    }
                    
                } else if (field === 'Ad Group Name') {
                    const adGroupId = row['Ad Group ID'];
                    const oldAdGroupName = getAdGroupName(row);
                    
                    // Find the actual Ad Group entity
                    const adGroupIndex = newData.findIndex(r => 
                        r.Entity === 'Ad Group' && r['Ad Group ID'] === adGroupId
                    );
                    
                    if (adGroupIndex !== -1) {
                        // Update the Ad Group entity
                        newData[adGroupIndex] = {
                            ...newData[adGroupIndex],
                            'Ad Group Name': value,
                            'Ad Group Name (Informational only)': value
                        };
                    }
                    
                    // Update both fields on ALL child rows (won't trigger change detection)
                    newData = newData.map((r, i) => {
                        if (r['Ad Group ID'] === adGroupId && i !== adGroupIndex) {
                            return {
                                ...r,
                                'Ad Group Name': value,
                                'Ad Group Name (Informational only)': value
                            };
                        }
                        return r;
                    });
                    
                    // Update column filters to include the new name
                    if (columnFilters['Ad Group Name'] && oldAdGroupName !== value) {
                        const newFilters = { ...columnFilters };
                        if (newFilters['Ad Group Name'].has(oldAdGroupName)) {
                            newFilters['Ad Group Name'].delete(oldAdGroupName);
                            newFilters['Ad Group Name'].add(value);
                            setColumnFilters(newFilters);
                        }
                    }
                    
                } else {
                    // For all other fields, update the actual row
                    newData[actualIndex] = { ...newData[actualIndex], [field]: value };
                }
                
                setData(newData);
            };

            const toggleSelection = (index) => {
                const newSelected = new Set(selectedItems);
                if (newSelected.has(index)) {
                    newSelected.delete(index);
                } else {
                    newSelected.add(index);
                }
                setSelectedItems(newSelected);
            };

            const selectAll = () => {
                const filtered = getFilteredData();
                if (selectedItems.size === filtered.length) {
                    setSelectedItems(new Set());
                } else {
                    const indices = new Set();
                    filtered.forEach((_, i) => indices.add(data.indexOf(filtered[i])));
                    setSelectedItems(indices);
                }
            };

            const bulkUpdateState = (state) => {
                const newData = [...data];
                selectedItems.forEach(index => {
                    newData[index] = { ...newData[index], State: state };
                });
                setData(newData);
            };

            const deleteSelected = () => {
                if (!confirm(`Delete ${selectedItems.size} items?`)) return;
                const newData = data.filter((_, index) => !selectedItems.has(index));
                setData(newData);
                setSelectedItems(new Set());
            };

            const addNewItems = (newItems) => {
                setData([...data, ...newItems]);
            };

            const undoChange = (row) => {
                // Find the actual index in the data array
                const rowId = getRowId(row);
                const actualIndex = data.findIndex(r => getRowId(r) === rowId);
                
                if (actualIndex === -1) return; // Row not found
                
                const original = originalRowMap.get(rowId);
                
                if (!original) {
                    // This is a new item, remove it entirely
                    const newData = data.filter((_, i) => i !== actualIndex);
                    setData(newData);
                } else {
                    // This is a modified item, revert to original
                    const newData = [...data];
                    newData[actualIndex] = { ...original };
                    setData(newData);
                }
                
                // Remove from selected items if it was selected
                const newSelected = new Set(selectedItems);
                newSelected.delete(actualIndex);
                setSelectedItems(newSelected);
            };

            const undoAllChanges = () => {
                if (!confirm(`Undo all ${changes.length} changes? This will revert all modifications and remove all new items.`)) return;
                
                // Revert all modified items and remove all new items
                const newData = data.filter(row => {
                    const rowId = getRowId(row);
                    return originalRowMap.has(rowId);
                }).map(row => {
                    const rowId = getRowId(row);
                    const original = originalRowMap.get(rowId);
                    return { ...original };
                });
                
                setData(newData);
                setSelectedItems(new Set());
            };

            // Listen for keywords added from ad group dropdown
            useEffect(() => {
                const handleAddKeywords = (event) => {
                    if (event.detail) {
                        addNewItems(event.detail);
                    }
                };
                
                window.addEventListener('addKeywords', handleAddKeywords);
                return () => window.removeEventListener('addKeywords', handleAddKeywords);
            }, [data]);

            const getFilteredData = () => {
                let filtered = data;

                // Filter by tab
                switch (activeTab) {
                    case 'campaigns':
                        filtered = filtered.filter(r => r.Entity === 'Campaign');
                        break;
                    case 'adgroups':
                        filtered = filtered.filter(r => r.Entity === 'Ad Group');
                        break;
                    case 'products':
                        filtered = filtered.filter(r => r.Entity === 'Product Ad');
                        break;
                    case 'keywords':
                        filtered = filtered.filter(r => r.Entity === 'Keyword');
                        break;
                    case 'targeting':
                        filtered = filtered.filter(r => r.Entity === 'Product Targeting');
                        break;
                    case 'negative':
                        filtered = filtered.filter(r => r.Entity === 'Negative Keyword' || r.Entity === 'Campaign Negative Keyword');
                        break;
                    case 'changes':
                        filtered = changes;
                        break;
                }

                // Filter by status (NEW, MODIFIED, UNCHANGED)
                if (statusFilterValue !== 'all') {
                    filtered = filtered.filter(row => {
                        const rowId = getRowId(row);
                        const isNew = !originalRowMap.has(rowId);
                        const original = originalRowMap.get(rowId);
                        const isModified = original && hasRowChanged(original, row);
                        
                        if (statusFilterValue === 'new') return isNew;
                        if (statusFilterValue === 'modified') return isModified;
                        if (statusFilterValue === 'unchanged') return !isNew && !isModified;
                        return true;
                    });
                }

                // Filter by search term
                if (searchTerm) {
                    filtered = filtered.filter(row => {
                        return Object.values(row).some(val => 
                            String(val).toLowerCase().includes(searchTerm.toLowerCase())
                        );
                    });
                }

                // Apply column filters
                if (Object.keys(columnFilters).length > 0) {
                    filtered = filtered.filter(row => {
                        return Object.entries(columnFilters).every(([column, selectedValues]) => {
                            if (selectedValues.size === 0) return true;
                            
                            let rowValue;
                            // Check against CURRENT data (what user sees), not original
                            if (column === 'Portfolio Name') {
                                rowValue = getPortfolioName(row);
                            } else if (column === 'Campaign Name') {
                                rowValue = getCampaignName(row);
                            } else if (column === 'Ad Group Name') {
                                rowValue = getAdGroupName(row);
                            } else {
                                rowValue = row[column];
                            }
                            
                            return selectedValues.has(String(rowValue));
                        });
                    });
                }
                
                // Apply column sorting
                if (columnSort.column && columnSort.direction) {
                    filtered = [...filtered].sort((a, b) => {
                        const aVal = a[columnSort.column];
                        const bVal = b[columnSort.column];
                        
                        // Parse numeric values
                        const aNum = parseFloat(String(aVal).replace(/[,$%]/g, '')) || 0;
                        const bNum = parseFloat(String(bVal).replace(/[,$%]/g, '')) || 0;
                        
                        if (columnSort.direction === 'asc') {
                            return aNum - bNum;
                        } else {
                            return bNum - aNum;
                        }
                    });
                }

                return filtered;
            };

            // Helper function to normalize keywords (replace + with spaces)
            const normalizeKeyword = (keyword) => {
                return keyword.trim().toLowerCase().replace(/\+/g, ' ').replace(/\s+/g, ' ');
            };

            // Check if an item is in the reference list
            const isInReferenceList = (row) => {
                // Filter by portfolio if one is selected
                if (referencePortfolio && getPortfolioName(row) !== referencePortfolio) {
                    return false;
                }
                
                if (row.Entity === 'Keyword') {
                    // Check table mode data
                    if (useTableMode && keywordTableData.length > 0) {
                        const refList = keywordTableData
                            .map(r => normalizeKeyword(r['Keyword'] || r[tableColumns[0]] || ''))
                            .filter(k => k);
                        const keyword = normalizeKeyword(row['Keyword Text'] || '');
                        return refList.includes(keyword);
                    }
                    // Check text mode data
                    if (referenceKeywords) {
                        const refList = referenceKeywords.split('\n')
                            .map(k => {
                                // Handle tab-separated data - take first column only
                                const parts = k.split('\t');
                                return normalizeKeyword(parts[0]);
                            })
                            .filter(k => k);
                        const keyword = normalizeKeyword(row['Keyword Text'] || '');
                        return refList.includes(keyword);
                    }
                }
                
                if ((row.Entity === 'Product Ad' || row.Entity === 'Product Targeting') && referenceProducts) {
                    const refList = referenceProducts.split('\n')
                        .map(p => p.trim().toUpperCase())
                        .filter(p => p);
                    const sku = (row.SKU || '').toUpperCase();
                    const asin = (row['ASIN (Informational only)'] || '').toUpperCase();
                    const targeting = (row['Product Targeting Expression'] || '').toUpperCase();
                    return refList.includes(sku) || refList.includes(asin) || 
                           refList.some(ref => targeting.includes(ref));
                }
                
                return false;
            };

            // Get list of unique portfolios
            const getPortfolioList = () => {
                const portfolios = new Set();
                data.forEach(row => {
                    const portfolio = getPortfolioName(row);
                    if (portfolio && portfolio !== '-') {
                        portfolios.add(portfolio);
                    }
                });
                return Array.from(portfolios).sort();
            };

            // Check keyword status (exists in campaigns or not)
            const getKeywordStatus = () => {
                // Use table data if in table mode
                if (useTableMode && keywordTableData.length > 0) {
                    return keywordTableData.map(row => {
                        const keyword = row['Keyword'] || row[tableColumns[0]] || '';
                        const normalizedKeyword = normalizeKeyword(keyword);
                        const metadata = {};
                        
                        // Store all columns except Keyword as metadata
                        tableColumns.forEach((col, idx) => {
                            if (idx > 0) {
                                metadata[col] = row[col] || '';
                            }
                        });
                        
                        const existing = data.filter(rowData => {
                            if (rowData.Entity !== 'Keyword') return false;
                            if (referencePortfolio && getPortfolioName(rowData) !== referencePortfolio) return false;
                            return normalizeKeyword(rowData['Keyword Text'] || '') === normalizedKeyword;
                        });
                        
                        const matchTypes = [...new Set(existing.map(e => e['Match Type']))].filter(Boolean);
                        
                        // Check if keywords are truly active (keyword, campaign, and ad group all enabled)
                        const enabledKeywords = existing.filter(e => {
                            const keywordEnabled = (e.State || '').toLowerCase() === 'enabled';
                            if (!keywordEnabled) return false;
                            
                            // Check campaign state
                            const campaignRow = data.find(r => 
                                r.Entity === 'Campaign' && 
                                r['Campaign ID'] === e['Campaign ID']
                            );
                            const campaignEnabled = !campaignRow || (campaignRow.State || '').toLowerCase() === 'enabled';
                            
                            // Check ad group state
                            const adGroupRow = data.find(r => 
                                r.Entity === 'Ad Group' && 
                                r['Campaign ID'] === e['Campaign ID'] && 
                                r['Ad Group ID'] === e['Ad Group ID']
                            );
                            const adGroupEnabled = !adGroupRow || (adGroupRow.State || '').toLowerCase() === 'enabled';
                            
                            return campaignEnabled && adGroupEnabled;
                        });
                        
                        const pausedKeywords = existing.filter(e => {
                            const keywordPaused = (e.State || '').toLowerCase() === 'paused';
                            
                            // Check campaign state
                            const campaignRow = data.find(r => 
                                r.Entity === 'Campaign' && 
                                r['Campaign ID'] === e['Campaign ID']
                            );
                            const campaignPaused = campaignRow && (campaignRow.State || '').toLowerCase() === 'paused';
                            
                            // Check ad group state
                            const adGroupRow = data.find(r => 
                                r.Entity === 'Ad Group' && 
                                r['Campaign ID'] === e['Campaign ID'] && 
                                r['Ad Group ID'] === e['Ad Group ID']
                            );
                            const adGroupPaused = adGroupRow && (adGroupRow.State || '').toLowerCase() === 'paused';
                            
                            // Keyword is effectively paused if any component is paused
                            return keywordPaused || campaignPaused || adGroupPaused;
                        });
                        
                        return {
                            keyword: keyword,
                            exists: existing.length > 0,
                            count: existing.length,
                            matchTypes: matchTypes,
                            metadata: metadata,
                            hasMetadata: tableColumns.length > 1,
                            enabledCount: enabledKeywords.length,
                            pausedCount: pausedKeywords.length,
                            isPaused: pausedKeywords.length > 0 && enabledKeywords.length === 0,
                            hasEnabledAndPaused: enabledKeywords.length > 0 && pausedKeywords.length > 0,
                            locations: existing.map(e => {
                                // Get campaign state
                                const campaignRow = data.find(r => 
                                    r.Entity === 'Campaign' && 
                                    r['Campaign ID'] === e['Campaign ID']
                                );
                                const campaignState = campaignRow ? (campaignRow.State || '').toLowerCase() : 'unknown';
                                
                                // Get ad group state
                                const adGroupRow = data.find(r => 
                                    r.Entity === 'Ad Group' && 
                                    r['Campaign ID'] === e['Campaign ID'] && 
                                    r['Ad Group ID'] === e['Ad Group ID']
                                );
                                const adGroupState = adGroupRow ? (adGroupRow.State || '').toLowerCase() : 'unknown';
                                
                                const keywordState = (e.State || '').toLowerCase();
                                
                                // Determine effective state
                                let effectiveState = 'enabled';
                                let pauseReason = '';
                                
                                if (keywordState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'keyword paused';
                                } else if (campaignState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'campaign paused';
                                } else if (adGroupState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'ad group paused';
                                }
                                
                                return {
                                    campaign: getCampaignName(e),
                                    adGroup: getAdGroupName(e),
                                    matchType: e['Match Type'],
                                    state: effectiveState,
                                    keywordState: keywordState,
                                    campaignState: campaignState,
                                    adGroupState: adGroupState,
                                    pauseReason: pauseReason
                                };
                            })
                        };
                    });
                }
                
                // Original text mode logic
                const lines = referenceKeywords.split('\n')
                    .map(k => k.trim())
                    .filter(k => k);
                
                // Detect if data has tabs (multi-column format from Google Sheets)
                const hasMultipleColumns = lines.some(line => line.includes('\t'));
                
                
                if (hasMultipleColumns) {
                    // Parse tab-separated data
                    const rows = lines.map(line => line.split('\t'));
                    
                    // First row might be headers, check if it looks like headers
                    const firstRow = rows[0];
                    const isHeaderRow = firstRow.some(cell => 
                        cell && /^[A-Za-z\s]+$/.test(cell) && !data.some(d => 
                            d.Entity === 'Keyword' && 
                            normalizeKeyword(d['Keyword Text'] || '') === normalizeKeyword(cell)
                        )
                    );
                    
                    const headers = isHeaderRow ? firstRow : ['Keyword', ...Array(firstRow.length - 1).fill('').map((_, i) => `Column ${i + 2}`)];
                    const dataRows = isHeaderRow ? rows.slice(1) : rows;
                    
                    return dataRows.map(row => {
                        const keyword = row[0] || '';
                        const normalizedKeyword = normalizeKeyword(keyword);
                        const metadata = {};
                        
                        // Store additional columns as metadata
                        for (let i = 1; i < row.length; i++) {
                            metadata[headers[i] || `Column ${i + 1}`] = row[i] || '';
                        }
                        
                        const existing = data.filter(rowData => {
                            if (rowData.Entity !== 'Keyword') return false;
                            if (referencePortfolio && getPortfolioName(rowData) !== referencePortfolio) return false;
                            return normalizeKeyword(rowData['Keyword Text'] || '') === normalizedKeyword;
                        });
                        
                        // Get unique match types
                        const matchTypes = [...new Set(existing.map(e => e['Match Type']))].filter(Boolean);
                        
                        // Check if keywords are truly active (keyword, campaign, and ad group all enabled)
                        const enabledKeywords = existing.filter(e => {
                            const keywordEnabled = (e.State || '').toLowerCase() === 'enabled';
                            if (!keywordEnabled) return false;
                            
                            const campaignRow = data.find(r => r.Entity === 'Campaign' && r['Campaign ID'] === e['Campaign ID']);
                            const campaignEnabled = !campaignRow || (campaignRow.State || '').toLowerCase() === 'enabled';
                            
                            const adGroupRow = data.find(r => r.Entity === 'Ad Group' && r['Campaign ID'] === e['Campaign ID'] && r['Ad Group ID'] === e['Ad Group ID']);
                            const adGroupEnabled = !adGroupRow || (adGroupRow.State || '').toLowerCase() === 'enabled';
                            
                            return campaignEnabled && adGroupEnabled;
                        });
                        
                        const pausedKeywords = existing.filter(e => {
                            const keywordPaused = (e.State || '').toLowerCase() === 'paused';
                            const campaignRow = data.find(r => r.Entity === 'Campaign' && r['Campaign ID'] === e['Campaign ID']);
                            const campaignPaused = campaignRow && (campaignRow.State || '').toLowerCase() === 'paused';
                            const adGroupRow = data.find(r => r.Entity === 'Ad Group' && r['Campaign ID'] === e['Campaign ID'] && r['Ad Group ID'] === e['Ad Group ID']);
                            const adGroupPaused = adGroupRow && (adGroupRow.State || '').toLowerCase() === 'paused';
                            
                            return keywordPaused || campaignPaused || adGroupPaused;
                        });
                        
                        return {
                            keyword: keyword,
                            exists: existing.length > 0,
                            count: existing.length,
                            matchTypes: matchTypes,
                            metadata: metadata,
                            hasMetadata: true,
                            enabledCount: enabledKeywords.length,
                            pausedCount: pausedKeywords.length,
                            isPaused: pausedKeywords.length > 0 && enabledKeywords.length === 0,
                            hasEnabledAndPaused: enabledKeywords.length > 0 && pausedKeywords.length > 0,
                            locations: existing.map(e => {
                                const campaignRow = data.find(r => r.Entity === 'Campaign' && r['Campaign ID'] === e['Campaign ID']);
                                const campaignState = campaignRow ? (campaignRow.State || '').toLowerCase() : 'unknown';
                                const adGroupRow = data.find(r => r.Entity === 'Ad Group' && r['Campaign ID'] === e['Campaign ID'] && r['Ad Group ID'] === e['Ad Group ID']);
                                const adGroupState = adGroupRow ? (adGroupRow.State || '').toLowerCase() : 'unknown';
                                const keywordState = (e.State || '').toLowerCase();
                                
                                let effectiveState = 'enabled';
                                let pauseReason = '';
                                
                                if (keywordState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'keyword paused';
                                } else if (campaignState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'campaign paused';
                                } else if (adGroupState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'ad group paused';
                                }
                                
                                return {
                                    campaign: getCampaignName(e),
                                    adGroup: getAdGroupName(e),
                                    matchType: e['Match Type'],
                                    state: effectiveState,
                                    keywordState: keywordState,
                                    campaignState: campaignState,
                                    adGroupState: adGroupState,
                                    pauseReason: pauseReason
                                };
                            })
                        };
                    });
                } else {
                    // Simple single-column format
                    return lines.map(keyword => {
                        const normalizedKeyword = normalizeKeyword(keyword);
                        const existing = data.filter(row => {
                            if (row.Entity !== 'Keyword') return false;
                            if (referencePortfolio && getPortfolioName(row) !== referencePortfolio) return false;
                            return normalizeKeyword(row['Keyword Text'] || '') === normalizedKeyword;
                        });
                        
                        // Get unique match types
                        const matchTypes = [...new Set(existing.map(e => e['Match Type']))].filter(Boolean);
                        
                        // Check if keywords are truly active (keyword, campaign, and ad group all enabled)
                        const enabledKeywords = existing.filter(e => {
                            const keywordEnabled = (e.State || '').toLowerCase() === 'enabled';
                            if (!keywordEnabled) return false;
                            
                            const campaignRow = data.find(r => r.Entity === 'Campaign' && r['Campaign ID'] === e['Campaign ID']);
                            const campaignEnabled = !campaignRow || (campaignRow.State || '').toLowerCase() === 'enabled';
                            
                            const adGroupRow = data.find(r => r.Entity === 'Ad Group' && r['Campaign ID'] === e['Campaign ID'] && r['Ad Group ID'] === e['Ad Group ID']);
                            const adGroupEnabled = !adGroupRow || (adGroupRow.State || '').toLowerCase() === 'enabled';
                            
                            return campaignEnabled && adGroupEnabled;
                        });
                        
                        const pausedKeywords = existing.filter(e => {
                            const keywordPaused = (e.State || '').toLowerCase() === 'paused';
                            const campaignRow = data.find(r => r.Entity === 'Campaign' && r['Campaign ID'] === e['Campaign ID']);
                            const campaignPaused = campaignRow && (campaignRow.State || '').toLowerCase() === 'paused';
                            const adGroupRow = data.find(r => r.Entity === 'Ad Group' && r['Campaign ID'] === e['Campaign ID'] && r['Ad Group ID'] === e['Ad Group ID']);
                            const adGroupPaused = adGroupRow && (adGroupRow.State || '').toLowerCase() === 'paused';
                            
                            return keywordPaused || campaignPaused || adGroupPaused;
                        });
                        
                        return {
                            keyword: keyword,
                            exists: existing.length > 0,
                            count: existing.length,
                            matchTypes: matchTypes,
                            hasMetadata: false,
                            enabledCount: enabledKeywords.length,
                            pausedCount: pausedKeywords.length,
                            isPaused: pausedKeywords.length > 0 && enabledKeywords.length === 0,
                            hasEnabledAndPaused: enabledKeywords.length > 0 && pausedKeywords.length > 0,
                            locations: existing.map(e => {
                                const campaignRow = data.find(r => r.Entity === 'Campaign' && r['Campaign ID'] === e['Campaign ID']);
                                const campaignState = campaignRow ? (campaignRow.State || '').toLowerCase() : 'unknown';
                                const adGroupRow = data.find(r => r.Entity === 'Ad Group' && r['Campaign ID'] === e['Campaign ID'] && r['Ad Group ID'] === e['Ad Group ID']);
                                const adGroupState = adGroupRow ? (adGroupRow.State || '').toLowerCase() : 'unknown';
                                const keywordState = (e.State || '').toLowerCase();
                                
                                let effectiveState = 'enabled';
                                let pauseReason = '';
                                
                                if (keywordState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'keyword paused';
                                } else if (campaignState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'campaign paused';
                                } else if (adGroupState === 'paused') {
                                    effectiveState = 'paused';
                                    pauseReason = 'ad group paused';
                                }
                                
                                return {
                                    campaign: getCampaignName(e),
                                    adGroup: getAdGroupName(e),
                                    matchType: e['Match Type'],
                                    state: effectiveState,
                                    keywordState: keywordState,
                                    campaignState: campaignState,
                                    adGroupState: adGroupState,
                                    pauseReason: pauseReason
                                };
                            })
                        };
                    });
                }
            };

            // Check product status
            const getProductStatus = () => {
                const products = referenceProducts.split('\n')
                    .map(p => p.trim().toUpperCase())
                    .filter(p => p);
                
                return products.map(product => {
                    const existing = data.filter(row => {
                        if (referencePortfolio && getPortfolioName(row) !== referencePortfolio) return false;
                        
                        // Use the same logic as isInReferenceList for consistency
                        if (row.Entity === 'Product Ad' || row.Entity === 'Product Targeting') {
                            const sku = (row.SKU || '').toUpperCase();
                            const asin = (row['ASIN (Informational only)'] || '').toUpperCase();
                            const targeting = (row['Product Targeting Expression'] || '').toUpperCase();
                            
                            // Check if the product matches SKU, ASIN, or appears in targeting expression
                            return sku === product || asin === product || targeting.includes(product);
                        }
                        
                        return false;
                    });
                    
                    // Check if any products are paused vs enabled
                    const enabledProducts = existing.filter(e => (e.State || '').toLowerCase() === 'enabled');
                    const pausedProducts = existing.filter(e => (e.State || '').toLowerCase() === 'paused');
                    
                    return {
                        product: product,
                        exists: existing.length > 0,
                        count: existing.length,
                        enabledCount: enabledProducts.length,
                        pausedCount: pausedProducts.length,
                        isPaused: pausedProducts.length > 0 && enabledProducts.length === 0,
                        hasEnabledAndPaused: enabledProducts.length > 0 && pausedProducts.length > 0,
                        locations: existing.map(e => ({
                            campaign: getCampaignName(e),
                            adGroup: getAdGroupName(e),
                            type: e.Entity, // Add entity type so we know if it's Product Ad or Product Targeting
                            state: (e.State || '').toLowerCase()
                        }))
                    };
                });
            };

            // Get keywords for an ad group with root word analysis
            const getAdGroupKeywords = (adGroupId) => {
                const keywords = data.filter(r => 
                    r.Entity === 'Keyword' && r['Ad Group ID'] === adGroupId
                )
                // Sort by sales (highest to lowest)
                .sort((a, b) => {
                    const salesA = parseFloat(a.Sales || 0);
                    const salesB = parseFloat(b.Sales || 0);
                    return salesB - salesA;
                });

                // Get Product Targeting items
                const productTargets = data.filter(r => 
                    r.Entity === 'Product Targeting' && r['Ad Group ID'] === adGroupId
                )
                // Sort by sales (highest to lowest)
                .sort((a, b) => {
                    const salesA = parseFloat(a.Sales || 0);
                    const salesB = parseFloat(b.Sales || 0);
                    return salesB - salesA;
                });

                // Root word analysis (only for keywords)
                const rootMap = {};
                keywords.forEach(kw => {
                    const keywordText = (kw['Keyword Text'] || '').toLowerCase();
                    const words = keywordText.split(/\s+/);
                    
                    words.forEach(word => {
                        if (word.length > 2) {
                            if (!rootMap[word]) {
                                rootMap[word] = {
                                    root: word,
                                    count: 0,
                                    spend: 0,
                                    sales: 0,
                                    keywords: []
                                };
                            }
                            
                            rootMap[word].count++;
                            rootMap[word].spend += parseFloat(kw.Spend || 0);
                            rootMap[word].sales += parseFloat(kw.Sales || 0);
                            rootMap[word].keywords.push(keywordText);
                        }
                    });
                });

                const roots = Object.values(rootMap)
                    .map(root => ({
                        ...root,
                        acos: root.sales > 0 ? (root.spend / root.sales) * 100 : 0
                    }))
                    .sort((a, b) => b.spend - a.spend);

                return { keywords, productTargets, roots };
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <div className="bg-white shadow-sm border-b sticky top-0 z-30">
                        <div className="max-w-[98%] mx-auto px-4 py-3">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-900">Amazon PPC Manager</h1>
                                    <p className="text-sm text-gray-600">Enhanced Bulksheet Manager - Create & Update Campaigns</p>
                                </div>
                                <div className="flex gap-3 items-center">
                                    <label className="cursor-pointer px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2 text-sm font-medium">
                                        <span>📂 Upload CSV</span>
                                        <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                                    </label>
                                    
                                    {data.length > 0 && (
                                        <>
                                            <button
                                                onClick={downloadCSV}
                                                className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition text-sm font-medium"
                                            >
                                                💾 Download All
                                            </button>
                                            <button
                                                onClick={downloadChanges}
                                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-medium flex items-center gap-2"
                                                disabled={changes.length === 0}
                                            >
                                                <span>📥 Export Bulksheet</span>
                                                {changes.length > 0 && (
                                                    <span className="bg-white text-green-700 px-2 py-0.5 rounded-full text-xs font-bold">
                                                        {changes.length}
                                                    </span>
                                                )}
                                            </button>
                                            <button
                                                onClick={() => setShowReferencePanel(!showReferencePanel)}
                                                className={`px-4 py-2 rounded-lg transition text-sm font-medium ${
                                                    showReferencePanel 
                                                        ? 'bg-orange-600 text-white hover:bg-orange-700' 
                                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                            >
                                                🎯 Target Checker
                                            </button>
                                            
                                            {/* Auto-save indicator */}
                                            {hasSavedChanges && (
                                                <div className="flex items-center gap-2 px-3 py-2 bg-green-100 text-green-800 rounded-lg text-xs font-medium">
                                                    <span className="animate-pulse">●</span>
                                                    <span>{savedChangesCount} changes auto-saved</span>
                                                </div>
                                            )}
                                            
                                            {/* Download/Upload Changes */}
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={downloadChangesFile}
                                                    className="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-xs font-medium"
                                                    disabled={!hasSavedChanges}
                                                    title="Download your changes as a backup file"
                                                >
                                                    💾 Save Changes
                                                </button>
                                                <label className="cursor-pointer px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-xs font-medium">
                                                    📂 Load Changes
                                                    <input type="file" accept=".json" onChange={uploadChangesFile} className="hidden" />
                                                </label>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                            {changes.length > 0 && showExportTip && (
                                <div className="mt-2 text-xs text-gray-600 bg-blue-50 px-3 py-2 rounded relative">
                                    <button
                                        onClick={() => setShowExportTip(false)}
                                        className="absolute top-1 right-1 text-blue-600 hover:text-blue-800 font-bold text-base leading-none"
                                        title="Close tip"
                                    >
                                        ×
                                    </button>
                                    💡 <strong>Tip:</strong> Export Bulksheet creates an Amazon-compatible CSV with {changes.length} {changes.length === 1 ? 'change' : 'changes'} 
                                    (new items will be created, modified items will be updated)
                                    {changes.length > 0 && (
                                        <span className="ml-2 text-green-700">
                                            • Changes are <strong>auto-saved</strong> - safe to close/reload anytime!
                                        </span>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Recovery Banner */}
                    {showRecoveryBanner && (
                        <div className="bg-orange-100 border-l-4 border-orange-500 px-4 py-3 shadow-sm sticky top-[72px] z-20">
                            <div className="max-w-[98%] mx-auto flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <span className="text-2xl">⚠️</span>
                                    <div>
                                        <p className="text-sm font-bold text-orange-900">Unsaved Changes Detected!</p>
                                        <p className="text-xs text-orange-800">
                                            You have <strong>{savedChangesCount} unsaved changes</strong>. Upload your CSV to restore them or download the changes file as backup.
                                        </p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={downloadChangesFile}
                                        className="px-3 py-1.5 bg-orange-600 text-white rounded text-xs font-medium hover:bg-orange-700"
                                    >
                                        💾 Download Changes
                                    </button>
                                    <label className="cursor-pointer px-3 py-1.5 bg-blue-600 text-white rounded text-xs font-medium hover:bg-blue-700">
                                        📂 Upload CSV
                                        <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                                    </label>
                                    <button
                                        onClick={async () => {
                                            if (confirm('Are you sure you want to discard all saved changes? This cannot be undone.')) {
                                                await clearSavedChanges();
                                            }
                                        }}
                                        className="px-3 py-1.5 bg-gray-600 text-white rounded text-xs font-medium hover:bg-gray-700"
                                    >
                                        🗑️ Discard
                                    </button>
                                    <button
                                        onClick={() => setShowRecoveryBanner(false)}
                                        className="px-3 py-1.5 bg-gray-200 text-gray-700 rounded text-xs font-medium hover:bg-gray-300"
                                    >
                                        ✕
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="max-w-[98%] mx-auto px-4 py-6">
                            {data.length > 0 && (
                                <>
                                    {/* Tabs */}
                                    <div className="bg-white rounded-lg shadow-sm mb-4 border border-gray-200">
                                        <div className="flex gap-1 p-2 overflow-x-auto">
                                            {[
                                                { id: 'campaigns', label: 'Campaigns', icon: '📢', count: data.filter(r => r.Entity === 'Campaign').length },
                                                { id: 'adgroups', label: 'Ad Groups', icon: '📁', count: data.filter(r => r.Entity === 'Ad Group').length },
                                                { id: 'products', label: 'Products', icon: '📦', count: data.filter(r => r.Entity === 'Product Ad').length },
                                                { id: 'keywords', label: 'Keywords', icon: '🔑', count: data.filter(r => r.Entity === 'Keyword').length },
                                                { id: 'targeting', label: 'Targeting', icon: '🎯', count: data.filter(r => r.Entity === 'Product Targeting').length },
                                                { id: 'negative', label: 'Negatives', icon: '🚫', count: data.filter(r => r.Entity === 'Negative Keyword' || r.Entity === 'Campaign Negative Keyword').length },
                                                { id: 'changes', label: 'Changes', icon: '✏️', count: changes.length }
                                            ].map(tab => (
                                                <button
                                                    key={tab.id}
                                                    onClick={() => setActiveTab(tab.id)}
                                                    className={`flex items-center gap-2 px-4 py-2.5 rounded-lg transition text-sm font-medium whitespace-nowrap ${
                                                        activeTab === tab.id
                                                            ? 'bg-blue-600 text-white shadow-md'
                                                            : 'text-gray-700 hover:bg-gray-100'
                                                    }`}
                                                >
                                                    <span>{tab.icon}</span>
                                                    <span>{tab.label}</span>
                                                    <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${
                                                        activeTab === tab.id
                                                            ? 'bg-white text-blue-700'
                                                            : 'bg-gray-200 text-gray-700'
                                                    }`}>
                                                        {tab.count}
                                                    </span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Search and Actions */}
                                    <div className="bg-white rounded-lg shadow-sm p-4 mb-4 border border-gray-200">
                                        <div className="flex flex-col gap-3">
                                            <input
                                                type="text"
                                                placeholder="Search..."
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                                            />
                                            <div className="flex items-center gap-2">
                                                {/* Add New dropdown with Campaign always accessible */}
                                                <div className="relative inline-block">
                                                    <button
                                                        onClick={(e) => {
                                                            const dropdown = e.currentTarget.nextElementSibling;
                                                            dropdown.classList.toggle('hidden');
                                                        }}
                                                        onBlur={(e) => {
                                                            // Delay to allow click on dropdown items
                                                            setTimeout(() => {
                                                                const dropdown = e.currentTarget.nextElementSibling;
                                                                if (dropdown && !dropdown.matches(':hover')) {
                                                                    dropdown.classList.add('hidden');
                                                                }
                                                            }, 200);
                                                        }}
                                                        className="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-xs font-medium flex items-center gap-1"
                                                    >
                                                        <span>➕</span>
                                                        <span>Add New</span>
                                                        <span className="ml-1">▼</span>
                                                    </button>
                                                    <div className="hidden absolute left-0 mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                                                        <button
                                                            onClick={() => {
                                                                setShowModal(true);
                                                                setModalType('campaigns');
                                                            }}
                                                            className="w-full text-left px-4 py-2 text-xs hover:bg-gray-100 rounded-t-lg flex items-center gap-2"
                                                        >
                                                            <span>📢</span>
                                                            <span>Campaign</span>
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                setShowModal(true);
                                                                setModalType('adgroups');
                                                            }}
                                                            className="w-full text-left px-4 py-2 text-xs hover:bg-gray-100 flex items-center gap-2 border-b border-gray-100"
                                                        >
                                                            <span>📁</span>
                                                            <span>Ad Group</span>
                                                        </button>
                                                        {activeTab === 'keywords' && (
                                                            <button
                                                                onClick={() => {
                                                                    setShowModal(true);
                                                                    setModalType('keywords');
                                                                }}
                                                                className="w-full text-left px-4 py-2 text-xs hover:bg-gray-100 flex items-center gap-2"
                                                            >
                                                                <span>🔑</span>
                                                                <span>Keywords</span>
                                                            </button>
                                                        )}
                                                        {activeTab === 'negative' && (
                                                            <button
                                                                onClick={() => {
                                                                    setShowModal(true);
                                                                    setModalType('negative');
                                                                }}
                                                                className="w-full text-left px-4 py-2 text-xs hover:bg-gray-100 flex items-center gap-2"
                                                            >
                                                                <span>🚫</span>
                                                                <span>Negative Keywords</span>
                                                            </button>
                                                        )}
                                                        {(activeTab === 'products' || activeTab === 'adgroups') && (
                                                            <button
                                                                onClick={() => {
                                                                    setShowModal(true);
                                                                    setModalType('products');
                                                                }}
                                                                className="w-full text-left px-4 py-2 text-xs hover:bg-gray-100 rounded-b-lg flex items-center gap-2"
                                                            >
                                                                <span>📦</span>
                                                                <span>Products</span>
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>

                                                {activeTab === 'changes' && changes.length > 0 && (
                                                    <button
                                                        onClick={undoAllChanges}
                                                        className="px-3 py-1.5 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-xs font-medium flex items-center gap-1"
                                                        title="Revert all changes and remove all new items"
                                                    >
                                                        <span>↶</span>
                                                        <span>Undo All ({changes.length})</span>
                                                    </button>
                                                )}
                                                
                                                {/* Status Filter */}
                                                {data.length > 0 && activeTab !== 'changes' && (
                                                    <select
                                                        value={statusFilterValue}
                                                        onChange={(e) => setStatusFilterValue(e.target.value)}
                                                        className="px-3 py-1.5 text-xs border border-gray-300 rounded-lg bg-white hover:bg-gray-50 font-medium"
                                                    >
                                                        <option value="all">All Items</option>
                                                        <option value="modified">📝 Modified Only</option>
                                                        <option value="new">✨ New Only</option>
                                                        <option value="unchanged">Unchanged Only</option>
                                                    </select>
                                                )}

                                                {selectedItems.size > 0 && (
                                                    <>
                                                        <span className="text-xs text-gray-600 font-medium">
                                                            {selectedItems.size} selected:
                                                        </span>
                                                        <button
                                                            onClick={() => bulkUpdateState('enabled')}
                                                            className="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700"
                                                        >
                                                            ▶ Enable
                                                        </button>
                                                        <button
                                                            onClick={() => bulkUpdateState('paused')}
                                                            className="px-2 py-1 text-xs bg-yellow-600 text-white rounded hover:bg-yellow-700"
                                                        >
                                                            ⏸ Pause
                                                        </button>
                                                        <button
                                                            onClick={() => bulkUpdateState('archived')}
                                                            className="px-2 py-1 text-xs bg-gray-600 text-white rounded hover:bg-gray-700"
                                                        >
                                                            📦 Archive
                                                        </button>
                                                        <button
                                                            onClick={deleteSelected}
                                                            className="px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700"
                                                        >
                                                            🗑️ Delete
                                                        </button>
                                                    </>
                                                )}

                                                <div className="ml-auto text-xs text-gray-600">
                                                    Showing {getFilteredData().length} items
                                                </div>
                                            </div>
                                        </div>

                                        {/* Active Column Filters Display */}
                                        {Object.keys(columnFilters).length > 0 && (
                                            <div className="bg-blue-50 rounded-lg shadow-sm p-3 mt-4 border border-blue-200">
                                                <div className="flex items-center gap-2 flex-wrap">
                                                    <span className="text-xs font-semibold text-blue-900">Column Filters:</span>
                                                    {Object.entries(columnFilters).map(([column, values]) => (
                                                        <div key={column} className="flex items-center gap-1 bg-white border border-blue-300 text-blue-800 px-2 py-1 rounded text-xs">
                                                            <span className="font-medium">{column.replace(' (Informational only)', '')}:</span>
                                                            <span>{values.size} selected</span>
                                                            <button
                                                                onClick={() => {
                                                                    const newFilters = { ...columnFilters };
                                                                    delete newFilters[column];
                                                                    setColumnFilters(newFilters);
                                                                }}
                                                                className="ml-1 text-blue-600 hover:text-blue-800 font-bold"
                                                            >
                                                                ×
                                                            </button>
                                                        </div>
                                                    ))}
                                                    <button
                                                        onClick={() => setColumnFilters({})}
                                                        className="text-xs text-red-600 hover:text-red-800 underline ml-2"
                                                    >
                                                        Clear all column filters
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Data Table */}
                                    {data.length > 0 ? (
                                        <div className="bg-white rounded-lg shadow-sm overflow-hidden">
                                            {showReferencePanel && (referenceKeywords || referenceProducts) && (
                                                <div className="bg-orange-50 px-4 py-2 border-b border-orange-200 flex items-center gap-2 text-sm">
                                                    <span className="text-orange-700 font-medium">🎯 Target Checker Active:</span>
                                                    <span className="text-orange-600">Rows matching your reference list are highlighted in orange</span>
                                                </div>
                                            )}
                                            <DataTable
                                                data={getFilteredData()}
                                                activeTab={activeTab}
                                                updateRow={updateRow}
                                                setData={setData}
                                                selectedItems={selectedItems}
                                                toggleSelection={toggleSelection}
                                                selectAll={selectAll}
                                                changes={changes}
                                                originalRowMap={originalRowMap}
                                                columnWidths={columnWidths}
                                                setColumnWidths={setColumnWidths}
                                                columnFilters={columnFilters}
                                                setColumnFilters={setColumnFilters}
                                                setActiveFilterColumn={setActiveFilterColumn}
                                                setFilterPosition={setFilterPosition}
                                                columnSort={columnSort}
                                                allData={data}
                                                isInReferenceList={isInReferenceList}
                                                showReferencePanel={showReferencePanel}
                                                getAdGroupKeywords={getAdGroupKeywords}
                                                undoChange={undoChange}
                                            />
                                        </div>
                                    ) : (
                                        <div className="bg-white rounded-lg shadow-sm p-12 text-center">
                                            {hasSavedChanges ? (
                                                <>
                                                    <div className="text-6xl mb-4">⚠️</div>
                                                    <h2 className="text-2xl font-semibold text-gray-900 mb-2">Unsaved Changes Detected</h2>
                                                    <p className="text-gray-600 mb-4">
                                                        You have <strong className="text-orange-600">{savedChangesCount} saved changes</strong> waiting to be applied.<br/>
                                                        Upload your CSV file to restore your work.
                                                    </p>
                                                    <div className="flex gap-3 justify-center">
                                                        <label className="cursor-pointer px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium">
                                                            📂 Upload CSV to Restore
                                                            <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                                                        </label>
                                                        <button
                                                            onClick={downloadChangesFile}
                                                            className="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm font-medium"
                                                        >
                                                            💾 Download Changes Backup
                                                        </button>
                                                    </div>
                                                </>
                                            ) : (
                                                <>
                                                    <div className="text-6xl mb-4">🚀</div>
                                                    <h2 className="text-2xl font-semibold text-gray-900 mb-2">Ready to Build Campaigns</h2>
                                                    <p className="text-gray-600 mb-4">
                                                        Click <strong>"➕ Add New"</strong> above to start building campaigns from scratch,<br/>
                                                        or upload a CSV file to edit existing campaigns.
                                                    </p>
                                                    {showBulkModeTip && (
                                                        <div className="text-sm text-gray-500 bg-gray-50 px-3 py-2 rounded relative inline-block">
                                                            <button
                                                                onClick={() => setShowBulkModeTip(false)}
                                                                className="absolute top-1 right-1 text-gray-500 hover:text-gray-800 font-bold text-base leading-none"
                                                                title="Close tip"
                                                            >
                                                                ×
                                                            </button>
                                                            💡 Tip: Use <strong>Bulk Mode</strong> in the campaign builder to create multiple campaigns at once!
                                                        </div>
                                                    )}
                                                </>
                                            )}
                                        </div>
                                    )}
                                </>
                            )}
                    </div>

                    {/* Reference Panel Sidebar */}
                    {showReferencePanel && (
                        <div className="fixed top-0 right-0 h-full bg-white shadow-2xl border-l border-gray-200 z-40 overflow-y-auto" style={{ width: `${panelWidth}px` }}>
                            {/* Resize Handle */}
                            <div
                                className="absolute left-0 top-0 h-full w-2 cursor-ew-resize hover:bg-blue-500 bg-gray-400 transition-colors flex items-center justify-center"
                                onMouseDown={(e) => {
                                    e.preventDefault();
                                    const startX = e.clientX;
                                    const startWidth = panelWidth;
                                    
                                    const handleMouseMove = (e) => {
                                        const diff = startX - e.clientX;
                                        const newWidth = Math.max(400, Math.min(window.innerWidth * 0.8, startWidth + diff));
                                        setPanelWidth(newWidth);
                                    };
                                    
                                    const handleMouseUp = () => {
                                        document.removeEventListener('mousemove', handleMouseMove);
                                        document.removeEventListener('mouseup', handleMouseUp);
                                    };
                                    
                                    document.addEventListener('mousemove', handleMouseMove);
                                    document.addEventListener('mouseup', handleMouseUp);
                                }}
                                title="◄► Drag to resize panel"
                            >
                                <div className="text-gray-600 text-xs writing-mode-vertical">⋮</div>
                            </div>
                            <div className="p-4">
                                {/* Header */}
                                <div className="flex items-center justify-between mb-4 pb-3 border-b">
                                    <h3 className="text-lg font-bold text-gray-900">🎯 Target Checker</h3>
                                    <div className="flex items-center gap-2">
                                        <button
                                            onClick={async () => {
                                                const savedData = await loadTargetCheckerFromDB();
                                                if (savedData && savedData.tableData && savedData.tableData.length > 0) {
                                                    const shouldRestore = confirm(
                                                        `Restore saved data from ${new Date(savedData.timestamp).toLocaleString()}?\n\n` +
                                                        `${savedData.tableData.length} rows in your table.\n\n` +
                                                        `This will replace your current table data.`
                                                    );
                                                    
                                                    if (shouldRestore) {
                                                        setKeywordTableData(savedData.tableData);
                                                        setTableColumns(savedData.columns);
                                                    }
                                                } else {
                                                    alert('No saved data found.');
                                                }
                                            }}
                                            className="px-2 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 font-medium"
                                            title="Restore last saved data"
                                        >
                                            ⏮️ Restore Last Data
                                        </button>
                                        <button
                                            onClick={() => setShowReferencePanel(false)}
                                            className="text-gray-500 hover:text-gray-700 text-xl"
                                        >
                                            ×
                                        </button>
                                    </div>
                                </div>

                                {/* Info Box */}
                                {showTargetCheckerTip && (
                                    <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-900 mb-4 relative">
                                        <button
                                            onClick={() => setShowTargetCheckerTip(false)}
                                            className="absolute top-2 right-2 text-blue-600 hover:text-blue-800 font-bold text-lg leading-none"
                                            title="Close tip"
                                        >
                                            ×
                                        </button>
                                        💡 <strong>How it works:</strong> Build your keyword table with custom columns. Items already in your campaigns are highlighted in orange.
                                        <div className="mt-2 pt-2 border-t border-blue-200">
                                            <strong>✨ Features:</strong>
                                            <ul className="mt-1 ml-4 space-y-1 text-[11px]">
                                                <li>• <strong>Drag the left edge</strong> of this panel to resize it</li>
                                                <li>• Add custom columns (Volume, Match Type, Group, etc.)</li>
                                                <li>• Paste multiple keywords at once in any cell</li>
                                                <li>• Sort, filter, search, and export your data</li>
                                                <li>• Select keywords with checkboxes</li>
                                            </ul>
                                        </div>
                                    </div>
                                )}

                                {/* Portfolio Filter */}
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Filter by Portfolio (optional)
                                    </label>
                                    <select
                                        value={referencePortfolio}
                                        onChange={(e) => setReferencePortfolio(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                    >
                                        <option value="">All Portfolios</option>
                                        {getPortfolioList().map((p, i) => (
                                            <option key={i} value={p}>{p}</option>
                                        ))}
                                    </select>
                                    {referencePortfolio && (
                                        <div className="mt-1 text-xs text-gray-600">
                                            Checking only in: <strong>{referencePortfolio}</strong>
                                        </div>
                                    )}
                                </div>

                                {/* Status Legend */}
                                <div className="mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                                    <div className="text-xs font-semibold text-gray-700 mb-2">Status Legend:</div>
                                    <div className="grid grid-cols-2 gap-2 text-[10px]">
                                        <div className="flex items-center gap-1.5">
                                            <span className="inline-block px-1.5 py-0.5 bg-green-600 text-white rounded text-[9px] font-bold">NEW</span>
                                            <span className="text-gray-600">Not in your campaigns yet</span>
                                        </div>
                                        <div className="flex items-center gap-1.5">
                                            <span className="inline-block px-1.5 py-0.5 bg-orange-600 text-white rounded text-[9px] font-bold">✓ ACTIVE</span>
                                            <span className="text-gray-600">Active &amp; performing</span>
                                        </div>
                                        <div className="flex items-center gap-1.5">
                                            <span className="inline-block px-1.5 py-0.5 bg-yellow-600 text-white rounded text-[9px] font-bold">⚠️ MIXED</span>
                                            <span className="text-gray-600">Some active, some paused</span>
                                        </div>
                                        <div className="flex items-center gap-1.5">
                                            <span className="inline-block px-1.5 py-0.5 bg-gray-500 text-white rounded text-[9px] font-bold">⚠️ PAUSED</span>
                                            <span className="text-gray-600">All instances paused</span>
                                        </div>
                                    </div>
                                    <div className="mt-2 text-[10px] text-gray-600 italic">
                                        💡 Hover over status badges or click ▶ to see which campaigns contain each keyword
                                    </div>
                                    <div className="mt-2 pt-2 border-t border-gray-300 text-[10px] text-gray-700">
                                        <strong>Important:</strong> A keyword is only <span className="text-orange-600 font-semibold">ACTIVE</span> if the keyword itself, its campaign, AND its ad group are all enabled. If any component is paused, the status shows <span className="text-gray-600 font-semibold">PAUSED</span> with the reason (keyword paused / campaign paused / ad group paused).
                                    </div>
                                </div>

                                {/* Tabs */}
                                <div className="flex gap-2 mb-4">
                                    <button
                                        onClick={() => {
                                            setReferenceTab('keywords');
                                            setStatusFilter('all');
                                            setStatusSearch('');
                                            setMatchTypeHas({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
                                            setMatchTypeMissing({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
                                        }}
                                        className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition ${
                                            referenceTab === 'keywords'
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        Keywords
                                    </button>
                                    <button
                                        onClick={() => {
                                            setReferenceTab('products');
                                            setStatusFilter('all');
                                            setStatusSearch('');
                                            setMatchTypeHas({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
                                            setMatchTypeMissing({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
                                        }}
                                        className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition ${
                                            referenceTab === 'products'
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        Products/ASINs
                                    </button>
                                </div>

                                {/* Content */}
                                {referenceTab === 'keywords' ? (
                                    <div>
                                        {/* Table Mode - Editable table */}
                                        <>
                                            <div className="mb-2 flex items-center justify-between">
                                                <label className="text-sm font-medium text-gray-700">
                                                    Build Your Keyword Table
                                                </label>
                                                    <div className="flex gap-1">
                                                        <button
                                                            onClick={() => {
                                                                const pasteText = prompt('Paste your keywords here (one per line, or tab-separated for multiple columns):');
                                                                if (!pasteText) return;
                                                                
                                                                const lines = pasteText.split('\n').filter(l => l.trim());
                                                                if (lines.length === 0) return;
                                                                
                                                                const hasMultipleCols = lines[0].includes('\t');
                                                                
                                                                if (hasMultipleCols) {
                                                                    // Multi-column paste
                                                                    const rows = lines.map(line => line.split('\t'));
                                                                    const firstRow = rows[0];
                                                                    
                                                                    // Check if first row is header
                                                                    const isHeaderRow = firstRow.some(cell => 
                                                                        cell && /^[A-Za-z\s]+$/.test(cell) && cell.length > 0
                                                                    );
                                                                    
                                                                    if (isHeaderRow) {
                                                                        // Use first row as headers
                                                                        setTableColumns(firstRow);
                                                                        const dataRows = rows.slice(1);
                                                                        setKeywordTableData(dataRows.map(row => 
                                                                            Object.fromEntries(firstRow.map((h, i) => [h, row[i] || '']))
                                                                        ));
                                                                    } else {
                                                                        // No header, auto-generate column names
                                                                        const numCols = Math.max(...rows.map(r => r.length));
                                                                        const neededCols = numCols - tableColumns.length;
                                                                        
                                                                        if (neededCols > 0) {
                                                                            const newCols = [...tableColumns];
                                                                            for (let i = 0; i < neededCols; i++) {
                                                                                newCols.push(`Column ${tableColumns.length + i + 1}`);
                                                                            }
                                                                            setTableColumns(newCols);
                                                                        }
                                                                        
                                                                        const cols = tableColumns.length > numCols ? tableColumns : [...tableColumns, ...Array(neededCols).fill('').map((_, i) => `Column ${tableColumns.length + i + 1}`)];
                                                                        
                                                                        const newRows = rows.map(row => 
                                                                            Object.fromEntries(cols.map((col, i) => [col, row[i] || '']))
                                                                        );
                                                                        
                                                                        setKeywordTableData([...keywordTableData, ...newRows]);
                                                                    }
                                                                } else {
                                                                    // Single column paste
                                                                    const newRows = lines.map(line => ({
                                                                        ...Object.fromEntries(tableColumns.map(col => [col, ''])),
                                                                        [tableColumns[0]]: line.trim()
                                                                    }));
                                                                    setKeywordTableData([...keywordTableData, ...newRows]);
                                                                }
                                                            }}
                                                            className="px-2 py-1 text-xs bg-orange-600 text-white rounded hover:bg-orange-700 font-medium"
                                                            title="Quick paste multiple keywords"
                                                        >
                                                            ⚡ Quick Paste
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                const newColName = prompt('Enter column name:');
                                                                if (newColName && !tableColumns.includes(newColName)) {
                                                                    setTableColumns([...tableColumns, newColName]);
                                                                    // Add empty values for new column
                                                                    setKeywordTableData(keywordTableData.map(row => ({
                                                                        ...row,
                                                                        [newColName]: ''
                                                                    })));
                                                                }
                                                            }}
                                                            className="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700"
                                                        >
                                                            + Column
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                setKeywordTableData([...keywordTableData, Object.fromEntries(tableColumns.map(col => [col, '']))]);
                                                            }}
                                                            className="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                                                        >
                                                            + Row
                                                        </button>
                                                        <button
                                                            onClick={async () => {
                                                                if (confirm('Clear all table data? This will also clear any saved data.')) {
                                                                    setKeywordTableData([{ Keyword: '' }]);
                                                                    setTableColumns(['Keyword']);
                                                                    await clearTargetCheckerData();
                                                                }
                                                            }}
                                                            className="px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700"
                                                        >
                                                            🗑️ Clear
                                                        </button>
                                                    </div>
                                                </div>

                                                {showTableModeTip && (
                                                    <div className="mb-2 text-xs text-gray-600 bg-gray-50 p-2 rounded border border-gray-200 relative">
                                                        <button
                                                            onClick={() => setShowTableModeTip(false)}
                                                            className="absolute top-1 right-1 text-gray-500 hover:text-gray-800 font-bold text-base leading-none"
                                                            title="Close tip"
                                                        >
                                                            ×
                                                        </button>
                                                        💡 <strong>Tip:</strong> Click any cell and paste (Ctrl+V / Cmd+V) keywords. Each line becomes a new row. Or use <strong>Quick Paste</strong> button to paste with auto-detected column headers!
                                                    </div>
                                                )}

                                                <div className="border rounded-lg overflow-auto" style={{ maxHeight: '400px' }}>
                                                    <table className="w-full text-xs">
                                                        <thead className="bg-gray-100 sticky top-0">
                                                            <tr>
                                                                <th className="px-2 py-1 text-left w-8">#</th>
                                                                {tableColumns.map((col, colIdx) => (
                                                                    <th key={colIdx} className="px-2 py-1 text-left">
                                                                        <div className="flex items-center gap-1">
                                                                            {colIdx === 0 ? (
                                                                                <span className="font-semibold">{col}</span>
                                                                            ) : (
                                                                                <input
                                                                                    type="text"
                                                                                    value={col}
                                                                                    onChange={(e) => {
                                                                                        const newCols = [...tableColumns];
                                                                                        const oldName = newCols[colIdx];
                                                                                        newCols[colIdx] = e.target.value;
                                                                                        setTableColumns(newCols);
                                                                                        
                                                                                        // Update data keys
                                                                                        setKeywordTableData(keywordTableData.map(row => {
                                                                                            const newRow = { ...row };
                                                                                            newRow[e.target.value] = row[oldName];
                                                                                            delete newRow[oldName];
                                                                                            return newRow;
                                                                                        }));
                                                                                    }}
                                                                                    className="w-full px-1 py-0.5 border border-gray-300 rounded text-xs font-semibold"
                                                                                    placeholder="Column name"
                                                                                />
                                                                            )}
                                                                            {colIdx > 0 && (
                                                                                <button
                                                                                    onClick={() => {
                                                                                        const newCols = tableColumns.filter((_, i) => i !== colIdx);
                                                                                        setTableColumns(newCols);
                                                                                        setKeywordTableData(keywordTableData.map(row => {
                                                                                            const newRow = { ...row };
                                                                                            delete newRow[col];
                                                                                            return newRow;
                                                                                        }));
                                                                                    }}
                                                                                    className="text-red-600 hover:text-red-800"
                                                                                    title="Remove column"
                                                                                >
                                                                                    ×
                                                                                </button>
                                                                            )}
                                                                        </div>
                                                                    </th>
                                                                ))}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {keywordTableData.map((row, rowIdx) => (
                                                                <tr key={rowIdx} className="border-b hover:bg-gray-50">
                                                                    <td className="px-2 py-1 text-gray-500">
                                                                        <div className="flex items-center gap-1">
                                                                            {rowIdx + 1}
                                                                            <button
                                                                                onClick={() => {
                                                                                    setKeywordTableData(keywordTableData.filter((_, i) => i !== rowIdx));
                                                                                }}
                                                                                className="text-red-600 hover:text-red-800 text-xs"
                                                                                title="Delete row"
                                                                            >
                                                                                🗑️
                                                                            </button>
                                                                        </div>
                                                                    </td>
                                                                    {tableColumns.map((col, colIdx) => (
                                                                        <td key={colIdx} className="px-2 py-1">
                                                                            <input
                                                                                type="text"
                                                                                value={row[col] || ''}
                                                                                onChange={(e) => {
                                                                                    const newData = [...keywordTableData];
                                                                                    newData[rowIdx][col] = e.target.value;
                                                                                    setKeywordTableData(newData);
                                                                                }}
                                                                                onPaste={(e) => {
                                                                                    e.preventDefault();
                                                                                    const pastedText = e.clipboardData.getData('text');
                                                                                    
                                                                                    // Split by newlines to get rows
                                                                                    const pastedRows = pastedText.split('\n').filter(line => line.trim());
                                                                                    
                                                                                    if (pastedRows.length === 0) return;
                                                                                    
                                                                                    // Check if pasted data has tabs (multiple columns)
                                                                                    const hasMultipleCols = pastedRows[0].includes('\t');
                                                                                    
                                                                                    const newData = [...keywordTableData];
                                                                                    
                                                                                    pastedRows.forEach((pastedRow, pasteRowIdx) => {
                                                                                        const targetRowIdx = rowIdx + pasteRowIdx;
                                                                                        
                                                                                        // Create new row if needed
                                                                                        if (targetRowIdx >= newData.length) {
                                                                                            newData.push(Object.fromEntries(tableColumns.map(c => [c, ''])));
                                                                                        }
                                                                                        
                                                                                        if (hasMultipleCols) {
                                                                                            // Paste across multiple columns
                                                                                            const cells = pastedRow.split('\t');
                                                                                            cells.forEach((cell, cellIdx) => {
                                                                                                const targetColIdx = colIdx + cellIdx;
                                                                                                if (targetColIdx < tableColumns.length) {
                                                                                                    newData[targetRowIdx][tableColumns[targetColIdx]] = cell;
                                                                                                }
                                                                                            });
                                                                                        } else {
                                                                                            // Single column paste
                                                                                            newData[targetRowIdx][col] = pastedRow.trim();
                                                                                        }
                                                                                    });
                                                                                    
                                                                                    setKeywordTableData(newData);
                                                                                }}
                                                                                className="w-full px-1 py-0.5 border border-gray-200 rounded text-xs focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                                                                placeholder={col}
                                                                            />
                                                                        </td>
                                                                    ))}
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>

                                                <div className="mt-2 text-xs text-gray-600">
                                                    {keywordTableData.length} row{keywordTableData.length !== 1 ? 's' : ''} × {tableColumns.length} column{tableColumns.length !== 1 ? 's' : ''}
                                                </div>
                                            </>
                                        
                                        {/* Keyword Status List */}
                                        {((useTableMode && keywordTableData.length > 0) || (!useTableMode && referenceKeywords.trim())) && (() => {
                                            const allStatus = getKeywordStatus();
                                            const existingCount = allStatus.filter(s => s.exists).length;
                                            const newCount = allStatus.filter(s => !s.exists).length;
                                            
                                            // Apply filters
                                            let filteredStatus = allStatus;
                                            
                                            // Apply metadata column filters
                                            if (Object.keys(metadataFilters).length > 0 && allStatus[0]?.hasMetadata) {
                                                filteredStatus = filteredStatus.filter(item => {
                                                    return Object.entries(metadataFilters).every(([column, values]) => {
                                                        const itemValue = item.metadata?.[column] || '';
                                                        return values.has(String(itemValue));
                                                    });
                                                });
                                            }
                                            
                                            // Apply match type filters
                                            const hasMatchTypeHasFilters = Object.values(matchTypeHas).some(v => v);
                                            const hasMatchTypeMissingFilters = Object.values(matchTypeMissing).some(v => v);
                                            
                                            if (hasMatchTypeHasFilters || hasMatchTypeMissingFilters) {
                                                filteredStatus = filteredStatus.filter(s => {
                                                    const keywordMatchTypes = (s.matchTypes || []).map(mt => mt.toLowerCase());
                                                    
                                                    // Check "Must have at least one of these" filters
                                                    if (hasMatchTypeHasFilters) {
                                                        const hasMatch = (
                                                            (matchTypeHas.broad && keywordMatchTypes.includes('broad')) ||
                                                            (matchTypeHas.phrase && keywordMatchTypes.includes('phrase')) ||
                                                            (matchTypeHas.exact && keywordMatchTypes.includes('exact')) ||
                                                            (matchTypeHas.negativeExact && keywordMatchTypes.includes('negative exact')) ||
                                                            (matchTypeHas.negativePhrase && keywordMatchTypes.includes('negative phrase'))
                                                        );
                                                        if (!hasMatch) return false;
                                                    }
                                                    
                                                    // Check "Must NOT have any of these" filters
                                                    if (hasMatchTypeMissingFilters) {
                                                        const hasForbidden = (
                                                            (matchTypeMissing.broad && keywordMatchTypes.includes('broad')) ||
                                                            (matchTypeMissing.phrase && keywordMatchTypes.includes('phrase')) ||
                                                            (matchTypeMissing.exact && keywordMatchTypes.includes('exact')) ||
                                                            (matchTypeMissing.negativeExact && keywordMatchTypes.includes('negative exact')) ||
                                                            (matchTypeMissing.negativePhrase && keywordMatchTypes.includes('negative phrase'))
                                                        );
                                                        if (hasForbidden) return false;
                                                    }
                                                    
                                                    return true;
                                                });
                                            } else {
                                                // If no match type filters, apply the old Exists/New filter
                                                if (statusFilter === 'exists') {
                                                    filteredStatus = allStatus.filter(s => s.exists);
                                                } else if (statusFilter === 'new') {
                                                    filteredStatus = allStatus.filter(s => !s.exists);
                                                }
                                            }
                                            
                                            // Apply search
                                            if (statusSearch) {
                                                filteredStatus = filteredStatus.filter(s => {
                                                    // Search in keyword
                                                    if (s.keyword.toLowerCase().includes(statusSearch.toLowerCase())) {
                                                        return true;
                                                    }
                                                    // Search in metadata if available
                                                    if (s.metadata) {
                                                        return Object.values(s.metadata).some(value => 
                                                            String(value).toLowerCase().includes(statusSearch.toLowerCase())
                                                        );
                                                    }
                                                    return false;
                                                });
                                            }
                                            
                                            // Apply metadata sorting
                                            if (metadataSort.column && metadataSort.direction) {
                                                filteredStatus.sort((a, b) => {
                                                    let aVal = '';
                                                    let bVal = '';
                                                    
                                                    if (metadataSort.column === 'keyword') {
                                                        aVal = a.keyword;
                                                        bVal = b.keyword;
                                                    } else if (metadataSort.column === 'status') {
                                                        aVal = a.exists ? '1' : '0';
                                                        bVal = b.exists ? '1' : '0';
                                                    } else {
                                                        aVal = a.metadata?.[metadataSort.column] || '';
                                                        bVal = b.metadata?.[metadataSort.column] || '';
                                                    }
                                                    
                                                    // Try numeric comparison first
                                                    const aNum = parseFloat(aVal);
                                                    const bNum = parseFloat(bVal);
                                                    if (!isNaN(aNum) && !isNaN(bNum)) {
                                                        return metadataSort.direction === 'asc' ? aNum - bNum : bNum - aNum;
                                                    }
                                                    
                                                    // String comparison
                                                    const comparison = String(aVal).localeCompare(String(bVal));
                                                    return metadataSort.direction === 'asc' ? comparison : -comparison;
                                                });
                                            }
                                            
                                            return (
                                            <div className="mt-4">
                                                <h4 className="text-sm font-semibold text-gray-900 mb-2">Status:</h4>
                                                
                                                {/* Summary Stats */}
                                                <div className="grid grid-cols-3 gap-2 mb-3">
                                                    <div className="bg-gray-100 p-2 rounded text-center">
                                                        <div className="text-lg font-bold text-gray-900">{allStatus.length}</div>
                                                        <div className="text-[10px] text-gray-600">Total</div>
                                                    </div>
                                                    <div className="bg-orange-100 p-2 rounded text-center">
                                                        <div className="text-lg font-bold text-orange-700">{existingCount}</div>
                                                        <div className="text-[10px] text-orange-600">Exists</div>
                                                    </div>
                                                    <div className="bg-green-100 p-2 rounded text-center">
                                                        <div className="text-lg font-bold text-green-700">{newCount}</div>
                                                        <div className="text-[10px] text-green-600">New</div>
                                                    </div>
                                                </div>
                                                
                                                {/* Filter Buttons */}
                                                <div className="flex gap-1 mb-2">
                                                    <button
                                                        onClick={() => setStatusFilter('all')}
                                                        className={`flex-1 px-2 py-1 text-xs rounded transition ${
                                                            statusFilter === 'all'
                                                                ? 'bg-gray-700 text-white'
                                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                        }`}
                                                    >
                                                        All ({allStatus.length})
                                                    </button>
                                                    <button
                                                        onClick={() => setStatusFilter('exists')}
                                                        className={`flex-1 px-2 py-1 text-xs rounded transition ${
                                                            statusFilter === 'exists'
                                                                ? 'bg-orange-600 text-white'
                                                                : 'bg-orange-100 text-orange-700 hover:bg-orange-200'
                                                        }`}
                                                    >
                                                        Exists ({existingCount})
                                                    </button>
                                                    <button
                                                        onClick={() => setStatusFilter('new')}
                                                        className={`flex-1 px-2 py-1 text-xs rounded transition ${
                                                            statusFilter === 'new'
                                                                ? 'bg-green-600 text-white'
                                                                : 'bg-green-100 text-green-700 hover:bg-green-200'
                                                        }`}
                                                    >
                                                        New ({newCount})
                                                    </button>
                                                </div>
                                                
                                                {/* Match Type Filters */}
                                                <div className="mb-2 p-2 bg-gray-50 rounded border border-gray-200">
                                                    <div 
                                                        className="flex items-center justify-between cursor-pointer hover:bg-gray-100 -m-2 p-2 rounded"
                                                        onClick={() => setMatchTypeFiltersExpanded(!matchTypeFiltersExpanded)}
                                                    >
                                                        <div className="text-[10px] font-semibold text-gray-700">Filter by Match Type:</div>
                                                        <span className="text-gray-500 text-xs">
                                                            {matchTypeFiltersExpanded ? '▼' : '▶'}
                                                        </span>
                                                    </div>
                                                    
                                                    {matchTypeFiltersExpanded && (
                                                        <div className="mt-2">
                                                            {/* Has at least one of these */}
                                                            <div className="mb-2">
                                                                <div className="text-[9px] font-medium text-green-700 mb-1">✓ Has at least one of:</div>
                                                                <div className="grid grid-cols-2 gap-1">
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-green-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeHas.broad}
                                                                            onChange={(e) => setMatchTypeHas({...matchTypeHas, broad: e.target.checked})}
                                                                            className="rounded text-green-600"
                                                                        />
                                                                        <span>Broad</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-green-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeHas.phrase}
                                                                            onChange={(e) => setMatchTypeHas({...matchTypeHas, phrase: e.target.checked})}
                                                                            className="rounded text-green-600"
                                                                        />
                                                                        <span>Phrase</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-green-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeHas.exact}
                                                                            onChange={(e) => setMatchTypeHas({...matchTypeHas, exact: e.target.checked})}
                                                                            className="rounded text-green-600"
                                                                        />
                                                                        <span>Exact</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-green-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeHas.negativeExact}
                                                                            onChange={(e) => setMatchTypeHas({...matchTypeHas, negativeExact: e.target.checked})}
                                                                            className="rounded text-green-600"
                                                                        />
                                                                        <span>Neg. Exact</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-green-50 p-1 rounded col-span-2">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeHas.negativePhrase}
                                                                            onChange={(e) => setMatchTypeHas({...matchTypeHas, negativePhrase: e.target.checked})}
                                                                            className="rounded text-green-600"
                                                                        />
                                                                        <span>Neg. Phrase</span>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Missing all of these */}
                                                            <div className="mb-1">
                                                                <div className="text-[9px] font-medium text-red-700 mb-1">✗ Missing (not in any of):</div>
                                                                <div className="grid grid-cols-2 gap-1">
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-red-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeMissing.broad}
                                                                            onChange={(e) => setMatchTypeMissing({...matchTypeMissing, broad: e.target.checked})}
                                                                            className="rounded text-red-600"
                                                                        />
                                                                        <span>Broad</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-red-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeMissing.phrase}
                                                                            onChange={(e) => setMatchTypeMissing({...matchTypeMissing, phrase: e.target.checked})}
                                                                            className="rounded text-red-600"
                                                                        />
                                                                        <span>Phrase</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-red-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeMissing.exact}
                                                                            onChange={(e) => setMatchTypeMissing({...matchTypeMissing, exact: e.target.checked})}
                                                                            className="rounded text-red-600"
                                                                        />
                                                                        <span>Exact</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-red-50 p-1 rounded">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeMissing.negativeExact}
                                                                            onChange={(e) => setMatchTypeMissing({...matchTypeMissing, negativeExact: e.target.checked})}
                                                                            className="rounded text-red-600"
                                                                        />
                                                                        <span>Neg. Exact</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-1 text-[10px] cursor-pointer hover:bg-red-50 p-1 rounded col-span-2">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={matchTypeMissing.negativePhrase}
                                                                            onChange={(e) => setMatchTypeMissing({...matchTypeMissing, negativePhrase: e.target.checked})}
                                                                            className="rounded text-red-600"
                                                                        />
                                                                        <span>Neg. Phrase</span>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                            
                                                            {(Object.values(matchTypeHas).some(v => v) || Object.values(matchTypeMissing).some(v => v)) && (
                                                                <button
                                                                    onClick={() => {
                                                                        setMatchTypeHas({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
                                                                        setMatchTypeMissing({ broad: false, phrase: false, exact: false, negativeExact: false, negativePhrase: false });
                                                                    }}
                                                                    className="mt-1 w-full text-[10px] px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                                                                >
                                                                    Clear Match Type Filters
                                                                </button>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                {/* Search Bar */}
                                                <input
                                                    type="text"
                                                    placeholder="Search keywords or metadata..."
                                                    value={statusSearch}
                                                    onChange={(e) => setStatusSearch(e.target.value)}
                                                    className="w-full px-3 py-1.5 text-xs border border-gray-300 rounded mb-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                />
                                                
                                                {/* Active Metadata Filters */}
                                                {Object.keys(metadataFilters).length > 0 && (
                                                    <div className="mb-2 p-2 bg-blue-50 rounded border border-blue-200">
                                                        <div className="flex items-center justify-between mb-1">
                                                            <span className="text-[10px] font-semibold text-blue-900">Active Filters:</span>
                                                            <button
                                                                onClick={() => setMetadataFilters({})}
                                                                className="text-[10px] text-red-600 hover:text-red-800 underline"
                                                            >
                                                                Clear All
                                                            </button>
                                                        </div>
                                                        <div className="flex flex-wrap gap-1">
                                                            {Object.entries(metadataFilters).map(([col, vals]) => (
                                                                <span key={col} className="inline-flex items-center gap-1 px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-[9px]">
                                                                    {col}: {vals.size} selected
                                                                    <button
                                                                        onClick={() => {
                                                                            const newFilters = {...metadataFilters};
                                                                            delete newFilters[col];
                                                                            setMetadataFilters(newFilters);
                                                                        }}
                                                                        className="hover:text-red-600"
                                                                    >
                                                                        ×
                                                                    </button>
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Results Count & Copy Actions */}
                                                <div className="flex items-center justify-between mb-2 gap-2">
                                                    <div className="text-xs text-gray-600">
                                                        Showing {filteredStatus.length} of {allStatus.length}
                                                    </div>
                                                    <div className="flex gap-1">
                                                        {filteredStatus.length > 0 && referenceKeywordSelections.size > 0 && (
                                                            <>
                                                                <button
                                                                    onClick={() => {
                                                                        const selectedItems = filteredStatus.filter((_, i) => referenceKeywordSelections.has(i));
                                                                        const keywords = selectedItems.map(s => s.keyword).join('\n');
                                                                        navigator.clipboard.writeText(keywords);
                                                                        alert(`Copied ${selectedItems.length} keywords!`);
                                                                    }}
                                                                    className="px-2 py-1 text-[10px] bg-green-600 text-white rounded hover:bg-green-700 font-medium"
                                                                >
                                                                    📋 Copy Selected KWs ({referenceKeywordSelections.size})
                                                                </button>
                                                                {filteredStatus[0]?.hasMetadata && (
                                                                    <button
                                                                        onClick={() => {
                                                                            const selectedItems = filteredStatus.filter((_, i) => referenceKeywordSelections.has(i));
                                                                            const headers = selectedItems[0].metadata ? Object.keys(selectedItems[0].metadata) : [];
                                                                            const rows = selectedItems.map(s => {
                                                                                const metadataValues = headers.map(h => s.metadata[h] || '');
                                                                                return [s.keyword, ...metadataValues].join('\t');
                                                                            });
                                                                            const content = ['Keyword', ...headers].join('\t') + '\n' + rows.join('\n');
                                                                            navigator.clipboard.writeText(content);
                                                                            alert(`Copied ${selectedItems.length} rows with all columns!`);
                                                                        }}
                                                                        className="px-2 py-1 text-[10px] bg-purple-600 text-white rounded hover:bg-purple-700 font-medium"
                                                                    >
                                                                        📊 + Metadata
                                                                    </button>
                                                                )}
                                                            </>
                                                        )}
                                                        {filteredStatus.length > 0 && (
                                                            <>
                                                                <button
                                                                    onClick={() => {
                                                                        const keywords = filteredStatus.map(s => s.keyword).join('\n');
                                                                        navigator.clipboard.writeText(keywords);
                                                                        alert(`Copied ${filteredStatus.length} keywords!`);
                                                                    }}
                                                                    className="px-2 py-1 text-[10px] bg-blue-600 text-white rounded hover:bg-blue-700 font-medium"
                                                                >
                                                                    📋 Copy All KWs ({filteredStatus.length})
                                                                </button>
                                                                {filteredStatus[0]?.hasMetadata && (
                                                                    <button
                                                                        onClick={() => {
                                                                            const headers = filteredStatus[0].metadata ? Object.keys(filteredStatus[0].metadata) : [];
                                                                            const rows = filteredStatus.map(s => {
                                                                                const metadataValues = headers.map(h => s.metadata[h] || '');
                                                                                return [s.keyword, ...metadataValues].join('\t');
                                                                            });
                                                                            const content = ['Keyword', ...headers].join('\t') + '\n' + rows.join('\n');
                                                                            navigator.clipboard.writeText(content);
                                                                            alert(`Copied ${filteredStatus.length} rows with all columns!`);
                                                                        }}
                                                                        className="px-2 py-1 text-[10px] bg-purple-600 text-white rounded hover:bg-purple-700 font-medium"
                                                                    >
                                                                        📊 + Metadata
                                                                    </button>
                                                                )}
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                                
                                                {/* List or Table View based on metadata */}
                                                <div className="border rounded-lg max-h-80 overflow-auto bg-gray-50">
                                                    {filteredStatus.length === 0 ? (
                                                        <div className="p-4 text-center text-xs text-gray-500">
                                                            No keywords match your filters
                                                        </div>
                                                    ) : filteredStatus[0]?.hasMetadata ? (
                                                        // Table view for multi-column data
                                                        <div className="overflow-x-auto">
                                                            <table className="w-full text-[10px]">
                                                                <thead className="bg-gray-100 sticky top-0 border-b">
                                                                    <tr>
                                                                        <th className="px-2 py-1 w-8">
                                                                            <input
                                                                                type="checkbox"
                                                                                checked={referenceKeywordSelections.size === filteredStatus.length && filteredStatus.length > 0}
                                                                                onChange={(e) => {
                                                                                    if (e.target.checked) {
                                                                                        setReferenceKeywordSelections(new Set(filteredStatus.map((_, i) => i)));
                                                                                    } else {
                                                                                        setReferenceKeywordSelections(new Set());
                                                                                    }
                                                                                }}
                                                                                className="rounded"
                                                                            />
                                                                        </th>
                                                                        <th className="px-2 py-1 text-left font-semibold">
                                                                            <div className="flex items-center gap-1 cursor-pointer hover:text-blue-600" onClick={() => {
                                                                                if (metadataSort.column === 'status' && metadataSort.direction === 'asc') {
                                                                                    setMetadataSort({ column: 'status', direction: 'desc' });
                                                                                } else if (metadataSort.column === 'status' && metadataSort.direction === 'desc') {
                                                                                    setMetadataSort({ column: null, direction: null });
                                                                                } else {
                                                                                    setMetadataSort({ column: 'status', direction: 'asc' });
                                                                                }
                                                                            }}>
                                                                                Status
                                                                                {metadataSort.column === 'status' && (
                                                                                    <span className="text-blue-600">{metadataSort.direction === 'asc' ? '↑' : '↓'}</span>
                                                                                )}
                                                                            </div>
                                                                        </th>
                                                                        <th className="px-2 py-1 text-left font-semibold">
                                                                            <div className="flex items-center gap-1 cursor-pointer hover:text-blue-600" onClick={() => {
                                                                                if (metadataSort.column === 'keyword' && metadataSort.direction === 'asc') {
                                                                                    setMetadataSort({ column: 'keyword', direction: 'desc' });
                                                                                } else if (metadataSort.column === 'keyword' && metadataSort.direction === 'desc') {
                                                                                    setMetadataSort({ column: null, direction: null });
                                                                                } else {
                                                                                    setMetadataSort({ column: 'keyword', direction: 'asc' });
                                                                                }
                                                                            }}>
                                                                                Keyword
                                                                                {metadataSort.column === 'keyword' && (
                                                                                    <span className="text-blue-600">{metadataSort.direction === 'asc' ? '↑' : '↓'}</span>
                                                                                )}
                                                                            </div>
                                                                        </th>
                                                                        {filteredStatus[0]?.metadata && Object.keys(filteredStatus[0].metadata).map((header, i) => (
                                                                            <th key={i} className="px-2 py-1 text-left font-semibold">
                                                                                <div className="flex items-center gap-1">
                                                                                    <span 
                                                                                        className="cursor-pointer hover:text-blue-600"
                                                                                        onClick={() => {
                                                                                            if (metadataSort.column === header && metadataSort.direction === 'asc') {
                                                                                                setMetadataSort({ column: header, direction: 'desc' });
                                                                                            } else if (metadataSort.column === header && metadataSort.direction === 'desc') {
                                                                                                setMetadataSort({ column: null, direction: null });
                                                                                            } else {
                                                                                                setMetadataSort({ column: header, direction: 'asc' });
                                                                                            }
                                                                                        }}
                                                                                    >
                                                                                        {header}
                                                                                        {metadataSort.column === header && (
                                                                                            <span className="text-blue-600 ml-1">{metadataSort.direction === 'asc' ? '↑' : '↓'}</span>
                                                                                        )}
                                                                                    </span>
                                                                                    <button
                                                                                        className={`text-gray-500 hover:text-blue-600 ${metadataFilters[header] ? 'text-blue-600' : ''}`}
                                                                                        onClick={() => {
                                                                                            // Create filter for this column
                                                                                            const uniqueValues = [...new Set(allStatus.map(s => s.metadata?.[header] || ''))].sort();
                                                                                            const currentFilters = metadataFilters[header] || new Set();
                                                                                            
                                                                                            // Simple toggle all on/off for now
                                                                                            if (currentFilters.size === 0) {
                                                                                                setMetadataFilters({
                                                                                                    ...metadataFilters,
                                                                                                    [header]: new Set(uniqueValues)
                                                                                                });
                                                                                            } else {
                                                                                                const newFilters = {...metadataFilters};
                                                                                                delete newFilters[header];
                                                                                                setMetadataFilters(newFilters);
                                                                                            }
                                                                                        }}
                                                                                        title="Click to filter this column"
                                                                                    >
                                                                                        🔍
                                                                                    </button>
                                                                                </div>
                                                                            </th>
                                                                        ))}
                                                                        <th className="px-2 py-1 text-center font-semibold">Match Types</th>
                                                                        <th className="px-2 py-1 text-center font-semibold w-12">📋</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {filteredStatus.map((item, i) => (
                                                                        <React.Fragment key={i}>
                                                                        <tr 
                                                                            className={`border-b last:border-b-0 hover:bg-gray-100 ${
                                                                                item.isPaused ? 'bg-gray-100' : 
                                                                                item.hasEnabledAndPaused ? 'bg-yellow-50' :
                                                                                item.exists ? 'bg-orange-50' : 'bg-white'
                                                                            }`}
                                                                        >
                                                                            <td className="px-2 py-1.5">
                                                                                <input
                                                                                    type="checkbox"
                                                                                    checked={referenceKeywordSelections.has(i)}
                                                                                    onChange={(e) => {
                                                                                        const newSelections = new Set(referenceKeywordSelections);
                                                                                        if (e.target.checked) {
                                                                                            newSelections.add(i);
                                                                                        } else {
                                                                                            newSelections.delete(i);
                                                                                        }
                                                                                        setReferenceKeywordSelections(newSelections);
                                                                                    }}
                                                                                    className="rounded"
                                                                                />
                                                                            </td>
                                                                            <td className="px-2 py-1.5 text-center">
                                                                                <div className="flex items-center justify-center gap-1">
                                                                                {item.isPaused ? (
                                                                                    <span 
                                                                                        className="inline-block px-1.5 py-0.5 bg-gray-500 text-white rounded text-[9px] font-bold cursor-help" 
                                                                                        title={`⚠️ ALL PAUSED - Not performing!\n\nPaused locations:\n${item.locations.filter(l => l.state === 'paused').map(l => `• ${l.campaign} / ${l.adGroup} [${l.matchType}]${l.pauseReason ? ' - ' + l.pauseReason : ''}`).join('\n')}`}
                                                                                    >
                                                                                        ⚠️ PAUSED
                                                                                    </span>
                                                                                ) : item.hasEnabledAndPaused ? (
                                                                                    <span 
                                                                                        className="inline-block px-1.5 py-0.5 bg-yellow-600 text-white rounded text-[9px] font-bold cursor-help" 
                                                                                        title={`⚠️ MIXED STATE - Some active, some paused\n\nACTIVE locations:\n${item.locations.filter(l => l.state === 'enabled').map(l => `• ${l.campaign} / ${l.adGroup} [${l.matchType}]`).join('\n')}\n\nPAUSED locations:\n${item.locations.filter(l => l.state === 'paused').map(l => `• ${l.campaign} / ${l.adGroup} [${l.matchType}]${l.pauseReason ? ' - ' + l.pauseReason : ''}`).join('\n')}`}
                                                                                    >
                                                                                        ⚠️ MIXED
                                                                                    </span>
                                                                                ) : item.exists ? (
                                                                                    <span 
                                                                                        className="inline-block px-1.5 py-0.5 bg-orange-600 text-white rounded text-[9px] font-bold cursor-help" 
                                                                                        title={`✓ ACTIVE - Performing well!\n\nActive in:\n${item.locations.filter(l => l.state === 'enabled').map(l => `• ${l.campaign} / ${l.adGroup} [${l.matchType}]`).join('\n')}`}
                                                                                    >
                                                                                        ✓ ACTIVE
                                                                                    </span>
                                                                                ) : (
                                                                                    <span className="inline-block px-1.5 py-0.5 bg-green-600 text-white rounded text-[9px] font-bold">
                                                                                        NEW
                                                                                    </span>
                                                                                )}
                                                                                {item.exists && item.locations && item.locations.length > 0 && (
                                                                                    <button
                                                                                        onClick={() => {
                                                                                            const newExpanded = new Set(expandedKeywordRows);
                                                                                            if (newExpanded.has(i)) {
                                                                                                newExpanded.delete(i);
                                                                                            } else {
                                                                                                newExpanded.add(i);
                                                                                            }
                                                                                            setExpandedKeywordRows(newExpanded);
                                                                                        }}
                                                                                        className="text-xs text-blue-600 hover:text-blue-800 p-0.5"
                                                                                        title="Show/hide campaign details"
                                                                                    >
                                                                                        {expandedKeywordRows.has(i) ? '▼' : '▶'}
                                                                                    </button>
                                                                                )}
                                                                                </div>
                                                                            </td>
                                                                            <td className="px-2 py-1.5 font-mono" style={{ minWidth: '200px', maxWidth: '300px' }}>
                                                                                <div className={`break-words ${item.exists ? 'text-gray-500' : 'text-gray-900'}`} title={item.keyword}>
                                                                                    {item.keyword}
                                                                                </div>
                                                                            </td>
                                                                            {item.metadata && Object.values(item.metadata).map((value, j) => (
                                                                                <td key={j} className="px-2 py-1.5 text-gray-700">
                                                                                    <div className="max-w-[100px] truncate" title={value}>
                                                                                        {value}
                                                                                    </div>
                                                                                </td>
                                                                            ))}
                                                                            <td className="px-2 py-1.5 text-center">
                                                                                {item.matchTypes && item.matchTypes.length > 0 ? (
                                                                                    <span className="inline-block px-1.5 py-0.5 bg-blue-100 text-blue-800 rounded text-[9px]" title={item.matchTypes.join(', ')}>
                                                                                        {item.matchTypes.length} type{item.matchTypes.length > 1 ? 's' : ''}
                                                                                    </span>
                                                                                ) : (
                                                                                    <span className="text-gray-400">-</span>
                                                                                )}
                                                                            </td>
                                                                            <td className="px-2 py-1.5 text-center">
                                                                                <button
                                                                                    onClick={() => {
                                                                                        navigator.clipboard.writeText(item.keyword);
                                                                                    }}
                                                                                    className="p-1 hover:bg-gray-200 rounded text-gray-600 hover:text-gray-900"
                                                                                    title="Copy keyword"
                                                                                >
                                                                                    📋
                                                                                </button>
                                                                            </td>
                                                                        </tr>
                                                                        {expandedKeywordRows.has(i) && item.exists && item.locations && item.locations.length > 0 && (
                                                                            <tr className="bg-blue-50 border-b">
                                                                                <td colSpan={item.hasMetadata ? Object.keys(item.metadata).length + 5 : 5} className="px-4 py-3">
                                                                                    <div className="text-xs">
                                                                                        <div className="font-semibold text-gray-700 mb-2">
                                                                                            Found in {item.locations.length} location{item.locations.length > 1 ? 's' : ''}:
                                                                                        </div>
                                                                                        <div className="space-y-1.5">
                                                                                            {item.locations.filter(l => l.state === 'enabled').length > 0 && (
                                                                                                <div>
                                                                                                    <div className="font-semibold text-green-700 mb-1">✓ Active ({item.locations.filter(l => l.state === 'enabled').length}):</div>
                                                                                                    {item.locations.filter(l => l.state === 'enabled').map((loc, idx) => (
                                                                                                        <div key={idx} className="ml-4 text-gray-700">
                                                                                                            • {loc.campaign} / {loc.adGroup} <span className="text-blue-600 font-medium">[{loc.matchType}]</span>
                                                                                                        </div>
                                                                                                    ))}
                                                                                                </div>
                                                                                            )}
                                                                                            {item.locations.filter(l => l.state === 'paused').length > 0 && (
                                                                                                <div>
                                                                                                    <div className="font-semibold text-red-700 mb-1">⚠️ Paused ({item.locations.filter(l => l.state === 'paused').length}):</div>
                                                                                                    {item.locations.filter(l => l.state === 'paused').map((loc, idx) => (
                                                                                                        <div key={idx} className="ml-4 text-gray-600">
                                                                                                            • {loc.campaign} / {loc.adGroup} <span className="text-blue-600 font-medium">[{loc.matchType}]</span>
                                                                                                            {loc.pauseReason && <span className="text-red-600 font-medium ml-1">({loc.pauseReason})</span>}
                                                                                                        </div>
                                                                                                    ))}
                                                                                                </div>
                                                                                            )}
                                                                                        </div>
                                                                                    </div>
                                                                                </td>
                                                                            </tr>
                                                                        )}
                                                                    </React.Fragment>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    ) : (
                                                        // Simple list view for single-column data
                                                        filteredStatus.map((item, i) => (
                                                            <div 
                                                                key={i} 
                                                                className={`px-3 py-2 text-xs border-b last:border-b-0 ${
                                                                    item.isPaused ? 'bg-gray-100' : 
                                                                    item.hasEnabledAndPaused ? 'bg-yellow-50' :
                                                                    item.exists ? 'bg-orange-50' : 'bg-white'
                                                                }`}
                                                            >
                                                                <div className="flex items-center justify-between gap-2">
                                                                    <span 
                                                                        className={`font-mono flex-1 select-text ${item.exists ? 'line-through text-gray-500' : 'text-gray-900'}`}
                                                                        style={{ userSelect: 'text' }}
                                                                    >
                                                                        {item.keyword}
                                                                    </span>
                                                                    <div className="flex items-center gap-1">
                                                                        <button
                                                                            onClick={() => {
                                                                                navigator.clipboard.writeText(item.keyword);
                                                                            }}
                                                                            className="p-1 hover:bg-gray-200 rounded text-gray-600 hover:text-gray-900"
                                                                            title="Copy this keyword"
                                                                        >
                                                                            📋
                                                                        </button>
                                                                        {item.isPaused ? (
                                                                            <span className="text-gray-600 font-semibold text-[10px]">⚠️ PAUSED</span>
                                                                        ) : item.hasEnabledAndPaused ? (
                                                                            <span className="text-yellow-600 font-semibold text-[10px]">⚠️ MIXED</span>
                                                                        ) : item.exists ? (
                                                                            <span className="text-orange-600 font-semibold text-[10px]">✓ ACTIVE</span>
                                                                        ) : (
                                                                            <span className="text-green-600 font-semibold text-[10px]">○ NEW</span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                {item.exists && (
                                                                    <div className="mt-1 text-[10px] text-gray-600">
                                                                        {item.isPaused ? (
                                                                            <span className="text-red-700 font-medium">⚠️ All instances paused - </span>
                                                                        ) : item.hasEnabledAndPaused ? (
                                                                            <span className="text-yellow-700 font-medium">⚠️ {item.enabledCount} active, {item.pausedCount} paused - </span>
                                                                        ) : (
                                                                            <span className="text-green-700 font-medium">✓ All active - </span>
                                                                        )}
                                                                        Found in {item.count} place{item.count > 1 ? 's' : ''}
                                                                        {item.matchTypes && item.matchTypes.length > 0 && (
                                                                            <span className="ml-1">
                                                                                ({item.matchTypes.join(', ')})
                                                                            </span>
                                                                        )}
                                                                        {item.locations && item.locations.length > 0 && (
                                                                            <button
                                                                                onClick={() => {
                                                                                    const newExpanded = new Set(expandedKeywordRows);
                                                                                    if (newExpanded.has(i)) {
                                                                                        newExpanded.delete(i);
                                                                                    } else {
                                                                                        newExpanded.add(i);
                                                                                    }
                                                                                    setExpandedKeywordRows(newExpanded);
                                                                                }}
                                                                                className="ml-2 text-blue-600 hover:text-blue-800"
                                                                            >
                                                                                {expandedKeywordRows.has(i) ? '▼ Hide details' : '▶ Show campaigns'}
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                )}
                                                                {expandedKeywordRows.has(i) && item.exists && item.locations && item.locations.length > 0 && (
                                                                    <div className="mt-2 pl-4 pr-2 py-2 bg-white rounded border border-gray-200 text-[10px]">
                                                                        {item.locations.filter(l => l.state === 'enabled').length > 0 && (
                                                                            <div className="mb-2">
                                                                                <div className="font-semibold text-green-700 mb-1">✓ Active ({item.locations.filter(l => l.state === 'enabled').length}):</div>
                                                                                {item.locations.filter(l => l.state === 'enabled').map((loc, idx) => (
                                                                                    <div key={idx} className="ml-2 text-gray-700">
                                                                                        • {loc.campaign} / {loc.adGroup} <span className="text-blue-600 font-medium">[{loc.matchType}]</span>
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        )}
                                                                        {item.locations.filter(l => l.state === 'paused').length > 0 && (
                                                                            <div>
                                                                                <div className="font-semibold text-red-700 mb-1">⚠️ Paused ({item.locations.filter(l => l.state === 'paused').length}):</div>
                                                                                {item.locations.filter(l => l.state === 'paused').map((loc, idx) => (
                                                                                    <div key={idx} className="ml-2 text-gray-600">
                                                                                        • {loc.campaign} / {loc.adGroup} <span className="text-blue-600 font-medium">[{loc.matchType}]</span>
                                                                                        {loc.pauseReason && <span className="text-red-600 font-medium ml-1">({loc.pauseReason})</span>}
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))
                                                    )}
                                                </div>
                                            </div>
                                            );
                                        })()}
                                    </div>
                                ) : (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Target Products/ASINs (one per line)
                                        </label>
                                        <textarea
                                            value={referenceProducts}
                                            onChange={(e) => setReferenceProducts(e.target.value)}
                                            placeholder="B07XYZ1234&#10;B08ABC5678&#10;MY-SKU-001&#10;&#10;Paste ASINs or SKUs..."
                                            className="w-full h-48 px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            style={{ resize: 'vertical' }}
                                        />
                                        <div className="mt-2 flex gap-2">
                                            <button
                                                onClick={() => setReferenceProducts('')}
                                                className="flex-1 px-3 py-1.5 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                                            >
                                                Clear
                                            </button>
                                            <div className="flex-1 text-xs text-gray-600 flex items-center justify-center">
                                                {referenceProducts.split('\n').filter(p => p.trim()).length} products
                                            </div>
                                        </div>

                                        {/* Product Status List */}
                                        {referenceProducts.trim() && (() => {
                                            const allStatus = getProductStatus();
                                            const existingCount = allStatus.filter(s => s.exists).length;
                                            const newCount = allStatus.filter(s => !s.exists).length;
                                            
                                            // Apply filters
                                            let filteredStatus = allStatus;
                                            if (statusFilter === 'exists') {
                                                filteredStatus = allStatus.filter(s => s.exists);
                                            } else if (statusFilter === 'new') {
                                                filteredStatus = allStatus.filter(s => !s.exists);
                                            }
                                            
                                            // Apply search
                                            if (statusSearch) {
                                                filteredStatus = filteredStatus.filter(s => 
                                                    s.product.toLowerCase().includes(statusSearch.toLowerCase())
                                                );
                                            }
                                            
                                            return (
                                            <div className="mt-4">
                                                <h4 className="text-sm font-semibold text-gray-900 mb-2">Status:</h4>
                                                
                                                {/* Summary Stats */}
                                                <div className="grid grid-cols-3 gap-2 mb-3">
                                                    <div className="bg-gray-100 p-2 rounded text-center">
                                                        <div className="text-lg font-bold text-gray-900">{allStatus.length}</div>
                                                        <div className="text-[10px] text-gray-600">Total</div>
                                                    </div>
                                                    <div className="bg-orange-100 p-2 rounded text-center">
                                                        <div className="text-lg font-bold text-orange-700">{existingCount}</div>
                                                        <div className="text-[10px] text-orange-600">Exists</div>
                                                    </div>
                                                    <div className="bg-green-100 p-2 rounded text-center">
                                                        <div className="text-lg font-bold text-green-700">{newCount}</div>
                                                        <div className="text-[10px] text-green-600">New</div>
                                                    </div>
                                                </div>
                                                
                                                {/* Filter Buttons */}
                                                <div className="flex gap-1 mb-2">
                                                    <button
                                                        onClick={() => setStatusFilter('all')}
                                                        className={`flex-1 px-2 py-1 text-xs rounded transition ${
                                                            statusFilter === 'all'
                                                                ? 'bg-gray-700 text-white'
                                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                        }`}
                                                    >
                                                        All ({allStatus.length})
                                                    </button>
                                                    <button
                                                        onClick={() => setStatusFilter('exists')}
                                                        className={`flex-1 px-2 py-1 text-xs rounded transition ${
                                                            statusFilter === 'exists'
                                                                ? 'bg-orange-600 text-white'
                                                                : 'bg-orange-100 text-orange-700 hover:bg-orange-200'
                                                        }`}
                                                    >
                                                        Exists ({existingCount})
                                                    </button>
                                                    <button
                                                        onClick={() => setStatusFilter('new')}
                                                        className={`flex-1 px-2 py-1 text-xs rounded transition ${
                                                            statusFilter === 'new'
                                                                ? 'bg-green-600 text-white'
                                                                : 'bg-green-100 text-green-700 hover:bg-green-200'
                                                        }`}
                                                    >
                                                        New ({newCount})
                                                    </button>
                                                </div>
                                                
                                                {/* Search Bar */}
                                                <input
                                                    type="text"
                                                    placeholder="Search products/ASINs..."
                                                    value={statusSearch}
                                                    onChange={(e) => setStatusSearch(e.target.value)}
                                                    className="w-full px-3 py-1.5 text-xs border border-gray-300 rounded mb-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                />
                                                
                                                {/* Results Count & Copy Actions */}
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="text-xs text-gray-600">
                                                        Showing {filteredStatus.length} of {allStatus.length}
                                                    </div>
                                                    {filteredStatus.length > 0 && (
                                                        <button
                                                            onClick={() => {
                                                                const products = filteredStatus.map(s => s.product).join('\n');
                                                                navigator.clipboard.writeText(products);
                                                                alert(`Copied ${filteredStatus.length} products to clipboard!`);
                                                            }}
                                                            className="px-2 py-1 text-[10px] bg-blue-600 text-white rounded hover:bg-blue-700 font-medium"
                                                        >
                                                            📋 Copy All ({filteredStatus.length})
                                                        </button>
                                                    )}
                                                </div>
                                                
                                                {/* List */}
                                                <div className="border rounded-lg max-h-80 overflow-y-auto bg-gray-50">
                                                    {filteredStatus.length === 0 ? (
                                                        <div className="p-4 text-center text-xs text-gray-500">
                                                            No products match your filters
                                                        </div>
                                                    ) : (
                                                        filteredStatus.map((item, i) => (
                                                            <div 
                                                                key={i} 
                                                                className={`px-3 py-2 text-xs border-b last:border-b-0 ${
                                                                    item.isPaused ? 'bg-gray-100' : 
                                                                    item.hasEnabledAndPaused ? 'bg-yellow-50' :
                                                                    item.exists ? 'bg-orange-50' : 'bg-white'
                                                                }`}
                                                            >
                                                                <div className="flex items-center justify-between gap-2">
                                                                    <span 
                                                                        className={`font-mono flex-1 select-text ${item.exists ? 'line-through text-gray-500' : 'text-gray-900'}`}
                                                                        style={{ userSelect: 'text' }}
                                                                    >
                                                                        {item.product}
                                                                    </span>
                                                                    <div className="flex items-center gap-1">
                                                                        <button
                                                                            onClick={() => {
                                                                                navigator.clipboard.writeText(item.product);
                                                                            }}
                                                                            className="p-1 hover:bg-gray-200 rounded text-gray-600 hover:text-gray-900"
                                                                            title="Copy this product"
                                                                        >
                                                                            📋
                                                                        </button>
                                                                        {item.isPaused ? (
                                                                            <span className="text-gray-600 font-semibold text-[10px]">⏸ PAUSED</span>
                                                                        ) : item.hasEnabledAndPaused ? (
                                                                            <span className="text-yellow-600 font-semibold text-[10px]">⚠️ MIXED</span>
                                                                        ) : item.exists ? (
                                                                            <span className="text-orange-600 font-semibold text-[10px]">✓ ACTIVE</span>
                                                                        ) : (
                                                                            <span className="text-green-600 font-semibold text-[10px]">○ NEW</span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                {item.exists && (
                                                                    <div className="mt-1 text-[10px] text-gray-600">
                                                                        {item.isPaused ? (
                                                                            <span>All instances paused - </span>
                                                                        ) : item.hasEnabledAndPaused ? (
                                                                            <span>{item.enabledCount} active, {item.pausedCount} paused - </span>
                                                                        ) : null}
                                                                        Found in {item.count} place{item.count > 1 ? 's' : ''}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))
                                                    )}
                                                </div>
                                            </div>
                                            );
                                        })()}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Modal */}
                    {showModal && (
                        <AddModal
                            type={modalType}
                            data={data}
                            onClose={() => setShowModal(false)}
                            onAdd={addNewItems}
                        />
                    )}

                    {/* Excel-style Filter Modal */}
                    {activeFilterColumn && (
                        <FilterModal
                            column={activeFilterColumn}
                            uniqueValues={(() => {
                                const values = new Set();
                                data.forEach(row => {
                                    let value;
                                    if (activeFilterColumn === 'Portfolio Name') {
                                        value = getPortfolioName(row);
                                    } else if (activeFilterColumn === 'Campaign Name') {
                                        value = getCampaignName(row);
                                    } else if (activeFilterColumn === 'Ad Group Name') {
                                        value = getAdGroupName(row);
                                    } else {
                                        value = row[activeFilterColumn];
                                    }
                                    if (value !== undefined && value !== null) {
                                        values.add(String(value));
                                    }
                                });
                                return Array.from(values).sort();
                            })()}
                            selectedFilters={columnFilters[activeFilterColumn]}
                            onApply={(column, selectedValues) => {
                                const newFilters = { ...columnFilters };
                                if (selectedValues.size === 0) {
                                    delete newFilters[column];
                                } else {
                                    newFilters[column] = selectedValues;
                                }
                                setColumnFilters(newFilters);
                            }}
                            onClose={() => setActiveFilterColumn(null)}
                            position={filterPosition}
                            currentSort={columnSort}
                            onSort={(column, direction) => {
                                if (direction === null) {
                                    setColumnSort({ column: null, direction: null });
                                } else {
                                    setColumnSort({ column, direction });
                                }
                            }}
                        />
                    )}
                </div>
            );
        }

        function DataTable({ 
            data, 
            activeTab, 
            updateRow,
            setData,
            selectedItems, 
            toggleSelection, 
            selectAll, 
            changes, 
            originalRowMap, 
            columnWidths, 
            setColumnWidths,
            columnFilters,
            setColumnFilters,
            setActiveFilterColumn,
            setFilterPosition,
            columnSort,
            allData,
            isInReferenceList,
            showReferencePanel,
            getAdGroupKeywords,
            undoChange
        }) {
            const [resizing, setResizing] = useState(null);
            const [expandedAdGroups, setExpandedAdGroups] = useState(new Set());
            const [addKeywordForms, setAddKeywordForms] = useState({});
            const [keywordFormData, setKeywordFormData] = useState({});
            const [keywordSearchTerms, setKeywordSearchTerms] = useState({});
            const [selectedKeywords, setSelectedKeywords] = useState({});

            const toggleAdGroupExpansion = (adGroupId) => {
                const newExpanded = new Set(expandedAdGroups);
                if (newExpanded.has(adGroupId)) {
                    newExpanded.delete(adGroupId);
                } else {
                    newExpanded.add(adGroupId);
                }
                setExpandedAdGroups(newExpanded);
            };

            const toggleAddKeywordForm = (adGroupId) => {
                setAddKeywordForms(prev => ({
                    ...prev,
                    [adGroupId]: !prev[adGroupId]
                }));
                // Initialize form data for this ad group if it doesn't exist
                if (!keywordFormData[adGroupId]) {
                    setKeywordFormData(prev => ({
                        ...prev,
                        [adGroupId]: { kwText: '', kwBid: '', kwMatch: 'Exact' }
                    }));
                }
            };

            const updateKeywordFormData = (adGroupId, field, value) => {
                setKeywordFormData(prev => ({
                    ...prev,
                    [adGroupId]: {
                        ...((prev[adGroupId] || { kwText: '', kwBid: '', kwMatch: 'Exact' })),
                        [field]: value
                    }
                }));
            };

            const getKeywordFormData = (adGroupId) => {
                return keywordFormData[adGroupId] || { kwText: '', kwBid: '', kwMatch: 'Exact' };
            };

            const toggleKeywordSelection = (adGroupId, keywordId) => {
                setSelectedKeywords(prev => {
                    const adGroupSelections = prev[adGroupId] || new Set();
                    const newSelections = new Set(adGroupSelections);
                    if (newSelections.has(keywordId)) {
                        newSelections.delete(keywordId);
                    } else {
                        newSelections.add(keywordId);
                    }
                    return {
                        ...prev,
                        [adGroupId]: newSelections
                    };
                });
            };

            const toggleAllKeywords = (adGroupId, keywords) => {
                setSelectedKeywords(prev => {
                    const adGroupSelections = prev[adGroupId] || new Set();
                    const allSelected = keywords.every(kw => adGroupSelections.has(kw['Keyword ID']));
                    
                    if (allSelected) {
                        return {
                            ...prev,
                            [adGroupId]: new Set()
                        };
                    } else {
                        return {
                            ...prev,
                            [adGroupId]: new Set(keywords.map(kw => kw['Keyword ID']))
                        };
                    }
                });
            };

            const bulkUpdateKeywordState = (adGroupId, newState) => {
                const selections = selectedKeywords[adGroupId] || new Set();
                if (selections.size === 0) return;

                // Create a new data array with all selected keywords updated
                const newData = allData.map(row => {
                    // Check if this row is a selected keyword
                    if (selections.has(row['Keyword ID']) && row.Entity === 'Keyword') {
                        return {
                            ...row,
                            State: newState
                        };
                    }
                    return row;
                });

                // Update the data in one batch
                setData(newData);

                // Clear selections after action
                setSelectedKeywords(prev => ({
                    ...prev,
                    [adGroupId]: new Set()
                }));
            };

            const addKeywordsToAdGroup = (adGroupId, keywordsText, bid, matchType) => {
                const row = data.find(r => r['Ad Group ID'] === adGroupId);
                if (!row) return;

                const keywords = keywordsText.split('\n').map(k => k.trim()).filter(k => k);
                const newItems = [];

                keywords.forEach(keyword => {
                    const newKeyword = {
                        Product: 'Sponsored Products',
                        Entity: 'Keyword',
                        Operation: 'Create',
                        'Campaign ID': row['Campaign ID'],
                        'Ad Group ID': adGroupId,
                        'Portfolio ID': row['Portfolio ID'] || '',
                        'Ad ID': '',
                        'Keyword ID': `kw_${Date.now()}_${Math.random()}`,
                        'Product Targeting ID': '',
                        'Campaign Name': row['Campaign Name'] || row['Campaign Name (Informational only)'] || '',
                        'Ad Group Name': row['Ad Group Name'] || row['Ad Group Name (Informational only)'] || '',
                        'Campaign Name (Informational only)': row['Campaign Name (Informational only)'] || '',
                        'Ad Group Name (Informational only)': row['Ad Group Name (Informational only)'] || '',
                        'Portfolio Name (Informational only)': row['Portfolio Name (Informational only)'] || '',
                        'Start Date': '',
                        'End Date': '',
                        'Targeting Type': '',
                        State: 'enabled',
                        'Campaign State (Informational only)': '',
                        'Ad Group State (Informational only)': '',
                        'Daily Budget': '',
                        SKU: '',
                        'ASIN (Informational only)': '',
                        'Eligibility Status (Informational only)': '',
                        'Reason for Ineligibility (Informational only)': '',
                        'Ad Group Default Bid': '',
                        'Ad Group Default Bid (Informational only)': '',
                        Bid: bid || '',
                        'Keyword Text': keyword,
                        'Native Language Keyword': '',
                        'Native Language Locale': '',
                        'Match Type': matchType,
                        'Bidding Strategy': '',
                        Placement: '',
                        Percentage: '',
                        'Product Targeting Expression': '',
                        'Resolved Product Targeting Expression (Informational only)': '',
                        Impressions: '0',
                        Clicks: '0',
                        'Click-through Rate': '',
                        Spend: '0',
                        Sales: '0',
                        Orders: '0',
                        Units: '',
                        'Conversion Rate': '',
                        ACOS: '',
                        CPC: '',
                        ROAS: ''
                    };
                    newItems.push(newKeyword);
                });

                // Add to main data array
                const event = new CustomEvent('addKeywords', { detail: newItems });
                window.dispatchEvent(event);
                
                // Hide the form
                setAddKeywordForms(prev => ({ ...prev, [adGroupId]: false }));
            };

            const addProductTargetsToAdGroup = (adGroupId, targetsText, bid) => {
                const row = data.find(r => r['Ad Group ID'] === adGroupId);
                if (!row) return;

                const targets = targetsText.split('\n').map(t => t.trim()).filter(t => t);
                const newItems = [];

                targets.forEach(target => {
                    // Auto-format the targeting expression
                    const formattedExpression = formatProductTargetingExpression(target, 'auto');
                    
                    const newTarget = {
                        Product: 'Sponsored Products',
                        Entity: 'Product Targeting',
                        Operation: 'Create',
                        'Campaign ID': row['Campaign ID'],
                        'Ad Group ID': adGroupId,
                        'Portfolio ID': row['Portfolio ID'] || '',
                        'Ad ID': '',
                        'Keyword ID': '',
                        'Product Targeting ID': `pt_${Date.now()}_${Math.random()}`,
                        'Campaign Name': row['Campaign Name'] || row['Campaign Name (Informational only)'] || '',
                        'Ad Group Name': row['Ad Group Name'] || row['Ad Group Name (Informational only)'] || '',
                        'Campaign Name (Informational only)': row['Campaign Name (Informational only)'] || '',
                        'Ad Group Name (Informational only)': row['Ad Group Name (Informational only)'] || '',
                        'Portfolio Name (Informational only)': row['Portfolio Name (Informational only)'] || '',
                        'Start Date': '',
                        'End Date': '',
                        'Targeting Type': '',
                        State: 'enabled',
                        'Campaign State (Informational only)': '',
                        'Ad Group State (Informational only)': '',
                        'Daily Budget': '',
                        SKU: '',
                        'ASIN (Informational only)': '',
                        'Eligibility Status (Informational only)': '',
                        'Reason for Ineligibility (Informational only)': '',
                        'Ad Group Default Bid': '',
                        'Ad Group Default Bid (Informational only)': '',
                        Bid: bid || '',
                        'Keyword Text': '',
                        'Native Language Keyword': '',
                        'Native Language Locale': '',
                        'Match Type': '',
                        'Bidding Strategy': '',
                        Placement: '',
                        Percentage: '',
                        'Product Targeting Expression': formattedExpression,
                        'Resolved Product Targeting Expression (Informational only)': '',
                        Impressions: '0',
                        Clicks: '0',
                        'Click-through Rate': '',
                        Spend: '0',
                        Sales: '0',
                        Orders: '0',
                        Units: '',
                        'Conversion Rate': '',
                        ACOS: '',
                        CPC: '',
                        ROAS: ''
                    };
                    newItems.push(newTarget);
                });

                // Add to main data array
                const event = new CustomEvent('addKeywords', { detail: newItems });
                window.dispatchEvent(event);
                
                // Hide the form
                setAddKeywordForms(prev => ({ ...prev, [adGroupId + '_targets']: false }));
            };

            const isRowNew = (row) => {
                const rowId = getRowId(row);
                return !originalRowMap.has(rowId);
            };

            const isRowChanged = (row) => {
                const rowId = getRowId(row);
                const original = originalRowMap.get(rowId);
                return original && hasRowChanged(original, row);
            };

            const handleMouseDown = (e, column) => {
                setResizing({ column, startX: e.pageX, startWidth: columnWidths[column] || 150 });
            };

            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (resizing) {
                        const diff = e.pageX - resizing.startX;
                        const newWidth = Math.max(50, resizing.startWidth + diff);
                        setColumnWidths(prev => ({ ...prev, [resizing.column]: newWidth }));
                    }
                };

                const handleMouseUp = () => {
                    setResizing(null);
                };

                if (resizing) {
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                }

                return () => {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
            }, [resizing]);

            const renderCell = (row, field, index) => {
                // Handle hierarchy columns - get values from either direct or informational columns
                let displayValue;
                if (field === 'Portfolio Name') {
                    displayValue = getPortfolioName(row);
                } else if (field === 'Campaign Name') {
                    displayValue = getCampaignName(row);
                } else if (field === 'Ad Group Name') {
                    displayValue = getAdGroupName(row);
                } else {
                    displayValue = row[field] || '';
                }
                
                if (field === 'State') {
                    return (
                        <select
                            value={displayValue || 'enabled'}
                            onChange={(e) => updateRow(row, field, e.target.value)}
                            className={`w-full px-2 py-1 rounded text-xs font-medium ${
                                displayValue === 'enabled' ? 'bg-green-100 text-green-800' :
                                displayValue === 'paused' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-gray-100 text-gray-800'
                            }`}
                        >
                            <option value="enabled">Enabled</option>
                            <option value="paused">Paused</option>
                            <option value="archived">Archived</option>
                        </select>
                    );
                }

                // Campaign State column in Ad Groups tab - allows controlling campaign state
                if (field === 'Campaign State (Informational only)' && activeTab === 'adgroups' && row.Entity === 'Ad Group') {
                    // Find the parent campaign to get/update its state
                    const campaignRow = allData.find(r => r.Entity === 'Campaign' && r['Campaign ID'] === row['Campaign ID']);
                    const campaignState = campaignRow ? campaignRow.State : displayValue;
                    
                    return (
                        <select
                            value={campaignState || 'enabled'}
                            onChange={(e) => {
                                // Update the campaign entity's state
                                if (campaignRow) {
                                    updateRow(campaignRow, 'State', e.target.value);
                                }
                            }}
                            className={`w-full px-2 py-1 rounded text-xs font-medium ${
                                campaignState === 'enabled' ? 'bg-green-100 text-green-800' :
                                campaignState === 'paused' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-gray-100 text-gray-800'
                            }`}
                            title="Control parent campaign state"
                        >
                            <option value="enabled">Enabled</option>
                            <option value="paused">Paused</option>
                            <option value="archived">Archived</option>
                        </select>
                    );
                }

                // Only allow editing of actual field columns, not derived hierarchy display
                const editableFields = [
                    'Daily Budget', 'Bidding Strategy', 
                    'Targeting Type', 'Ad Group Default Bid', 'Bid', 'Keyword Text', 
                    'Match Type', 'Product Targeting Expression', 'SKU', 'Percentage'
                ];

                // Campaign Name editable for Campaign entities AND when viewing from Ad Groups tab
                if (field === 'Campaign Name' && (row.Entity === 'Campaign' || (row.Entity === 'Ad Group' && activeTab === 'adgroups'))) {
                    return (
                        <input
                            type="text"
                            value={displayValue}
                            onChange={(e) => updateRow(row, 'Campaign Name', e.target.value)}
                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-blue-500"
                            title={displayValue}
                        />
                    );
                }

                if (field === 'Ad Group Name' && row.Entity === 'Ad Group') {
                    return (
                        <input
                            type="text"
                            value={displayValue}
                            onChange={(e) => updateRow(row, field, e.target.value)}
                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-blue-500"
                            title={displayValue}
                        />
                    );
                }

                if (editableFields.includes(field)) {
                    if (field === 'Match Type' && row.Entity === 'Keyword') {
                        return (
                            <select
                                value={displayValue || 'Broad'}
                                onChange={(e) => updateRow(row, field, e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                            >
                                <option value="Broad">Broad</option>
                                <option value="Phrase">Phrase</option>
                                <option value="Exact">Exact</option>
                            </select>
                        );
                    }

                    if (field === 'Match Type' && (row.Entity === 'Negative Keyword' || row.Entity === 'Campaign Negative Keyword')) {
                        return (
                            <select
                                value={displayValue || 'negativeExact'}
                                onChange={(e) => updateRow(row, field, e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                            >
                                <option value="negativeExact">Negative Exact</option>
                                <option value="negativePhrase">Negative Phrase</option>
                            </select>
                        );
                    }

                    if (field === 'Targeting Type') {
                        return (
                            <select
                                value={displayValue || 'Manual'}
                                onChange={(e) => updateRow(row, field, e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                            >
                                <option value="Auto">Auto</option>
                                <option value="Manual">Manual</option>
                            </select>
                        );
                    }

                    if (field === 'Bidding Strategy') {
                        return (
                            <select
                                value={displayValue || 'Dynamic bids - down only'}
                                onChange={(e) => updateRow(row, field, e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                            >
                                <option value="Dynamic bids - down only">Dynamic bids - down only</option>
                                <option value="Dynamic bids - up and down">Dynamic bids - up and down</option>
                                <option value="Fixed bid">Fixed bid</option>
                            </select>
                        );
                    }

                    return (
                        <input
                            type="text"
                            value={displayValue}
                            onChange={(e) => updateRow(row, field, e.target.value)}
                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-blue-500"
                            title={displayValue}
                        />
                    );
                }

                return <span className="text-xs text-gray-700" title={displayValue}>{displayValue || '-'}</span>;
            };

            const getColumns = () => {
                const portfolioCol = 'Portfolio Name';
                const campaignCol = 'Campaign Name';
                const adGroupCol = 'Ad Group Name';
                
                switch(activeTab) {
                    case 'campaigns':
                        return [
                            portfolioCol,
                            campaignCol,
                            'State',
                            'Targeting Type',
                            'Daily Budget',
                            'Bidding Strategy',
                            'Impressions',
                            'Clicks',
                            'Spend',
                            'Sales',
                            'ACOS',
                            'ROAS'
                        ];
                    
                    case 'adgroups':
                        return [
                            portfolioCol,
                            campaignCol,
                            'Campaign State (Informational only)',
                            adGroupCol,
                            'State',
                            'Ad Group Default Bid',
                            'Impressions',
                            'Clicks',
                            'Spend',
                            'Sales'
                        ];
                    
                    case 'products':
                        return [
                            portfolioCol,
                            campaignCol,
                            adGroupCol,
                            'State',
                            'SKU',
                            'ASIN (Informational only)',
                            'Impressions',
                            'Clicks',
                            'Spend',
                            'Sales'
                        ];
                    
                    case 'keywords':
                        return [
                            portfolioCol,
                            campaignCol,
                            adGroupCol,
                            'State',
                            'Keyword Text',
                            'Match Type',
                            'Bid',
                            'Impressions',
                            'Clicks',
                            'Spend',
                            'Sales',
                            'ACOS'
                        ];
                    
                    case 'targeting':
                        return [
                            portfolioCol,
                            campaignCol,
                            adGroupCol,
                            'State',
                            'Product Targeting Expression',
                            'Bid',
                            'Impressions',
                            'Clicks',
                            'Spend',
                            'Sales'
                        ];
                    
                    case 'negative':
                        return [
                            portfolioCol,
                            campaignCol,
                            adGroupCol,
                            'Entity',
                            'State',
                            'Keyword Text',
                            'Match Type'
                        ];
                    
                    case 'changes':
                        return [
                            'Status',
                            'Entity',
                            portfolioCol,
                            campaignCol,
                            adGroupCol,
                            'State',
                            'Keyword Text',
                            'SKU',
                            'Bid',
                            'Actions'
                        ];
                    
                    default:
                        return [portfolioCol, campaignCol, adGroupCol];
                }
            };

            const columns = getColumns();

            return (
                <div className="overflow-x-auto scrollbar-thin" style={{ maxHeight: '65vh' }}>
                    <table className="w-full text-xs">
                        <thead className="bg-gray-50 border-b border-gray-200 sticky top-0">
                            <tr>
                                <th className="px-3 py-2 text-left" style={{ width: '40px' }}>
                                    <input
                                        type="checkbox"
                                        checked={selectedItems.size === data.length && data.length > 0}
                                        onChange={selectAll}
                                        className="rounded"
                                    />
                                </th>
                                {columns.map(col => (
                                    <th 
                                        key={col} 
                                        className="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider"
                                        style={{ width: columnWidths[col] || '150px', minWidth: '80px' }}
                                    >
                                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '8px' }}>
                                            <span>{col.replace(' (Informational only)', '')}</span>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                {columnSort.column === col && (
                                                    <span className="text-blue-600 font-bold text-xs">
                                                        {columnSort.direction === 'asc' ? '↑' : '↓'}
                                                    </span>
                                                )}
                                                <div
                                                    className={`filter-icon ${columnFilters && columnFilters[col] ? 'active' : ''}`}
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        const rect = e.currentTarget.getBoundingClientRect();
                                                        setFilterPosition({
                                                            top: rect.bottom + window.scrollY + 5,
                                                            left: rect.left + window.scrollX
                                                        });
                                                        setActiveFilterColumn(col);
                                                    }}
                                                    title={`Filter ${col.replace(' (Informational only)', '')}`}
                                                >
                                                    {columnFilters && columnFilters[col] ? (
                                                        <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fillRule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clipRule="evenodd" />
                                                        </svg>
                                                    ) : (
                                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                                        </svg>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                        <div
                                            className="resizer"
                                            onMouseDown={(e) => handleMouseDown(e, col)}
                                        />
                                    </th>
                                ))}
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {data.length === 0 ? (
                                <tr>
                                    <td colSpan={columns.length + 1} className="px-4 py-12 text-center">
                                        <div className="text-gray-500">
                                            <div className="text-4xl mb-2">🔍</div>
                                            <div className="font-medium">No items found</div>
                                            <div className="text-sm mt-1">Try adjusting your filters</div>
                                        </div>
                                    </td>
                                </tr>
                            ) : (
                            data.map((row, index) => {
                                const inReferenceList = isInReferenceList && isInReferenceList(row);
                                const rowClasses = inReferenceList && showReferencePanel
                                    ? 'bg-orange-100 border-l-4 border-orange-400'
                                    : isRowNew(row) 
                                    ? 'new-row' 
                                    : isRowChanged(row) 
                                    ? 'changed-row' 
                                    : '';
                                
                                const isAdGroup = row.Entity === 'Ad Group';
                                const adGroupId = row['Ad Group ID'];
                                const isExpanded = isAdGroup && expandedAdGroups.has(adGroupId);
                                
                                return (
                                    <React.Fragment key={index}>
                                        <tr 
                                            className={`hover:bg-gray-50 ${selectedItems.has(index) ? 'bg-blue-50' : rowClasses}`}
                                            title={inReferenceList && showReferencePanel ? '🎯 In your target list' : ''}
                                        >
                                            <td className="px-3 py-2">
                                                <div className="flex items-center gap-1">
                                                    {isAdGroup && getAdGroupKeywords && (
                                                        <button
                                                            onClick={() => toggleAdGroupExpansion(adGroupId)}
                                                            className="text-gray-600 hover:text-blue-600 text-xs"
                                                            title="Show keywords and root analysis"
                                                        >
                                                            {isExpanded ? '▼' : '▶'}
                                                        </button>
                                                    )}
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedItems.has(index)}
                                                        onChange={() => toggleSelection(index)}
                                                        className="rounded"
                                                    />
                                                </div>
                                            </td>
                                            {columns.map((col) => {
                                                if (col === 'Status') {
                                                    return (
                                                        <td key={col} className="px-3 py-2">
                                                            <span className={`px-2 py-1 text-xs rounded font-medium ${
                                                                isRowNew(row) ? 'bg-green-100 text-green-800' :
                                                                isRowChanged(row) ? 'bg-yellow-100 text-yellow-800' :
                                                                'bg-gray-100 text-gray-800'
                                                            }`}>
                                                                {isRowNew(row) ? 'NEW' : isRowChanged(row) ? 'MODIFIED' : 'UNCHANGED'}
                                                            </span>
                                                        </td>
                                                    );
                                                }
                                                
                                                if (col === 'Actions' && activeTab === 'changes') {
                                                    return (
                                                        <td key={col} className="px-3 py-2">
                                                            <button
                                                                onClick={() => undoChange(row)}
                                                                className="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-medium hover:bg-red-200 flex items-center gap-1"
                                                                title={isRowNew(row) ? "Remove this new item" : "Revert to original"}
                                                            >
                                                                <span>↶</span>
                                                                <span>{isRowNew(row) ? 'Remove' : 'Undo'}</span>
                                                            </button>
                                                        </td>
                                                    );
                                                }
                                                
                                                return (
                                                    <td 
                                                        key={col} 
                                                        className="px-3 py-2"
                                                        style={{ width: columnWidths[col] || '150px' }}
                                                    >
                                                        {renderCell(row, col, index)}
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                        
                                        {/* Expanded keyword and root analysis */}
                                        {isExpanded && (() => {
                                            const { keywords, productTargets, roots } = getAdGroupKeywords(adGroupId);
                                            const hasKeywords = keywords.length > 0;
                                            const hasTargets = productTargets.length > 0;
                                            const hasRoots = roots.length > 0 && hasKeywords;
                                            
                                            // Determine grid layout
                                            let gridCols = 'grid-cols-1';
                                            if (hasKeywords && hasTargets && hasRoots) {
                                                gridCols = 'grid-cols-3'; // All three sections
                                            } else if ((hasKeywords && hasTargets) || (hasKeywords && hasRoots)) {
                                                gridCols = 'grid-cols-2'; // Two sections
                                            } else if (hasKeywords || hasTargets) {
                                                gridCols = 'grid-cols-1'; // One section
                                            }
                                            
                                            return (
                                                <tr className="bg-gray-50">
                                                    <td colSpan={columns.length + 1} className="px-6 py-4">
                                                        <div className={`grid ${gridCols} gap-4`}>
                                                            {/* Keywords List - Show only if there are keywords OR if there are no targets */}
                                                            {(hasKeywords || !hasTargets) && (
                                                            <div>
                                                                <h4 className="text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                                                                    📝 Keywords ({keywords.length})
                                                                </h4>
                                                                
                                                                {/* Search and Bulk Actions */}
                                                                {keywords.length > 0 && (
                                                                    <div className="mb-2 space-y-2">
                                                                        <input
                                                                            type="text"
                                                                            placeholder="🔍 Search keywords..."
                                                                            className="w-full px-3 py-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                                                            value={keywordSearchTerms[adGroupId] || ''}
                                                                            onChange={(e) => setKeywordSearchTerms(prev => ({
                                                                                ...prev,
                                                                                [adGroupId]: e.target.value
                                                                            }))}
                                                                        />
                                                                        
                                                                        {(selectedKeywords[adGroupId] && selectedKeywords[adGroupId].size > 0) && (
                                                                            <div className="flex items-center gap-2">
                                                                                <span className="text-xs text-gray-600">
                                                                                    {selectedKeywords[adGroupId].size} selected
                                                                                </span>
                                                                                <button
                                                                                    onClick={() => bulkUpdateKeywordState(adGroupId, 'paused')}
                                                                                    className="px-2 py-1 text-xs bg-yellow-600 text-white rounded hover:bg-yellow-700 font-medium"
                                                                                    title="Pause selected keywords"
                                                                                >
                                                                                    ⏸ Pause Selected
                                                                                </button>
                                                                                <button
                                                                                    onClick={() => bulkUpdateKeywordState(adGroupId, 'enabled')}
                                                                                    className="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700 font-medium"
                                                                                    title="Enable selected keywords"
                                                                                >
                                                                                    ▶ Enable Selected
                                                                                </button>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                                
                                                                <div className="bg-white border rounded-lg p-3 max-h-60 overflow-y-auto text-xs">
                                                                    {keywords.length > 0 ? (
                                                                        <table className="w-full">
                                                                            <thead className="text-[10px] text-gray-600 border-b">
                                                                                <tr>
                                                                                    <th className="text-left pb-1 pr-2" style={{ width: '30px' }}>
                                                                                        <input
                                                                                            type="checkbox"
                                                                                            checked={(() => {
                                                                                                const searchTerm = (keywordSearchTerms[adGroupId] || '').toLowerCase();
                                                                                                const filteredKws = keywords.filter(kw => 
                                                                                                    !searchTerm || 
                                                                                                    (kw['Keyword Text'] || '').toLowerCase().includes(searchTerm)
                                                                                                );
                                                                                                const selections = selectedKeywords[adGroupId] || new Set();
                                                                                                return filteredKws.length > 0 && filteredKws.every(kw => selections.has(kw['Keyword ID']));
                                                                                            })()}
                                                                                            onChange={() => {
                                                                                                const searchTerm = (keywordSearchTerms[adGroupId] || '').toLowerCase();
                                                                                                const filteredKws = keywords.filter(kw => 
                                                                                                    !searchTerm || 
                                                                                                    (kw['Keyword Text'] || '').toLowerCase().includes(searchTerm)
                                                                                                );
                                                                                                toggleAllKeywords(adGroupId, filteredKws);
                                                                                            }}
                                                                                            className="rounded cursor-pointer"
                                                                                            title="Select all keywords"
                                                                                        />
                                                                                    </th>
                                                                                    <th className="text-left pb-1">Keyword</th>
                                                                                    <th className="text-left pb-1">Match</th>
                                                                                    <th className="text-left pb-1">State</th>
                                                                                    <th className="text-right pb-1">Bid</th>
                                                                                    <th className="text-right pb-1">CPC</th>
                                                                                    <th className="text-right pb-1">Clicks</th>
                                                                                    <th className="text-right pb-1">Impr.</th>
                                                                                    <th className="text-right pb-1">Orders</th>
                                                                                    <th className="text-right pb-1">Spend</th>
                                                                                    <th className="text-right pb-1">Sales</th>
                                                                                    <th className="text-center pb-1">Actions</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                {keywords
                                                                                    .filter(kw => {
                                                                                        const searchTerm = (keywordSearchTerms[adGroupId] || '').toLowerCase();
                                                                                        if (!searchTerm) return true;
                                                                                        return (kw['Keyword Text'] || '').toLowerCase().includes(searchTerm);
                                                                                    })
                                                                                    .map((kw, i) => {
                                                                                    const clicks = parseInt(kw.Clicks || 0);
                                                                                    const spend = parseFloat(kw.Spend || 0);
                                                                                    const cpc = clicks > 0 ? spend / clicks : 0;
                                                                                    const inReferenceList = isInReferenceList && isInReferenceList(kw);
                                                                                    const isSelected = (selectedKeywords[adGroupId] || new Set()).has(kw['Keyword ID']);
                                                                                    
                                                                                    return (
                                                                                    <tr key={i} className={`border-b last:border-0 ${
                                                                                        isSelected ? 'bg-blue-50' :
                                                                                        inReferenceList && showReferencePanel ? 'bg-orange-100' : ''
                                                                                    }`}>
                                                                                        <td className="py-1 pr-2">
                                                                                            <input
                                                                                                type="checkbox"
                                                                                                checked={isSelected}
                                                                                                onChange={() => toggleKeywordSelection(adGroupId, kw['Keyword ID'])}
                                                                                                className="rounded cursor-pointer"
                                                                                            />
                                                                                        </td>
                                                                                        <td className="py-1">{kw['Keyword Text']}</td>
                                                                                        <td className="py-1">{kw['Match Type']}</td>
                                                                                        <td className="py-1">
                                                                                            <span className={`px-1 rounded text-[10px] ${
                                                                                                kw.State === 'enabled' ? 'bg-green-100 text-green-800' : 
                                                                                                kw.State === 'paused' ? 'bg-yellow-100 text-yellow-800' : 
                                                                                                'bg-gray-100 text-gray-800'
                                                                                            }`}>
                                                                                                {kw.State}
                                                                                            </span>
                                                                                        </td>
                                                                                        <td className="py-1 text-right font-medium text-blue-700">${parseFloat(kw.Bid || 0).toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">${cpc.toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">{clicks}</td>
                                                                                        <td className="py-1 text-right">{parseInt(kw.Impressions || 0)}</td>
                                                                                        <td className="py-1 text-right">{parseInt(kw.Orders || 0)}</td>
                                                                                        <td className="py-1 text-right">${spend.toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">${parseFloat(kw.Sales || 0).toFixed(2)}</td>
                                                                                        <td className="py-1 text-center">
                                                                                            <div className="flex gap-1 justify-center">
                                                                                                {kw.State !== 'enabled' && (
                                                                                                    <button
                                                                                                        onClick={() => {
                                                                                                            const kwRow = allData.find(r => 
                                                                                                                r['Keyword ID'] === kw['Keyword ID']
                                                                                                            );
                                                                                                            if (kwRow) {
                                                                                                                updateRow(kwRow, 'State', 'enabled');
                                                                                                            }
                                                                                                        }}
                                                                                                        className="px-1.5 py-0.5 bg-green-600 text-white rounded text-[10px] hover:bg-green-700"
                                                                                                        title="Enable keyword"
                                                                                                    >
                                                                                                        ▶
                                                                                                    </button>
                                                                                                )}
                                                                                                {kw.State !== 'paused' && (
                                                                                                    <button
                                                                                                        onClick={() => {
                                                                                                            const kwRow = allData.find(r => 
                                                                                                                r['Keyword ID'] === kw['Keyword ID']
                                                                                                            );
                                                                                                            if (kwRow) {
                                                                                                                updateRow(kwRow, 'State', 'paused');
                                                                                                            }
                                                                                                        }}
                                                                                                        className="px-1.5 py-0.5 bg-yellow-600 text-white rounded text-[10px] hover:bg-yellow-700"
                                                                                                        title="Pause keyword"
                                                                                                    >
                                                                                                        ⏸
                                                                                                    </button>
                                                                                                )}
                                                                                            </div>
                                                                                        </td>
                                                                                    </tr>
                                                                                    );
                                                                                })}
                                                                            </tbody>
                                                                        </table>
                                                                    ) : (
                                                                        <div className="text-gray-500 text-center py-4">No keywords found</div>
                                                                    )}
                                                                    
                                                                    {/* Show message when search has no results */}
                                                                    {keywords.length > 0 && (() => {
                                                                        const searchTerm = (keywordSearchTerms[adGroupId] || '').toLowerCase();
                                                                        const filteredCount = keywords.filter(kw => 
                                                                            !searchTerm || 
                                                                            (kw['Keyword Text'] || '').toLowerCase().includes(searchTerm)
                                                                        ).length;
                                                                        
                                                                        if (searchTerm && filteredCount === 0) {
                                                                            return (
                                                                                <div className="text-gray-500 text-center py-3 text-xs">
                                                                                    No keywords match "{keywordSearchTerms[adGroupId]}"
                                                                                </div>
                                                                            );
                                                                        }
                                                                        return null;
                                                                    })()}
                                                                </div>
                                                                
                                                                {/* Add Keywords Form */}
                                                                <div className="mt-3">
                                                                    {!addKeywordForms[adGroupId] ? (
                                                                        <button
                                                                            onClick={() => toggleAddKeywordForm(adGroupId)}
                                                                            className="w-full px-3 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 text-xs font-medium border border-blue-200"
                                                                        >
                                                                            ➕ Add Keywords to This Ad Group
                                                                        </button>
                                                                    ) : (
                                                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                                                            <div className="flex items-center justify-between mb-2">
                                                                                <span className="text-xs font-bold text-gray-900">Add Keywords</span>
                                                                                <button
                                                                                    onClick={() => toggleAddKeywordForm(adGroupId)}
                                                                                    className="text-gray-500 hover:text-gray-700"
                                                                                >
                                                                                    ×
                                                                                </button>
                                                                            </div>
                                                                            <div className="space-y-2">
                                                                                <textarea
                                                                                    placeholder="Keywords (one per line)&#10;badewannenmatte&#10;duschmatte&#10;rutschfeste matte"
                                                                                    className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                                                    rows="4"
                                                                                    value={getKeywordFormData(adGroupId).kwText}
                                                                                    onChange={(e) => updateKeywordFormData(adGroupId, 'kwText', e.target.value)}
                                                                                />
                                                                                <div className="grid grid-cols-2 gap-2">
                                                                                    <div>
                                                                                        <label className="text-[10px] text-gray-600 block mb-1">Bid $</label>
                                                                                        <input
                                                                                            type="number"
                                                                                            step="0.01"
                                                                                            placeholder="0.50"
                                                                                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                                                            value={getKeywordFormData(adGroupId).kwBid}
                                                                                            onChange={(e) => updateKeywordFormData(adGroupId, 'kwBid', e.target.value)}
                                                                                        />
                                                                                    </div>
                                                                                    <div>
                                                                                        <label className="text-[10px] text-gray-600 block mb-1">Match Type</label>
                                                                                        <select
                                                                                            className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                                                            value={getKeywordFormData(adGroupId).kwMatch}
                                                                                            onChange={(e) => updateKeywordFormData(adGroupId, 'kwMatch', e.target.value)}
                                                                                        >
                                                                                            <option value="Broad">Broad</option>
                                                                                            <option value="Phrase">Phrase</option>
                                                                                            <option value="Exact">Exact</option>
                                                                                        </select>
                                                                                    </div>
                                                                                </div>
                                                                                <button
                                                                                    onClick={() => {
                                                                                        const formData = getKeywordFormData(adGroupId);
                                                                                        if (formData.kwText.trim()) {
                                                                                            addKeywordsToAdGroup(adGroupId, formData.kwText, formData.kwBid, formData.kwMatch);
                                                                                            // Reset form
                                                                                            setKeywordFormData(prev => ({
                                                                                                ...prev,
                                                                                                [adGroupId]: { kwText: '', kwBid: '', kwMatch: 'Exact' }
                                                                                            }));
                                                                                        }
                                                                                    }}
                                                                                    className="w-full px-3 py-1.5 bg-blue-600 text-white rounded text-xs font-medium hover:bg-blue-700"
                                                                                >
                                                                                    Add {getKeywordFormData(adGroupId).kwText.split('\n').filter(k => k.trim()).length} Keyword(s)
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            )}
                                                            
                                                            {/* Product Targeting List - Show only if there are targets OR if there are no keywords */}
                                                            {(hasTargets || !hasKeywords) && (
                                                            <div>
                                                                <h4 className="text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                                                                    🎯 Product Targets ({productTargets.length})
                                                                </h4>
                                                                <div className="bg-white border rounded-lg p-3 max-h-60 overflow-y-auto text-xs">
                                                                    {productTargets.length > 0 ? (
                                                                        <table className="w-full">
                                                                            <thead className="text-[10px] text-gray-600 border-b">
                                                                                <tr>
                                                                                    <th className="text-left pb-1">Target Expression</th>
                                                                                    <th className="text-left pb-1">State</th>
                                                                                    <th className="text-right pb-1">Bid</th>
                                                                                    <th className="text-right pb-1">CPC</th>
                                                                                    <th className="text-right pb-1">Clicks</th>
                                                                                    <th className="text-right pb-1">Spend</th>
                                                                                    <th className="text-right pb-1">Sales</th>
                                                                                    <th className="text-center pb-1">Actions</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                {productTargets.map((pt, i) => {
                                                                                    const clicks = parseInt(pt.Clicks || 0);
                                                                                    const spend = parseFloat(pt.Spend || 0);
                                                                                    const cpc = clicks > 0 ? spend / clicks : 0;
                                                                                    const inReferenceList = isInReferenceList && isInReferenceList(pt);
                                                                                    
                                                                                    return (
                                                                                    <tr key={i} className={`border-b last:border-0 ${
                                                                                        inReferenceList && showReferencePanel ? 'bg-orange-100' : ''
                                                                                    }`}>
                                                                                        <td className="py-1 max-w-[200px] truncate" title={pt['Product Targeting Expression']}>
                                                                                            {pt['Product Targeting Expression']}
                                                                                        </td>
                                                                                        <td className="py-1">
                                                                                            <span className={`px-1 rounded text-[10px] ${
                                                                                                pt.State === 'enabled' ? 'bg-green-100 text-green-800' : 
                                                                                                pt.State === 'paused' ? 'bg-yellow-100 text-yellow-800' : 
                                                                                                'bg-gray-100 text-gray-800'
                                                                                            }`}>
                                                                                                {pt.State}
                                                                                            </span>
                                                                                        </td>
                                                                                        <td className="py-1 text-right font-medium text-blue-700">${parseFloat(pt.Bid || 0).toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">${cpc.toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">{clicks}</td>
                                                                                        <td className="py-1 text-right">${spend.toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">${parseFloat(pt.Sales || 0).toFixed(2)}</td>
                                                                                        <td className="py-1 text-center">
                                                                                            <div className="flex gap-1 justify-center">
                                                                                                {pt.State !== 'enabled' && (
                                                                                                    <button
                                                                                                        onClick={() => {
                                                                                                            const ptRow = allData.find(r => 
                                                                                                                r['Product Targeting ID'] === pt['Product Targeting ID']
                                                                                                            );
                                                                                                            if (ptRow) {
                                                                                                                updateRow(ptRow, 'State', 'enabled');
                                                                                                            }
                                                                                                        }}
                                                                                                        className="px-1.5 py-0.5 bg-green-600 text-white rounded text-[10px] hover:bg-green-700"
                                                                                                        title="Enable target"
                                                                                                    >
                                                                                                        ▶
                                                                                                    </button>
                                                                                                )}
                                                                                                {pt.State !== 'paused' && (
                                                                                                    <button
                                                                                                        onClick={() => {
                                                                                                            const ptRow = allData.find(r => 
                                                                                                                r['Product Targeting ID'] === pt['Product Targeting ID']
                                                                                                            );
                                                                                                            if (ptRow) {
                                                                                                                updateRow(ptRow, 'State', 'paused');
                                                                                                            }
                                                                                                        }}
                                                                                                        className="px-1.5 py-0.5 bg-yellow-600 text-white rounded text-[10px] hover:bg-yellow-700"
                                                                                                        title="Pause target"
                                                                                                    >
                                                                                                        ⏸
                                                                                                    </button>
                                                                                                )}
                                                                                            </div>
                                                                                        </td>
                                                                                    </tr>
                                                                                    );
                                                                                })}
                                                                            </tbody>
                                                                        </table>
                                                                    ) : (
                                                                        <div className="text-gray-500 text-center py-4">No product targets found</div>
                                                                    )}
                                                                </div>
                                                                
                                                                {/* Add Product Targets Form */}
                                                                <div className="mt-3">
                                                                    {!addKeywordForms[adGroupId + '_targets'] ? (
                                                                        <button
                                                                            onClick={() => toggleAddKeywordForm(adGroupId + '_targets')}
                                                                            className="w-full px-3 py-2 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 text-xs font-medium border border-purple-200"
                                                                        >
                                                                            ➕ Add Product Targets to This Ad Group
                                                                        </button>
                                                                    ) : (
                                                                        <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                                                            <div className="flex items-center justify-between mb-2">
                                                                                <span className="text-xs font-bold text-gray-900">Add Product Targets</span>
                                                                                <button
                                                                                    onClick={() => toggleAddKeywordForm(adGroupId + '_targets')}
                                                                                    className="text-gray-500 hover:text-gray-700"
                                                                                >
                                                                                    ×
                                                                                </button>
                                                                            </div>
                                                                            <div className="space-y-2">
                                                                                <textarea
                                                                                    placeholder="ASINs or Expressions (one per line, auto-formatted on export)&#10;B07XYZ1234&#10;B08ABC5678&#10;category=&quot;12345678&quot;"
                                                                                    className="w-full px-2 py-1 border border-gray-300 rounded text-xs font-mono"
                                                                                    rows="4"
                                                                                    value={getKeywordFormData(adGroupId + '_targets').kwText}
                                                                                    onChange={(e) => updateKeywordFormData(adGroupId + '_targets', 'kwText', e.target.value)}
                                                                                />
                                                                                <div className="text-[10px] text-gray-600 italic">
                                                                                    💡 Just enter ASINs (B0CL21ZDS3) - they'll be auto-formatted to asin="..." on export
                                                                                </div>
                                                                                <div>
                                                                                    <label className="text-[10px] text-gray-600 block mb-1">Bid $</label>
                                                                                    <input
                                                                                        type="number"
                                                                                        step="0.01"
                                                                                        placeholder="0.50"
                                                                                        className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                                                        value={getKeywordFormData(adGroupId + '_targets').kwBid}
                                                                                        onChange={(e) => updateKeywordFormData(adGroupId + '_targets', 'kwBid', e.target.value)}
                                                                                    />
                                                                                </div>
                                                                                <button
                                                                                    onClick={() => {
                                                                                        const formData = getKeywordFormData(adGroupId + '_targets');
                                                                                        if (formData.kwText.trim()) {
                                                                                            addProductTargetsToAdGroup(adGroupId, formData.kwText, formData.kwBid);
                                                                                            // Reset form
                                                                                            setKeywordFormData(prev => ({
                                                                                                ...prev,
                                                                                                [adGroupId + '_targets']: { kwText: '', kwBid: '', kwMatch: 'Exact' }
                                                                                            }));
                                                                                        }
                                                                                    }}
                                                                                    className="w-full px-3 py-1.5 bg-purple-600 text-white rounded text-xs font-medium hover:bg-purple-700"
                                                                                >
                                                                                    Add {getKeywordFormData(adGroupId + '_targets').kwText.split('\n').filter(k => k.trim()).length} Target(s)
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            )}
                                                            
                                                            {/* Root Analysis - Only show when there are keywords */}
                                                            {hasRoots && (
                                                            <div>
                                                                <h4 className="text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                                                                    🌱 Root Word Analysis ({roots.length} roots)
                                                                </h4>
                                                                <div className="bg-white border rounded-lg p-3 max-h-60 overflow-y-auto text-xs">
                                                                    {roots.length > 0 ? (
                                                                        <table className="w-full">
                                                                            <thead className="text-[10px] text-gray-600 border-b">
                                                                                <tr>
                                                                                    <th className="text-left pb-1">Root Word</th>
                                                                                    <th className="text-center pb-1">KW Count</th>
                                                                                    <th className="text-right pb-1">Spend</th>
                                                                                    <th className="text-right pb-1">Sales</th>
                                                                                    <th className="text-right pb-1">ACOS</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                {roots.map((root, i) => (
                                                                                    <tr key={i} className="border-b last:border-0" title={`Used in: ${root.keywords.join(', ')}`}>
                                                                                        <td className="py-1 font-medium">{root.root}</td>
                                                                                        <td className="py-1 text-center">
                                                                                            <span className="bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded">
                                                                                                {root.count}
                                                                                            </span>
                                                                                        </td>
                                                                                        <td className="py-1 text-right">${root.spend.toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">${root.sales.toFixed(2)}</td>
                                                                                        <td className="py-1 text-right">
                                                                                            <span className={`px-1 rounded ${
                                                                                                root.acos < 20 ? 'bg-green-100 text-green-800' :
                                                                                                root.acos < 40 ? 'bg-yellow-100 text-yellow-800' :
                                                                                                'bg-red-100 text-red-800'
                                                                                            }`}>
                                                                                                {root.acos > 0 ? root.acos.toFixed(1) + '%' : '-'}
                                                                                            </span>
                                                                                        </td>
                                                                                    </tr>
                                                                                ))}
                                                                            </tbody>
                                                                        </table>
                                                                    ) : (
                                                                        <div className="text-gray-500 text-center py-4">No keyword data available</div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            )}
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })()}
                                    </React.Fragment>
                                );
                            })
                            )}
                        </tbody>
                    </table>
                </div>
            );
        }

        function AddModal({ type, data, onClose, onAdd }) {
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({
                keywords: '',
                negativeKeywords: ''
            });
            const [bulkMode, setBulkMode] = useState(false);
            const [bulkCampaigns, setBulkCampaigns] = useState([]);
            const [createdCampaigns, setCreatedCampaigns] = useState([]);
            const [loadedExisting, setLoadedExisting] = useState(false);

            const campaigns = data.filter(r => r.Entity === 'Campaign');
            const adGroups = data.filter(r => r.Entity === 'Ad Group');
            
            // Build portfolios map with both ID and Name
            const portfoliosMap = new Map();
            data.forEach(r => {
                const portfolioId = r['Portfolio ID'];
                const portfolioName = getPortfolioName(r);
                if (portfolioId && portfolioName && portfolioName !== '-') {
                    portfoliosMap.set(portfolioName, portfolioId);
                }
            });
            const portfolios = [...portfoliosMap.keys()];

            // Check for duplicate keywords and ASINs in existing data
            const checkDuplicates = (text, type, campaignId = null, adGroupId = null) => {
                if (!text || data.length === 0) return [];
                
                const items = text.split('\n').map(s => s.trim()).filter(s => s);
                const duplicates = [];
                
                items.forEach(item => {
                    if (type === 'keywords') {
                        // Check against existing keywords
                        const existing = data.find(row => 
                            row.Entity === 'Keyword' && 
                            row['Keyword Text'] && 
                            row['Keyword Text'].toLowerCase() === item.toLowerCase() &&
                            (!campaignId || row['Campaign ID'] === campaignId) &&
                            (!adGroupId || row['Ad Group ID'] === adGroupId)
                        );
                        if (existing) {
                            duplicates.push({
                                text: item,
                                campaign: getCampaignName(existing),
                                adGroup: getAdGroupName(existing),
                                matchType: existing['Match Type'] || '-'
                            });
                        }
                    } else if (type === 'products') {
                        // Check against existing product ads (SKUs)
                        const existing = data.find(row => 
                            row.Entity === 'Product Ad' && 
                            row.SKU && 
                            row.SKU.toLowerCase() === item.toLowerCase() &&
                            (!campaignId || row['Campaign ID'] === campaignId) &&
                            (!adGroupId || row['Ad Group ID'] === adGroupId)
                        );
                        if (existing) {
                            duplicates.push({
                                text: item,
                                campaign: getCampaignName(existing),
                                adGroup: getAdGroupName(existing)
                            });
                        }
                    } else if (type === 'negatives') {
                        // Check against existing negative keywords
                        const existing = data.find(row => 
                            (row.Entity === 'Campaign Negative Keyword' || row.Entity === 'Negative Keyword') && 
                            row['Keyword Text'] && 
                            row['Keyword Text'].toLowerCase() === item.toLowerCase() &&
                            (!campaignId || row['Campaign ID'] === campaignId) &&
                            (!adGroupId || row['Ad Group ID'] === adGroupId)
                        );
                        if (existing) {
                            duplicates.push({
                                text: item,
                                campaign: getCampaignName(existing),
                                adGroup: getAdGroupName(existing) || 'Campaign-level',
                                matchType: existing['Match Type'] || '-'
                            });
                        }
                    }
                });
                
                return duplicates;
            };

            // Load only newly created campaigns (not all existing campaigns)
            const loadExistingCampaigns = () => {
                if (!data || data.length === 0 || loadedExisting) return;
                
                // Only load campaigns that are NEW (Operation = 'Create')
                const newCampaignRows = data.filter(r => 
                    r.Entity === 'Campaign' && 
                    r.Operation === 'Create'
                );
                
                const parsedCampaigns = [];
                
                newCampaignRows.forEach(campaignRow => {
                    const campaignId = campaignRow['Campaign ID'];
                    const campaignName = getCampaignName(campaignRow);
                    
                    if (!campaignId || !campaignName) return;
                    
                    // Find ad group for this campaign (also must be NEW)
                    const adGroupRow = data.find(r => 
                        r.Entity === 'Ad Group' && 
                        r['Campaign ID'] === campaignId &&
                        r.Operation === 'Create'
                    );
                    
                    const adGroupId = adGroupRow ? adGroupRow['Ad Group ID'] : null;
                    const adGroupName = adGroupRow ? getAdGroupName(adGroupRow) : '';
                    
                    // Get keywords for this ad group (only NEW ones)
                    const keywords = data
                        .filter(r => 
                            r.Entity === 'Keyword' && 
                            r['Campaign ID'] === campaignId && 
                            r['Ad Group ID'] === adGroupId &&
                            r.Operation === 'Create'
                        )
                        .map(r => r['Keyword Text'])
                        .filter(k => k)
                        .join('\n');
                    
                    // Get products (SKUs) for this ad group (only NEW ones)
                    const products = data
                        .filter(r => 
                            r.Entity === 'Product Ad' && 
                            r['Campaign ID'] === campaignId && 
                            r['Ad Group ID'] === adGroupId &&
                            r.Operation === 'Create'
                        )
                        .map(r => r.SKU)
                        .filter(s => s)
                        .join('\n');
                    
                    // Get product targets for this ad group (only NEW ones)
                    const productTargets = data
                        .filter(r => 
                            r.Entity === 'Product Targeting' && 
                            r['Campaign ID'] === campaignId && 
                            r['Ad Group ID'] === adGroupId &&
                            r.Operation === 'Create'
                        )
                        .map(r => r['Product Targeting Expression'])
                        .filter(t => t)
                        .join('\n');
                    
                    // Get match type from first keyword
                    const firstKeyword = data.find(r => 
                        r.Entity === 'Keyword' && 
                        r['Campaign ID'] === campaignId && 
                        r['Ad Group ID'] === adGroupId &&
                        r.Operation === 'Create'
                    );
                    const matchType = firstKeyword ? firstKeyword['Match Type'] || 'Broad' : 'Broad';
                    
                    // Get keyword bid from first keyword
                    const keywordBid = firstKeyword ? firstKeyword['Bid'] || '' : '';
                    
                    // Get product target bid from first product target
                    const firstProductTarget = data.find(r => 
                        r.Entity === 'Product Targeting' && 
                        r['Campaign ID'] === campaignId && 
                        r['Ad Group ID'] === adGroupId &&
                        r.Operation === 'Create'
                    );
                    const productTargetBid = firstProductTarget ? firstProductTarget['Bid'] || '' : '';
                    
                    // Get placement modifiers (only NEW ones)
                    const topOfSearchRow = data.find(r => 
                        r.Entity === 'Campaign Placement' && 
                        r['Campaign ID'] === campaignId && 
                        r['Placement'] === 'Placement Top' &&
                        r.Operation === 'Create'
                    );
                    const restOfSearchRow = data.find(r => 
                        r.Entity === 'Campaign Placement' && 
                        r['Campaign ID'] === campaignId && 
                        r['Placement'] === 'Placement Rest of Search' &&
                        r.Operation === 'Create'
                    );
                    const productPagesRow = data.find(r => 
                        r.Entity === 'Campaign Placement' && 
                        r['Campaign ID'] === campaignId && 
                        r['Placement'] === 'Placement Product Page' &&
                        r.Operation === 'Create'
                    );
                    
                    parsedCampaigns.push({
                        id: Date.now() + Math.random(),
                        portfolioId: campaignRow['Portfolio ID'] || '',
                        portfolioName: getPortfolioName(campaignRow) || '',
                        campaignName: campaignName,
                        dailyBudget: campaignRow['Daily Budget'] || '',
                        targetingType: campaignRow['Targeting Type'] || 'Manual',
                        biddingStrategy: campaignRow['Bidding Strategy'] || 'Dynamic bids - down only',
                        adGroupName: adGroupName,
                        defaultBid: adGroupRow ? adGroupRow['Ad Group Default Bid'] || '' : '',
                        products: products,
                        keywords: keywords,
                        matchType: matchType,
                        keywordBid: keywordBid,
                        productTargets: productTargets,
                        targetingMethod: 'asin',
                        productTargetBid: productTargetBid,
                        topOfSearchMod: topOfSearchRow ? topOfSearchRow['Percentage'] || '' : '',
                        restOfSearchMod: restOfSearchRow ? restOfSearchRow['Percentage'] || '' : '',
                        productPagesMod: productPagesRow ? productPagesRow['Percentage'] || '' : ''
                    });
                });
                
                // Sort by most recent and take up to 50 campaigns
                parsedCampaigns.sort((a, b) => b.id - a.id);
                setCreatedCampaigns(parsedCampaigns.slice(0, 50));
                setLoadedExisting(true);
            };

            // Load existing campaigns when entering bulk mode
            React.useEffect(() => {
                if (bulkMode && type === 'campaigns' && !loadedExisting) {
                    loadExistingCampaigns();
                }
            }, [bulkMode, type]);

            // Bulk campaign builder functions
            const addEmptyBulkCampaign = () => {
                setBulkCampaigns([...bulkCampaigns, {
                    id: Date.now(),
                    portfolioName: '',
                    campaignName: '',
                    dailyBudget: '',
                    targetingType: 'Manual',
                    biddingStrategy: 'Dynamic bids - down only',
                    adGroupName: '',
                    defaultBid: '',
                    products: '',
                    keywords: '',
                    matchType: 'Broad',
                    keywordBid: '',
                    productTargets: '',
                    targetingMethod: 'asin',
                    productTargetBid: '',
                    topOfSearchMod: '',
                    restOfSearchMod: '',
                    productPagesMod: ''
                }]);
            };

            const duplicateBulkCampaign = (index) => {
                const campaign = bulkCampaigns[index];
                const duplicated = { ...campaign, id: Date.now(), campaignName: campaign.campaignName + ' - Copy' };
                const newCampaigns = [...bulkCampaigns];
                newCampaigns.splice(index + 1, 0, duplicated);
                setBulkCampaigns(newCampaigns);
            };

            const removeBulkCampaign = (index) => {
                setBulkCampaigns(bulkCampaigns.filter((_, i) => i !== index));
            };

            const updateBulkCampaign = (index, field, value) => {
                const newCampaigns = [...bulkCampaigns];
                newCampaigns[index][field] = value;
                setBulkCampaigns(newCampaigns);
            };

            const createBulkCampaigns = () => {
                if (bulkCampaigns.length === 0) {
                    alert('Please add at least one campaign');
                    return;
                }

                const newItems = [];
                bulkCampaigns.forEach(camp => {
                    if (!camp.campaignName) {
                        alert('All campaigns must have a name');
                        return;
                    }

                    const campaignId = camp.campaignName.replace(/[^a-zA-Z0-9]/g, '_');
                    const adGroupId = camp.adGroupName ? camp.adGroupName.replace(/[^a-zA-Z0-9]/g, '_') : '';

                    // Create Campaign
                    newItems.push(createRow('Campaign', {
                        'Campaign ID': campaignId,
                        'Campaign Name': camp.campaignName,
                        'Campaign Name (Informational only)': camp.campaignName,
                        'Portfolio ID': camp.portfolioId || '',
                        'Portfolio Name (Informational only)': camp.portfolioName || '',
                        'Daily Budget': camp.dailyBudget || '',
                        'Targeting Type': camp.targetingType,
                        'Bidding Strategy': camp.biddingStrategy
                    }));

                    // Add Placement bid modifiers if specified
                    if (camp.topOfSearchMod && camp.topOfSearchMod !== '0' && camp.topOfSearchMod !== '') {
                        newItems.push(createRow('Campaign Placement', {
                            'Campaign ID': campaignId,
                            'Campaign Name (Informational only)': camp.campaignName,
                            'Placement': 'Placement Top',
                            'Percentage': camp.topOfSearchMod,
                            'Portfolio Name (Informational only)': camp.portfolioName || ''
                        }));
                    }
                    
                    if (camp.restOfSearchMod && camp.restOfSearchMod !== '0' && camp.restOfSearchMod !== '') {
                        newItems.push(createRow('Campaign Placement', {
                            'Campaign ID': campaignId,
                            'Campaign Name (Informational only)': camp.campaignName,
                            'Placement': 'Placement Rest of Search',
                            'Percentage': camp.restOfSearchMod,
                            'Portfolio Name (Informational only)': camp.portfolioName || ''
                        }));
                    }
                    
                    if (camp.productPagesMod && camp.productPagesMod !== '0' && camp.productPagesMod !== '') {
                        newItems.push(createRow('Campaign Placement', {
                            'Campaign ID': campaignId,
                            'Campaign Name (Informational only)': camp.campaignName,
                            'Placement': 'Placement Product Page',
                            'Percentage': camp.productPagesMod,
                            'Portfolio Name (Informational only)': camp.portfolioName || ''
                        }));
                    }

                    // Create Ad Group if specified
                    if (camp.adGroupName) {
                        newItems.push(createRow('Ad Group', {
                            'Campaign ID': campaignId,
                            'Campaign Name (Informational only)': camp.campaignName,
                            'Ad Group ID': adGroupId,
                            'Ad Group Name': camp.adGroupName,
                            'Ad Group Name (Informational only)': camp.adGroupName,
                            'Ad Group Default Bid': camp.defaultBid || '',
                            'Portfolio Name (Informational only)': camp.portfolioName || ''
                        }));

                        // Add Products
                        if (camp.products) {
                            const skus = camp.products.split('\n').map(s => s.trim()).filter(s => s);
                            skus.forEach(sku => {
                                newItems.push(createRow('Product Ad', {
                                    'Campaign ID': campaignId,
                                    'Campaign Name (Informational only)': camp.campaignName,
                                    'Ad Group ID': adGroupId,
                                    'Ad Group Name (Informational only)': camp.adGroupName,
                                    'SKU': sku,
                                    'Portfolio Name (Informational only)': camp.portfolioName || ''
                                }));
                            });
                        }

                        // Add Keywords
                        if (camp.keywords) {
                            const keywords = camp.keywords.split('\n').map(k => k.trim()).filter(k => k);
                            keywords.forEach(keyword => {
                                newItems.push(createRow('Keyword', {
                                    'Campaign ID': campaignId,
                                    'Campaign Name (Informational only)': camp.campaignName,
                                    'Ad Group ID': adGroupId,
                                    'Ad Group Name (Informational only)': camp.adGroupName,
                                    'Keyword Text': keyword,
                                    'Match Type': camp.matchType,
                                    'Bid': camp.keywordBid || camp.defaultBid || '',
                                    'Portfolio Name (Informational only)': camp.portfolioName || ''
                                }));
                            });
                        }

                        // Add Product Targets
                        if (camp.productTargets) {
                            const targets = camp.productTargets.split('\n').map(t => t.trim()).filter(t => t);
                            const targetingMethod = camp.targetingMethod || 'asin';
                            
                            targets.forEach(target => {
                                // Format the expression
                                const formattedExpression = formatProductTargetingExpression(target, targetingMethod);
                                
                                newItems.push(createRow('Product Targeting', {
                                    'Campaign ID': campaignId,
                                    'Campaign Name (Informational only)': camp.campaignName,
                                    'Ad Group ID': adGroupId,
                                    'Ad Group Name (Informational only)': camp.adGroupName,
                                    'Product Targeting Expression': formattedExpression,
                                    'Bid': camp.productTargetBid || camp.defaultBid || '',
                                    'Portfolio Name (Informational only)': camp.portfolioName || ''
                                }));
                            });
                        }
                    }
                });

                if (newItems.length > 0) {
                    onAdd(newItems);
                    // Move campaigns to createdCampaigns and clear bulkCampaigns
                    setCreatedCampaigns(prev => [...prev, ...bulkCampaigns]);
                    setBulkCampaigns([]);
                }
            };

            // Functions to manage created campaigns
            const removeCreatedCampaign = (index) => {
                const newCreated = [...createdCampaigns];
                newCreated.splice(index, 1);
                setCreatedCampaigns(newCreated);
            };

            const duplicateCreatedCampaign = (index) => {
                const campaign = createdCampaigns[index];
                const duplicated = {
                    ...campaign,
                    id: Date.now() + Math.random(),
                    campaignName: `${campaign.campaignName} (Copy)`
                };
                setCreatedCampaigns(prev => [...prev, duplicated]);
            };

            const editCreatedCampaign = (index) => {
                const campaign = createdCampaigns[index];
                const newCreated = [...createdCampaigns];
                newCreated.splice(index, 1);
                setCreatedCampaigns(newCreated);
                setBulkCampaigns(prev => [...prev, campaign]);
            };

            const createRow = (entity, overrides = {}) => {
                return {
                    Product: 'Sponsored Products',
                    Entity: entity,
                    Operation: 'Create',
                    'Campaign ID': formData.campaignId || '',
                    'Ad Group ID': formData.adGroupId || '',
                    'Portfolio ID': formData.portfolioId || '',
                    'Ad ID': '',
                    'Keyword ID': '',
                    'Product Targeting ID': '',
                    'Campaign Name': formData.campaignName || '',
                    'Ad Group Name': formData.adGroupName || '',
                    'Campaign Name (Informational only)': formData.campaignName || '',
                    'Ad Group Name (Informational only)': formData.adGroupName || '',
                    'Portfolio Name (Informational only)': formData.portfolioName || '',
                    'Start Date': '',
                    'End Date': '',
                    'Targeting Type': '',
                    State: 'enabled',
                    'Campaign State (Informational only)': '',
                    'Ad Group State (Informational only)': '',
                    'Daily Budget': '',
                    SKU: '',
                    'ASIN (Informational only)': '',
                    'Eligibility Status (Informational only)': '',
                    'Reason for Ineligibility (Informational only)': '',
                    'Ad Group Default Bid': '',
                    'Ad Group Default Bid (Informational only)': '',
                    Bid: '',
                    'Keyword Text': '',
                    'Native Language Keyword': '',
                    'Native Language Locale': '',
                    'Match Type': '',
                    'Bidding Strategy': '',
                    Placement: '',
                    Percentage: '',
                    'Product Targeting Expression': '',
                    'Resolved Product Targeting Expression (Informational only)': '',
                    Impressions: '',
                    Clicks: '',
                    'Click-through Rate': '',
                    Spend: '',
                    Sales: '',
                    Orders: '',
                    Units: '',
                    'Conversion Rate': '',
                    ACOS: '',
                    CPC: '',
                    ROAS: '',
                    ...overrides
                };
            };

            const handleAdd = () => {
                const newItems = [];

                if (type === 'campaigns') {
                    const campaignId = formData.name?.replace(/[^a-zA-Z0-9]/g, '_') || '';
                    const campaign = createRow('Campaign', {
                        'Campaign ID': campaignId,
                        'Campaign Name': formData.name,
                        'Targeting Type': formData.targetingType || 'Manual',
                        'Daily Budget': formData.budget || '10',
                        'Bidding Strategy': formData.biddingStrategy || 'Dynamic bids - down only',
                        'Start Date': new Date().toISOString().split('T')[0].replace(/-/g, ''),
                        'Portfolio ID': formData.portfolioId || '',
                        'Portfolio Name (Informational only)': formData.portfolioName || ''
                    });
                    newItems.push(campaign);

                    // Add Placement bid modifiers if specified
                    if (formData.topOfSearchMod && formData.topOfSearchMod !== '0' && formData.topOfSearchMod !== '') {
                        const placement1 = createRow('Campaign Placement', {
                            'Campaign ID': campaignId,
                            'Campaign Name (Informational only)': formData.name,
                            'Placement': 'Placement Top',
                            'Percentage': formData.topOfSearchMod,
                            'Portfolio Name (Informational only)': formData.portfolioName || ''
                        });
                        newItems.push(placement1);
                    }
                    
                    if (formData.restOfSearchMod && formData.restOfSearchMod !== '0' && formData.restOfSearchMod !== '') {
                        const placement2 = createRow('Campaign Placement', {
                            'Campaign ID': campaignId,
                            'Campaign Name (Informational only)': formData.name,
                            'Placement': 'Placement Rest of Search',
                            'Percentage': formData.restOfSearchMod,
                            'Portfolio Name (Informational only)': formData.portfolioName || ''
                        });
                        newItems.push(placement2);
                    }
                    
                    if (formData.productPagesMod && formData.productPagesMod !== '0' && formData.productPagesMod !== '') {
                        const placement3 = createRow('Campaign Placement', {
                            'Campaign ID': campaignId,
                            'Campaign Name (Informational only)': formData.name,
                            'Placement': 'Placement Product Page',
                            'Percentage': formData.productPagesMod,
                            'Portfolio Name (Informational only)': formData.portfolioName || ''
                        });
                        newItems.push(placement3);
                    }

                    // Add ad group if provided
                    if (formData.adGroupName) {
                        const adGroupId = formData.adGroupName.replace(/[^a-zA-Z0-9]/g, '_');
                        const adGroup = createRow('Ad Group', {
                            'Campaign ID': campaignId,
                            'Campaign Name': formData.name,
                            'Ad Group ID': adGroupId,
                            'Ad Group Name': formData.adGroupName,
                            'Ad Group Default Bid': formData.defaultBid || '0.50'
                        });
                        newItems.push(adGroup);

                        // Add products if provided
                        if (formData.skus) {
                            const skus = formData.skus.split('\n').map(s => s.trim()).filter(Boolean);
                            skus.forEach(sku => {
                                const product = createRow('Product Ad', {
                                    'Campaign ID': campaignId,
                                    'Campaign Name': formData.name,
                                    'Ad Group ID': adGroupId,
                                    'Ad Group Name': formData.adGroupName,
                                    SKU: sku
                                });
                                newItems.push(product);
                            });
                        }

                        // Add keywords if provided
                        if (formData.keywords) {
                            const keywords = formData.keywords.split('\n').map(k => k.trim()).filter(Boolean);
                            keywords.forEach(keyword => {
                                const kw = createRow('Keyword', {
                                    'Campaign ID': campaignId,
                                    'Campaign Name': formData.name,
                                    'Ad Group ID': adGroupId,
                                    'Ad Group Name': formData.adGroupName,
                                    'Keyword Text': keyword,
                                    'Match Type': formData.matchType || 'Broad',
                                    Bid: formData.keywordBid || ''
                                });
                                newItems.push(kw);
                            });
                        }

                        // Add product targets if provided
                        if (formData.productTargets) {
                            const targets = formData.productTargets.split('\n').map(t => t.trim()).filter(Boolean);
                            const targetingMethod = formData.targetingMethod || 'asin';
                            
                            targets.forEach(target => {
                                // Format the expression
                                const formattedExpression = formatProductTargetingExpression(target, targetingMethod);
                                
                                const productTarget = createRow('Product Targeting', {
                                    'Campaign ID': campaignId,
                                    'Campaign Name': formData.name,
                                    'Ad Group ID': adGroupId,
                                    'Ad Group Name': formData.adGroupName,
                                    'Product Targeting Expression': formattedExpression,
                                    Bid: formData.productTargetBid || ''
                                });
                                newItems.push(productTarget);
                            });
                        }
                    }
                } else if (type === 'keywords') {
                    // Bulk keyword adding
                    const keywords = formData.keywords.split('\n').map(k => k.trim()).filter(Boolean);
                    keywords.forEach(keyword => {
                        const kw = createRow('Keyword', {
                            'Keyword Text': keyword,
                            'Match Type': formData.matchType || 'Broad',
                            Bid: formData.bid || ''
                        });
                        newItems.push(kw);
                    });
                } else if (type === 'adgroups') {
                    // Add new ad group to existing campaign
                    if (!formData.campaignId || !formData.adGroupName) {
                        alert('Please select a campaign and enter an ad group name');
                        return;
                    }

                    const campaign = campaigns.find(c => c['Campaign ID'] === formData.campaignId);
                    const adGroupId = formData.adGroupName.replace(/[^a-zA-Z0-9]/g, '_');
                    
                    const adGroup = createRow('Ad Group', {
                        'Campaign ID': formData.campaignId,
                        'Campaign Name': getCampaignName(campaign),
                        'Campaign Name (Informational only)': getCampaignName(campaign),
                        'Ad Group ID': adGroupId,
                        'Ad Group Name': formData.adGroupName,
                        'Ad Group Name (Informational only)': formData.adGroupName,
                        'Ad Group Default Bid': formData.defaultBid || '0.50',
                        'Portfolio ID': campaign['Portfolio ID'] || '',
                        'Portfolio Name (Informational only)': getPortfolioName(campaign) || ''
                    });
                    newItems.push(adGroup);

                    // Add products if provided
                    if (formData.skus) {
                        const skus = formData.skus.split('\n').map(s => s.trim()).filter(Boolean);
                        skus.forEach(sku => {
                            const product = createRow('Product Ad', {
                                'Campaign ID': formData.campaignId,
                                'Campaign Name': getCampaignName(campaign),
                                'Campaign Name (Informational only)': getCampaignName(campaign),
                                'Ad Group ID': adGroupId,
                                'Ad Group Name': formData.adGroupName,
                                'Ad Group Name (Informational only)': formData.adGroupName,
                                SKU: sku,
                                'Portfolio ID': campaign['Portfolio ID'] || '',
                                'Portfolio Name (Informational only)': getPortfolioName(campaign) || ''
                            });
                            newItems.push(product);
                        });
                    }

                    // Add keywords if provided
                    if (formData.keywords) {
                        const keywords = formData.keywords.split('\n').map(k => k.trim()).filter(Boolean);
                        keywords.forEach(keyword => {
                            const kw = createRow('Keyword', {
                                'Campaign ID': formData.campaignId,
                                'Campaign Name': getCampaignName(campaign),
                                'Campaign Name (Informational only)': getCampaignName(campaign),
                                'Ad Group ID': adGroupId,
                                'Ad Group Name': formData.adGroupName,
                                'Ad Group Name (Informational only)': formData.adGroupName,
                                'Keyword Text': keyword,
                                'Match Type': formData.matchType || 'Broad',
                                Bid: formData.keywordBid || '',
                                'Portfolio ID': campaign['Portfolio ID'] || '',
                                'Portfolio Name (Informational only)': getPortfolioName(campaign) || ''
                            });
                            newItems.push(kw);
                        });
                    }
                } else if (type === 'negative') {
                    // Bulk negative keyword adding
                    const keywords = formData.negativeKeywords.split('\n').map(k => k.trim()).filter(Boolean);
                    const entity = formData.level === 'campaign' ? 'Campaign Negative Keyword' : 'Negative Keyword';
                    keywords.forEach(keyword => {
                        const neg = createRow(entity, {
                            'Keyword Text': keyword,
                            'Match Type': formData.matchType || 'negativeExact',
                            'Ad Group ID': formData.level === 'adgroup' ? formData.adGroupId : ''
                        });
                        newItems.push(neg);
                    });
                } else if (type === 'products') {
                    const skus = formData.skus.split('\n').map(s => s.trim()).filter(Boolean);
                    skus.forEach(sku => {
                        const product = createRow('Product Ad', {
                            SKU: sku
                        });
                        newItems.push(product);
                    });
                }

                if (newItems.length > 0) {
                    onAdd(newItems);
                    onClose();
                }
            };

            const renderFormContent = () => {
                if (type === 'campaigns') {
                    if (bulkMode) {
                        return (
                            <div className="space-y-3">
                                <div className="flex items-center justify-between">
                                    <h3 className="text-lg font-semibold">Campaign Builder - Bulk Mode</h3>
                                    <button
                                        onClick={() => setBulkMode(false)}
                                        className="text-sm text-blue-600 hover:text-blue-800 underline"
                                    >
                                        Switch to Single Mode
                                    </button>
                                </div>
                                
                                <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-900 mb-3">
                                    💡 Build multiple campaigns at once! Your newly created campaigns (marked as NEW in Changes tab) are shown above. Duplicate or edit them to create similar campaigns. Add new rows below to build more.
                                </div>

                                {data.length > 0 && (
                                    <div className="bg-orange-50 p-3 rounded-lg text-xs text-orange-900 mb-3 border border-orange-200">
                                        ⚠️ <strong>Duplicate Checker Active:</strong> Keywords and SKUs that already exist in your campaigns will be highlighted in orange with a warning icon. Hover over the ⚠️ to see which campaign/ad group contains the duplicate.
                                    </div>
                                )}

                                {/* Created Campaigns Section */}
                                {createdCampaigns.length > 0 && (
                                    <div className="mb-4">
                                        <div className="flex items-center justify-between mb-2">
                                            <h4 className="text-sm font-semibold text-green-800">✅ Newly Created Campaigns ({createdCampaigns.length})</h4>
                                            <span className="text-xs text-gray-600">Campaigns ready to be uploaded - duplicate or edit to create more</span>
                                        </div>
                                        <div className="overflow-x-auto max-h-[35vh] border rounded-lg bg-green-50">
                                            <table className="w-full text-xs">
                                                <thead className="bg-green-100 sticky top-0">
                                                    <tr>
                                                        <th className="px-2 py-2 text-left font-medium w-8">#</th>
                                                        <th className="px-2 py-2 text-left font-medium min-w-[150px]">Campaign Name</th>
                                                        <th className="px-2 py-2 text-left font-medium min-w-[120px]">Portfolio</th>
                                                        <th className="px-2 py-2 text-left font-medium w-24">Budget</th>
                                                        <th className="px-2 py-2 text-left font-medium min-w-[150px]">Ad Group Name</th>
                                                        <th className="px-2 py-2 text-left font-medium min-w-[100px]">Keywords</th>
                                                        <th className="px-2 py-2 text-left font-medium min-w-[100px]">Products (SKUs)</th>
                                                        <th className="px-2 py-2 text-left font-medium w-32">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {createdCampaigns.map((camp, index) => (
                                                        <tr key={camp.id} className="border-t hover:bg-green-100">
                                                            <td className="px-2 py-2 text-gray-600">{index + 1}</td>
                                                            <td className="px-2 py-2 font-medium">{camp.campaignName}</td>
                                                            <td className="px-2 py-2">{camp.portfolioName || '-'}</td>
                                                            <td className="px-2 py-2">{camp.dailyBudget || '-'}</td>
                                                            <td className="px-2 py-2">{camp.adGroupName || '-'}</td>
                                                            <td className="px-2 py-2">
                                                                <div className="max-w-[100px] truncate" title={camp.keywords}>
                                                                    {camp.keywords ? camp.keywords.split('\n').filter(k => k.trim()).length + ' keyword(s)' : '-'}
                                                                </div>
                                                            </td>
                                                            <td className="px-2 py-2">
                                                                <div className="max-w-[100px] truncate" title={camp.products}>
                                                                    {camp.products ? camp.products.split('\n').filter(p => p.trim()).length + ' SKU(s)' : '-'}
                                                                </div>
                                                            </td>
                                                            <td className="px-2 py-2">
                                                                <div className="flex gap-1">
                                                                    <button
                                                                        onClick={() => editCreatedCampaign(index)}
                                                                        className="p-1 text-blue-600 hover:bg-blue-100 rounded"
                                                                        title="Edit (move back to draft)"
                                                                    >
                                                                        ✏️
                                                                    </button>
                                                                    <button
                                                                        onClick={() => duplicateCreatedCampaign(index)}
                                                                        className="p-1 text-green-600 hover:bg-green-100 rounded"
                                                                        title="Duplicate"
                                                                    >
                                                                        📋
                                                                    </button>
                                                                    <button
                                                                        onClick={() => removeCreatedCampaign(index)}
                                                                        className="p-1 text-red-600 hover:bg-red-100 rounded"
                                                                        title="Remove"
                                                                    >
                                                                        🗑️
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {/* Draft Campaigns Section */}
                                {bulkCampaigns.length > 0 && (
                                    <h4 className="text-sm font-semibold text-gray-700 mb-2">📝 Draft Campaigns ({bulkCampaigns.length})</h4>
                                )}

                                {bulkCampaigns.length === 0 && createdCampaigns.length === 0 && (
                                    <div className="text-center py-8 text-gray-500 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                                        <p className="text-sm">No campaigns yet. Click "➕ Add Row" below to start building campaigns.</p>
                                    </div>
                                )}

                                {bulkCampaigns.length === 0 && createdCampaigns.length > 0 && (
                                    <div className="text-center py-6 text-green-700 bg-green-50 rounded-lg border border-green-200">
                                        <p className="text-sm font-medium">✓ No draft campaigns - ready to create more!</p>
                                        <p className="text-xs mt-1">Click "➕ Add Row" below to build new campaigns, or duplicate your newly created ones above.</p>
                                    </div>
                                )}

                                {bulkCampaigns.length > 0 && (
                                <div className="overflow-x-auto max-h-[60vh] border rounded-lg">
                                    <table className="w-full text-xs">
                                        <thead className="bg-gray-100 sticky top-0">
                                            <tr>
                                                <th className="px-2 py-2 text-left font-medium w-8">#</th>
                                                <th className="px-2 py-2 text-left font-medium min-w-[150px]">Campaign Name *</th>
                                                <th className="px-2 py-2 text-left font-medium min-w-[120px]">Portfolio</th>
                                                <th className="px-2 py-2 text-left font-medium w-24">Budget</th>
                                                <th className="px-2 py-2 text-left font-medium w-24">Targeting</th>
                                                <th className="px-2 py-2 text-left font-medium min-w-[140px]">Bidding Strategy</th>
                                                <th className="px-2 py-2 text-left font-medium min-w-[150px]">Ad Group Name</th>
                                                <th className="px-2 py-2 text-left font-medium w-20">Default Bid</th>
                                                <th className="px-2 py-2 text-left font-medium min-w-[120px]">
                                                    <div className="flex items-center gap-1">
                                                        Products (SKUs)
                                                        <span className="text-orange-600 text-[10px]" title="Duplicates will be highlighted">⚠️</span>
                                                    </div>
                                                </th>
                                                <th className="px-2 py-2 text-left font-medium min-w-[120px]">
                                                    <div className="flex items-center gap-1">
                                                        Keywords
                                                        <span className="text-orange-600 text-[10px]" title="Duplicates will be highlighted">⚠️</span>
                                                    </div>
                                                </th>
                                                <th className="px-2 py-2 text-left font-medium w-24">Match Type</th>
                                                <th className="px-2 py-2 text-left font-medium w-20">KW Bid</th>
                                                <th className="px-2 py-2 text-left font-medium min-w-[120px]">Product Targets (ASINs)</th>
                                                <th className="px-2 py-2 text-left font-medium w-24">Target Type</th>
                                                <th className="px-2 py-2 text-left font-medium w-20">PT Bid</th>
                                                <th className="px-2 py-2 text-left font-medium w-24">Top of Search %</th>
                                                <th className="px-2 py-2 text-left font-medium w-24">Rest of Search %</th>
                                                <th className="px-2 py-2 text-left font-medium w-24">Product Pages %</th>
                                                <th className="px-2 py-2 text-left font-medium w-24">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {bulkCampaigns.map((camp, index) => {
                                                const keywordDuplicates = checkDuplicates(camp.keywords, 'keywords');
                                                const productDuplicates = checkDuplicates(camp.products, 'products');
                                                
                                                return (
                                                <tr key={camp.id} className="border-t hover:bg-gray-50">
                                                    <td className="px-2 py-2 text-gray-600">{index + 1}</td>
                                                    <td className="px-2 py-2">
                                                        <input
                                                            type="text"
                                                            value={camp.campaignName}
                                                            onChange={(e) => updateBulkCampaign(index, 'campaignName', e.target.value)}
                                                            placeholder="Campaign name"
                                                            className="w-full px-2 py-1 border rounded text-xs"
                                                        />
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <input
                                                            type="text"
                                                            value={camp.portfolioName}
                                                            onChange={(e) => {
                                                                const portfolioName = e.target.value;
                                                                const portfolioId = portfolioName ? portfoliosMap.get(portfolioName) : '';
                                                                const newCampaigns = [...bulkCampaigns];
                                                                newCampaigns[index].portfolioName = portfolioName;
                                                                newCampaigns[index].portfolioId = portfolioId || '';
                                                                setBulkCampaigns(newCampaigns);
                                                            }}
                                                            list={`portfolio-list-${index}`}
                                                            placeholder="Portfolio name"
                                                            className="w-full px-2 py-1 border rounded text-xs"
                                                        />
                                                        {portfolios.length > 0 && (
                                                            <datalist id={`portfolio-list-${index}`}>
                                                                {portfolios.map(p => <option key={p} value={p} />)}
                                                            </datalist>
                                                        )}
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <input
                                                            type="text"
                                                            value={camp.dailyBudget}
                                                            onChange={(e) => updateBulkCampaign(index, 'dailyBudget', e.target.value)}
                                                            placeholder="10.00"
                                                            className="w-full px-2 py-1 border rounded text-xs"
                                                        />
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <select
                                                            value={camp.targetingType}
                                                            onChange={(e) => updateBulkCampaign(index, 'targetingType', e.target.value)}
                                                            className="w-full px-2 py-1 border rounded text-xs"
                                                        >
                                                            <option value="Manual">Manual</option>
                                                            <option value="Auto">Auto</option>
                                                        </select>
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <select
                                                            value={camp.biddingStrategy}
                                                            onChange={(e) => updateBulkCampaign(index, 'biddingStrategy', e.target.value)}
                                                            className="w-full px-2 py-1 border rounded text-xs"
                                                        >
                                                            <option value="Dynamic bids - down only">Dynamic - down only</option>
                                                            <option value="Dynamic bids - up and down">Dynamic - up and down</option>
                                                            <option value="Fixed bid">Fixed bid</option>
                                                        </select>
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <input
                                                            type="text"
                                                            value={camp.adGroupName}
                                                            onChange={(e) => updateBulkCampaign(index, 'adGroupName', e.target.value)}
                                                            placeholder="Ad group name"
                                                            className="w-full px-2 py-1 border rounded text-xs"
                                                        />
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <input
                                                            type="text"
                                                            value={camp.defaultBid}
                                                            onChange={(e) => updateBulkCampaign(index, 'defaultBid', e.target.value)}
                                                            placeholder="0.50"
                                                            className="w-full px-2 py-1 border rounded text-xs"
                                                        />
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <div className="relative">
                                                            <textarea
                                                                value={camp.products}
                                                                onChange={(e) => updateBulkCampaign(index, 'products', e.target.value)}
                                                                placeholder="SKU1&#10;SKU2"
                                                                rows="2"
                                                                className={`w-full px-2 py-1 border rounded text-xs ${
                                                                    productDuplicates.length > 0 ? 'border-orange-400 bg-orange-50' : ''
                                                                }`}
                                                            />
                                                            {productDuplicates.length > 0 && (
                                                                <div className="absolute top-0 right-0 mt-1 mr-1">
                                                                    <span 
                                                                        className="text-orange-600 cursor-help text-xs"
                                                                        title={`Duplicates found:\n${productDuplicates.map(d => `${d.text} → ${d.campaign} / ${d.adGroup}`).join('\n')}`}
                                                                    >
                                                                        ⚠️
                                                                    </span>
                                                                </div>
                                                            )}
                                                        </div>
                                                        {productDuplicates.length > 0 && (
                                                            <div className="mt-1 text-[10px] text-orange-700 font-medium">
                                                                {productDuplicates.length} duplicate{productDuplicates.length > 1 ? 's' : ''} found
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <div className="relative">
                                                            <textarea
                                                                value={camp.keywords}
                                                                onChange={(e) => updateBulkCampaign(index, 'keywords', e.target.value)}
                                                                placeholder="keyword1&#10;keyword2"
                                                                rows="2"
                                                                className={`w-full px-2 py-1 border rounded text-xs ${
                                                                    keywordDuplicates.length > 0 ? 'border-orange-400 bg-orange-50' : ''
                                                                }`}
                                                            />
                                                            {keywordDuplicates.length > 0 && (
                                                                <div className="absolute top-0 right-0 mt-1 mr-1">
                                                                    <span 
                                                                        className="text-orange-600 cursor-help text-xs"
                                                                        title={`Duplicates found:\n${keywordDuplicates.map(d => `${d.text} (${d.matchType}) → ${d.campaign} / ${d.adGroup}`).join('\n')}`}
                                                                    >
                                                                        ⚠️
                                                                    </span>
                                                                </div>
                                                            )}
                                                        </div>
                                                        {keywordDuplicates.length > 0 && (
                                                            <div className="mt-1 text-[10px] text-orange-700 font-medium">
                                                                {keywordDuplicates.length} duplicate{keywordDuplicates.length > 1 ? 's' : ''} found
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <select
                                                            value={camp.matchType}
                                                            onChange={(e) => updateBulkCampaign(index, 'matchType', e.target.value)}
                                                            className="w-full px-2 py-1 border rounded text-xs"
                                                        >
                                                            <option value="Broad">Broad</option>
                                                            <option value="Phrase">Phrase</option>
                                                            <option value="Exact">Exact</option>
                                                        </select>
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <input
                                                            type="text"
                                                            value={camp.keywordBid}
                                                            onChange={(e) => updateBulkCampaign(index, 'keywordBid', e.target.value)}
                                                            placeholder="0.50"
                                                            className="w-full px-2 py-1 border rounded text-xs"
                                                        />
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <textarea
                                                            value={camp.productTargets || ''}
                                                            onChange={(e) => updateBulkCampaign(index, 'productTargets', e.target.value)}
                                                            placeholder="B0CL21ZDS3"
                                                            className="w-full px-2 py-1 border rounded text-xs font-mono"
                                                            rows="2"
                                                        />
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <select
                                                            value={camp.targetingMethod || 'asin'}
                                                            onChange={(e) => updateBulkCampaign(index, 'targetingMethod', e.target.value)}
                                                            className="w-full px-2 py-1 border rounded text-xs"
                                                        >
                                                            <option value="asin">ASIN</option>
                                                            <option value="asin-expanded">ASIN-Exp</option>
                                                            <option value="category">Category</option>
                                                        </select>
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <input
                                                            type="text"
                                                            value={camp.productTargetBid || ''}
                                                            onChange={(e) => updateBulkCampaign(index, 'productTargetBid', e.target.value)}
                                                            placeholder="0.50"
                                                            className="w-full px-2 py-1 border rounded text-xs"
                                                        />
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <input
                                                            type="text"
                                                            value={camp.topOfSearchMod || ''}
                                                            onChange={(e) => updateBulkCampaign(index, 'topOfSearchMod', e.target.value)}
                                                            placeholder="0"
                                                            className="w-full px-2 py-1 border rounded text-xs"
                                                        />
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <input
                                                            type="text"
                                                            value={camp.restOfSearchMod || ''}
                                                            onChange={(e) => updateBulkCampaign(index, 'restOfSearchMod', e.target.value)}
                                                            placeholder="0"
                                                            className="w-full px-2 py-1 border rounded text-xs"
                                                        />
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <input
                                                            type="text"
                                                            value={camp.productPagesMod || ''}
                                                            onChange={(e) => updateBulkCampaign(index, 'productPagesMod', e.target.value)}
                                                            placeholder="0"
                                                            className="w-full px-2 py-1 border rounded text-xs"
                                                        />
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <div className="flex gap-1">
                                                            <button
                                                                onClick={() => duplicateBulkCampaign(index)}
                                                                className="p-1 text-blue-600 hover:bg-blue-50 rounded"
                                                                title="Duplicate"
                                                            >
                                                                📋
                                                            </button>
                                                            <button
                                                                onClick={() => removeBulkCampaign(index)}
                                                                className="p-1 text-red-600 hover:bg-red-50 rounded"
                                                                title="Remove"
                                                            >
                                                                🗑️
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                                )}

                                <button
                                    onClick={addEmptyBulkCampaign}
                                    className="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm"
                                >
                                    ➕ Add Row
                                </button>

                                <div className="flex gap-3 mt-4">
                                    {bulkCampaigns.length > 0 ? (
                                        <>
                                            <button
                                                onClick={createBulkCampaigns}
                                                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                            >
                                                Create {bulkCampaigns.length} New Campaign{bulkCampaigns.length !== 1 ? 's' : ''}
                                            </button>
                                            <button
                                                onClick={onClose}
                                                className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                                            >
                                                Cancel
                                            </button>
                                        </>
                                    ) : (
                                        <button
                                            onClick={onClose}
                                            className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                        >
                                            Done {createdCampaigns.length > 0 ? `(${createdCampaigns.length} campaign${createdCampaigns.length !== 1 ? 's' : ''} created)` : ''}
                                        </button>
                                    )}
                                </div>
                            </div>
                        );
                    }

                    // Single campaign mode
                    return (
                        <div className="space-y-3">
                            <div className="flex items-center justify-between">
                                <h3 className="text-lg font-semibold">Campaign Builder</h3>
                                <button
                                    onClick={() => setBulkMode(true)}
                                    className="text-sm text-blue-600 hover:text-blue-800 underline"
                                >
                                    Switch to Bulk Mode
                                </button>
                            </div>
                            
                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => {
                                    const portfolioName = e.target.value;
                                    const portfolioId = portfolioName ? portfoliosMap.get(portfolioName) : '';
                                    setFormData({
                                        ...formData, 
                                        portfolioName: portfolioName,
                                        portfolioId: portfolioId || ''
                                    });
                                }}
                            >
                                <option value="">Portfolio (optional)</option>
                                {portfolios.map((p, i) => (
                                    <option key={i} value={p}>{p}</option>
                                ))}
                            </select>

                            <input
                                type="text"
                                placeholder="Campaign Name *"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, name: e.target.value})}
                            />

                            <input
                                type="number"
                                placeholder="Daily Budget"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, budget: e.target.value})}
                            />

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, targetingType: e.target.value})}
                                defaultValue="Manual"
                            >
                                <option value="Manual">Manual</option>
                                <option value="Auto">Auto</option>
                            </select>

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, biddingStrategy: e.target.value})}
                                defaultValue="Dynamic bids - down only"
                            >
                                <option value="Dynamic bids - down only">Dynamic bids - down only</option>
                                <option value="Dynamic bids - up and down">Dynamic bids - up and down</option>
                                <option value="Fixed bid">Fixed bid</option>
                            </select>

                            <hr className="my-4" />
                            <h4 className="font-medium">Bid Adjustments (optional)</h4>
                            <p className="text-sm text-gray-600 mb-2">Enter percentage modifiers for different placements (e.g., 50 for +50%)</p>

                            <div className="grid grid-cols-3 gap-3">
                                <div>
                                    <label className="block text-sm text-gray-700 mb-1">Top of Search %</label>
                                    <input
                                        type="number"
                                        placeholder="0"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        onChange={(e) => setFormData({...formData, topOfSearchMod: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-700 mb-1">Rest of Search %</label>
                                    <input
                                        type="number"
                                        placeholder="0"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        onChange={(e) => setFormData({...formData, restOfSearchMod: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-700 mb-1">Product Pages %</label>
                                    <input
                                        type="number"
                                        placeholder="0"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        onChange={(e) => setFormData({...formData, productPagesMod: e.target.value})}
                                    />
                                </div>
                            </div>

                            <hr className="my-4" />
                            <h4 className="font-medium">Add Ad Group (optional)</h4>

                            <input
                                type="text"
                                placeholder="Ad Group Name"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, adGroupName: e.target.value})}
                            />

                            <input
                                type="number"
                                placeholder="Default Bid"
                                step="0.01"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, defaultBid: e.target.value})}
                            />

                            <textarea
                                placeholder="Products (one SKU per line)"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                rows="3"
                                onChange={(e) => setFormData({...formData, skus: e.target.value})}
                            />

                            <textarea
                                placeholder="Keywords (one per line)"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                rows="3"
                                onChange={(e) => setFormData({...formData, keywords: e.target.value})}
                            />

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, matchType: e.target.value})}
                                defaultValue="Broad"
                            >
                                <option value="Broad">Broad Match</option>
                                <option value="Phrase">Phrase Match</option>
                                <option value="Exact">Exact Match</option>
                            </select>

                            <input
                                type="number"
                                placeholder="Keyword Bid (optional)"
                                step="0.01"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, keywordBid: e.target.value})}
                            />

                            <hr className="my-4" />
                            <h4 className="font-medium">Product Targeting (optional)</h4>
                            <p className="text-sm text-gray-600 mb-2">Add ASINs for product targeting. They will be auto-formatted.</p>
                            
                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, targetingMethod: e.target.value})}
                                defaultValue="asin"
                            >
                                <option value="asin">Individual ASINs</option>
                                <option value="asin-expanded">Expanded ASIN Targeting</option>
                                <option value="category">Category Targeting</option>
                            </select>

                            <textarea
                                placeholder="ASINs or Category IDs (one per line, e.g., B0CL21ZDS3)"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg font-mono text-sm"
                                rows="4"
                                onChange={(e) => setFormData({...formData, productTargets: e.target.value})}
                            />

                            <input
                                type="number"
                                placeholder="Product Target Bid (optional)"
                                step="0.01"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, productTargetBid: e.target.value})}
                            />
                        </div>
                    );
                } else if (type === 'keywords') {
                    const keywordDuplicates = checkDuplicates(formData.keywords, 'keywords', formData.campaignId, formData.adGroupId);
                    
                    return (
                        <div className="space-y-3">
                            <h3 className="text-lg font-semibold">Add Keywords (Bulk)</h3>
                            
                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => {
                                    const campaign = campaigns.find(c => c['Campaign ID'] === e.target.value);
                                    setFormData({
                                        ...formData,
                                        campaignId: e.target.value,
                                        campaignName: getCampaignName(campaign)
                                    });
                                }}
                            >
                                <option value="">Select Campaign *</option>
                                {campaigns.map((c, i) => (
                                    <option key={i} value={c['Campaign ID']}>
                                        {getCampaignName(c)}
                                    </option>
                                ))}
                            </select>

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => {
                                    const ag = adGroups.find(a => a['Ad Group ID'] === e.target.value);
                                    setFormData({
                                        ...formData,
                                        adGroupId: e.target.value,
                                        adGroupName: getAdGroupName(ag)
                                    });
                                }}
                            >
                                <option value="">Select Ad Group *</option>
                                {adGroups
                                    .filter(ag => !formData.campaignId || ag['Campaign ID'] === formData.campaignId)
                                    .map((ag, i) => (
                                        <option key={i} value={ag['Ad Group ID']}>
                                            {getAdGroupName(ag)}
                                        </option>
                                    ))}
                            </select>

                            <div className="relative">
                                <textarea
                                    placeholder="Keywords (one per line) *"
                                    className={`w-full px-4 py-2 border rounded-lg ${
                                        keywordDuplicates.length > 0 ? 'border-orange-400 bg-orange-50' : 'border-gray-300'
                                    }`}
                                    rows="10"
                                    onChange={(e) => setFormData({...formData, keywords: e.target.value})}
                                />
                                {keywordDuplicates.length > 0 && (
                                    <div className="absolute top-0 right-0 mt-1 mr-1">
                                        <span 
                                            className="text-orange-600 cursor-help text-xs"
                                            title={`Duplicates found:\n${keywordDuplicates.map(d => `${d.text} (${d.matchType}) → ${d.campaign} / ${d.adGroup}`).join('\n')}`}
                                        >
                                            ⚠️
                                        </span>
                                    </div>
                                )}
                            </div>
                            {keywordDuplicates.length > 0 && (
                                <div className="mt-1 text-xs text-orange-700 font-medium">
                                    {keywordDuplicates.length} duplicate{keywordDuplicates.length > 1 ? 's' : ''} found
                                </div>
                            )}

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, matchType: e.target.value})}
                                defaultValue="Broad"
                            >
                                <option value="Broad">Broad</option>
                                <option value="Phrase">Phrase</option>
                                <option value="Exact">Exact</option>
                            </select>

                            <input
                                type="number"
                                placeholder="Bid (optional)"
                                step="0.01"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, bid: e.target.value})}
                            />
                        </div>
                    );
                } else if (type === 'negative') {
                    const negativeDuplicates = checkDuplicates(formData.negativeKeywords, 'negatives', formData.campaignId, formData.adGroupId);
                    
                    return (
                        <div className="space-y-3">
                            <h3 className="text-lg font-semibold">Add Negative Keywords (Bulk)</h3>
                            
                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, level: e.target.value})}
                                defaultValue="campaign"
                            >
                                <option value="campaign">Campaign-level</option>
                                <option value="adgroup">Ad Group-level</option>
                            </select>

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => {
                                    const campaign = campaigns.find(c => c['Campaign ID'] === e.target.value);
                                    setFormData({
                                        ...formData,
                                        campaignId: e.target.value,
                                        campaignName: getCampaignName(campaign)
                                    });
                                }}
                            >
                                <option value="">Select Campaign *</option>
                                {campaigns.map((c, i) => (
                                    <option key={i} value={c['Campaign ID']}>
                                        {getCampaignName(c)}
                                    </option>
                                ))}
                            </select>

                            {formData.level === 'adgroup' && (
                                <select
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    onChange={(e) => {
                                        const ag = adGroups.find(a => a['Ad Group ID'] === e.target.value);
                                        setFormData({
                                            ...formData,
                                            adGroupId: e.target.value,
                                            adGroupName: getAdGroupName(ag)
                                        });
                                    }}
                                >
                                    <option value="">Select Ad Group *</option>
                                    {adGroups
                                        .filter(ag => !formData.campaignId || ag['Campaign ID'] === formData.campaignId)
                                        .map((ag, i) => (
                                            <option key={i} value={ag['Ad Group ID']}>
                                                {getAdGroupName(ag)}
                                            </option>
                                        ))}
                                </select>
                            )}

                            <div className="relative">
                                <textarea
                                    placeholder="Negative Keywords (one per line) *"
                                    className={`w-full px-4 py-2 border rounded-lg ${
                                        negativeDuplicates.length > 0 ? 'border-orange-400 bg-orange-50' : 'border-gray-300'
                                    }`}
                                    rows="10"
                                    onChange={(e) => setFormData({...formData, negativeKeywords: e.target.value})}
                                />
                                {negativeDuplicates.length > 0 && (
                                    <div className="absolute top-0 right-0 mt-1 mr-1">
                                        <span 
                                            className="text-orange-600 cursor-help text-xs"
                                            title={`Duplicates found:\n${negativeDuplicates.map(d => `${d.text} (${d.matchType}) → ${d.campaign} / ${d.adGroup}`).join('\n')}`}
                                        >
                                            ⚠️
                                        </span>
                                    </div>
                                )}
                            </div>
                            {negativeDuplicates.length > 0 && (
                                <div className="mt-1 text-xs text-orange-700 font-medium">
                                    {negativeDuplicates.length} duplicate{negativeDuplicates.length > 1 ? 's' : ''} found
                                </div>
                            )}

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, matchType: e.target.value})}
                                defaultValue="negativeExact"
                            >
                                <option value="negativeExact">Negative Exact</option>
                                <option value="negativePhrase">Negative Phrase</option>
                            </select>
                        </div>
                    );
                } else if (type === 'products') {
                    const productDuplicates = checkDuplicates(formData.skus, 'products', formData.campaignId, formData.adGroupId);
                    
                    return (
                        <div className="space-y-3">
                            <h3 className="text-lg font-semibold">Add Products (Bulk)</h3>
                            
                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => {
                                    const campaign = campaigns.find(c => c['Campaign ID'] === e.target.value);
                                    setFormData({
                                        ...formData,
                                        campaignId: e.target.value,
                                        campaignName: getCampaignName(campaign)
                                    });
                                }}
                            >
                                <option value="">Select Campaign *</option>
                                {campaigns.map((c, i) => (
                                    <option key={i} value={c['Campaign ID']}>
                                        {getCampaignName(c)}
                                    </option>
                                ))}
                            </select>

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => {
                                    const ag = adGroups.find(a => a['Ad Group ID'] === e.target.value);
                                    setFormData({
                                        ...formData,
                                        adGroupId: e.target.value,
                                        adGroupName: getAdGroupName(ag)
                                    });
                                }}
                            >
                                <option value="">Select Ad Group *</option>
                                {adGroups
                                    .filter(ag => !formData.campaignId || ag['Campaign ID'] === formData.campaignId)
                                    .map((ag, i) => (
                                        <option key={i} value={ag['Ad Group ID']}>
                                            {getAdGroupName(ag)}
                                        </option>
                                    ))}
                            </select>

                            <div className="relative">
                                <textarea
                                    placeholder="SKUs (one per line) *"
                                    className={`w-full px-4 py-2 border rounded-lg ${
                                        productDuplicates.length > 0 ? 'border-orange-400 bg-orange-50' : 'border-gray-300'
                                    }`}
                                    rows="10"
                                    onChange={(e) => setFormData({...formData, skus: e.target.value})}
                                />
                                {productDuplicates.length > 0 && (
                                    <div className="absolute top-0 right-0 mt-1 mr-1">
                                        <span 
                                            className="text-orange-600 cursor-help text-xs"
                                            title={`Duplicates found:\n${productDuplicates.map(d => `${d.text} → ${d.campaign} / ${d.adGroup}`).join('\n')}`}
                                        >
                                            ⚠️
                                        </span>
                                    </div>
                                )}
                            </div>
                            {productDuplicates.length > 0 && (
                                <div className="mt-1 text-xs text-orange-700 font-medium">
                                    {productDuplicates.length} duplicate{productDuplicates.length > 1 ? 's' : ''} found
                                </div>
                            )}
                        </div>
                    );
                } else if (type === 'adgroups') {
                    return (
                        <div className="space-y-3">
                            <h3 className="text-lg font-semibold">Add New Ad Group</h3>
                            
                            <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-900">
                                💡 Create a new ad group within an existing campaign. Optionally add products and keywords to it.
                            </div>

                            <select
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => {
                                    const campaign = campaigns.find(c => c['Campaign ID'] === e.target.value);
                                    setFormData({
                                        ...formData,
                                        campaignId: e.target.value,
                                        campaignName: getCampaignName(campaign)
                                    });
                                }}
                            >
                                <option value="">Select Campaign *</option>
                                {campaigns.map((c, i) => (
                                    <option key={i} value={c['Campaign ID']}>
                                        {getCampaignName(c)}
                                    </option>
                                ))}
                            </select>

                            <input
                                type="text"
                                placeholder="Ad Group Name *"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, adGroupName: e.target.value})}
                            />

                            <input
                                type="text"
                                placeholder="Default Bid (e.g., 0.50)"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                onChange={(e) => setFormData({...formData, defaultBid: e.target.value})}
                            />

                            <div className="border-t pt-3 mt-3">
                                <p className="text-xs text-gray-600 mb-2 font-medium">Optional: Add products to this ad group</p>
                                <textarea
                                    placeholder="SKUs (one per line, optional)"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    rows="4"
                                    onChange={(e) => setFormData({...formData, skus: e.target.value})}
                                />
                            </div>

                            <div className="border-t pt-3 mt-3">
                                <p className="text-xs text-gray-600 mb-2 font-medium">Optional: Add keywords to this ad group</p>
                                <textarea
                                    placeholder="Keywords (one per line, optional)"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    rows="4"
                                    onChange={(e) => setFormData({...formData, keywords: e.target.value})}
                                />
                                
                                <div className="grid grid-cols-2 gap-3 mt-2">
                                    <select
                                        className="px-4 py-2 border border-gray-300 rounded-lg"
                                        onChange={(e) => setFormData({...formData, matchType: e.target.value})}
                                        defaultValue="Broad"
                                    >
                                        <option value="Broad">Broad Match</option>
                                        <option value="Phrase">Phrase Match</option>
                                        <option value="Exact">Exact Match</option>
                                    </select>
                                    
                                    <input
                                        type="text"
                                        placeholder="Keyword Bid (optional)"
                                        className="px-4 py-2 border border-gray-300 rounded-lg"
                                        onChange={(e) => setFormData({...formData, keywordBid: e.target.value})}
                                    />
                                </div>
                            </div>
                        </div>
                    );
                }
                
                // Default return to prevent undefined rendering error
                return null;
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 max-w-[95vw] w-full mx-4 max-h-[90vh] overflow-y-auto">
                        {renderFormContent()}
                        {!bulkMode && (
                            <div className="flex gap-3 mt-6">
                                <button
                                    onClick={handleAdd}
                                    className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                >
                                    Add
                                </button>
                                <button
                                    onClick={onClose}
                                    className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                                >
                                    Cancel
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
